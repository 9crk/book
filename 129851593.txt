


　　对本书的赞誉
　　“对于那些正在进行规划、实施和管理小型至大型虚拟化环境的人们来说，这是一本重要的、可读性强的参考书籍。”
　　——Michael Rose，IDC公司行业分析师
　　“对于所有正在使用或者正在为用户规划一个或多个虚拟化解决方案的IT专业人员来说，这是一本重要的书籍。通过学习本书所包含的最全面、最流行的虚拟化解决方案，你将能够规划、构建和维护你的数据中心，并将其转变为战略性的动态服务交付中心。”
　　——Ruben Spruijt，PQR、MVP、CTP解决方案架构师
　　“本书涵盖了门类齐全的虚拟化供应商、工具以及类型！这本书与众不同！”
　　——Duncan Epping，PSO高级顾问、BCDR实践成员、VMware荷比卢分部
　　“可以预见，虚拟化在未来几年将会成为一个继续增长的领域，同时它也是一个复杂的领域。在决定哪些供应商的解决方案和产品将最有益于公司之前，需要考虑众多因素。这本综合性著作提供了许多重要的概念和标准，可以为计划在其IT基础架构中部署、进一步扩大虚拟化的公司提供非常有用的帮助。”
　　——Frank Anderson，Citrix Xendesktop高级技术市场经理
　　“Nelson Ruest和Danielle Ruest是IT和虚拟化方面的专家，他们在本书中分享了丰富的知识。如果你希望立即实施任何虚拟化项目，无论规模大小，本书都可以为项目提供所需的知识。并且随着内容的深入介绍，本书还提供了一些让经验丰富的虚拟化老手也感到惊奇的警示性故事。”
　　——Chris Wolf，Burton集团高级分析师
　　



　　译者序
　　虚拟化——一种在几十年前就已出现的前瞻性IT技术，在平淡发展了多年以后，终于在21世纪焕发了它的第二春。当前各种虚拟化技术层出不穷，并且愈演愈烈，让虚拟化成为当今最热门的IT技术之一。
　　虚拟化技术最初是出现在大型服务器架构中，目的是充分利用服务器硬件资源，但其高昂的价格和封闭的技术阻碍了虚拟化技术的普及。近些年来，随着普及型计算机系统硬件性能的不断提升以及各大虚拟化厂商的不断努力，x86架构的虚拟化技术有了突破性的发展，使得虚拟化技术在商业应用上的优势日益体现，虚拟化不仅可以降低IT成本，节省能源消耗，而且还可以增强系统的安全性以及可靠性。正是这些无可抗拒的优势，吸引了许多企业和组织争相部署虚拟化技术，使得虚拟化技术逐渐成为一种重要的IT基础架构。但对于虚拟化，各位IT技术人员是否真正充分地了解？他们是否知道如何才能有效地、正确地部署虚拟化技术？
　　很高兴有机会为大家翻译本书。本书的作者是Danielle Ruest和Nelson Ruest，两位都是著名的IT基础架构专家，一直以来都密切地关注着虚拟化技术的发展。他们结合自己丰富的虚拟化经验，共同编写了这本“经典”。与其他专门针对某种虚拟化产品/技术的操作指南型书籍不同，本书全面地阐述了虚拟化的各种基本概念，简要地分析了多种主流虚拟化产品的特性，最重要的是针对部署虚拟化技术过程所涉及的各个方面进行了系统深入的探讨，而且还加入了许多宝贵的实用经验案例。
　　无论你是刚刚接触虚拟化的新手，还是熟悉虚拟化的老手；无论你是正在准备部署虚拟化，还是已经部署了虚拟化，阅读本书绝对会让你获益良多。
　　最后，要感谢机械工业出版社决定引进这本经典之作，让国内的虚拟化技术人员有机会全面、系统地了解虚拟化。还要感谢的有参与本书翻译工作的4位好朋友：贺宏杰、杨万里、陈果文、赵万明。他们都是虚拟化的爱好者，为本书的翻译工作倾注了大量的智慧和汗水。
　　陈奋
　　2011.6
　　



　　序言
　　虚拟化是一种已有漫长历史的技术，由IBM在20世纪60年代末、70年代初提出。尽管如此，却很容易发现事实有那么一点讽刺：你正站在这里而且手里拿着这本虚拟化技术的初学者指南。既然虚拟化已经存在了那么长的时间，究竟为什么你需要一本初学者指南？这个问题的答案也许就是为什么你要把这本书放在首位阅读的原因。
　　这种已经存在了40年的技术有什么变化？虚拟化的目的和核心概念并没有多大的不同，但当它年满40岁时，可以说虚拟化出现了些许的“中年危机”。如果虚拟化可以返回并改变其生命周期内的任何东西，结果就是它将会发生很大的变化。虚拟化从来没有真正想要成为一种专有的技术，仅仅受限于有限的供应商和非常昂贵的硬件。虚拟化反而是多么想成为免费的技术并开放给任何想要使用它的人，而且能够在商用x86硬件平台上运行。
　　因此，如果你刚刚才开始接触虚拟化，那么现在正是时候。虚拟化不再是一项只有IT界的富人与名人才使用的边缘技术，它已经成为一项大众化的技术。今天，几乎所有的IT机构都在以这样或那样的方式使用着虚拟化技术，对于大多数IT基础架构来说，虚拟化正在成为一种核心组成部分。对于许多组织来说，x86服务器虚拟化是一种行为准则。所有新的应用程序都应部署为虚拟机（Virtual Machine，VM），除非应用程序所有者可以证明物理资源是必需的。
　　虚拟化消除了服务器操作系统对物理硬件的依赖性，前所未有地允许它们可以移动和恢复。服务器管理员现在可以将虚拟机实时迁移到另一个物理资源中，然后可以在工作日期间执行物理服务器硬件维护，而不再需要在周末期间的深夜里执行定期硬件维护。这种级别的灵活性，使得IT界中的许多人可以找回一些失去了很久的东西——可预测的休息时间和随心所欲的个人生活！此外，我工作过的几家组织已经放弃了灾难恢复（Disaster Resource，DR）测试，因为“它们对士气不利”。生产站点与灾难恢复站点之间的物理资源差异会令灾难恢复测试变得极其复杂，并且会对IT资源产生巨大的压力。你可以想象，虚拟化带来的硬件独立性消除了传统的与灾难恢复相关的复杂性，并使得许多组织可以比以往更频繁地、可靠地测试灾难恢复。实际上，我发现组织在它们的灾难恢复策略中使用虚拟化作为核心元素，使得它们对灾难恢复计划的第一次执行变得充满信心。
　　虚拟化正在全面地改变我们管理系统、存储、网络、安全、操作系统和应用程序的方式。更糟糕的是，现在有了无数的虚拟化方案可以让你选择。权衡每个选择的利弊以及成功实施和管理它们并非易事。这就是我个人认为这本书的内容非常有价值的原因。我在2000年第一次开始使用x86虚拟化技术。当时，我的一些同事称VMware为“VM恐慌”。可以肯定地说，现在已经没有人害怕或嘲笑虚拟化技术了。然而，虽然我看到了x86虚拟化成熟的优点，但我也目睹了要正确部署、保护和管理虚拟基础架构的粗放型增长的复杂性。了解每一个虚拟化平台的细微差别，是成功部署虚拟化解决方案的基础，并且可以避免特定的解决方案可能存在的危险。
　　如果你已经做到了这一步，我真的希望你继续阅读本书。Nelson Ruest和Danielle Ruest是IT和虚拟化专家，他们在本书中分享了他们丰富的知识。我长久以来一直是Nelson和Danielle的粉丝，是因为他们有条有理、循序渐进、理论联系实际（包括他们工作中的实际问题）的写作风格。如果你希望立即实施任何虚拟化项目，无论规模是大是小，本书都可以为你项目的开始提供所需的知识，而且随着内容的深入会为你提供一些甚至让某些经验丰富的虚拟化老手也感到惊奇的警示性故事。
　　——Burton集团高级分析师Chris Wolf
　　



　　前言
　　今天，有一股变革的新风吹向了IT行业。这就是虚拟化。在数据中心，虚拟化可以出现在多个层面上，但这股变革之风所创建的虚拟化类型是客户操作系统（Operating System，OS）或服务器虚拟化。客户操作系统虚拟化是一种软件层，提供了共享物理资源的能力，使物理资源在同一时间内可以被多台不同的虚拟机使用。客户操作系统虚拟化技术有2种版本，第一种是软件层，用于在现有的运行在硬件主机上的操作系统上模拟物理机。第二种是hypervisor——一种直接运行在硬件之上的软件引擎，消除了辅助操作系统的开销。
　　无论使用哪一种服务器虚拟化版本，它都具备在一台物理主机上运行一台或多台虚拟机的能力，在数据中心内开辟了各种各样的可能性。使用这项技术，现在可以更容易创建测试、培训或开发环境，甚至生产环境，并将它们转变成可塑性实例以响应业务需求的出现。对于培训、开发和测试环境，这种技术是特别有用的，因为当一个会话已经完成，你可以轻松地重置它们以恢复到原始的设置。并且可以更轻易地创建安全的虚拟桌面环境，以及依靠虚拟化技术减少需要管理的物理机箱的总数。此外，虚拟化解决了大多数组织在应用程序管理中一直遇到的问题。最后，虚拟化在业务连续性方面开辟了广阔的可能性。
　　然而，将所有的这些技术汇集到一个单一清晰的结构中是一项难以驾驭的任务。而这正是本书试图做到的事情。为了让大家更容易理解，本书分为3个部分，形成了虚拟化的基础知识。
　　虚拟化的基础知识基于3个关键任务：
　　▼第一部分：虚拟化架构师，开始对所有不同的虚拟化层进行探究，研究它们如何与现代的数据中心结合在一起。本部分由3章组成，每章概述了5步过程的一部分，对于虚拟基础架构的实施，Resolutions已经大力宣扬了2年多。
　　■第二部分：构建虚拟化基础架构，展开构建过程，通过需要执行的每个具体步骤将现有数据中心转变为一个可以动态响应每一个业务需求的动态的数据中心。第4章和第5章关注在物理层需要做哪些改变。第6章通过概述帮助你开始如何将现有的培训、测试和开发环境转化为虚拟基础架构。第7章、第8章和第9章帮助你实施服务器虚拟化以及将你当前的工作负载迁移到虚拟机中。第10章详细介绍如何从同时在本地和中央级别的桌面虚拟化中获益。第11章和第12章关注如何利用应用程序虚拟化来解决所有的应用程序管理问题。第12章结束本部分，关注如何将服务器、台式机和应用程序的虚拟化融合到一起，创建动态的虚拟桌面，以帮助减少大量的桌面管理，这是大多数组织一直在面对的困境。
　　▲第三部分：整合优点，完成虚拟化迁移，关注一旦你正在运行一个虚拟基础架构，将如何改变数据中心的管理方法。第13章和第14章关注安全性与如何保护你最近更新的基础架构。第15章让你审查如何通过虚拟基础架构来最终解决业务连续性问题，第16章关注管理方法应该如何改变，因为你现在运行的是虚拟工作负载而不是物理机。
　　同时，这3个部分试图提出一种一致的虚拟化观点。这将帮助你与出现在IT世界中最激动人心的其中一项技术一起向前迈进。虚拟化将对你现有的数据中心产生多个方面的影响，包括：
　　▼对网络的影响；
　　■对操作的影响；
　　■对业务流程的影响；
　　▲对你的底线的影响。
　　最后一项的影响将是最有利的。虚拟化项目在IT中是难得的一项技术，因为它们在现实中可以在短时间内收回成本。然而，它们是项目，如果你想要第一次就可以正确地实施，那么它们也应该受到管理。
　　



　　作者简介
　　Danielle Ruest和Nelson Ruest是专门从事IT基础架构优化和效率研究的未来学家。他们是多本书籍的作者，包括《Microsoft Windows Server 2008：The Complete Reference》（McGraw-Hill）、《MCITP Self-Paced Training Kit（Exam 70-238）：Deploying Messaging Solutions with Microsoft Exchange Server 2007》和《MCITP Self-Paced Training Kit（Exam 70-640）：Configuring Windows Server 2008 Active Directory》（Microsoft Press），以及《Vista Deployment and Administration Bible》（Wiley and Sons）。他们的下一本书是《MCITP Self-Paced Training Kit（Exam 70-652）：Configuring Windows Server Virtualization》。
　　Danielle和Nelson已经在美国巡回演讲了2年，在多个城市举行了名为“虚拟化：五个步骤从试点到生产”的主题演讲（http://events.techtarget.com/virtualization2008），旨在帮助各种组织迁移到虚拟基础架构。他们还举办了多个关于虚拟化的全天课程，主要是在拉斯维加斯的Interop（www.interop.com）展会上。两位同时还作为多家IT刊物的自由撰稿人，并为不同的厂商（www.reso-net.com/articles.asp？m=8）编写白皮书，举办网络广播和会议（www.reso-net.com/presentation.asp？m=7）。
　　Nelson和Danielle就职于Resolutions Enterprises，这是一家专门研究IT基础架构优化的咨询公司。Resolutions Enterprises已经经营超过20年，要了解更多的信息请登录www.Reso-Net.com。
　　



　　技术编辑简介
　　Chris Wolf是Burton集团数据中心策略部的高级分析师。他的研究涉及服务器虚拟化和数据中心整合、数据保护、管理和分类、数据恢复和业务连续性。在加入Burton集团之前，Chris是国家认可的独立顾问，主管ECPI技术学院的CIS部门，并担任CommVault Systems的顾问。他在虚拟化、数据保护和恢复、高可用性和企业存储管理方面具有14年的经验，是虚拟化领域的一位行业领先者。Chris还撰写了《Virtualization：From the Desktop to the Enterprise》一书，这是关于此类专题的第一本书。他的虚拟化演讲和专题会议在美国与欧洲一直是排名最高的。
　　Ruben Spruijt是PQR公司的解决方案架构师。PQR是一家从事设计、实施和迁移高级IT基础架构的较大的IT公司。在荷兰，PQR是微软金牌认证合作伙伴、Citrix白金解决方案顾问、VMware高级和咨询合作伙伴。在Ruben的工作中，他主要专注于应用程序和桌面分发、硬件和软件虚拟化。他是一位Citrix认证集成架构师（Citrix Integration Archilect，CCIA）、Citrix认证企业管理员（Citrix Certified Enterprise Administrator，CCEA）和微软认证系统工程师（Microsoft Certified Systems Engineer，MCSE+S）。Ruben被授予Microsoft最有价值专家（Microsofot Value Professional，MVP）、Citrix技术专家（Citrix Technology Professional，CTP）和RES软件价值专家（Res Software Value Professional，RSVP）。可以从www.virtuall.eu下载他写的一些文章。
　　Duncan Epping是荷兰一家VMware专业服务组织（Professional Senlces Organization，PSO）的高级顾问。他主要专注于服务器虚拟化。他还建立了一个博客Yellow-Bricks.com，主要涉及虚拟化的各种主题。他对各种规模的虚拟化项目有着丰富的经验，并且十分热衷于这项技术。
　　



　　致谢
　　感谢所有参加了我们课程和会议的人员，使得这本书尽可能的完整。你们的疑问对于充实本书内容有极大的帮助，大多数正在迁移到虚拟基础架构的人都会关注这些问题。此外，感谢本书提到的供应商们，感谢他们提供了坦诚的产品信息。
　　感谢我们的多位技术审查员在审查本书过程中的辛勤努力，确保本书的技术内容尽可能正确。
　　感谢McGraw-Hill给予我们机会写作这本书，使我们得以帮助世界各地的IT专业人员。此外，还要感谢制作团队，这是我参与制作的书籍中最轻松的一本。希望你们再接再厉！
　　



　　第一部分　虚拟化架构设计
　　第1章　迁移到虚拟化
　　世界各地的数据中心都正在研究虚拟化技术，以降低它们的碳足迹。它们已经厌倦了自己服务器系统的利用率只有10%或更低，并且像任何其他机器一样，需要持续耗费庞大的能源和空间，还需要不断冷却。虚拟化可以保证服务器硬件的利用率达到80%或更高，能够以更少的硬件提供相同的工作负载，从而达到降低碳足迹的目的。
　　再次指出，大多数的数据中心管理人员都会将自己遇到的这种困境归咎于Microsoft。但是，这其实不完全是Microsoft的问题——问题在于人们该如何使用Microsoft的软件产品，尤其是它们的操作系统。20世纪90年代发布的Windows NT Server让Microsoft Windows开始在数据中心中流行。那时候，Microsoft还处于劣势，正努力地将其服务器操作系统（Operating System，OS）打入企业数据中心领域。这不是开玩笑，当时有些政府的司法管辖区甚至实施具有约束力的裁决，指明Microsoft Windows在任何时候都不能用于与服务器或网络相关的工作。同样的情况也在很多公司发生。打入数据中心对于Microsoft是一场十分艰苦的战斗，但Windows是一个令人信服的产品，能够在提供网络服务的同时还支持应用程序的执行，因此没有人能抗拒。这些已成为历史。如今，大多数数据中心的服务器上都运行着各种版本的Windows。
　　但是，这些服务器怎么会只有10%甚至更低的利用率呢？这主要是Windows NT的问题。当管理员部署了这种服务器操作系统后，他们发现Windows NT其实是一种单内核操作系统。在进行了大量的操作，特别是在操作系统内核级别执行应用程序操作后，管理员很快发现当应用程序出现了冻结情况时，常常会连整个操作系统也一起冻结，这导致了整个服务器的蓝屏死机（Bule Screen Of Death，BSOD）。因此，当人们在Windows NT上部署工作负载时，开始创建单一用途的服务器。顾名思义，单一用途的服务器只会运行单个应用程序。如果发生由应用程序失效导致的服务器失效，它就不会影响到任何其他应用程序所在的服务器。这一做法很快影响到最终用户。如果商业客户想要引入新的技术以满足新业务的需求，他们首要的任务之一就是表明他们不想与任何人共享服务器工作负载，并要确保他们的应用程序不受任何其他因素的影响。这种做法迅速导致大规模的服务器增长，在项目实施时，部署新技术常常需要引入多台生产服务器，为了支持测试和开发环境还需要引入其他额外的服务器。由于这些做法开始盛行，各地数据中心很快出现了Windows和其他服务器激增的情况。
　　随着时间的推移，Microsoft通过交付日益强大的Windows服务器版本，解决了单内核操作系统的问题，但人们的习惯并没有随着操作系统的更新而改变。直到今天，最终用户客户仍然拒绝与其他人共用同一台应用程序服务器，这说明他们不信任其他应用程序的稳定性，甚至不希望因为另一个应用程序有一个与他们不同的更新计划而造成他们的服务失效。因此，管理员经常被迫部署额外的物理服务器，即使他们知道问题已经有所改善。
　　习惯并不是有这么多服务器大量增加的唯一原因。应用程序供应商也常常要求独立部署他们的应用程序，支持应用程序供应商也是原因之一。此外，安全性和新的法规要求也是应用程序独立部署的原因。在一台服务器上运行的应用程序越多，它所受的攻击面就越大。在这种情况下，管理员别无选择，他们必须隔离系统，因此会创建更多的服务器。
　　现在，Windows已不再是问题，需要改变的是人们的观念和长期以来的习惯。他们需要尽快转变观念，因为数据中心中的空间已严重不足，数量巨大的物理服务器已经令冷却系统超负荷运转，非再生资源的成本上升使得电力成本不堪重负。
　　虽然很多人在他们的数据中心运行着各式各样的操作系统，但他们运行的主要都是Windows服务器，所以他们需要考虑通过虚拟化来进行某种形式的整合。UNIX或Linux不是主要的原因，即使单一用途的服务器方案也经常涉及这些操作系统。如今，超过76%的虚拟化服务器运行着各种版本的Microsoft Windows（数据来源：Enterprise Strategy Group 2008年1月发布的简报——Microsoft将在2008年加大服务器虚拟化的力度）。你可以预期虚拟化数字的增长将成为本年度和下一年度的主流。虚拟化是一种强大的解决方案，支持任何x86服务器的转化，包括Windows、UNIX和Linux。
　　



　　1.1　了解虚拟化
　　分析师们说什么都可以，但提供IT服务确实是一项重大的工作。根据Gartner的分析报告，超过70%的IT预算花费在基础设施上，并且在许多情况下，数字还会更糟糕，尤其在整合以及/或者优化项目上。
　　这正是虚拟化可以发挥作用的地方。大多数管理员都关注到服务器虚拟化可以帮助他们减少数据中心的物理服务器。虽然将数据中心虚拟化，无论规模大小，需要做的工作都是部署一种虚拟化引擎以及转换一些物理服务器。但与任何新技术一样，管理员在期望虚拟化为他们带来益处之前，必须先要经过认真的思考和详尽的规划。在现实情况中，当你在规划部署虚拟化时，你应该先清楚了解下列问题：
　　▼什么是虚拟化？
　　■为什么我们需要虚拟化？
　　■虚拟化将如何改善我的业务？
　　■存在哪些类型的虚拟化技术？
　　■我是否清楚了解部署虚拟化所需的条件？
　　■什么是虚拟化的成本/效益比率？
　　■虚拟化会为数据中心带来哪些新的挑战
　　■我该如何构建我的虚拟化解决方案？
　　■哪些应用程序或服务适合进行虚拟化？
　　■哪些服务器平台或设备最适合用于支持虚拟化？
　　▲我还有什么没了解清楚的吗
　　以上是本书的重点：在考虑部署虚拟化以及为组织所带来的潜在效益时，有助于你先清楚了解这些问题。
　　根据Ziff-Davis在2008年2月18日发布的研究报告，有一些常见的虚拟化驱动因素（见图1-1），其中最常见的是降低硬件成本和提高服务器利用率。毫无疑问，服务器虚拟化是迁移到虚拟化的主要驱动因素，但不一定只有数据中心层才可以实现虚拟化。
　　图1-1　常见的虚拟化驱动因素
　　Enterprise Strategy Group在2008年1月发起的一项调查显示，全部341位受访者都打算在将来部署虚拟化解决方案（见图1-2），而且他们当中有70%以上打算在未来12个月内部署。同一家研究公司在2007年12月发布的另一项调查发现，在已运行着虚拟化解决方案的全部受访者（365位）当中，超过70%的解决方案选择了VMware（见图1-3）。当然，第二个调查是在Microsoft内置虚拟化解决方案Windows Server 2008 Hyper-V加入市场之前发布的。如今，这些结果可能会有所不同，但有一点可以肯定：世界上的每一个数据中心将在未来的5年内运用虚拟化解决方案。无论你使用哪种形式的x86或x64技术，虚拟化肯定是你的未来。
　　图1-2　采用服务器虚拟化的规划
　　数据来源：ESG调查报告：服务器虚拟化对存储的影响，2007年
　　图1-3　主要的服务器虚拟化解决方案
　　数据来源：ESG调查报告：服务器虚拟化对存储的影响，2007年
　　首先要做的是对数据中心虚拟化的固有概念进行充分的了解，了解从现在开始虚拟化对你的意义。
　　1.1.1　在你开始之前
　　随着能源成本的不断上升，越来越多的组织认为有必要迁移到一种可以减少空间用量，减少能源消耗量，减少需要冷却的物理服务器数量的、更环保的数据中心。正如前面所提到的，这些可以通过在数据中心内的服务器、工作站和应用程序等级上使用虚拟化技术来实现。把运行效率只有10%的物理服务器转变成一个虚拟机，其益处远远大于其缺点。
　　电力和公用事业公司也看到了硬件虚拟化的益处，因为它们的客户可以大大地减少它们的电力和冷却的消耗比率，确保当前发电设施可以维持更长的时间，解决更大的社区用户的需求。这就是为什么很多电力公司已经为组织实施虚拟化项目以及将物理服务器从数据中心移除制订了折扣计划。第一个这样做的是加州的太平洋天然气和电气公司（Pacific Gas & Electric，PG & E），该公司在2006年11月8日推出的一项折扣计划让实施服务器虚拟化项目的组织的每个站点可以节省高达4000000美元。每台服务器的奖励范围从150美元到300美元，计划的最高上限为项目总成本的50%。PG & E与虚拟化厂商VMware公司一起倡导了这项计划。
　　注意：要了解PG & E折扣计划，请参阅www.pge.com/about/news/ediarelations/newsreleas-es/q4＿2006/061108.shtml。关于PG & E折扣计划的详细信息，请参阅www.ge.com/my-business/energysavingsrebates/incentivesbyindustry/hightech/hteeincentives.shtml。
　　目前，PG & E并不是唯一的提供这样折扣的公用事业公司。实际上，折扣可以有许多不同的来源，包括联邦政府、州政府和市政府以及公用事业公司。一个很好的节能折扣信息来源是Good to Be Green网站。此网站包含面向Web的美国地图（见图1-4）。若要查找你所在地区的折扣，只需点击你所在的州，然后深入了解可能适用于你的折扣计划。
　　图1-4　Good to Be Green面向Web的美国折扣计划地图
　　注意：要访问Good to Be Green的美国地图，请访问www.goodtobegreen.com/financialin-centives.aspx#nc。
　　如果你发现所在的地区没有提供虚拟化折扣计划，那么你可以联合虚拟化供应商和公用事业公司一起制订一个相关的计划。大多数公用事业公司都迫切需要降低数据中心的能耗水平，他们将非常乐意创建这样一个折扣计划。因为，他们在这方面也有利益关系。公用事业组织希望确保位于他们电网中的数据中心客户保持使用其电网。另外，他们希望能够最有效地使用他们提供和管理的能源。因此对他们来说，让组织都留在他们的电网中和更有效地使用能源具有双重经济意义。
　　但是，无论你是与公用事业公司合作创建一个计划，还是依靠现有的计划，你将发现在你开始虚拟化项目之前，必须先申请此计划。有以下几种原因：
　　▼在虚拟化项目开始之前，公用事业公司必须进行电力消耗分析。这将确定在传统的消耗方式下如何使用数据中心的电力。
　　■公用事业公司将对虚拟化后可能的电力消耗减少进行初步的分析，并以此作为项目继续进行的基准。
　　■执行虚拟化项目，并将物理服务器转换为虚拟机，降低电力消耗水平。
　　■在项目后进行评估。
　　▲将项目后评估与初始的基准进行比较，确定新的电力消耗水平。调整原始基准和最终结果之间的差异，并确定将提供给该项目的最终折扣。
　　基于以上原因，必须在项目开始之前，先联系你的公用事业公司；否则，他们将无法确定以前的消耗率，无法确定你在能源节省计划中受到的潜在益处。
　　1.1.1.1　购买绿色技术
　　当然，当转换数据中心，将大部分的物理系统转换为虚拟机时，很可能需要在基础架构中更换一些硬件组件。由于执行这个项目的主要原因之一是减少数据中心的碳足迹，你应该继续本着这种精神，并使其成为数据中心的基本原则之一。绿化数据中心意味着不仅仅是需要降低其中包含的物理服务器数量，还意味着要推动绿色的政策和实践。最好的方法之一是采取行动支持购买新的硬件。
　　另一个关注绿色IT技术的网站是电子产品环境评估工具（www.EPEAT.net），感谢由美国环境保护署（Environmental Protection Agency，EPA）经过为期2年的努力研究提供的首批工具。EPEAT制定了一套准则，帮助测定信息技术设备对环境的影响。准则划分为3种遵从标准：
　　铜牌、银牌和金牌。产品基于遵从以下条件所定的标准类别：
　　铜牌产品满足所有要求的标准。
　　银牌产品满足所有要求的标准，并且符合可选标准的50%。
　　金牌产品满足所有要求的标准和所有可选的标准。
　　EPEAT在其网站上维护核准设备的清单（见图1-5），除了为设备购买者提供一系列的资源——诸如支持招标方案（Request For Proposal，RFP）标准的创建，规范RFP的使用，以及为采购过程提供帮助。
　　图1-5　EPEAT注册产品搜索工具持续地更新达到铜牌、银牌或金牌标准的新产品
　　注意：要了解更多有关EPEAT的详细信息，请访问www.epeat.net/Criteria.aspx。
　　依据EPEAT标准购买绿色硬件以补充虚拟化项目，因为这可以进一步帮助你减少长期的电力消耗比率。
　　1.1.1.2　绿色资产处置
　　虚拟化项目的另一个“绿色”方面是如何处理多余的设备。当你通过你的项目以虚拟机取代现有的物理系统时，你需要找到处理那些不再需要的机器的方法。在许多情况下，你会发现你裁减出来的硬件很多都可以重新使用。但是，如果你的虚拟化项目的目的是降低你的碳足迹，那么重新使用更换出来的所有设备是毫无意义的。此外，你还必须找到从系统中安全地清除信息和知识财产的方法，然后你才能完全地摆脱这些多余的设备。大多数组织对于已经过时硬件都制订了安全信息保护计划，但很少有组织制定绿色资产处置程序。
　　针对迈向绿色技术产生的需求，已经制定了新的服务以帮助组织实现2个目标：安全资产处置，同时减低处置过程本身的碳足迹。只需在因特网上简单搜索就会找到多家同时提供绿色和安全处置的服务公司，但最受欢迎的服务之一是Green Asset Disposal（www.greenassetdisposal.com），这家公司专门从事这种类型的系统处置。Green Asset Disposal将回收、转售甚至购买你需要处置的资产。他们提供上门回收服务以方便你的处置，还为你提供如何妥善弃置的技术信息，范围从服务器、个人计算机以及其他过时的IT设备。
　　如果你重视环境保护，请确保你是依据绿色处置程序，以获取最大的环保效果。
　　



　　1.2　使用五步过程
　　像其他IT项目一样，虚拟化项目必须条理清晰。在过去的10年中，Resolutions Enterprises和本书的作者制定了一套虚拟化迁移战略。这一战略已经过通过了众多交付项目的考验，并在整个美国和加拿大进行了一系列的演示。举办了2次在多个城市进行的巡回演示，一次主题为2007年的服务器整合、一次主题为2008年的虚拟化以及关于该主题的多个全天课程。在每次的演示中，与会者和客户组织都发现这一战略是健全和直接的，迁移到虚拟化对他们自己是极其有用的。
　　根据Resolutions，迁移到虚拟化依赖于5个主要的步骤：
　　1.发现，第一步着手在数据中心编制详细清单和确定潜在的虚拟化候选服务。
　　2.虚拟化，第二步的重点是获取对虚拟化价值选择的全面认识。
　　3.硬件最大化，第三步的重点是硬件恢复和当添加新硬件或替换旧的系统时，应该如何制定合理的投入。
　　4.体系结构，第四步是研究体系结构，必须准备好正确地将虚拟化技术引入数据中心的业务中。
　　5.管理虚拟化，第五步的重点是管理工具的更新，在新的动态数据中心中，使用此工具来维护完整的虚拟化方案。
　　这些模块的每个部分将带你一步一步地完成一个完整的虚拟化解决方案。
　　虚拟化不仅仅是简单地在服务器上加载一种虚拟化技术和转换一个或2个工作负载到虚拟机中。为了充分利用虚拟化项目，你必须学会如何将不同的虚拟化解决方案结合在一起，了解每个供应商提供的方案和实际需要实施的方案，以便在数据中心中充分利用虚拟化技术，解决你的业务需求。Resolutions五步过程将大大有助于这项工作。
　　



　　第2章　开始五步过程
　　第1章介绍了Resolutions的五步过程。此过程有助于你了解虚拟化可以为你的组织提供的价值定位。第一步是发现，让你识别组织的网络中有些什么，并为你提供一个视图来分析它该如何进行转换。第二步是虚拟化，从引入各种虚拟化技术作为开始，并引导你全面了解如何将它们整合到一起创以建动态的数据中心。
　　



　　2.1　第一步：发现
　　在多城市巡回演讲期间，我们已经能够确认IT管理员不喜欢编列财产清单。没错，在成千上万参与了我们巡回演讲的人中，平均约有15%的人持有最新的财产清单。但是，当你和IT打交道时，财产清单是绝对必需的。如果你自己都不清楚你拥有什么，那么你该如何进行管理？如果你都不清楚在你的网络中有多少台服务器正在运行、它们的作用是什么，那么你如何可以迁移到虚拟化？
　　我们都知道，大多数IT管理员研究服务器虚拟化的原因是由于数据中心的空间紧缺。今天的数据中心已经没有更多的空间了。添加更多的服务器总是需要更多电力输入和更多的冷却系统。升级数据中心是昂贵的。如果你实际上不需要它们，为什么要与它们向前迈进？
　　此外，物理服务器是难以预备的。人们使用Windows服务器来运行各种技术，从磁盘镜像到Windows部署服务（Windows Deployment Services，WDS），以尝试减少一台物理服务器的开销。当服务器终于置备好，你会发现购置成本非常高，整套硬件集合运行只有不到15%的利用率。更糟糕的是，当为了要保护系统和应用程序从灾难中恢复运行，必须包含一套昂贵的业务连续性解决方案——将此服务器中包含的数据复制到远程站点的镜像装置中。试问有多少组织能负担得起这笔昂贵的费用？但是，我们知道80%以上的组织所遭受的彻底的IT故障将无法恢复并将破产。这种运行方式带有明显的风险。
　　个人计算机也是一个问题。多个组织想要花点时间将它们的系统升级到新版本的操作系统。看看Vista发生了什么事就好了。在我们巡回演讲的所有与会者中，超过90%的人还没有迁移到Vista，而且没有打算这样做。每个人都在等待下一个版本的操作系统（OS）。此外，我们的与会者中超过75%的人让他们的用户以管理员权限运行个人计算机。难怪他们的工作站和移动系统会有无尽的问题。这些与个人计算机相关的问题，由于其本身的性质，是十分复杂的。个人计算机分布在整个组织中，在每一个站点中、在每一个位置中、在路上、甚至在雇员的家中。这使得管理员更加难以管理和维护。
　　应用程序也有相同的问题。无论IT管理员或应用程序开发人员如何想办法避免它们，应用程序冲突还总是不断发生。Microsoft发布了Windows Installer（Windows安装程序）服务来保护系统免受应用程序更改的影响，但创建Windows安装程序文件是一个复杂的过程，需要大量时间和金钱。但是，最糟糕的是每个人都依赖部署模型：当涉及系统修复或者甚至许可管理时，推送大量的数据到组织中来的所有终端绝对不是最佳的做法。必须有一个更好的方法，并且当前就要有。
　　2.1.1　编制财产清单的重要性
　　有那么多的组织不清楚它们基础架构的内容是什么，这真是太惊人了。然而，这对于虚拟化项目却是最重要的步骤。了解你的网络的内容可以帮助你维护它，控制它的增长。如果你不知道有些什么设备，你如何确定你可以保护它和管理它，或者更糟糕的是将它转换为动态数据中心？
　　不想花时间和精力购买一个编制财产清单的产品，然后将其部署？没有时间准备一份财产清单？不用担心。生成网络设备财产清单的最简单的方法是使用免费工具。例如，许多人使用Microsoft基准安全分析器（Microsoft Baseline Security Analyzer，MBSA）扫描网络的安全漏洞和所需的更新。MBSA很容易在你的基础架构中所有的系统上安装和运行。一旦扫描完成，MBSA向你提供它扫描过的每个系统的信息：Internet协议（IP）地址、操作系统、已安装的应用程序，当然还有漏洞。通过Microsoft Visio Connector for MBSA可以将MBSA扫描的结果与Microsoft Visio联系起来，你就可以轻易地将这些有价值的数据转变为一份财产清单。Visio能自动生成一个关于你的网络的图形化图像，当你点击它时（见图2-1），会显示每个设备详细的信息。有了这些工具，你可以在短时间内生成你的第一份财产清单！你将会对你的发现感到惊讶。
　　图2-1　使用Microsoft Visio Connector for MBSA
　　注意：想要了解更多关于MBSA的详细信息，请访问http://technet.microsoft.com/en-us/secu-rity/cc184925aspx.aspx。要下载Visio Connector for MBSA，请访问www.microsoft.com/downloads/details.aspx？FamilyID=8EA27D78-32B5-4F37-A7FD-99EE2AA76C62 & display-lang=en。
　　注意：Microsoft还为System Center Operations Manager（SCOM）提供了Visio Connector。可以使用SCOM为你的网络创建视图。要下载SCOM Visio Connector，请访问http://technet.microsoft.com/en-us/security/cc184925.aspx。
　　2.1.2　扫描潜在的虚拟化候选者
　　MBSA不是唯一的用来执行初步分析的免费工具。Microsoft还提供了Microsoft评估和规划（Microsoft Assessment and Plan，MAP）工具包解决方案加速器。MAP是一种可以用来扫描你的整个网络的评估工具。它以前是作为Windows Vista的硬件评估工具发布的，目的是让组织能够扫描其现有的个人计算机，以确定其承载Vista操作系统的潜力。Microsoft很快就意识到了2件事情。第一，没有人迁移到Vista。第二，如果这个工具可以扫描Vista的硬件需求，那么它也可以扫描各种不同的评估。因此，Microsoft对这个工具进行了改变和调整，以支持全系列的其他业务。
　　注意：想要访问MAP，请访问www.microsoft.com/downloads/details.aspx？familyid=67240b76-3148-4e49-943d-4d9ea7f77730 & displaylang=en。
　　MAP是一个无代理的分析器，可以收集所有已识别系统的信息。它主要是在Windows系统上工作，并需要使用在每台目标计算机上都具有管理权限的账户。MAP可以从任何的系统运行，但最好是安装在管理工作站上。通过Windows安装程序文件执行安装。有2个文件可供选择：一个用于x86或32位系统，另一个用于x64或64位系统。一旦完成安装，MAP将依赖Windows管理规范（Windows Management Instrumentation，WMI）、远程注册表服务，或简单网络管理协议（Simple Network Management Protocol，SNMP）识别你的网络上的系统。在MAP中包含的评估包含了以下内容（见图2-2）：
　　图2-2　使用MAP执行系统评估
　　▼数据库系统，可以迁移到SQL Server 2008
　　■系统和服务，可迁移到Microsoft联机服务（主要为小型企业或远程办公室）
　　■环境，可以从网络访问保护（NAP）中受益或者使用Forefront安全技术，以及一般安全报告
　　■节电建议，以降低数据中心的能耗
　　■可以运行Vista with Service Pack 1的系统
　　■可以运行Microsoft Office 2007的系统
　　■可以运行Windows Server 2008的系统
　　■服务器角色，可以迁移到相应的Windows Server 2008角色
　　■服务器或工作站的性能
　　■通过Microsoft Hyper-V和Windows Server 2008提供的虚拟化进行服务器整合
　　■应用程序，可以通过Microsoft Application Virtualization（微软应用虚拟化）进行虚拟化
　　▲潜在优化桌面方案
　　每个评估都会提供一份基于评估目的的一系列的全面报告。
　　默认报告是英文的，但可以本地化设置为法语、德语、日语、朝鲜语、西班牙语和葡萄牙语。报告的细节将取决于使用MAP运行的报告类型。例如，运行为Windows Server 2008准备的MAP报告将包括有关核准驱动程序和所需的硬件更新的详细信息。服务器虚拟化报告将确定当前的工作负载和虚拟化的潜在候选者（见图2-3）。
　　图2-3　查看MAP报告
　　注意：Microsoft正在不断地改进MAP。当你读到这本书的时候，它可能提供了更多可用的报告。
　　Microsoft并不是唯一提供系统评估解决方案的厂商。VMware——x86虚拟化的奠基者也提供了2个用于评估服务器是否可以转换为虚拟机的工具。对于所有用户来说第一个也是最容易获得的工具是VMware Guided Consolidation（VGC）。VGC可作为VMware VirtualCenter的一个组成部分（见图2-4），管理界面用于控制物理硬件和在VMware上运行的虚拟机。VGC通过3个主要步骤来执行分析：
　　1.第一，它依赖于一个无代理的基础架构，发现存在的计算机并从它们那里收集性能信息。
　　2.第二，分析收集的数据，看看是否适合进行硬件整合，并推荐一个潜在的整合计划。
　　3.第三，它允许你通过VMware Converter将主机由物理转换到虚拟（Physical to Virtual，P2V）装置。
　　VGC是一个强大的工具，适用于小于100台物理服务器的网络。虽然可以在实时网络上执行分析，而且影响甚微——由于引擎是无代理的，它不会增加生产服务器工作负载的开销——但整合应该首先在实验室进行测试，因为它是任何虚拟化项目中最复杂的部分。如果可能，应该在服务器处于脱机状态的时候执行你的转换以保护现有的服务，与最终用户一起维护你服务级别协议（SLA）。
　　图2-4　使用VMware的Guided Consolidation（导向整合）引擎
　　通过下载VMware VirtualCenter评估版本可以获得VMware Guided Consolidation。评估可以持续60天，因为它会给你足够的时间来正确地分析你的网络。
　　注意：VMware VirtualCenter是VMware Infrastructure的一部分。要获得VirtualCenter的试用版本，请访问www.vmware.com/download/。运行这个工具需要一个评估序列号。一旦你在网站上完成注册，你就会收到它。
　　对于超过100台服务器的网络，可以利用VMware的Capacity Planner（容量规划器）分析你的服务器资源。遗憾的是，虽然可以免费使用Capacity Planner，但最终用户却不容易获得此工具。为了使用另一种无代理的工具Capacity Planner执行扫描，你必须与VMware Professional Services签订合约，或者通过咨询合作伙伴来执行分析。大多数情况下分析本身是免费的，它将为你提供关于可以进行整合的服务器的多方面的信息。
　　Capacity Planner将为你提供关于服务器处理器利用率的报告（见图2-5），以及一份标识虚拟化潜在候选者的全面的报告。分析结果包括CPU、内存、网络和基于服务器的服务器磁盘利用率。
　　图2-5　使用VMware的Capacity Planner工具
　　然而，像许多人一样，你可能会担心经销商使用Capacity Planner的时候会存在厂商偏见。如果出现这种情况，你可能宁愿依靠CiRBA的Data Center Intelligence或PlateSpin的PowerRecon工具，因为它们可以模仿多种虚拟化环境。此外，CiRBA的工具还可以在许多不同的服务器平台上执行假设分析，以此为虚拟化项目确定最佳的目标平台，而PlateSpin还将在分析中包括减少电力消耗的选项。
　　注意：要了解更多关于CiRBA的Data Center Intelligence工具的详细信息，请访问www.cirba.com。要了解更多PlateSpin PowerRecon的详细信息，可在下列地址找到www.platespin.com/products/powerrecon/。你可以下载PowerRecon的免费版，它将支持最多100台服务器的分析。
　　与在这里提到的其他工具不同的是，CiRBA的工具还可以考虑非技术性因素对整合的影响。例如，网站、部门、安全区域限制、维护窗口和服务级别要求都会对确定最终的整合计划产生影响。不过，这个工具收集的性能数据并不能说明整合项目中的任何非技术性元素。分析并不包括此项信息，你必须手动对其说明。使用像CiRBA这样的工具会让你把这些元素包括到你的计算中，并提供你需要的更好的整体视图。
　　另一方面，PowerRecon可以每次监控高达2000台服务器，并且如果将此工具的商业版本与PlateSpin PowerConvert结合，一旦完成分析，它能够自动完成转换过程。
　　还有很多其他的工具，但最常见的是MAP、VGC、Capacity Planner、CiRBA和PlateSpin的工具。请记住，无论你使用哪一种工具，你必须在一段时间内持续运行分析。目的是确定那些正在运行的系统，当它们需要资源的时候，它们需要多少资源，资源在什么时候处于低阈值，什么时候达到最高峰。基于这个原因，你应该进行至少一个月的分析。这段时间内进行的分析，至少将为你提供每台服务器在一个月的周期内的高和低的利用率情况。分析将不能确定较长周期的峰值和低点，例如，应用程序基于每季或每半年的利用率峰值。当你在查看分析结果时，请记住这一点。
　　注意：在此分析过程中要非常小心，因为它将构成你未来的基础架构的基础。正确识别每台服务器工作负载所需的资源，将使你正确地估量一旦你将这些工作负载迁移到虚拟化所需的硬件资源。当执行虚拟化候选者分析时，你再怎么仔细也不为过，因为一旦虚拟化你的系统，这些工作负载的物理资源需求信息将不再可用。
　　你还要让你的分析时间尽量接近实施时间。在实施前的几个星期对环境进行重新分析总是一个很好的做法。如果执行分析的时间和你推进项目的时间之间有很大的差距，那么你可能会发现在较早前的分析中并没有捕获新的应用程序需求，而且将会完全错过。
　　2.1.3　对服务器资源进行分类
　　一旦获得分析的结果，就可以针对每个机器角色按组进行分类。例如，可以按照以下的服务类型来确定服务器的角色或功能：
　　▼网络基础架构和物理服务器　这些服务器提供核心网络功能，如IP寻址或名字解析，包括对旧式系统的支持。它们还提供虚拟专用网络（Virtual Private Network，VPN）和路由与远程访问服务。而且，因为它们是底层服务，所以它们将成为物理机器上的虚拟化角色。
　　■身份管理服务器　这些服务器是网络的核心身份管理人员。它们为所有用户和通过轻型目前访问协议（LDAP）服务的用户访问包含与维护整个企业的身份数据库。在Windows Server 2008中，这些功能由运行Active Directory Domain Services（活动目录域服务）的服务器提供。这个功能应该尽量不要与其他服务器共享，除非它是核心的网络功能，如通过域名系统（Domain Name System，DNS）进行名字解析。
　　■文件和打印服务器　这些服务器主要为网络提供存储和结构化文档服务。这些功能在生产力网络内构成了信息共享的基础。
　　■应用程序服务器　这些服务器为用户社区提供应用程序服务。如Exchange Server、SQL Server等——实际上是在生产力网络中运行的任何服务。
　　■终端服务器　这些服务器为用户提供了一个集中的应用程序执行环境。用户只需要有一个最小的基础架构，以访问这些服务器，因为它们的整个执行环境驻留在服务器本身。
　　■专用的Web服务器　这些服务器主要为用户社区提供Web服务。例如，在Windows Server中，Web Edition（网络版）是专门设计来满足这些需求。
　　▲协作服务器　这些服务器为企业内部的协同运作提供基础架构。这些服务的例子包括Windows SharePoint服务、流媒体服务和统一通信服务。
　　服务器可以根据其位置和服务器类型进一步分类。例如，在总部数据中心中使用的服务器与在远程办公室中使用的那些服务器不会是相同的类型。此外，如果你使用塔式、机架式或刀片服务器，你应该在分析中标识出来。应用程序或工作负载可以进一步分为以下几个组：
　　▼商业与公司内部或者自定义的应用程序
　　■旧有与更新
　　■基础架构应用程序
　　■支持业务
　　■行业应用（LOB）
　　▲关键的应用程序
　　当你迁移到虚拟化时，这些应用程序的每一个类别将会非常有用。
　　2.1.4　使一切合理化
　　当你完成系统评估后，一切准备就绪，你将准备向虚拟化迁移。然而，重要的是你要能区分服务器和物理整合之间的不同。服务器整合意味着可以在你的数据中心内减少服务器的数量，创建更强大的服务器以承载多个工作负载。但在大多数情况下，执行虚拟化项目的组织将不会执行服务器整合；他们将执行物理整合。参考下面的例子。
　　组织A有100台物理服务器。在进行多方面的分析，并选择了要使用的虚拟化引擎后，组织A确定它们可以将每一个现有的工作负载转换成一台虚拟机。为了这样做，它们必须使用10台物理机器来运行100个虚拟化工作负载。结果呢？却变成了110台服务器。所以，这不是一个服务器整合项目。它是一个物理整合项目。当然，组织A将从迁移到虚拟化中受益，因为它们少了90台物理机器需要管理，但它们的管理员的工作量不会减少，因为它们现在比以前要多管理10台服务器。
　　这就是为什么合理化是任何虚拟化项目最重要的方面。当你完成了虚拟化项目，你的目标应该是比你开始的时候拥有更少的物理服务器，并且这应该包括你创建的需要用于运行虚拟机的物理服务器。当你迁移到新的虚拟化基础架构时，将没有更好的时间来执行服务或工作负载的整合或合理化。当查看你的分析结果时，请牢记下列问题：
　　▼每台机器的利用率是多少？
　　■有“已停机”的机器吗——机器属于特定的用户群组，但没有被经常使用？
　　■有已过时的机器吗？
　　■有方法来合并工作负载吗？
　　▲有其他的方法减少机器占用的空间吗？
　　如何恰当地处理这些问题，将决定一旦完成你的项目，究竟多少台机器将会被留下。
　　



　　2.2　第二步：虚拟化
　　当你收集了有关系统的信息，你可以转到第二步，并开始了解不同的虚拟化技术以及它们可以如何帮助你解决组织中特定的业务问题。第一步可能就是虚拟化本身。根据韦氏在线字典（www.merriam-webster.com/home.htm）的解释，虚拟现实是“通过由电脑提供的感官刺激（例如视觉和听觉），使用户产生一种人工环境的体验，并且在这人工环境中，用户的行动部分地由该环境中所发生的事情所决定”。这正是虚拟化要做的事：虚拟机软件在一台真正的物理系统上创建一个或多个虚拟工作站或服务器（见图2-6）。一切都取决于在真正的物理机上可用的资源：硬盘空间、处理器性能、网络接口卡以及大量的随机访问存储器（RAM）。使用虚拟化软件创建的虚拟机，可以支持任意数量操作系统的安装和操作，包括所有版本的Microsoft Windows、MSDOS、Linux，某种形式的UNIX等——基本上任何基于x86的操作系统，甚至那些运行在x64扩展上的平台。它们可以与物理主机和网络上的其他机器进行通信，觉得它们自己就是一台真正的机器。
　　图2-6　在VMware Workstation中使用虚拟机
　　物理机分区在20世纪60年代已经出现，当时IBM开始对其大型机服务器进行分区，以承载多个操作系统实例。在这种情况下，分区技术被用来运行多个或者说是平行的相同的操作系统实例。虽然IBM发明了系统分区，但直到20世纪90年代这种类型的分区才被引入x86处理器结构中。也正是在这个时候，物理系统分区被重命名为虚拟化。这种虚拟化的类型首先被用于让最终用户可以在其他平台（如苹果Macintosh）上运行操作系统（如Windows）。事实上，Microsoft在2003年收购了法国公司Connectix，这家公司专门设计在Macintosh计算机上运行Windows操作系统的“虚拟机”软件，允许Macintosh用户访问Windows平台上成千上万可用的应用程序。这开启了Microsoft在机器虚拟化世界的战斗。
　　当然，Microsoft已经来晚了，因为VMware公司在20世纪90年代末以来就一直致力于机器虚拟化的研究，通过推行VMware Workstation这款针对最终用户的产品，目的是让用户可以在x86操作系统上运行任意数量的其他实例。VMware然后认识到虚拟化的威力，并将它迁移到服务器级别，今天我们看到机器虚拟化开始了大规模的繁荣。现在，VMware是虚拟化市场的领导者，并为数据中心提供了最广泛的虚拟化解决方案。
　　最后，IBM发明的机器分区与Xerox发明的鼠标和图形用户界面遇到的情形很相似。Xerox多年前在其帕洛阿尔托研究中心（PARC）发明了这些技术，但将它们普及的却是Apple公司，而不是Xerox公司，Apple公司因为这2个工具获得了好的名声。今天，很多人都认为这2种发明源于Apple公司，但实际上Apple公司只是借用了现有的创新并将它们重新包装成一种外形设计，这样就拥有了广泛的吸引力。同样的情况发生在VMware与IBM首创的系统分区技术之间。虽然IBM推出了原创的构思，但却是VMware以这样一种方式将此构思付诸实施，并使它迅速普及起来，并且现在它已拥有数10亿美元的产业。VMware成功的关键与IBM不同，VMware的虚拟化技术允许运行各种不同的操作系统。此外，它允许在低价位的商用硬件上运行它们，并将这项技术置入任何IT部门的范围内。
　　对于需要创建、设置和重复使用机器运行所有操作系统的人来说，能够在单台物理机之上运行多个虚拟机，这一技术确实令人兴奋。这就是类似于VMware的虚拟化技术所带来的最佳价值。
　　2.2.1　定义虚拟化
　　如今，虚拟化技术已经有了很大的发展，现在可以适用于数据中心内的多个层次。这就是为什么一定要充分了解有哪些类型的虚拟化。在一个动态数据中心内——要充分利用虚拟化的价值主张——有最少7层的虚拟化（见图2-7）。
　　图2-7　虚拟化的7个方面
　　▼服务器虚拟化（SerV）的重点是将一个操作系统的物理实例分割到虚拟实例或虚拟机中。真正的服务器虚拟化产品会让你虚拟任何x86或x64的操作系统，例如Windows、Linux和某些形式的UNIX。服务器虚拟化有2个方面：
　　■软件虚拟化（SoftV），在一个软件虚拟化平台上运行虚拟化操作系统，这个软件虚拟化平台运行在一个现有的操作系统上。
　　■硬件虚拟化（HardV），在一个软件虚拟化平台上运行虚拟化操作系统，这个软件虚拟化平台直接运行在一个没有现有操作系统的硬件上。用来运行硬件虚拟化的引擎通常称为hypervisor。这个引擎的目的是将硬件资源暴露给虚拟化操作系统。
　　当使用服务器虚拟化时，物理服务器将成为所有虚拟操作系统或虚拟机（VM）的主机，工作负载将运行在此主机之上。
　　■存储虚拟化（StoreV）　用于从多个设备中合并物理存储，以使其表现为一个单一的存储池。在此池中的存储可以有多种形式：直接连接存储（Direct Attached Storage，DAS）、网络连接存储（Network Attached Storage，NAS）或者存储区域网络（Storage Area Net-work，SAN）；它可以通过多种协议进行链接：光纤通道、因特网SCSI（iSCSI）、基于以太网的光纤通道或者网络文件系统（Network File System，NFS）。虽然存储虚拟化不是服务器虚拟化的必要条件，你能够从存储虚拟化中获得的主要优势之一是可以依靠自动精简配置或者为存储分配一个特定大小的逻辑单元（Logical Unit，LUN），但只会按需调配。例如，如果创建了一个100吉字节（GB）的LUN，并且只使用了12GB，那么只需调配12GB的实际存储。这显著地降低了存储的成本，因为只需要为使用的实际存储来付费（见图2-8）。
　　图2-8　通过存储虚拟化使用自动精简配置可以显著地降低存储成本
　　■网络虚拟化（NetV）　让你通过将带宽分割成独立的通道来控制可用带宽，分配给特定的资源。例如，网络虚拟化最简单的形式是虚拟局域网（Virtual Local Area Network，VLAN），它创建一个物理网络上的逻辑隔离。此外，服务器虚拟化产品本身就支持虚拟网络层的创建。例如，使用虚拟网络层可以让你像其他生产虚拟工作负载一样在的同一台主机上放置一个外围网络，而不会影响网络或者让虚拟机之间互相访问。
　　■管理虚拟化（ManageV）　关注管理整个数据中心的物理机和虚拟机的技术，为提供的服务提出一个单一的统一的基础架构。ManageV不一定是通过单一界面执行。例如，在大型的数据中心，你会将不同的服务交付划分到不同的层次中并分离它们之间的操作。在较小的数据中心，可能没有进行工作人员的职责划分，但当他们使用你的体系结构的各个层次时，你应至少确保管理员具备相关的技能。实际上，你应该确保2个关键层在任何时候都是隔离的：
　　■资源池（Resource Pool，RP），它包括硬件资源的集合——主机服务器、机架、机箱、存储以及网络硬件——这些构成了数据中心的基础架构
　　■虚拟服务或产品（VSO），或者是虚拟机构成的工作负载——服务器或台式机——这是面向客户端的和为最终用户提供的服务
　　在此隔离中一个关键的因素是在资源池和VSO之间创建不同的安全上下文。由于管理团队是不一样的，他们具有不相同的责任——资源池管理员必须确保为VSO提供适当的可用资源，而VSO管理员必须确保为最终用户提供适当的服务——通过使用两者之间完全不同的安全上下文，限制了从虚拟世界感染物理世界的可能性。
　　例如，物理层应使用强密码，并确保管理控制台和物理主机之间所有的通信在任何时候都是加密的，因为密码会在这些连接中传送。虚拟层也应该使用这些原则，但此外，为用户提供的安全上下文将不会依赖于这些严格的策略。
　　在某些情况下，物理和虚拟层的隔离是自动执行的。在VSO中运行一个Windows基础架构，但在资源池中却使用一个非Windows的hypervisor时，将发生这种情况。如果在这2个层中使用相同的操作系统，请确保在两者之间创建单独的安全上下文。
　　■桌面虚拟化（DeskV）　允许你可以依靠虚拟机来提供桌面系统。桌面虚拟化有多个优点，其中之一就是能够集中桌面部署并降低分布式管理的成本，因为用户是通过各种瘦客户端或非托管设备访问集中式桌面。
　　注意：在2008年年底，VMware从一家名为Trango Virtual Processors的公司收购了技术，主要是为了使虚拟化技术超出桌面的范围迁移到手机上。VMware的移动虚拟化平台（Mobile Virtualization Platform，MVP）的目的是在手机上创建一个虚拟层，让你在同一个手机上运行多个移动系统。例如，你可以运行一个平台用于工作，另一个用于个人使用。此外，通过虚拟化手机，VMware的MVP将让你可以更方便地把你的个人设置从一部电话移到另一部电话。自2009以来，一直都在关注MVP的更多信息。
　　■表现层虚拟化（PresentV）　直到最近还称为终端服务，从一个中央位置向用户仅提供表现层。虽然，像应用程序虚拟化技术的引入，PresentV的需求正在逐步减少，但PresentV所使用的协议是在DeskV和SerV技术的前端，因为它们使用协议来访问、使用和管理虚拟工作负载。
　　▲应用程序虚拟化（AppV）　与基于软件的SerV一样使用相同的准则，但不提供引擎运行操作系统，AppV将生产力应用程序从操作系统中分离出来。AppV转变了分布式应用程序管理的模式，因为只需要虚拟化应用程序一次。从那时起，应用程序虚拟化引擎将使虚拟化应用程序运行在任何版本的Windows之上。更好的产品，如Acresso软件公司的AdminStudio（www.acresso.com/products/licensing/adminstudio.htm）将所有你已经打包的以MSI格式运行Windows Installer服务的应用程序，通过一个批处理在一夜之间将它们转换为AppV格式。AdminStudio同时支持Citrix和VMware的AppV格式。将应用程序转换为AppV格式，你就永远不需要再去触碰它们！工作也会由主要的AppV厂商来开展，如Microsoft、Citrix、InstallFree、Symantec和VMware为应用程序服务申请AppV。虽然AppV现在只能工作在32位平台上，但使其可以工作在64位或x64平台上的工作也正在开展。当这本书出版的时候，基于服务器的AppV和x64的AppV可能已经可以使用。
　　注意：也可以使用某些Solaris和Linux的应用程序来成功创建应用程序虚拟化部署。厂商，如Data Synapse、Trigence和Transitive在Linux与Solaris的应用程序上利用应用程序虚拟化技术已经取得了一些成功，特别是在金融业中。
　　虽然虚拟化有7层，但在数据中心中还有其他的关键术语一起组成虚拟化的语言。这些包括：
　　▼主机服务器　运行虚拟机工作负载的物理服务器。
　　■客户操作系统　在主机服务器上作为工作负载运行的一个被虚拟化的操作系统。
　　■资源池　硬件资源的集合，包括构成数据中心基础架构的主机服务器。
　　■虚拟服务或产品　面向客户端的虚拟机，并为最终用户提供服务。它们还经常被称为虚拟工作负载。
　　■虚拟应用（VAP）　是预先封装的VSO，用于运行特定的应用程序或工作负载。
　　■基于策略的工作负载　通过自动化策略设定VSO按需启动。
　　▲操作系统虚拟化　经常被误解为客户操作系统虚拟化，其实这只不过是操作系统分区，因为它仅能以并行实例的方式运行一个单独的操作系统类型。这种“虚拟化”类型的价值是有限的，因为必须需要运行特定的操作系统。这种类型的产品包括Solaris Container和Parallels Virtuozzo Container，这些容器运行Virtuozzo操作系统——一个Linux版本——在并行模式中。
　　现在，你已经了解了最关键的术语，下面分别深入探讨这3种核心虚拟化技术——SerV、DeskV和AppV——可以用于数据中心。
　　2.2.2　什么是虚拟机
　　正如你现在所知道的，虚拟化是一种技术，用于将计算机划分为几个独立的机器，以支持不同的操作系统和应用程序同时运行。这种技术最大的优点是对于一台利用率为10%的物理服务器，通过在其上面装载多个虚拟机，将其转换成为一台利用率为60%~80%的服务器。基础的hypervisor软件将直接在硬件上运行，并在虚拟机中作为管理多个操作系统的协调员。在这种情况下，每个操作系统实例运行在一个虚拟机中，每个运行在hypervisor上的虚拟机都是一个独立的操作环境，就像它是一台独立的计算机。
　　虚拟机是由多个不同的组件构成的（见图2-9）：
　　图2-9　包含在VMware虚拟机中的不同文件
　　▼配置文件　是一个包含了虚拟机设置信息的文件——内存的数量、处理器的数目、网络接口卡（Network Inferface Card，NIC）的数量和类型、虚拟磁盘的数量和类型。每次创建一个新的虚拟机时，同时会创建一个虚拟机配置文件，正是这个文件告诉虚拟化软件如何从主机上为虚拟机分配物理资源。此文件指出了硬盘文件的位置，使用内存的数量，如何与网卡进行交流以及使用哪种或哪些处理器。因为它只包含设置，此文件通常很小，是纯文本或XML格式。
　　■硬盘文件　通常是物理硬盘中包含的一个包含了某些信息的文件。每次创建一个虚拟机，虚拟化软件就会创建一个虚拟硬盘，正是这个文件模拟了一个典型的基于扇区的磁盘。当在虚拟机中安装操作系统时，操作系统将包含在此文件中。与物理系统一样，每个虚拟机可以有多个磁盘文件。因为它模拟了一个硬盘，所以此文件通常极为巨大，虽然所有的虚拟化引擎支持自动增长，但让系统以较小的文件容量启动，并随着新内容的添加将会扩大虚拟机的磁盘文件。硬盘文件有2种主要的类型：来自VMware的虚拟机磁盘（Virtual Machine Disk，VMDK）和来自Microsoft的虚拟硬盘（Virtual Hard Disk，VHD）。两者都使用了平面文件格式，与数据库一样每次添加信息时会不断增长。重申一遍，与数据库文件一样，可以对虚拟磁盘驱动器文件进行压缩，以恢复文件中未使用的空间。
　　注意：虚拟硬盘文件不一定会因为数据的添加而增大；默认情况下，ESX服务器使用固定大小的虚拟硬盘文件，因此一个新的16GB虚拟磁盘将从一开始就占用16GB的空间。唯一的例外是，通过命令行创建一个新的VMware虚拟磁盘时，如果使用了-thin开关。另一个例外是使用的后端阵列支持自动精简配置，例如，一个默认的VMware 16GB的虚拟磁盘可能只会占用4GB的空间。
　　■内存文件　一个包含了正在运行的虚拟机内存信息的文件。当虚拟机关闭时，其内容被提交到硬盘文件中。
　　■虚拟机状态文件　与真正的机器一样，虚拟机也支持类似于待机或休眠状态的操作模式。对虚拟化而言，这意味着需要暂停或中止以及保存计算机的状态。当暂停了一台机器，其挂起状态会保存到一个文件中。因为它只包含了机器状态，此文件通常比硬盘文件小。
　　▲其他的文件　包含了日志和其他虚拟机相关的信息的文件。
　　还有其他的文件格式支持最先进的虚拟化功能，但前面讨论的文件类型是最常见的。此外，每一种虚拟化产品都支持“可撤销”磁盘。这意味着该产品提供一种通过放弃更改将虚拟机返回到以前状态的手段。这是一个强大的功能，在测试和开发方案中非常有用，甚至可用于生产中。例如，如果病毒感染了虚拟机，但有一个以前的文件快照，可以通过此快照来恢复，可以关闭受感染的虚拟机，并返回到以前未受感染的副本。当然，应该小心做这件事，因为可能会丢失数据，但这种水平的灵活性是物理机器无法比拟的。
　　虚拟磁盘的主要优点是将通常构成一台机器运行一个操作系统的物理磁盘转化成一个文件夹中的文件，使磁盘从它们的物理限制中“解脱”出来。这意味着由于机器现在完全包含在一个单独的文件夹内，所以变成可移动和可传输的。同一台机器可以在一个工作站上、在一台服务器上、在一个群集上或者甚至在远程位置上运行。如果要保护这个虚拟机，只需将构成它的文件复制到另外一个位置。这就是为什么服务器虚拟化技术是如此具有革命性。尝试用物理机来实践一下吧！
　　因为所有的虚拟机都是由一系列文件组成，所以在任何时候都可以很容易地复制它们和重复使用它们——当然，你需要提供适当的物理磁盘空间。此外，由于虚拟机总是至少由2个文件构成，所以在主机硬盘上将每个虚拟机放到它自己的文件夹中是一个很好的做法。然后，如果需要复制一个副本，只需复制整个文件夹。
　　虚拟机也很容易备份和恢复。因为备只份涉及复制一组文件，所以可以在任何项目的关键阶段进行定期备份。如果出现任何问题，很容易返回到机器以前的版本。因为，就备份工具而言，虚拟机存储在文件服务器上，因此不需要特别的备份代理。
　　2.2.3　服务器虚拟化的模式
　　如上所述，服务器虚拟化（SerV）有2种虚拟化模式（见图2-10）。第一种，软件虚拟化或SoftV，通常用于开始虚拟化项目，因为它依赖于更简单的、通常免费的技术，但效率较低，因为它需要一个基础的主机操作系统（OS）。这个基础的主机操作系统也需要资源，因此会影响运行在它之上的虚拟机的操作。基于这个原因，组织不会使用这种模式，除非是用于测试或开发目的。因为它运行在一个现有的操作系统之上，通常更简单地依靠SoftV来了解服务器虚拟化技术是如何工作的。
　　图2-10　两种不同的服务器虚拟化模式
　　然而，SoftV永远不应该用于生产环境，除非你有低级别的服务等级协议，并且能够确保虚拟机内提供的服务在脱机时间较长的情况下不会对用户造成负面的影响。只有少数组织的网络服务具有此级别的灵活性。此外，在现有操作系统之上运行虚拟化产品，使得所有的虚拟机容易受到主机操作系统更新过程的影响。如果主机需要重新启动，那么所有的虚拟机也将需要重新启动。因此，这不是最好的方案。
　　基于这个原因，当迁移到生产环境时，必须使用第二种模式，硬件虚拟化层或HardV。在这种情况下，hypervisor代码将被直接集成到硬件中，并将只把主机服务器的硬件提供给在其之上运行的虚拟机，而且只消耗主机很少的物理资源，让尽可能多的虚拟机在其上面运行。此外，由于主机实际上并不包含常规的操作系统，所以它不需要补丁，至少不需要与虚拟机中运行的操作系统以同样的速率进行修补和更新。这就最大限度地减少了对机器上承载的hypervisor的影响。正因为如此，HardV是迄今为止用于重要的服务器虚拟化的最佳模式。
　　例如，VMware ESXi是32兆字节（MB）的hypervisor，不需要操作系统就可以直接从固件或者内部通用串行总线（Universal Serial Bus，USB）存储器上运行。VMware不是唯一提供与主机服务器硬件集成的hypervisor厂商。这个级别的集成，让你有机会创建一种新的无磁盘的主机服务器模式，只使用内存、处理器和网络资源来承载虚拟机。
　　注意：VMware ESXi也是一种免费技术。你可以从www.vmware.com/go/getesxi下载一个全功能的版本。Microsoft也提供了免费版的hypervisor、Windows Hyper-V Server，但它的功能有限，并且没有提供从Windows Server 2008代码中的版本中获得的所有功能。你可以从www.microsoft.com/windowsserver2008/en/us/hyperv.aspx下载它。
　　在不同的虚拟化的技术中，服务器虚拟化仍然是最流行的。想想看所有成千上万的服务器今天的利用率不到10%——并且这还不是最差的，因为许多服务器的利用率甚至不到5%。在世界各地的数据中心中，每台服务器都在满功率地运行，需要充分地冷却，需要充足的空间。然后想象一下，适当地配置运行服务器虚拟化，相同的物理服务器可以实际运行10多个虚拟机、服务器或桌面。这些虚拟机的每一个都不需要自己的电源，每一个都不会产生自己的热量以及每一个都不需要空间，但这些虚拟机中的每一个可以贡献相同的服务并同时在一台物理机器上运行。如果你目前还没有使用这种技术，这难道不值得你深入研究吗？
　　每个虚拟机只是在磁盘某个地方上的一组文件而已。当把一个服务器的物理实例转换为一个虚拟实例时——有效地执行P2V转换——就把物理机器转换为文件夹中的一组文件。然后，在此状态下，可以在服务器之间移动虚拟机，将它关闭、将它重新启动、将它休眠，在没有任何明显的性能下降的前提下，虚拟机基本上可以做任何事。
　　2.2.4　主要的服务器虚拟化供应商
　　客户操作系统虚拟化的厂商有很多，但以下3个主要的厂商已经占据了市场：
　　▼Citrix提供了一系列不同的虚拟化技术（www.citrix.com/xenserver），目的是将其产品扩展到所有的虚拟化领域。XenServer有4个版本。快速版是产品的免费入门版本。标准版是基本版本，同时支持2个VSO。企业版增加了硬件资源池和运行无限制的VSO的能力。白金版增加了主机和VSO两者的动态资源调配。Citrix提供了一个原始设备制造商（Original Equipment Manufacturer，OEM）版本的hypervisor，将它内置到服务器硬件中。Citrix还为DeskV提供了XenDesktop，为AppV提供了XenApps。
　　■Microsoft为每个虚拟化领域提供了一系列的虚拟化技术，要了解更多的产品信息请访问www.microsoft.com/virtualization。Microsoft目前提供的Virtual Server 2005 R2 SP1和Virtual PC 2007都是免费的，但只是SoftV产品。其企业级的hypervisor和Hyper-V是Windows Server 2008操作系统的一部分，并且只能运行在x64硬件上。Microsoft还为AppV提供了Microsoft Application Virtualization，为PresentV提供了终端服务，并提出了一些收购计划以进入DeskV领域。
　　▲VMware提供了最成熟的产品，以及全面的服务器和桌面虚拟化工具（www.vmware.com）。它提供了VMware Server——另一个免费的SoftV产品；VMware Workstation和Virtual Infrastructure——一个基于其ESX Server hypervisor的完整平台。VMware是第一个提供将ESXi hypervisor嵌入服务器硬件的厂商，并使其免费附加到主机服务器中。VMware还为DeskV提供了虚拟桌面基础架构（Virtual Desktop Infrastructure，VDI），为AppV提供了ThinApp。
　　运行这些厂商的任何产品可以让你虚拟化任何的环境，无论是培训、测试、开发或者生产环境。更好的是，这些厂商中的每一家都提供了免费版本的工具，让你无须破费就可以开始你的虚拟化项目。
　　注意：Microsoft Hyper-V将运行在能够运行Windows Server的任何系统之上。这意味着它将运行在成千上万的服务器配置之上。要查找Windows硬件兼容性列表的详细信息请访问www.microsoft.com/whdc/hcl/default.mspx。VMware ESX和Citrix XenServer将只能在选定的配置上运行。要查找ESX Server 3.5和ESX Server 3i的VMware系统兼容性指南请访问www.vmware.com/pdf/vi35＿systems＿guide.pdf，查找ESX Server 3.5和ESX Server 3i的I/O兼容性指南请访问www.vmware.com/pdf/vi35＿io＿guide.pdf。关于Citrix XenServer的系统配置，请访问XenServer兼容性列表www.citrix.com/English/ps2/products/feature.asp？contentID=1453254。
　　Oracle（Oracle VM）、Novell（Xen）、Red Hat（Xen）、IBM、Sun（xVM）、Virtual Iron以及其他厂商也都提供了自己的hypervisors，如果你试图考虑使用其中某种工具，将会令你感到困惑。如果可能的话，请在3个主要的厂商中选择。有时候可能无法这样做，因为某些厂商不支持他们的应用程序运行在竞争对手的hypervisor中。例如，Oracle只支持其应用程序运行在他们的Oracle VM之上（www.oracle.com/technologies/virtualization/docs/ovm-faq.pdf）。然而，Microsoft对于它们的产品在任何版本的hypervisor中运行有一项“尽最大努力”的支持策略，无论是不是它们的产品（请参见Knowledge Base Article知识库文章）编号897615，地址为http://support.microsoft.com/kb/897615）。
　　当选择你的虚拟化平台和管理产品时，请记住一点。如果你最终运行了多个hypervisor，那么你应该选择那些不受hypervisor限制的管理产品，以确保你可以持续管理你的基础架构。表2-1概括了不同制造商的各种可用的产品。
　　服务器虚拟化有以下一些优点：
　　▼第一个当然是在部署方面。虚拟机通常可以在20分钟内完成建立和自定义。你可以在与物理机相比少很多的时间内马上交付一个可以随时使用的虚拟机。但你要小心不要将虚拟机扩散到你的基础架构中。你需要持续控制机器请求，无论它们是物理或虚拟。你不会想要最终变成虚拟机泛滥，仅仅因为你可以很容易地创建它们。
　　■另一个优点是虚拟机移动性。你可以在任何时候将虚拟机移从一台主机移动到另一台主机上。在某些情况下，你可以在它运行的时候移动它。这是一个极大的优点，将有助于减少网络停机时间。
　　■虚拟机非常容易使用。一旦它建立并配置完成，只需启动机器，虚拟机就立即准备好向用户提供服务。
　　■虚拟机支持标准配置。你可以控制生成虚拟机的方式：只要创建一个标准的虚拟机，每次需要一台新的机器，只需复制此VM的源文件。使用这种方式，你将总是拥有标准配置的虚拟机。
　　■虚拟机还支持挥发性服务的概念。如果测试人员或开发人员需要一个虚拟机来执行指定的一系列测试，你可以启动一个新的虚拟机，在数分钟内提供给他们，然后，当他们完成测试，你只需将其删除。尝试用物理机来实践一下吧！
　　■虚拟机可以通过虚拟化厂商认证，确保你与你的虚拟机使用的是最佳的技术能力。
　　■虚拟机也是安全的，因为它们在任何时候都可以被完全隔离；通过主机的虚拟化技术就可以切断它们的通信。
　　■虚拟机可以进行横向扩展或者纵向扩展。横向扩展，只需创建更多提供相同服务的虚拟机。纵向扩展，关闭虚拟机并为它分配更多的资源，如内存、处理器内核心、磁盘和网卡。
　　▲虚拟机也是理想的灾难恢复解决方案，因为所有你需要做的就是复制它们的文件到另一个位置，或者在你的数据中心内或者是到另一个完整的站点。
　　由于这些核心的利益，很难想象为什么有人不愿意使用服务器虚拟化。服务器虚拟化允许以一对一的关系将计算资源映射到业务需求。允许通过提高效率和资源分配来降低IT成本。可以根据需要来调配资源。虚拟化允许你将数据中心视为一个单一的资源池，把服务器硬件和数据中心内所有的其他硬件融为一体（见图2-11）。通过服务器虚拟化，可以将所有最终用户的服务变成虚拟的工作负载，并把所有硬件资源变成资源池，创建一个新的数据中心，一个将所有的工作负载划分为虚拟和物理表示形式的数据中心。
　　图2-11　在数据中心使用资源和虚拟层
　　2.2.5　桌面虚拟化
　　相同的技术，既可以为服务器虚拟化提供动力，也可以为桌面虚拟化提供动力。桌面虚拟化集中了桌面的部署，以便你可以取得对它们的完全控制，让用户依靠各种终端——瘦计算机设备、非托管的计算机、家用PC或公共PC——来访问你的企业桌面基础架构，重申一遍，是通过远程桌面连接（Remote Desktop Connection，RDC）。DeskV与PresentV或表现层虚拟化之间的主要区别，通常被称为终端服务或者基于服务器的计算，那就是PresentV，用户必须与所有其他连接到服务器的用户共享桌面环境。在DeskV中，每个用户可以使用他们自己的桌面，限制了其他桌面会话对应用程序的需求带来的潜在影响。通过将应用程序包含在虚拟桌面中，可以保证如果在一个虚拟桌面中发生了不幸的事情，它不会影响到在同一台服务器上运行的其他虚拟桌面。
　　通过将桌面放置到服务器上的虚拟实例中，并给用户远程访问一个由虚拟桌面提供的封闭和受控制的环境，想想看通过虚拟化桌面你能做些什么。作为管理员，你可以使用它们测试补丁程序和服务包部署，在多系统环境中提供支持，以相同的方式为最终用户和技术人员提供培训，或者仅仅提供受控制的环境。当完成你的测试或培训，只需重置虚拟机回到其初始状态，一切又恢复到原来的样子了。DeskV比起管理整个基础架构的分布式系统所需的成本，是一个十分节省时间的解决方案。如果你有现有的桌面，可以将它们变成非托管设备，因为你只需在物理工作站上完成以下3件事：
　　▼一个基本的操作系统，它可以是任何版本的Vista或Windows XP或更新的版本。这个基本的操作系统必须已经打补丁和更新，这是你无论如何都必须做的事。
　　■正确的病毒防护，如果你有物理桌面，这是你无论如何必须管理的另一个项目。
　　▲一个远程桌面连接客户端。
　　仅此而已。在此系统上你不需要额外的应用程序或者任何其他的开销。管理这些瘦终端比起你必须在数百个终端上部署和更新应用程序，更具成本效益。
　　如果你的组织可以负担得起，建议将所有的物理桌面转换成瘦客户端。瘦客户端可以进行自我更新，没有任何内置的软件，比起实际的桌面更容易管理。从你的环境中以移除每个单独的桌面系统，每年将会减少你的电力消耗达到650000千瓦时。
　　还有一些迁移到虚拟桌面的理由：
　　▼可以在非托管远程PC上创建企业标准的锁定PC。通过服务器虚拟化集中管理桌面，可以锁定公司的PC镜像，但允许用户在非托管物理桌面上自由运行。这既为你提供了标准的集中化配置，又让用户仍然感到开心，因为他们可以在非托管PC上做他们想做的事情。
　　■可以创建受时间控制的PC镜像。如果你的组织有雇佣临时或季节员工的习惯，你可以生成受时间控制的虚拟PC镜像，一旦不再需要它们就会消失。临时雇员甚至可以从家里使用他们自己的PC进行工作，因为他们只需要使用RDC客户端访问你的企业镜像，RDC客户端是每个Windows默认安装的一部分。
　　■还可以通过将桌面保持在数据中心内以保护信息的安全。通过控制远程连接虚拟PC，可以确保通过PC镜像生成的任何数据都保持在数据中心内，并且不能离开数据中心。这为你提供了对企业知识产权的完全控制。
　　■你可以封装复杂或敏感的应用程序，将它们与任何其他人隔离开来。例如，必须使用多种不同的安全级别访问企业数据的雇员，经常不得不使用多台不同的物理PC才能正确地访问这些数据。你可以为他们提供多个不同的虚拟PC镜像，分别做不同的配置，以支持适当的安全级别。
　　■DeskV可以提供一种迁移到新的操作系统的新途径。很多人不会迁移到较新的操作系统，如Vista，因为他们必须升级所有的终端来做到这一点，但当你在虚拟环境中运行新的操作系统时，没有终端需要改变，因为它们只需要一个RDC客户端就可以访问最新的桌面。这极大地方便了桌面的迁移。
　　▲DeskV也是一种极好的测试和开发模式，与服务器虚拟化机器一样，它们也支持可撤销盘，并且在需要时可以很容易生成。
　　要迁移到集中式的桌面环境，你需要做的是生成一个核心的虚拟镜像，然后通过这个最初的镜像及标准配置来生成所有的其他镜像。从那时起，用户就可以依靠任何的终端来访问自己的个人虚拟PC镜像，甚至可以穿过防火墙（见图2-12）。
　　图2-12　依靠DeskV让你可以维护标准的集中镜像，用户可以从任何终端上访问该镜像
　　2.2.6　应用程序虚拟化
　　最后一个关键的、与服务器虚拟化最相似的虚拟化层是应用程序虚拟化。应用程序虚拟化或AppV，通过一个特殊的虚拟化层在操作系统之上创建隔离的软件或服务。在这方面，AppV与软件服务器虚拟化或SoftV最相似，因为它需要一个底层操作系统来运作。然而，AppV的优点是它可以完全保护操作系统免受在应用程序安装过程中进行的任何更改。这是因为当你通过AppV准备一个应用程序，你不需要与传统上的做法一样捕获安装过程；相反，你需要捕获应用程序的运行状态或者是需要捕获哪些条件才可以使应用程序在操作系统上正常运行。因此，启用AppV的应用程序只需以Xcopied方式复制到终端，因为不需要安装。这为分布式应用程序管理提供了强大的模式。AppV还提供了对应用程序整合的支持。
　　有多个厂商提供了AppV解决方案：
　　▼通过流技术的应用虚拟化：
　　■Microsoft Application Virtualization（Microsoft应用程序虚拟化）（MAV，以前的Soft-Grid）允许你不需要安装就可以分发应用程序，并且可以根据需要动态地分发。MAV可以在桌面电脑、笔记本电脑或者终端服务器上部署。MAV是Desktop Optimi-zation Pack for Software Assurance（软件保障桌面优化软件包）的核心组件。有关详细信息，请参阅http://technet.microsoft.com/en-us/appvirtualization/default.aspx。
　　■Citrix XenApp（以前的Citrix Presentation Server）是一个端到端的Windows应用程序分发系统，它提供了客户端和服务器端的应用程序虚拟化，以及表现层虚拟化的。有关详细信息，请参阅www.citrix.com/english/ps2/products/product.asp？contentid=186。
　　■Symantec Software Virtualization Solution（Symantec软件虚拟化解决方案）Pro（SVS）是应用程序虚拟化平台，它解决了本地系统过滤。Pro版本包括一个称为Appstream的流组件，它提供了市场上最先进的流平台。有关详细信息，参见www.symantec.com/busi-ness/products/overview.jsp？pcid=pcat＿iufrastruct＿op & pvid=sv＿sol＿pro＿1。
　　▲无代理的应用程序虚拟化：
　　■VMware ThinApp（以前的Thinstall）从操作系统中封装应用程序和运行环境，消除了昂贵的回归测试和应用程序不良行为引起的冲突。只需将一个.msi或.exe文件插入部署虚拟系统环境中，包括注册表项、动态链接库（Dynamic Link Libraries，DLL）、第三方运行库和架构，而不需要在底层操作系统上进行任何代理或应用程序的安装。有关详细信息，请参阅www.vmware.com/products/thinapp/？hl=en & rlz= & q=thinapp & meta。
　　■InstallFree Bridge提供了一个无客户端的平台，它在虚拟应用程序和操作系统之间建立了一个座透明的“桥”，以保护操作系统免受任何应用程序更改的影响。有关详细信息，请参阅www.installfree.com/pageload.aspx？page=products＿bridge.html。
　　正如你所见到的，VMware和InstallFree两家厂商提供了不需要事先在目标桌面上部署代理的解决方案。这是真正地将应用程序从任何约束或绑定中释放出来，并使它们可以完整地传送。选择一个无代理还是一个基于代理的AppV解决方案，将取决于你的需要，但在大多数情况下，代理部署很少有问题，比起无代理解决方案提供了更好的针对虚拟应用程序的控制措施——没有代理、没有应用程序；它就是这样的简单。
　　虚拟化应用程序有多个优点。传统的应用程序安装穿透了操作系统，并且会更改其配置。最终，托管或非托管系统会变得完全转变和无法识别。基于这个原因，随着时间的推移，很多组织需要不断地重新镜像他们的桌面，以重置它们回到已知的配置。相反，应用程序虚拟化可以保护操作系统避免任何修改对它的影响，并且支持完全安全的环境（见图2-13）。
　　图2-13　依靠AppV来保护目标操作系统
　　而且，最重要的是，任何已经虚拟化的应用程序都可以在任何版本的Windows上运行。这是因为AppV层管理虚拟应用程序和Windows之间的所有互动。一旦应用程序被虚拟化，每次需要更换操作系统的时候，它不需要重新打包。单凭这一点，AppV是IT可以采用的最强大的新技术之一。
　　正如你所见到的，虚拟化对于服务器、桌面电脑和应用程序有着重大的影响。对于服务器，虚拟化支持硬件整合，增加了服务器的绿色足迹，并且为业务连续性提供了最佳的模式。对于桌面，虚拟化支持桌面集中、信息保护以及可以提供安全的桌面环境。最后，虚拟化为组织提供了应该用于应用程序分布式系统管理的唯一模式。组织面临的挑战是了解如何使这些虚拟化的3个层次能够协调一致地执行，以便充分利用每一种技术。
　　



　　2.3　使用前两步
　　Resolutions五步过程的前两个步骤集中于新技术的发现和它们可以如何帮助你的组织迁移到全新的数据中心。在数据中心内，虚拟化技术为IT提供了一种新的模式，把过去所工作的静态环境转变为可以提供按需服务的动态环境。但是，它自己不会发生这种转变；它必须以新的运作方式来调整。这正是接下来的三个步骤所要提供的帮助。
　　



　　第3章　完成五步过程
　　第2章开始讲述Resolutions的五步过程。前两个步骤的重点是发现你的网络中有什么设备和虚拟化究竟是什么，五步骤中剩余步骤的重点是你需要如何去适应你的环境以令一切可以正常运作。第三步概述了你的硬件视图需要做怎样的更改。第四步关注每一层——硬件和软件——如何相互配合形成一个统一的体系结构。第五步关注你的管理需要做怎样的改变，以适应动态数据中心。
　　



　　3.1　第三步：硬件最大化
　　既然你了解到你可以在不同的级别应用虚拟化，那么你可以开始考虑虚拟化技术特别是服务器虚拟化将如何改变硬件以运行你的工作负载。大多数组织的数据中心已经演变成充满了小型、用途单一的服务器从直连存储上运行的服务器房间。虽然这种做法在资源丰富的世界中是可行的，那里没有人需要担心空间的问题，但在动态数据中心中，这种做法不再可行。
　　当你迁移服务器和桌面到虚拟工作负载时，你必须考虑改变所依赖的硬件的性质，以确保你在系统上运行的虚拟工作负载总是保持高可用性。此外。由于数据中心的转变是依靠将较少使用的工作负载迁移到更少的硬件系统上，重要的是要确保每一个你运行的系统提供了最广泛的资源，以应付这些工作负载。基于这个原因，你必须重新考虑数据中心并且最有可能将其转换成一个更精简和更灵活的资源池。
　　3.1.1　迁移到64位
　　由于你的硬件服务器现在打算要运行多个虚拟工作负载，所以你必须考虑那些可以提供最佳性价比的硬件。启动的第一个地方是潜在的瓶颈。最重要的瓶颈之一是随机存取内存（RAM）。由于每个虚拟机必须处理自己的内存，所以你的服务器配置必须设计为使用最大的内存配置。此外，系统必须使用最好的资源，以使内存可用于每个虚拟机。基于这个原因，考虑64位处理器体系结构是非常重要的。
　　在这种情况下，你必须寻求x64处理器，不是安腾（Itanium）或IA64。x64处理器是一种32位x86体系结构的扩展，正因为如此，它可以运行很多与x86系统相同的代码。但是，x64体系结构是一种64位的体系结构，相比x86系统，它可以处理更多的内存。内存一直是困扰计算系统的问题。引述Apple公司主席乔布斯多年以前说过的话“开发人员必须学会严密地编程”时提到了原始的Macintosh的内存限制，只有128千字节（KB）的RAM。Apple公司只花了8个月的时间就生产出了Fat Mac，一个可以使用全部512KB RAM运行的版本。这些已成为历史。
　　计算机总是需要访问大量的内存。实际上，内存已标榜为对应用程序操作的单一最大限制。从原始Macintosh或IBM PC的千字节开始，我们已走了很长的一段路，但即使计算机正在运行真正的32位处理器体系结构和相应的操作系统，也可能会遇到内存瓶颈。这是因为32位的处理器只能处理不超过4吉字节（GB）的RAM（见图3-1）。
　　在默认配置中，32位系统的基准4GB分为2个部分。第一部分的2GB是为内核进程保留的。此空间分配给核心操作系统。第二部分的2GB RAM分配给应用程序的虚拟内存。这是应用程序执行时可以使用的空间。有临时应急措施可以更改这些配置。例如，如果你指定了/3GB开关到启动过程，内核进程空间将减至1GB，并且将为应用程序保留3GB。在这种情况下，应用程序能够访问到更多的物理内存，但随后核心操作系统成为了瓶颈，因为无法满足其内存的全部数额。还可以在启动时使用物理地址扩展或/PAE开关。这改变了从32位至36位的内存管理空间，并允许操作系统将应用程序内存交换到地址窗口化扩展（Address Windowing Extension，AWE）中，以提供更多的物理内存，使系统可以超越基准4GB。但是，当应用程序需要执行代码时，它们必须要交换回到应用程序虚拟内存的基准2GB（见图3-2）。这意味着即使系统可以“看到”大于4GB的RAM，但由于必须符合基准2GB的执行限制，应用程序仍然面临着瓶颈。
　　图3-1　在32位处理器体系结构中可能的内存配置
　　图3-2　为应用程序使用/PAE开关让操作系统将应用程序交换到基准2GB可用空间中
　　超越这些限制、访问更多的内存，同时仍然可以执行相同的应用程序代码的唯一方法就是x64处理器体系结构。默认情况下，x64处理器体系结构可以处理更多的内存，比它们的x86同行多得多的内存。应用程序可以存取的物理内存的最大数量取决于你选择要运行的操作系统。表3-1概述了各种可用的内存限制取决于你在x64机器上运行的Windows版本。
　　例如，如果你正在运行Windows Server 2008 x64 Web或标准版，系统将能够访问高达32GB的物理RAM。如果你正在运行x64企业或数据中心版，你的系统将能够访问高达2TB的RAM。这比起32位系统上的可用最大内存多得多。此外，每个操作系统可以访问超过16TB的虚拟内存。当然，还没有任何人拥有可以提供支持2TB RAM的服务器配置或者是能够访问128GB RAM的工作站配置，但它们已不再遥不可及。
　　对于Windows Server 2003系统要访问其x64平台的全部内存容量，它们必须运行Service Pack2或更高版本。此外，Microsoft声称Vista的极限、企业与商业版的x64版本最终可以访问超过128GB的RAM，但Microsoft开发人员网站声称应用程序将只能访问到128GB，即使系统硬件可以发现更多。
　　有一点可以肯定的是：每一种基于x64代码的Windows或Linux操作系统默认情况下比起x86或32位的操作系统可以访问更多的内存。访问这么多的内存意味着应用程序现在可以完全按预期执行。Microsoft的Windows Server操作系统可以分配完整的8TB虚拟内存给任何的应用程序。并且应用程序不一定要以原生x64代码编程才能利用这一变化，甚至当32位应用程序运行在x64操作系统上，将会看到性能提升，因为其历史上的首次，这些应用程序可以访问一个完整的4GB的RAM而无须与操作系统共享基本内存区块。不再需要交换，而且在每一个单独实例中的应用程序的性能得到了提高。但是，该应用程序内的代码必须能够支持/LARGEADDRESSAWARE选项，以从完整的4 GB RAM中获益。
　　如果想从你的系统中消除单一最大的制约瓶颈，需要寻求x64操作系统。只有少数几家厂商销售x86处理器，所有拥有它们的组织应该在x64硬件上运行x64操作系统，即使与x86操作系统是兼容的。首先，你甚至不需要更改你的应用程序以访问此功能。每个x86应用程序在默认情况下与x64兼容。
　　此外，32位和64位服务器级别的机器当前的价格几乎是完全相同的。AMD和Intel都提供x64处理器。很多hypervisor也是仅64位的hypervisor。虽然不是所有的hypervisor都为64位，但它们全部都至少使用64位的内存管理。这就是为什么64位硬件是必需的。如果你打算花时间迁移到虚拟基础架构，你应该确保你用于承载虚拟工作负载的系统是最好的，并且准备好要长期执行此任务。
　　3.1.2　依靠共享存储
　　除了要在你的服务器配置中消除资源瓶颈之外，你还必须消除潜在的单点故障。当你在单一主机服务器上放置了10个、20个甚至30个虚拟机，你必须确保此主机服务器不会发生故障；否则，所有的虚拟工作负载也将失效，这会引起最终用户的愤怒。基于这个原因，你必须考虑配置高可用性的硬件。在大多数情况下，这意味着需要使用某种形式的群集。而像Microsoft和Citrix等一些厂商实际上是依靠群集服务来保护在他们的系统上运行的虚拟工作负载，VMware使用了一种叫做高可用性（High Availability，HA）的自定义配置。
　　最后，每一种配置都是相同的：多个计算机节点连接在一起以保护它们运行的工作负载。如果其中一台机器发生故障，工作负载将自动转移到另一个可用节点上。
　　使这些配置得以运作的是共享存储。每个节点都连接到同一个存储容器上。这意味着当一个工作负载需要进行故障转移时，组成它的文件不需要移动或复制到下一个可用的计算机节点上。此外，当虚拟工作负载比那时驻留节点上需要更多的可用资源时，虚拟化技术支持将工作负载从一个系统动态迁移到另一个系统中。工作负载自动迁移到有足够可用资源，而无须管理交互的另一个节点上。重申一遍，这只有当虚拟工作负载位于某些共享存储上才成为可能实现。这就是为什么存储虚拟机的最佳方式是依靠共享存储（见图3-3）。你可以把所有的虚拟机存放到共享存储子系统上。此外，因为连接到共享存储基础架构的系统位于同一个站点内，所以应该考虑为它们提供站点级别的冗余。并且，由于虚拟机是故障点，运行在它们内部的每一个应用程序也应该自动具有高可用性。
　　图3-3　使用共享存储允许你创建高可用性的配置
　　注意你的共享存储子系统不要变成它自己的一个单点故障。当为支持虚拟工作负载的硬件组件进行规划时，总是要考虑冗余。
　　3.1.3　了解许可授权费用
　　虚拟化可以节省的金钱是令人难以置信的，举出一个简单的商业案例。首先，你不再需要购买所有的硬件，从而可以节省费用。其次，软件制造商如Microsoft，从Windows Server 2003 R2（WS03R2）的发布开始，持续到Windows Server 2008（WS08），Microsoft改变了他们的软件许可模式，以支持虚拟化。购买一份Windows Server 2003 R2或Windows Server 2008企业版的许可，现在授予你多达4个免费的操作系统虚拟实例，如果你选择在主机服务器上运行Windows Server，也会为主机服务器提供一个许可。每一个附加的许可以为你提供4个客户虚拟机。购买一份Windows Server 2003 R2或Windows Server 2008数据中心版的许可，可以让你拥有运行无限数量的任意版本的Windows服务器操作系统的虚拟化实例的权利。表3-2列出了一些在虚拟化中所涉及的可节约成本。当然，如果你运行的是Linux工作负载，许可授权问题可能会变得毫无意义。
　　为了帮助你了解虚拟化的优点以及它对操作系统授权的影响，Microsoft开发了一种虚拟化计算器，可以在以下地址找到www.microsoft.com/windowsserver2003/howtobuy/licensing/calculator.mspx。两个计算器提供了2种方式来估算虚拟化方案中Windows Server标准、企业或数据中心版本的数量和许可费用。第一个计算器的目的用于估算许可和使用不同版本的Windows Server以及众多Microsoft服务器产品在单一物理服务器上的成本（见图3-4），第二个计算器可以帮助你估算许可和仅是不同版本的Windows Server操作系统在一台或多台物理服务器上的成本（见图3-5）。依靠这些工具仅能确定虚拟化Windows Server操作系统可以实现虚拟化的潜在可节约成本。最后，可以依靠Microsoft的投资回报率（Return On Investment，ROI）计算器确定你可以从迁移到虚拟化中获得益处。
　　图3-4　Microsoft虚拟化许可计算器1号
　　图3-5　Microsoft虚拟化许可计算器2号
　　注意：要了解更多有关Microsoft ROI计算器的详细信息，请访问www.microsoft.com/virtualization/ROItool/default.mspx。
　　此外，Microsoft已经修改了Windows Vista桌面的许可模式。新的Windows Vista企业集中桌面（Visa Enterprise Centralized Desktop，VECD）许可允许你用一个单一的Windows许可，就让每个用户同时运行最多4个虚拟桌面。它还允许你运行任何版本的Windows桌面操作系统。例如，你使用同一个许可让每个用户运行2个Vista副本、一个XP副本和一个Windows 2000的副本。这种模式可以让你管理和维护应用程序，通过将它们放入运行旧版本的虚拟机使得它们不用在较新版本的操作系统上运行。了解更多有关VECD的信息，请访问www.microsoft.com/virtualization/solution-productvecd.mspx。
　　总之，专有代码的厂商如Windows也认识到虚拟化的价值，要求组织通过迁移到动态数据中心模式，以减少其碳足迹。
　　3.1.4　依靠新的服务器设备
　　因为需要x64服务器连接到共享存储，所以可以开始考虑不同的服务器设备。今天，组织为远程办公室或小的组织建立复杂的多用途服务器。使用虚拟化技术，不再需要这样做。例如，可以建立一台远程办公室服务器，包括以下几个角色——域控制器、文件服务器、打印服务器、管理服务器、数据库服务器等。建立这种服务器需要很多的妥协。在任何时候，域控制器应该始终受到保护。用户通过域控制器访问文件或打印服务迫使你要么降低服务器的安全性，要么使文件访问比它所需要的更加复杂。随着虚拟机的出现，现在可以分隔开所有的这些角色，并且无须支付额外的许可。但这意味着需要寻求新的服务器类型。包括2台物理服务器、网络交换机和共享的存储的一体化服务器或者服务器群（见图3-6），非常适合用于这种情况，无论是远程或小办公室。
　　以HP为例，它现在提供了在同一个机箱中可以同时承载服务器和存储刀片的刀片机箱。此外，这些机箱可以在普通的110伏电源插座上运行，不再需要安装特殊的电源就可以运行。就是现在，HP提供了2种不同类型的这种机箱：c3000（见图3-7），这是一种半高机箱适合用于小型办公室。c7000，这是一种标准的全高机箱。若要了解更多有关这些机箱的详细信息，请访问http://h20384.www2.hp.com/serverstorage/cache/536425-0-0-0-121.html。
　　图3-6　在小型或远程办公室中使用服务器群来承载虚拟机
　　图3-7　HP BladeSystem c3000半高机箱，通常称为“矮子”
　　最后，如果你需要将新的机箱放到没有数据中心的地方，那么你应该寻求新的机箱设计。另一家厂商Kell Systems，专门销售适合任何办公室的新型智能机箱（见图3-8）。
　　图3-8　Kell牌办公室机箱
　　这些机箱看上去就像标准的办公家具，但这种具有隔音外壳的机箱可以为刀片和机架安装服务器提供冷却、电源和空间。这种产品真的太有意义了，既可以保护你的主机系统，又可以虚拟化所有你的工作负载，甚至是在远程办公室中。要了解更多有关Kell Systems的详细信息，请访问www.kellsystems.com。
　　毫无疑问，为了推进你的虚拟化项目，需要寻找到新的硬件，或者至少重新调整现有的硬件用途，这将是必须包含在项目各个阶段中的重要一环。
　　



　　3.2　第四步：体系结构
　　过程的下一步是更新和改变数据中心的体系结构。如果它们是不正确的结构，使用多个虚拟化层会变得十分混乱。你已经看到虚拟化基础架构有多个要素。例如，要保护虚拟工作负载，需要使用x64系统连接到共享存储，并安排某种形式的高可用性群集。但也可以在虚拟层设置群集。例如，当建立了一个Exchange Server 2007邮箱服务器来存储用户的邮箱时，你将很可能利用这个产品的故障转移群集和复制功能，以确保由虚拟产品服务提供的邮箱服务具有高可用性。同样也可以适用于SQL Server数据库服务器。如果你想让你的Web服务器实现高可用性，你可能需要为它们建立网络负载平衡群集。在虚拟层设置群集不仅是好的做法，而且它们往往是必需的。因为设置了群集的机器更易于维护——可以把工作负载转移到群集中的另一台机器，因此你可以为当前节点安装补丁程序等。这意味着对系统管理的影响非常少，如果有的话，只有对最终用户生产力有一点影响。在虚拟层设置群集几乎是免费的，因为你不需要定制硬件以支持它。请记住，群集虚拟机必须使用非亲和规则，以确保群集中的2个节点不会驻留在同一台主机上；否则，从一开始群集虚拟机就将会是无用的。
　　但是，当你在一个群集中建立群集时，可能会令人感到困惑。另一个可能让你感到困惑的例子来自于当你创建虚拟服务器为虚拟桌面提供服务，同时在虚拟网络中依靠虚拟存储来运行虚拟应用程序。快速问答，在这种情况下哪一层没有虚拟化？很难回答，是不是？
　　这正是可视化体系结构可以帮忙的地方（见图3-9）。在此体系结构中，构建了7个不同的虚拟化层，并以特定的构造来处理每一层。第一层是物理层，将每个组件都包含在资源池中。第二层是存储层，将依靠存储虚拟化技术来调配，正如你需要为物理和虚拟资源提供许多逻辑单元（Logical Unit，LUN）一样。第三层是分配层，由于虚拟服务或产品（VSO）只不过是在某个位置的文件夹中的一组文件而已，当需要额外的资源或者当特定主机上需要进行管理操作时，它们可以并且应该从一台物理主机动态地迁移到另一台上。正是这个分配层或VSO定位追踪，将数据中心由静态转变为动态。也正是在这一层内，基于hypervisor的功能来创建和分配虚拟网络。
　　第四层是虚拟层，它决定什么将被虚拟化，并且最终成为包含服务器和工作站的工作负载。第五层处理物理和虚拟两者的管理层。请记住，这2个资源级别依靠于不同的安全上下文。此外，可以使用不同的工具来管理这2个基础架构级别。第六层是PC层。虽然很多人将会迁移到虚拟桌面基础架构，以减少管理分布式系统的成本，另一些人将发现通过迁移到虚拟化应用程序，整个分布式桌面管理的业务模型发生了积极的改变——非常多的改变，实际上，它们将永远不会回到应用程序安装的年代。
　　仅剩的最后一层是业务连续性层。由于虚拟服务产品只不过是在某个位置的文件夹中的文件而已，让业务连续性的实现变得更简单：只需将构成每个虚拟机的文件复制到异地，并在任何时候你都要有一个整个数据中心的可用副本。此外，远程数据中心内的物理资源不需要与生产数据中心内的相同。毕竟，在一场灾难中，你只需启动和运行的关键服务。这比起运行整个生产系统需要相当少的资源。
　　图3-9　将虚拟化层集成到一个单一服务体系结构中
　　现在你明白了吧。一种7层虚拟化体系结构，每一层都是构建在另一层之上，支持新的动态数据中心。现在，已经了解了每一个层以及它里面所包含的内容，可以开始建立基础架构并运行它。而且，当你感觉一切已准备就绪，就可以把你的物理工作负载转换为虚拟服务产品，一劳永逸地彻底改变你的数据中心。当然，开始的最好地方永远是在实验室。在迁移生产系统之前，先做好一切充分的测试。
　　



　　3.3　第五步：管理虚拟化
　　动态数据中心现在分为2个层次：资源池和虚拟服务产品。因此，操作也应该分为2个部分。如果你有足够的技术人员，你应该指定不同的技术人员来管理每一个层。如果没有，当使用每一层时，你应该确保管理员和技术人员已学会各种相关的技能。每一层都有不同的责任。例如，资源池（Resowrce Pool，RP）现在只不过是物理资源，包括了服务器、网络设备和共享存储。管理这些资源的人不必与最终用户进行互动，这些应该由管理虚拟工作负载的人来做。最终用户不应该与你网络中的交换机和路由器的进行任何的互动，如果出现这种情况，为什么他们必须要与构成资源池的服务器进行互动？
　　组织必须依靠它们的企业体系结构来为它们经营的业务提供完整的IT服务。但在企业体系结构的内部，所以操作体系结构必须支持体系结构中的所有其他元素（见图3-10）。如果操作体系结构与你通过虚拟化为企业体系结构带来的改变没有同步，那么你的虚拟化项目将会崩溃。请确保你从一开始就参与操作，以确保他们认识到虚拟化对IT各个方面的影响。
　　图3-10　操作体系结构为所有其他的体系结构提供支持
　　注意：要了解更多有关企业体系结构的详细信息和它们如何与操作互动，请访问www.reso-net.com/articles.asp？m=8#f并点击页面中的“Architectures.”。
　　引入虚拟化带来的改变是深远的。与VSO相关的活动需要多个不同的任务。安全上下文也是不同的。你的主机服务器可以成为一个高度安全的基础结构的一部分，因为只有管理员需要与其进行互动。你的VSO必须比较宽松，因为最终用户和管理员都必须与其进行互动。
　　注意：超过150个有关RP和VSO管理任务的列表，请参阅Windows Server 2008：The Complete Reference by Ruest & Ruest（McGraw-Hill，2008）。
　　虚拟机管理的重点
　　此外，虚拟机管理带来了突出的问题。因此，你需要将检查管理结构，并且在这做这件事时，当你正在寻找新的管理工具时，你将需要提出正确的问题。例如，请考虑下列问题：
　　▼如何跟踪和更新虚拟机源镜像？
　　■如何跟踪虚拟机快照？每个虚拟机可以包含最多512个先前状态的快照。如果你有1000个虚拟机，那么这可以添加相当数量的快照。
　　■如何移动、添加和更改（MAC）跟踪，特别是虚拟机从一台主机动态移动到另一台的时候？
　　■如何准备和部署虚拟工作负载策略？策略可以包括分配给一个虚拟机的资源类型，把资源优先分配给一台虚拟机而放弃其他，一天中哪个时段虚拟机必须有权访问核心资源等等。
　　■应用程序和虚拟机之间有特殊的依赖关系吗？如果在虚拟环境中运行一个多层次应用程序，连接前端Web服务器到后端数据库，那么你必须注意虚拟机之间的依赖关系，你的管理工具也是一样。
　　■资源池和虚拟服务产品之间如何进行安全管理？什么样的隔离是适当的？是否要加密资源服务器的所有通信以保护密码？
　　■当虚拟机或主机出现问题时，工具会提供怎样的故障诊断支持？该工具可以查明你所面对问题的根本原因吗——物理或虚拟或两者兼而有之？
　　■这个工具具有完整功能的吗？它是否提供一站式的服务？它可以管理虚拟化的各个方面吗？
　　■对于资源池和VSO的管理，你是否应使用同一个工具？也许一个工具的隔离将有助于单独保护2个基础结构。
　　▲工具是无关管理程序（hypervisor-agnostic）方式吗？它可以随着你的需要扩展吗？你是否会因应用程序的支持策略而实施新的hypervisor？你的工具可以适应这些更改吗？
　　不是只有你一个人在寻找合适的工具。大多数迁移到虚拟化的管理员和负责人也是一心想着找到一个同时支持物理和虚拟世界的系统管理工具。Ziff-Davis Research在2008年2月18日发布的一项调查说明了管理员期待工具可以解决某些特定的管理问题（见图3-11）。
　　图3-11　管理虚拟机环境的工具应具有的基本功能
　　



　　3.4　依靠虚拟化决策流程图
　　现在，你已经为开始项目做好了准备。你对于虚拟化可以提供的帮助以及你应该如何进行有了充分的了解。虚拟化的每一层将给你的数据中心带来不同益处。但是，你需要一个结构化的方法来实施虚拟化的3个核心方面：服务器、桌面和应用程序的虚拟化。为此，你需要一个特定的决策过程（见图3-12）。这个流程图可以解决每个执行方面问题，使用它来完成你对业务需求的关联。正如你所见，它说明了业务的实现是在后端服务器还是在前端桌面，然后基于你想要如何解决此需要而进行处理。
　　图3-12　虚拟化决策过程
　　本书的其余部分将通过此流程图来帮助你了解如何处理该过程的每一个方面。首先，你需要准备好你的物理基础结构，这是在第4章、第5章和第6章中要讨论的问题。其次，为了支持物理服务器整合和桌面集中化管理，需要实施服务器虚拟化，这是第7章和第8章要讨论的问题。再次，一旦你的服务器基础架构准备妥当，就可以通过第10章的指引来进行桌面虚拟化迁移。最后，第11章和第12章将讨论应用程序虚拟化与非永久性虚拟桌面的概念。其余各章将讨论安全性和业务连续性，从而完善你的虚拟基础架构和动态数据中心。
　　



　　第二部分　构建你的虚拟化基础架构
　　第4章　执行全面的分析
　　如你在第1章中所见，有很多理由值得你将服务提供由物理基础架构迁移到虚拟基础架构。全球范围内的传统数据中心都面临着类似的问题。根据Network World在2008年1月7日发布的分析报告，数据中心的电力和冷却成本正在直线上升，需要受到控制（见图4-1）。此外，所有的数据中心管理人员都一致同意：
　　图4-1　直线上升的电力/冷却成本的示例
　　▼物理服务器占用了太多的空间
　　■物理服务器未被充分利用、有时候利用率只有5%~15%
　　■物理服务器产生了太多的热量
　　■物理服务器需要消耗越来越多的电力
　　■物理数据中心需要复杂的业务连续性解决方案
　　■停机时间是一个持续的问题，必须消除此问题
　　▲硬件管理十分复杂，必须简化
　　所有这些问题的答案当然就是虚拟化。对IT基础架构进行虚拟化转换，有望在为组织提供相同的服务时提高物理服务器的工作负载达80%以上。
　　因此，虚拟化对于服务器的销售有着直接的影响。IDC的研究预计未来3年服务器的销售额将削减450000000美元。最初，IDC预计到2010年服务器的销量会增加61%，但现在的预测却是减少31%。
　　组织发现收支平衡点是每台主机服务器需要承载3个虚拟机，并且至少有15台服务器需要进行物理整合才能抵消虚拟化的实施费用。虽然很多人都使用机架安装服务器来进行这种整合，但其实使用刀片服务器也是一个可行的选择，因为一旦刀片机箱架设好，它们更容易实施。组织推行虚拟化项目可以获得的一些益处（见图4-2）。
　　但是迁移到虚拟化并不是一个简单的项目，必须小心处理。第2章和第3章强调了实现虚拟化的五步过程中的两个方面：第一，发现；第二，硬件最大化。这两个方面对于项目的成功都是极为重要的。发现，通过为改变提供投入，推动了规划进程；硬件最大化，使你可以创建支持新的虚拟化服务产品的硬件基础。在本章和第5章中都会讨论到这两个方面。
　　图4-2　为什么要实施服务器虚拟化（来源：Network World，2008年1月7日）
　　



　　4.1　开始分析
　　准备物理服务器时，应该做的第一件事是分析IT环境以确定在迁移到虚拟化之前是否有需要改善的地方。理想的情况是，所有的物理服务器都比较新，并包含了合适的处理器——具有硬件虚拟化功能。对Intel来说，这是一个采用了虚拟化技术（Virtual Technology，VT）的处理器或者一个包含64位扩展内存技术（EM64T）的处理器。对AMD来说，这意味着一个启用了AMD-V技术的处理器。在评估服务器时要非常小心，因为如果它们没有包含这些功能，就不能运行某些hypervisor。例如，你将不能在上面运行如Microsoft Hyper-V或者Citrix XenServer这样的hypervisor；如果处理器不支持启用VT，那么Citrix或者Microsoft的虚拟化引擎就不会加载。没有hypervisor，就没有虚拟机。
　　在某些情况下，它也许只是获取适当的基本输入/输出系统（Basic Input/Output System，BIOS）更新的问题，就像AMD处理器一样，因为所有的AMD处理器都包含了AMD-V，但如果系统没有运行适当的BIOS版本，那么它可能就无法启用。BIOS来自系统厂商如HP或Dell，所以你可能需要与他们联系以获取更多的信息。至于Intel，则简单得多；如果你的处理器没有包含EM64T，它只是不会以高性能运行hypervisor，并不需要转移到另一项任务或者被替换掉。注意：一些早期的第一代AMD-V芯片不能工作于所有需要硬件协助的hypervisor上。在你购买系统之前，请务必向hypervisor厂商确认。
　　AMD提供了一个免费的实用程序，用于验证你的处理器是否可以运行hypervisor。虽然这个实用程序主要用于Microsoft的Hyper-V（见图4-3），但其目的是检查处理器上是否启用了AMD-V；如果是，处理器将可以工作在任何hypervisor上。
　　注意：要获得这个AMD实用程序，请访问www.amd.com/us-en/Processors/TechnicalResources/0，30＿182＿871＿9033，00.html。
　　图4-3　评测一个AMD处理器是否能够运行Hyper-V
　　此外，如果想要发挥最强大的虚拟化功能，必须确保服务器的处理器使用相同的步进，如实时迁移——将虚拟机从一台主机迁移到另一台的同时，虚拟机仍然保持运行并不间断为最终用户提供服务。对于VMware，此功能称为VMotion；对于Citrix XenServer，此功能称为XenMotion。这一过程的基本原理是从一台物理服务器上复制所有的内存进程到另一台服务器上。由于内存的内容包含了处理器指令集，将这些内容的进程从一台机器迁移到另一台机器只会在2个处理器可以处理相同的指令集的情况下才能进行。基于这个原因，这一过程在Intel和AMD的处理器之间是不能进行的，并且在许多情况下，不能在2个Intel处理器之间进行，除非它们有相同的步进。CPUID开发站点包含了一个实用程序CPU-Z.exe（见图4-4），可以用来评测CPU步进的值。在任何想要保留作为承载设备的服务器上运行此实用程序，以确保主机系统群组中使用了匹配的处理器家族。
　　图4-4　评测CPU步进值
　　注意：Intel的“flex migration（灵活迁移）”解决了Intel-to-Intel的迁移问题。AMD也有类似的功能。两者都是依靠hypervisor来支持“feature disable bits（功能禁用位）”，这将关闭群集中所有节点上都不支持的那些更高级的硬件辅助虚拟化功能。使用hypervisor可以配置此功能。如果这对你很重要，在选择hypervisor之前，请确保你已经查明hypervisor支持此功能。例如，Microsoft Hyper-V的第一个版本并不包含此功能。但是，VMware通过一个称为CPU Masking（CPU掩蔽）的功能解决了这个问题——属于其增强VMotion兼容性（EVC）设置的一部分。实际上，可以使用这个功能支持在Intel处理器和AMD处理器之间实时迁移虚拟机。
　　注意：要获取CPU-Z实用程序，请访问www.cpuid.com/cpuz.php。
　　但是，服务器验证并不是规划过程中需要包括的唯一行动。此外，你必须评估将会影响虚拟化的每一个硬件层，包括：
　　▼存储　你必须在存储级别执行2项行动。首先，可以使用工具，如Windows文件系统资源管理器——在Windows Server 2003 R2和2008中可用——以确定存储容器的内容的状态：直接连接，网络连接和存储区域网络。其次，你应该依靠此进行分析，以确定哪些文件可以进行存档。第二项行动是寻找可以作为虚拟机容器重复使用的存储。理想的情况是，当承载虚拟机时，存储将被共享。为此，你必须使用来自于你的存储厂商的工具。
　　注意：有关Windows文件系统资源管理器的详细信息，请参阅http://technet2.microsoft.com/windowsserver2008/en/library/d6d480ca-18ec-4dee-aafc-a9e7971038cf1033.mspx？mfr=true。
　　■网络带宽　应该确定当前网络带宽的使用情况。依靠工具，如Windows网络监视器、在网络接口卡使用率级别上的Windows性能监视器，或者第三方工具。你希望能够识别可用的带宽是否可以支持额外的工作负载，如实时虚拟机迁移，或者甚至它可以通过协议，如互联网小型计算机系统接口（Internet Small Computer System Interface，iSCSI）支持存储通信。
　　■电力和冷却　应该执行电力和冷却审计，以确保数据中心基础架构可以应付虚拟基础架构的迁移。审计有2个用途。首先，它将作为公用事业公司将你的组织迁移到虚拟基础架构潜在折扣的起始点。其次，它将确定与你当前基础架构有关的任何问题。你可以使用American Power Conversion（www.APC.com）公司提供的工具确定数据中心基础架构中可能出现的问题。
　　▲硬件整合　应该扫描你的网络以确定可能的硬件整合候选者。为此，可以使用在五步过程的第一步中所描述的由VMware、Microsoft或其他厂商所提供的工具。
　　注意：企业级的整合工具可以完成所有这些事情。然而，像CiRBA的配置智能技术工具（www.cirba.com）这样的工具，虽然它们可以支持所有的这些功能，只有在订购的基础上才可以使用，把特定的成本附加到在你的网络中运行的每一台物理服务器上。
　　要尽可能地重视这4项调查。每项调查的数值将取决于你的基础架构的大小。例如，如果你只有25台物理服务器，那么电力和冷却的审计不可能与具有2000台物理服务器获得同样多的受益，但了解当前的系统是否可以应付规划的改变仍然是非常重要的。
　　请记住，如果没有以正确的步伐开始你的虚拟化项目，那么当你的物理系统无法应付放置在它们上面的虚拟机负载时，将来的某个时候你将会遇到问题。为了避免发生这种情况，现在就进行深入的分析吧。
　　注意：许多组织在进行整合分析时只关注性能而不考虑非技术性限制，直到整合项目时才发现问题。安全分区、站点位置、部门所有权、服务级别协议（SLA）以及产品许可等都可能影响最终的整合计划。请确保将它们包含在最初的分析中。
　　



　　4.2　执行存储整合调查
　　如前所述，对于虚拟化存储验证有2个步骤。首先，要扫描所有存储以确定哪些内容可以从基础架构中移除。每当出现空间不足的问题时，太多的IT部门只是继续增加存储，并没有分析他们存储的是什么内容。例如，当一个用户通过电子邮件发送了一个5MB的Microsoft Power-Point幻灯片给其他10个人时，通常最终会存放演示文稿的多个副本在存储系统中。如果所有的用户都在同一台Microsoft Exchange邮箱服务器上，那么至少Exchange会在电子邮件系统中删除这10个重复的副本，但一旦用户是在其他的邮箱服务器上时，就会获得更多的副本。此外，有些用户同时还将演示文稿复制到文件系统中，因此创建了更多的副本。最后，5MB的演示文稿可以很轻易地就占用了100MB的空间。
　　当迁移到虚拟化，你希望获取能够支持重复数据删除的存储技术，不是在备份级别，而是在存储级别。虚拟机文件的大小经常会达到吉字节并占用大量空间，但是如果你的存储引擎可以删除它们存储的重复内容，就可以在你的磁盘底层结构上节省大量的空间。
　　这就是为什么文件服务器分析是如此的重要。如果可以恢复这些空间，删除重复的项目，否则将未使用的数据存档，那么就可以为其他用途释放存储空间。重申一遍，有多个工具可以帮助你执行此任务。从Windows Server 2003 R2版本以来的Windows Server包含了一个文件系统资源管理器（File System Resource Manager，FSRM）。这个引擎可以扫描所有的文件服务器，以多种不同的方式对存储进行分类。为了让此工具可以工作，每台文件服务器必须运行Windows Server 2003 R2或者2008并且已在其上面加载了FS-RM引擎。可以在群组中的任何服务器上运行存储报告，并且可以提供数据存储方面的各种综合信息（见图4-5）。
　　图4-5　使用FSRM准备存储报告
　　还有多个其他的工具可用于生成存储报告。例如，存储提供商EMC提供的File System Assessment（文件系统评估）工具，是咨询公司最常使用的工具，它可以帮助你确定你到底有多少存储——直接连接（DAS）、网络连接（NAS）或者存储区域网络（SAN）——多次存储相同的信息，造成空间浪费，或者更糟糕的是存储不再使用的信息。
　　评估的第二部分是确定存储类型。正如第3章所述，为了支持当今可用的虚拟化引擎的最高级功能，并为你的虚拟工作负载提供高可用性，你最需要考虑的是以某种方式共享存储。但是，并不是所有的虚拟工作负载都需要共享存储。例如，你可以确定在某类环境中某些中断是可以接受的。对小规模的网络，测试和开发环境通常运行在DAS上，因为共享存储的成本对于这些工作负载显然是不合理的。此外，小型的办公室可以选择基于DAS来创建虚拟基础架构。如果将每个直接连接容器的内容复制到其他容器中，以确保在共享高可用性配置的主机之间的虚拟机的内容是同步的，那么这是可行的。如LeftHand Virtual SAN Appliance（VSA）这样的产品可以让你将内容从一个DAS容器复制到另一个容器。VSA现在支持VMware，当你阅读这本书的时候，将可能会支持其他主要的hypervisor。你可以在www.lefthandnetworks.com上找到它。
　　注意：HP在2008年10月收购了LeftHand Networks。
　　中型的办公室可以选择NAS设备，因为它们可以提供文件共享服务，并且可以连接多台主机。大型数据中心绝对应该选择SAN，因为它们要求存储阵列提供顶级的性能。
　　了解使用了哪些类型的存储、有多少存储可用以及系统是如何连接到存储，对于主机服务器基础结构的准备将会有极大的帮助。虚拟机文件往往会很大，并且需要快速、高效的存储才能运行其最佳状态。
　　



　　4.3　检查现有的网络带宽
　　使用虚拟化，网络的使用情况也会改变。在许多情况下，组织将会选择使用iSCSI连接到共享存储容器，而不是使用更传统的通过主机总线适配器（Host Bus Adapter，HBA）的光纤通道连接。在这种情况下，所有的存储通信将在网络上传输，比起单独的网络资源需要更多的网络带宽。
　　此外，在一个系统上运行的每个虚拟机必须有某种类型的网络连接。对于虚拟机，虚拟化技术支持虚拟机隔离、虚拟机仅能连接到主机服务器或者虚拟机的全面连接。后者在主机服务器上需要额外的网络接口卡。如果一台主机同时运行30多个虚拟机，那么你必须确保有足够的网络接口卡（Network Interface Card，NIC），以支持这些工作负载。然而，你还必须确保你当前的基础结构——交换机、路由器、集线器——在网络层支持额外的工作负载。在某些情况下，你可能需要升级数据中心中的一些网络组件。重申一遍，这将取决于你计划在虚拟层运行的工作负载，因此这个分析与其他分析一样重要。
　　因此，当扫描当前的网络状态，应该尝试回答下列问题。
　　▼哪些服务正在运行以及它们需要多大的带宽？例如，如果你当前正在运行如Microsoft Exchange Server 2007或者SQL Server 2008，那么你可能已经在远程站点中设置了复制伙伴。增加工作负载的负担可能会使工作负载面临风险。
　　■将内存内容从一台主机服务器移动到另一台，将会使物理服务器以及网络受到严峻的考验。VMotion或者XenMotion这样的技术通常需要有它们自己的网络路径才能充分运行。你的基础架构准备好支持这些额外的数据流量了吗？
　　■如果你选择依靠共享存储并通过iSCSI访问存储，那么你的网络设备可以支持这些额外的负载吗？
　　▲你的交换机和路由器旧了吗？需要升级吗？还有富余的端口吗？这些问题的答案将有助于你准备主机环境时对网络级别的需求的评估。
　　



　　4.4　执行电力和冷却的审计
　　虚拟化和物理服务器整合最具吸引力的方面之一是潜在的电力节省。节省的电力是基于每台服务器来计算的。公用事业公司已制定了一条公式来计算潜在的电力节省：
　　表4-1说明了在公式中使用的值。
　　注意：要了解更多关于计算潜在电力节省的详细信息，请查看由VMware提供的白皮书《Virtualization：The Most Impactful Solution to the Data Center Power Crisis》；下载地址为www.vmware.com/files/pdf/Energy＿Efficiency＿WP.pdf。
　　根据IDC专家John Humphries（在2007年发布的数据），数据中心基础架构的状况是这样的：现在有超过1400亿美元的服务器容量，这相当于3年的服务器供应。在服务器采购上每花费1美元其电力支出平均为0.50美元。电力和冷却在整个行业范围的消耗超过290亿美元。空间也是非常宝贵的。服务器在数据中心的成本为每平方英尺1000美元、每台服务器2400美元，每个机架40000美元。运作成本为每花费1美元在新的基础架构组件上，就需要高达8美元的维护费用。当前的服务器管理比率是每个管理员管理20台或30台服务器。
　　必须要减少碳足迹，提升硬件的衍生价值。这就是为什么电力和冷却的评估是十分重要的。它们的作用表现在2个方面。
　　第一，让你了解你的基础架构可以如何迁移到虚拟化。
　　第二，可以从公用事业公司得到潜在的折扣参考。
　　许多组织从来不执行电力和冷却评估，可能是它们不清楚该以什么样的方式来进行评估。幸运的是，APC提供了多个免费的工具，可以在这种情况下提供帮助（见表4-2）。这些工具可分为3类。第一类是计算器，一旦为它们提供数据，它们将会提供估算成本。第二类是选择器，可以帮助你选择如何组织数据中心的内容。第三类是图解器，可以为你的选择和计算提供图解概述。每一个工具都十分有价值。
　　注意：想要了解更多有关APC TradeOff Tools（权衡工具）的详细信息，请参阅www.apc.com/prod＿docs/results.cfm？DocType=TradeOff%20Tool & Query＿Type=10。
　　数据中心碳计算器用于确定当前的碳足迹（见图4-6）。它依靠你提供的基于潜在方案的数据，描述了你的数据中心到底产生了多少二氧化碳（CO2），以及这相当于多少汽车的排放量。
　　图4-6　数据中心碳计算器（APC免费提供）
　　数据中心效率计算器还基于所提供的有关数据中心配置的输入数据，以帮助你确定整体设计和利用效率所处的水平（见图4-7）。这个计算器是用于验证和帮助你当前的数据中心配置尽可能高效。
　　图4-7　数据中心效率计算器（APC免费提供）
　　在你为数据中心规划基础架构改变时，数据中心资本成本计算器可以提供帮助（见图4-8）。
　　图4-8　数据中心资本成本计算器（APC免费提供）
　　如果你确定数据中心的设计达不到它的最高效率，那么你可以依靠此计算器来帮助确定哪些变化可以降低成本。
　　虚拟化能源成本计算器可能是这个组合中最有价值的计算器，因为它概述了基于虚拟化技术你究竟可以节省多少电力和冷却系统（见图4-9）。其最有价值的组件是图形化概述了对虚拟化账单的影响。请注意，你必须依靠第7章所述的信息正确确定服务器整合比率，因为不是所有创建的hypervisor都是同样的，每台主机不会支持同样多的虚拟机。
　　图4-9　虚拟化能源成本计算器（APC免费提供）
　　由于你将更改服务器和存储的配置以支持虚拟化，所以数据中心电力估算计算器将有助于确定这些新的配置对数据中心产生的影响（见图4-10）。可以依靠此计算器来帮助确定适合你的环境的最佳配置。
　　最后，数据中心排列式气流遏制系统选择器将帮助你为准备承载虚拟化基础架构的服务器机架确定最佳的气流遏制方法（见图4-11）。将它与数据中心电力估算计算器一起使用，可以帮助你确定最佳和最有效的机架配置。
　　虽然，你可能不习惯对数据中心进行分析，但这些免费工具使分析变得简单、直观。最低限度，你应该确定碳足迹、你数据中心的效率和虚拟化将会带来的潜在的节省。
　　注意：请记住你也可以依靠Microsoft Assessment and Planning Toolkit（MAP）（评估和规划工具包）来进行电力评估。
　　图4-10　数据中心电力估算计算器（APC免费提供）
　　图4-11　数据中心排列式气流遏制系统选择器（APC免费提供）
　　



　　4.5　依靠其他的工具
　　你还可以依靠其他工具来获取更多的信息。例如，VMware提供了一个免费的在线总拥有成本（Total Cost of Ownership，TCO）/投资回报率（Return on Investment，ROI）计算器，它将引导你完成有关你的环境的一系列问题，帮助你确定虚拟化项目的投资回报（见图4-12）。这个计算器非常有用，因为它可以帮助你为项目编排预算，确定潜在的项目时间表。
　　图4-12　VMware TCO/ROI计算器
　　注意：要了解更多VMware TCO/ROI计算器的详细信息，请访问www.vmware.com/products/vi/calculator.htm。
　　此外，Microsoft提供了多个其他的信息来源和工具，帮助你确定物理服务器整合提供的潜在的节省（见表4-3）。
　　在信息的3个来源中，对于数据收集最有用的是优化自我评估工具。它为评估提供了3个选项。Microsoft核心基础架构优化评估调查的重点是基本IT服务，如身份和访问管理、设备管理、安全性以及网络、数据保护和安全流程（见图4-13）。它对于基础架构的评估是非常有用的，可以帮助确定缺少的组件。
　　图4-13　Microsoft核心基础架构优化评估调查
　　Microsoft企业生产力基础架构优化评估的重点是生产力服务，如协作、统一通信、内容管理、商务智能和搜索服务（见图4-14）。它对于确定你的IT服务如何支持你的业务流程是非常有用的。
　　图4-14　Microsoft企业生产力基础架构优化评估
　　最后，Microsoft应用程序平台优化评估帮助你关注未来的增长和客户化开发、面向服务体系结构（Service-Oriented Architectures，SOA），数据管理、用户体验评估和商务智能（见图4-15）。这一评估为有定制要求的组织提供了价值。
　　图4-15　Microsoft应用程序平台优化评估
　　当迁移到虚拟基础架构时，这些工具的每一个都提供了更多的信息，让你更好地了解你现有的基础架构和服务以及你可以实现的潜在改变。
　　



　　4.6　执行服务器整合调研
　　实施项目的另一个极为重要的步骤是服务器整合调研。正如第2章中指出，你必须充分了解当前将迁移到虚拟化的服务基础结构。你必须在调研中确定以下组件：
　　▼提供特定服务的服务器类别
　　■应用程序和依赖关系之间的联系
　　■工作负载类型，专注于资源需求以支持特定的工作负载，关注它的内存、CPU、磁盘访问或网络访问
　　■工作负载的繁忙时间，以及繁忙持续时间
　　■工作负载计划，可以是每日、每周、每月或者甚至每半年
　　▲特别的工作负载需求，如自定义硬件、应用程序激活加密狗等
　　这些数值将帮助你规划如何将工作负载迁移到虚拟环境以及它们驻留的位置。虚拟化规划最重要的方面之一是虚拟工作负载安置——确保在主机上运行和管理的各种工作负载能够正确地使用主机服务器的资源。例如，如果其中一项工作负载在一大清早需要网络资源，那么你需要确保其他的工作负载不会争夺相同的资源。如先前所述，当你确定了工作负载的特性时，你就可以只需为此制订计划。
　　4.6.1　确定适当的性能指标
　　当你收集关于你的工作负载的数据时，如果你想要获得对将要转换的工作负载有一个正确的了解，你就必须要确定适当的性能指标。如果你的工作负载是运行在Windows上，那么你可以依靠工具，如性能控制台。它允许你定期捕获你的服务器执行情况的数据。性能控制台的优点是它支持对每个工作负载的单一层面的评估，包括CPU、内存、磁盘和网络资源。
　　你可以在所有服务器上创建一个自动跟踪资源使用情况的性能监视控制台。在你监控的每台服务器上，控制台需要访问权限才能运行性能计数器，因此最好使用管理权限启动性能监视器控制台（在Windows Server 2008中，打开Server Manager（服务器管理器）—Diagnostics（诊断）—Reliability and Performance（可靠性和性能）—Monitoring Tools（监视工具）—Performance Monitor（性能监视器），然后进行如下操作：
　　1.在工具栏中使用加号来添加计数器。
　　2.在Select Counters From Computer（从计算机选择计数器）字段中，输入你要查看的服务器的名称。请记住，要使用通用命名约定（Universal Naming Convention，UNC）的名称，例如＼＼ComputerName。
　　3.选择性能对象和计数器（点击向下的箭头查看计数器），然后点击Add（添加）。
　　4.在其他你要包括的服务器上重复以上步骤。完成后点击OK（确定）。
　　5.既然所有的服务器已添加，那么就从操作窗格中使用More Action（更多操作）—New（新建）—Data Collector Set（数据收集器设置）。
　　6.命名此收集为“服务器监控”，单击Next（下一步），将它保存在默认位置，再次点击Next（下一步）。
　　7.在下一个对话框中，点击Run As（运行为）下面的Change（更改），为此收集添加适当的凭据。单击OK（确定）。
　　8.点击Save（保存），点击Close（关闭），并点击Finish（完成）。
　　9.要运行收集器，移动到Server Manager（服务器管理器）—Diagnostics Reliability And Performance（诊断程序的可靠性和性能）—Data Collector Set（数据收集器设置）—User Defined（用户自定义）。右键点击你的收集器集，并选择Start（启动）。
　　10.定期运行它来审查你的服务器上的资源使用情况。
　　对于网络中的每台服务器，监控中的项目应该包含以下元素：
　　▼逻辑磁盘，可用磁盘空间（%可用逻辑磁盘空间）
　　■逻辑磁盘，磁盘时间（%逻辑磁盘时间）
　　■逻辑磁盘，磁盘读取和写入
　　■逻辑磁盘，磁盘队列（平均磁盘队列长度），默认情况下启用
　　■内存使用率（可用内存字节）
　　■内存分页（每秒内存页），默认情况下启用
　　■网络接口（当前带宽）
　　■网络接口（输出队列长度）
　　■网络接口（数据包/秒）
　　■分页文件活动（%分页文件使用率）
　　■物理磁盘，磁盘队列（平均磁盘队列长度）
　　■物理磁盘（分裂IO/秒）
　　■处理器使用率（%处理器时间），默认情况下启用
　　■处理器中断（每秒处理器中断）
　　■服务器页面缓冲池（服务器缓冲池分页高峰）
　　■服务器服务（每秒服务器总字节）
　　■服务器工作项目（服务器工作项目短缺）
　　▲服务器工作队列（服务器工作队列长度）
　　使用Explain（说明）按钮来了解每一项设置所指的是什么。持续监控这些设置以确定你的服务器及其工作负载是如何执行的。一个适当的时间表将包括以下安排：
　　▼平日繁忙时间，如上午7：00点至9：00点、上午11：00点至下午2：00点、以及下午3：30点至6：00点
　　■平日非繁忙时间
　　■周末不同的时间，例如星期六下午、星期天早上和星期天下午
　　▲周日夜晚，你的批处理作业运行的时间
　　运行计划的过程至少要有一个月。该计划还应包括你的业务周期。如果你有特别的业务高峰期，你应该在你的评估中将它们考虑在内。将此分析数据与其他分析工具的数据结合到一起，如第2章中的讨论。
　　4.6.2　解读结果
　　你所收集的数据将包括多种不同类型的输出。解读此数据将取决于数据本身的来源，例如：
　　▼从Microsoft MAP收集的数据可以直接解读，因为它提供了为物理服务器整合目的而设计的图表和报告。
　　■从VMware的2个当中的任何一个工具中收集的数据——Guided Consolidation（导向整合）或者Capacity Planner（容量规划器）——也可以直接解读，因为它们也是为物理服务器整合的目的而创建的。
　　▲从Windows性能控制台收集的数据，为了提供适当的结果，通常需要经过额外的处理。请注意下列各个项目：
　　■如果你的平均磁盘队列长度是3个或者更多，说明你的磁盘出现使用过度的情况，除非在服务器中没有足够的内存或者是由虚拟内存交换引起的磁盘抖动。
　　■如果%Processor Time（处理器时间百分比）持续偏低，并有很多的空闲时间，那么就说明处理器未被充分使用，除非有其他导致处理器等待指令的瓶颈。
　　■如果Memory Usage（内存使用率）很高，Page File Swapping（页文件交换）很频繁，就说明服务器没有足够的内存，当它被虚拟化后将需要添加更多的内存。
　　■如果Network Interface（网络接口）总是持续繁忙，说明此工作负载是网络密集型的，一旦它被转换，将需要多个虚拟网卡。但是，请注意此数值取决于源物理网卡的速度。如果将物理机迁移到虚拟机，而这个虚拟机是驻留在使用10GB的以太网网卡的主机上，而原始的机器是在100MB的网卡上运行，那么此问题可能就会自行消失。
　　将所有的数据整合到一起尝试创建你的工作负载的综合图像。还要将你自己对业务流程的理解添加到整体报告中。最后，要注意自定义硬件组件，因为它们在工作负载的转化过程中将需要特殊的方法。
　　你的目标是创建一个基本整合评估（Basic Consolidation Estimate，BCE），将你所有的工作负载进行分类，并确定如何以及何时会进行转换。
　　



　　4.7　再次使一切合理化
　　现在，你已经有了评估信息，你可以依据你的服务器清单确定哪些服务器可以合理化、哪些服务器可以退役，哪些需要被更换。没错，一旦物理服务器清单收集完成后，第一步应该是进行合理化。你应该使用你的分析来确定：
　　▼CPU利用率很低的服务器。所有这类服务器都是虚拟化的候选者。
　　■那些在“安眠”的服务器。这类服务器可能是移除的候选者。
　　■可以随便关闭的服务器。这类服务器是移除的另外的候选者。
　　■虚拟化最佳候选者的服务器，其硬件将不会作为主机服务器重复使用。这将包括大多数的工作负载。只有唯一的工作负载不可能受益于今天的虚拟化。
　　▲作为潜在虚拟主机候选者的服务器。这应该包括具有相似处理器能力的最新服务器。
　　这将帮助你对所有的服务器进行分类。你应该创建服务器的批次，并从这些批次中基于转换的复杂程度，从容易到中等到困难来确定最佳的虚拟化候选者。最后，你可以摆脱任何不合理东西，使一切合理化。别忘了最容易管理的服务器是不存在的。此外，请记住你在物理世界中需要拥有服务器是由于其准备的复杂性，而在虚拟世界中，你要创建挥发性的服务器则容易得多。挥发性服务器是指一种只需在短时期内使用，为特定的基于时间限制的目的而创建的服务器。一旦目的完成，服务器可以完全消失。虽然在物理世界中不能这样做，但在虚拟世界中是绝对有可能的。因此，你可以移除一些为了“以防万一”而被保留的物理服务器。
　　提示：既然你要迁移到一个虚拟的或动态的数据中心，你将最有可能需要进行物理到虚拟（P2V）的迁移。例如，Microsoft系统中心虚拟机管理器（System Center Virtual Machine Manager，SCVMM），位于www.microsoft.com/systemcenter/scvmm/default.mspx，具有捕获物理计算机映像并将其转换为虚拟机的能力。这对于测试和准备新的虚拟服务或产品（VSO）环境是非常有用的。如果你是基于一个非Microsoft的hypervisor，例如由VMware或Citrix提供的hypervisor，那么你可以使用其他的迁移工具。VMware提供了免费的VMware Converter（www.vmware.com/products/converter）；Citrix还在XenCenter控制台中包含了一个转换功能，但它也可以依靠SCVMM，因为它支持与Microsoft相同的虚拟机格式。
　　今天，服务器提供的是一种功能，而不是一种产品。许多组织在使用Windows的早期版本时，都是采用单实例的服务器。这种方式在Windows NT时期就已经开始。尽管Windows NT本身是一个稳固的产品，但组织在它上面执行许多操作或应用程序令它变得不稳定。通常，处理这种不稳定状况的最好办法是指定服务器专用于一个特定的角色。这种方法的另一个原因是基于项目的硬件购置——每次新项目需要服务器时，都将购置它自己专用的服务器，并且会添加一台或多台新的单一用途的服务器到生产网络中，并创建它自己的测试和开发环境。不幸的是，单一用途服务器的工作方式，增加了组织中的服务器数量，造成服务器迅速扩散。很多现有的服务器根本没有充分使用。
　　整合涉及较少数的、速度更快的服务器。较少的服务器意味着管理更加简单。你可以提高服务级别，因为少数集中式服务器的操作比起多台分布式服务器的操作更容易维护。由于服务器倾向于集中的和提供更方便的物理访问，因此减少了停机时间。因为大部分代码驻留在服务器本身，应用程序可以更快速地部署。因为涉及较少的物理元素，所以更容易标准化。而且，使用虚拟服务器可以轻松地将服务器的一个虚拟实例从一台物理主机移动到另一台，提供了动态响应以满足增加的业务需求。
　　整合有4个理由。
　　▼集中化　重新放置现有的服务器到较集中的站点。
　　■物理整合　将多数较小型的服务器替换为更少的、功能更强大的服务器。
　　■数据集成　将多个分布式数据库整合成一个单一的数据仓库。
　　▲应用集成　将多个应用程序迁移到更少的、功能更强大的服务器上。在这种集成发生之前，应用程序必须具有一定程度的密切关系。
　　通过使用虚拟化技术，可以在虚拟机中安装多个操作系统实例，能够更好地利用单一服务器的硬件。平均来说，你将能够在每台物理主机上运行10个到20个的虚拟机，当然，具体要取决于物理主机的配置以及你选择的hypervisor。
　　请记住，默认情况下，虚拟化项目是一个物理服务器整合项目。但你可以通过勤奋和努力，凭借合理化把它变成一个服务器整合项目。你可以摆脱任何不合理的事情。当你认真考虑你所运行的一些工作负载时，这是多么的有意义。如果可以的话，请尝试合理化你虚拟服务器的数量，特别是多个开发和测试环境，以及只运行单一工作负载的服务器。
　　



　　第5章　建立资源池
　　一旦你完成了分析，准备好进行下一步，你就可以了解概念并建立你的资源池。你将需要根据实际上需要虚拟化什么、将需要从什么地方开始，以及将从哪里开始着手虚拟化来仔细地进行规划。为此，你将很有可能需要更新你的网络、存储、也许还涉及服务器基础架构。然后，当你觉得自己已经准备好了，你将要建立一个实验室，准备好开始实际地虚拟化你的基础架构，接下来，当然是进行深入的测试。
　　你的资源池的组件基于多个因素将会有很大的差别。少于50台服务器的小型组织不需建立太昂贵的基础架构，也可能不需要较大型组织寻求的高可用性级别。中型组织将会关注更可靠的基础架构，大型组织将想要建立最好的基础架构。一切都取决于业务需求和预算。就算是低预算的项目仍可以向前推进，并达到令人惊喜的结果。那些有适当预算的项目将能够迁移到最新的技术，并创建非常有弹性的基础设施。
　　此外，你选择的hypervisor将会影响你将如何进行下一步。不是所有的hypervisor都是一样的，它们有显著不同的特性。本主题将在第7章中进行深入的研究，在你为你的资源池配置做出最终的选择之前，你要仔细研究这一章。正如第1章所述，你很有可能最终会使用多种hypervisor，除非你是一家小公司或者你已经可以完全控制你选择的技术。后者是很少看到的，来自其他人的政治压力常常会影响技术的选择，即使他们的论点有很多不足之处。因此，许多组织最终运行在没有真正配合得很好的混合基础架构上，但他们别无选择。无论有没有政治压力，充分利用你的选择并尽可能多地验证它们。同性质的基础架构总是最容易进行管理和保护，但如果你发现你必须要建立一个异构的环境，那么选择合适的管理工具就变得非常关键。第16章对此任务的论述将会对你有很大的帮助。
　　



　　5.1　规划和准备
　　一旦得到清单，你将要执行的最重要的任务之一是确定如何进行你的虚拟化项目。这涉及需要确定如何进行虚拟化和以何种顺序进行虚拟化。这将构成你的虚拟化项目的结构。从小处着手开始逐步建立，直到你想要虚拟化的一切都实现了虚拟化。
　　5.1.1　什么适合虚拟化
　　在进行虚拟化规划时，第一个要问的问题就是我可以虚拟化哪些服务器？这个答案很简单。大多数服务器的工作负载，甚至那些需要定制的硬件，都可以被虚拟化。但是，也有例外。
　　▼使用超过8个CPU内核的服务器就可能会带来挑战。如果你有物理工作负载运行在超过8个CPU内核上，事实上你将无法虚拟化它们，这是因为虚拟机处理的最大处理器内核数量是8个。但是，你可以通过以下2种方式中的任何一种绕过这一限制。
　　■如果你的物理服务器显示出实际上并不依赖超过8个内核，那么你可以轻易地虚拟它。
　　■如果你的物理工作负载当前已经使用了所有的内核，有一个可能的方法就是将它运行的功能拆分到多个虚拟机中，让你无论如何都可以虚拟化此工作负载。例如，一台运行着Microsoft Exchange 2007并可能使用了超过8个内核的服务器，但是，由于Exchange是设计为可以运行最多4个不同的工作负载，可以在一起或分开，那么你可以把工作负载拆分到多个虚拟机上，让你得以虚拟化此系统。
　　■服务器利用超过85%以上的物理资源可能会带来挑战。重申一遍，Exchange Server提供了一个很好的例子。如果你的Exchange服务器在物理系统上占用了大部分的资源，实际上你可以选择保持不变。然而，将它虚拟化，将可以为你带来多个益处——从物理约束中解放出来、系统保护的合理复制、简单的业务连续性——为此你可能无论如何都想要虚拟化此系统，甚至是把它转换为在一台主机上运行的唯一的虚拟机。
　　▲需要定制硬件的服务器，如通用串行总线（Universal Serial Bus，USB）加密狗或者调制解调器可能很难实现虚拟化。但是，有技术支持这些设备的虚拟化。
　　■USB端口可以被虚拟化，因为大多数现今的hypervisor都将支持虚拟USB端口。如果你的应用程序需要USB端口显示为本地设备，以便它为了许可用途可以识别所需的加密狗，那么你也可以转用定制硬件，例如，Digi的AnywhereUSB，通过Internet协议（IP）连接为虚拟机创建专用的USB端口。要想了解更多的信息，请访问www.digi.com/products/usb/anywhereusb.jsp。
　　■呼叫中心服务器、传真服务器以及路由器和远程访问服务器也面临挑战，因为它们都需要访问多个调制解调器。虽然hypervisor可以虚拟串行端口，但仍然需要将它们连接到调制解调器。为此，可以依靠2种产品。Virtual Modem Pro将创建虚拟化的IP调制解调器。要了解更多，请访问www.eltima.com/products/virtual-modem-pro。Digi也提供了可以用于创建多个调制解调器接入点的串行卡。要了解更多，请访问www.digi.com/products/serialcards。
　　正如你所见，要百分百地虚拟化你的工作负载将有很大的挑战，但这些是可以被克服的。请记住，如果你需要特殊的硬件，你将需要创建至少2台主机服务器以支持此角色，为依赖于它们之上的服务提供高可用性。
　　5.1.2　替换过时的硬件
　　当你提出哪些可以进行虚拟化的问题时，答案仍然很简单：一切都可以。但是，你需要以具体的步骤开始。
　　▼从那些长期需要重新配置的服务器开始。这些通常是测试或开发环境，因为它们需要定期重新配置或甚至重新购置。虽然在物理世界中这些任务是很艰巨的，但将它们变成虚拟世界中的快照，你就可以轻易地复制虚拟机，并且你可以使用可撤销磁盘，这使得重新配置变得轻而易举。考虑使用一些你现有的硬件作为这些工作负载的主机，因为它们不需要像生产系统所需要的高可用性级别。
　　■然后转向那些容易实现的目标。这包括“过时硬件”，有故障的硬件，或者低利用率的服务器。这通常包括的工作负载，如文件或打印服务器、Web服务器和小部门的应用程序。甚至自行开发的应用程序都是虚拟化第一阶段的极佳候选者。此外，域控制器或身份认证服务器也是虚拟化理想的候选者，因为它们的运作模式提供了内置冗余服务的许多小型服务器。
　　■下一步，关注那些高风险的旧式服务器——运行着应用程序但基于某些原因不能升级，但必须在较旧的操作系统上运行的服务器。但愿你不是仍然在运行那些过时的操作系统，如Windows NT，但如果你是，没有比虚拟化Windows NT更好的Windows NT了。一旦你创建了一个虚拟化的NT，在按需的基础上要复制它绝对比以前容易得多。建议在物理基础上尝试这样做。旧式应用程序通常是必不可少的业务，但也往往由于其本身的性质成为利用率偏低的工作负载。它们是虚拟化极好的候选者。
　　▲把复杂的工作负载放到最后。那些占用大量资源的工作负载，如电子邮件服务器、数据库服务器或者群集服务器，这些服务器的转换更加困难，因为转换它们需要更高级的虚拟化平台知识，并且它们通常提供的都是关键的服务。建议使用较小型的工作负载来进行第一次实践，当你对你所使用的hypervisor已经完全掌握后，才转移到更复杂的工作负载。这些工作负载通常还会包括有定制硬件要求的服务器。
　　请确保你了解每个虚拟化的工作负载对每秒输入和输出（Input and Output Per Second，IOPS）的要求。这可以让你创建合适的虚拟机配置以支持你所转换的应用程序。
　　5.1.3　选择实施方法
　　你可以选择几种不同的实施方法。首先，当组织倡导推行虚拟化时，他们将需要许多外部的帮助。由于这是一个未经测试的领域，并且涉及各种不同的现有产品的知识，因此许多组织选择通过合作伙伴来实施虚拟化。今天，情况已经完全不同。事实上，你要有本书在手，表明虚拟化的知识对于你来说是近在咫尺。
　　不过，仍然有3种不同的实施方案。
　　▼你可以独自完成一切，学习不同的虚拟化技术，选择一个平台，然后通过分阶段的方法逐步向前推进。
　　■你可以雇佣一家合作伙伴为你提供前期推动。前期推动程序是非常有用的，因为它们为你开展项目之前预先对你做好相关的培训，使得项目的不同阶段可以更容易实现。在前期推动结束后，你已经拥有配置好的主机系统、一台示范用的虚拟化服务器和为你个人提供了一些基本的培训。
　　▲你可以将整个项目外包。此模式使用外部资源来执行该项目的每个阶段。许多组织觉得使用这种方法更为合适，但请记住，如果你选择这种模式，你选择合作伙伴一定要非常小心，因为只有具备丰富经验的合作伙伴才能很好地执行此类项目。重申一遍，这本书可以在为你提供指导、识别需要提防的陷阱方面提供帮助。
　　重申一遍，你选择哪一种方案将取决于你的职位、你组织的规模、驱动虚拟化项目的业务需求以及预算。你可以自己完成此项目，也可以将此项目外包。但是，如果你选择此道路走下去，我们需要强调你所选择的合作伙伴将是非常关键的。因为只有精通虚拟化技能的合作伙伴才能够为你提供所需要的帮助。
　　



　　5.2　准备网络层
　　既然你已经决定如何进行，那么你就可以确定如何改变你的基础架构。第一个地方是关注网络层。如先前所述，你将需要确定你的网络设备是否可以胜任处理虚拟化所需增加的带宽。如果发现有某些设备不能胜任，就将它们马上替换掉。
　　然后，你需要检查你的网络基础架构。虚拟化通常需要多个虚拟局域网（Virtual Local Area Network，VLAN）。VLAN是网络节点的逻辑分组，即使它们位于不同的物理局域网网段上，它们也好像被连接到一个单独的网络上。如果你选择使用互联网小型计算机系统接口（iSCSI）来访问共享存储，那么你将需要为从你的主机服务器迁移到每个共享存储容器的流量创建不同的VLAN。把每个存储容器保持在单独的VLAN中将可以提高性能并简化流量管理。VLAN也是一种有效的网络隔离手段——例如，将生产网络与外围网络隔离开来，将服务器工作负载与最终用户流量隔离开来等等。最后，如果你打算使用实时虚拟机迁移，那么你应该为此流量单独指定一个VLAN，当它们需要带宽时，可以确保系统具有高优先级的带宽。实际上，因为正在传输的是实时的数据，甚至可以指定一台交换机专门负责此流量，以确保更高的优先级和安全性。
　　此外，还需要考虑服务器中的物理网络识别卡（Network Identification Card，NIC）的配置。主机服务器通常至少有4个NIC，用途如下所述：
　　▼保留2个NIC用于服务控制台或者虚拟机管理流量。服务控制台用于管理虚拟环境，作为管理的目的因此需要高优先级的流量。此流量在任何时候都要进行加密，因为它通常包含了管理密码和其他敏感信息。使用Internet协议安全性（Internet Protocol Security，IPSec）或者安全套接字层（Secure Sockets Layer，SSL）是确保此通信安全的一种最佳做法。至少使用一个单独的NIC来处理管理流量，因为将管理流量与虚拟机流量隔离开来可以提供额外的安全性。例如，如果你有一个位于外围网络中的虚拟机Web服务器，并且Web服务器和管理流量共用同一个NIC，那么NIC的性能很有可能会大打折扣，恶意用户将有机会访问管理流量。因此，可以使用2个NIC提供冗余以及进一步隔离管理流量。
　　■一个NIC被保留用于实时虚拟机迁移。为此流量指定一个NIC，为它提供所需的高优先级。此NIC不应与任何的虚拟机流量共享，并且应至少是一张1GB的NIC，以提供所需的吞吐量。应将此NIC分配到实时迁移VLAN中。
　　▲一个或者通常是多个NIC通过虚拟机内核保留用于虚拟机的工作负载。这些NIC在物理主机和虚拟机之间进行共享。像所有其他物理设备一样，网络接口卡往往没有被物理工作负载充分利用。这意味着多个虚拟机可以共用相同的NIC。但是，应该为每4个在主机上运行的虚拟机指定至少一个主机NIC。这可能意味着每台主机上将需要4个以上的NIC。
　　此外，应将静态IP地址同时分配给主机和尽可能多的虚拟机。在IP版本4（IPv4）中，这意味着使用一个私有地址池。在IPv6中，这意味着每台服务器或者站点可以使用全局唯一的地址作为本地地址，这类似于在IPv4中可用的私有地址池。确保域名系统（Domain Name System，DNS）已经正确配置所有IP地址，包括虚拟的和物理的。这意味着正向和反向查找。实际上，最好使用2个DNS基础架构：一个仅包含资源池的物理地址和一个包含所有虚拟服务或产品（VSO）的虚拟地址。
　　如果虚拟机需要访问远程位置或者需要被远程位置访问，那么你将需要确保正确配置你的防火墙以允许此流量。在大多数情况下，当组织开始推进虚拟化时，他们经常使用物理工作站来访问虚拟服务。请确保所有设备（物理的和虚拟的）上防火墙以适当的模式允许流量。
　　NIC teaming或者多个NIC的聚合可以提供容错、增加带宽和高可用性——如果条件允许也应该尽可能地考虑。正如前面所讨论的那样，在系统配置中，应该始终避免单点故障。如果有多个虚拟机共享单个物理NIC并且此NIC由于某个原因发生了中断，那么多个工作负载将会出现故障。使用NIC teaming可以防止这种情况的发生，因为它提供了设备冗余以应付任何不幸事故发生。
　　5.2.1　虚拟层中的网络化
　　虚拟机技术支持在同一物理主机内存在多个虚拟网络。因此，实际上可以在同一主机内承载来自不同网络区域的虚拟机。hypervisor通过为每个网络使用和创建虚拟交换机来管理这一进程。例如，在Microsoft Hyper-V中，在主机服务器上的物理NIC被转换为虚拟网络交换机（Virtual Network Switch，VNS），然后可以被指派给虚拟层中多个不同的组网模式（见图5-1）。
　　图5-1　Hyper V中的网络化
　　然后，可以为3种连接类型之一分配虚拟网络接口：
　　▼一个外部的虚拟NIC将连接到VNS以便可以同时访问主机和外部网络。
　　■将一个内部的虚拟NIC连接到主机，允许连接到此NIC的每一个虚拟机之间可以进行通信。而且不支持任何外部的通信。
　　▲一个虚拟私有NIC只能连接虚拟机，不会提供任何到主机系统的通信。
　　VNS进程将移除物理NIC上的所有设置，除了Microsoft Virtual Switch（Microsoft虚拟交换机）以外。基于这个原因，在一台物理主机上应该拥有多个NIC。许多管理员通过终端服务远程执行主机服务器配置。当使用这种方式执行配置并且系统上只有一个NIC时，所有终端服务通信都会丢失，这意味着不能再通过远程的方式与主机进行任何的通信。然后，你必须坐在服务器旁边完成其配置。在主机中使用至少2个NIC就可以避免这一问题。
　　VMware也支持虚拟网络交换机。例如，VMware Workstation，一种SerV产品，默认情况下可以支持10个虚拟网络交换机（见图5-2）。如果需要，可以独立配置每个VNS，以提供完全的虚拟机隔离。
　　图5-2　VMware Workstation中的网络
　　在使用hypervisor时，可以创建与虚拟机所需同样多的虚拟NIC。此外，服务，如网络负载平衡（Network Load Balance，NLB），通过在网络层重定向流量在多台计算机之间实现工作负载平衡，在虚拟化层内也可以很好地工作，因此可以通过使用主机服务器的虚拟网络功能来创建具有高可用性的虚拟机配置。大多数虚拟化引擎还支持网络地址转换（Network Address Translation，NAT），通过一个单一的物理IP地址为多个虚拟机提供访问。因此，这些虚拟化引擎通常还包括为虚拟机提供动态主机配置协议（Dynamic Host Configuration Protocol，DHCP）服务的能力。
　　一定要仔细记录在主机服务器上使用虚拟网络交换机创建的虚拟网络。
　　



　　5.3　准备存储
　　应该在尽可能多的主机系统之间共享存储配置。如果这是不可能的——例如，如果选择依靠直接连接存储来创建低成本的主机配置——为了支持虚拟机的高可用性，必须在主机之间执行复制服务。此配置对于只运行几台主机的小型公司通常是最好的选择。例如，Windows Server 2008 Hyper-V，由于它是Windows Server的一部分，所以通过故障转移群集支持这种类型的高可用性配置，使用多数节点集创建群集，因此不需要共享数据。但是，为了确保在群集中的每个节点上的内容都是相同的，它还必须依靠系统复制。虽然像Exchange Server 2007和SQL Server 2008这样的技术通过日志传送提供了复制机制——在本地以及远程系统上的每个数据库事务日志中生成一个副本，以保持数据库的同步——Hyper-V没有这个功能，至少目前还没有。但是，Microsoft提供了一份支持这些配置的复制合作伙伴的列表，请访问www.microsoft.com/windowsserver2008/en/us/clustering-multisite.aspx。这一战略是基于Windows Server多站点群集能力，但在这种情况下，每个节点可以是在相同或不同的站点中，这取决于你的要求。
　　多站点群集配置是一种需要为它们的虚拟机提供多站点冗余的小型公司或者大型公司使用的解决方案。大多数其他的组织将依靠共享存储——或者网络连接存储（NAS）或者存储区域网络（SAN）——为其主机服务器配置高可用性。在这种配置下，每台主机服务器连接到一个或多个存储器共享逻辑单元（LUN）上（见图5-3）。通过为多个主机提供连接，共享存储容器可以支持高可用性，因为主机不需要通过复制存储容器的内容来访问它。相反，高可用性技术只是断开故障主机的连接，并启用容错主机的连接，因此提供了服务的持续性。在这些配置下，服务器池中的所有主机必须连接到同一个存储容器。
　　图5-3　高可用性配置需要多台主机连接到同一个存储容器中
　　注意：高可用性的工作方式与实时虚拟机迁移是不相同的。实时迁移是从一台主机上复制虚拟机内存中的内容到另一台主机，然后激活它，因此服务不会中断。为了向虚拟机提供最大量的资源，这项技术用于将虚拟机迁移到新的主机上。另一方面，高可用性用于主机服务器出现故障的时候。因为出现了故障，在故障发生和故障转移之间的服务会有轻微的中断。
　　虽然，高可用性在Windows Server 2008 Hyper-V和其他基于Linux Xen代码的hypervisor中是通过群集服务来提供的，但在VMware中，它是通过2种技术来提供的：高可用性（HA）组件和虚拟机文件系统（Virtual Machine File System，VMFS）。VMFS专门用于管理承载虚拟机文件的容器。VMFS的特点之一是HA池中的多台主机服务器能够共享容器连接。这意味着如果池中的某台主机发生了某种形式的硬件故障，那么任何绑定到同一个共享存储容器的系统都可以承接运行原故障主机上的虚拟机（见图5-4）。HA与VMFS一起工作，当发生硬件故障的时候，可以将虚拟机由故障主机转移到另一台正常主机上运行（见图5-5）。VMFS是一种真正的群集文件系统，它是ESX Server实现中，HA配置的一个重要的组成部分。
　　图5-4　VMFS将多台主机服务器连接到同一个存储容器
　　图5-5　VMware HA与VMFS一起工作，当发生硬件故障时，故障转移虚拟机到另一台主机上
　　而且，当其他的虚拟化技术依靠其主机操作系统（OS）的功能创建内存交换文件时，VMFS为VMware主机服务器创建和管理这些文件。VMFS还为虚拟机存储着所有的撤销、重做、日志和配置文件。
　　另一个虚拟机存储组件的要求是对其他媒体类型文件的要求。尽管主机服务器可以共享其物理驱动器，例如通过原始设备映射（Raw Device Mapping，RDM）来共享DVD或软盘驱动器，但在一台主机上运行多个虚拟机通常意味着需要在同一时间访问这些设备的多个副本。20个虚拟机共用一个DVD驱动器是不可行的。为了克服这一问题，hypervisor必须有创建虚拟驱动器的能力（可以同时模拟DVD和软盘驱动器）。每个虚拟驱动器是以某种类型的映像文件来存储。例如，DVD通常会以ISO文件格式（文件扩展名为.iso）来存储，并且可以有针对性地直接连接到一个虚拟机上。你的存储容器还需要为这种类型的介质预留空间。在许多情况下，使用网络文件系统（Network File System，NFS）的存储容器存放这类文件。通过简单文件共享服务在多个虚拟机之间共享NFS容器，这意味着可以方便地集中管理它，因此在整个数据中心只有一个这种容器需要管理。在Windows中，这将是一个标准的Windows文件服务器。
　　5.3.1　准备存储配置
　　共享存储必须以某种方式连接到主机服务器。如果共享存储是NAS设备，由于NAS设备是一种会以NFS或者标准Windows文件共享格式来提供文件服务的文件共享单元，因此你需要通过网络接口卡来连接这种设备。但是，如果你的设备是SAN，那么你必须确定如何连接到该设备。
　　SAN通常通过iSCSI或光纤通道连接到主机服务器。iSCSI依靠网络接口卡将存储通信转换为网络通信。虽然iSCSI本身不能提供与光纤通道相同的性能，但当它可以通过网卡聚合来提供接近的性能水平——为iSCSI负载添加多个网卡以增加数据的吞吐量。今天，SAN是大致平均地通过这2种方法来配置。光纤通道提供了更好的吞吐量，并且不会对网络添加任何的负载，但虚拟化厂商支持的主机总线适配器（Host Bus Adapter，HBA）的数量远低于他们支持的网卡数量。因此，许多组织选择了iSCSI，这样他们在进行系统配置的时候有更好的选择。请注意，不管如何，因为成本较低，iSCSI对于中小型组织可能是更好的选择。而大型组织通常选择光纤通道HBA，即使最初它们需要花费更多，但长远来看它们可以提供更好的性能。
　　此外，许多组织为hypervisor分区和主机控制台配置主机服务器为直接连接存储，然后使用共享存储存放和维护所有虚拟机文件。从现在起，这种配置已发生了变化，多家服务器厂商都提供了在一个内置USB驱动器上包含hypervisor的主机服务器配置，这使得直接连接存储（DAS）配置是不必要的。但是，如果发现必须在主机服务器中使用DAS，那么使用固态驱动器可以尽可能获得最佳的IOPS速度。
　　还要注意每个存储容器主机上虚拟机的数量。尽管LUN可以承载多达100个虚拟机，但为了提高性能，每个LUN可能最好维持在不超过32个虚拟机。性能会根据廉价磁盘随机阵列（Random Array of Inexpensive Disk，RAID）的驱动器配置而有所不同。RAID5往往是最常用的RAID类型，因为它在保护数据的同时提供了可接受的性能。但目前，RAID10可以提供最佳的性能，因为它是兼具了镜像和条带磁盘，在获取最佳读写性能的同时保护所有驱动器的内容。RAID10的成本比较高，因为完成此配置需要更多数量的磁盘驱动器，但从长远来看，它可以为共享存储容器提供最佳的结构（见图5-6）。
　　图5-6　使用不同的RAID类型
　　5.3.2　虚拟化存储
　　当使用共享存储时，还需要使用共享存储管理技术。这些技术能够虚拟化存储，使存储容器更容易访问，无论其位置在哪里。基本上，虚拟存储技术就是将物理存储转换为逻辑视图。在某些情况下，这种软件可以扫描组织中所有的存储：DAS、NAS和SAN，并且把它们聚合起来提供一个统一的包含所有存储的逻辑视图。
　　虚拟存储的重点是卷，而不是实际的磁盘。它是硬件不可知的，这样它可以同时管理来自多家厂商的存储容器，让你选择最佳的产品。它为所有的存储管理提供了一个中心控制台。
　　虚拟存储技术可以是软硬结合，或者可以是纯软件，这提供了最大的灵活性。存储容器是基于策略的并且可以根据需要来开启。但虚拟存储的最大的特点是“自动精简配置”。
　　当创建虚拟硬盘时，你会发现其中一种格式是动态扩展磁盘——一种配置为最大容量，但是只存储驱动器实际内容的磁盘，并会随着磁盘的使用而增长。例如，可以创建一个100GB的虚拟磁盘驱动器，但由于实际磁盘只包含10GB的内容，因此虚拟磁盘文件的大小只有10GB。这个文件根据实际使用情况将会最大增长到100GB，但可能永远不会实际到达配置的驱动器最大容量。
　　自动精简配置与物理存储做的都是同一件事情（见图5-7）。它创建一个指定大小的存储卷，但规定当中的虚拟磁盘只须包含其实际的容量。例如，你可以配置一个包含虚拟机的大小为500GB的卷，但如果虚拟机的大小只有60GB，那么你实际只需要60GB的物理磁盘空间。当对磁盘有需求时，另外的磁盘可以通过存储虚拟化技术请求调用，这可以为你节省巨大的实际磁盘成本。因为这个原因，存储虚拟化对于所有想要迁移到虚拟基础架构的组织是很大的福音。
　　此外，存储虚拟化软件让你在创建卷的时候配置RAID的类型，但也允许你在需要的时候更改它。此软件将帮助你最大限度地利用实际存储，同时为你提供最佳的管理能力。
　　图5-7　使用自动精简配置让你可以使用较少的实际磁盘来创建共享卷
　　5.3.3　创建备份计划
　　在存储配置中，最后一项应侧重于备份和驱动器复制。关于备份将在第14章全面深入地讨论，但在准备存储时应该将它一并考虑。归根到底，在虚拟化中最重要的是避免单点故障。如果有多台主机服务器绑定到共享存储中，并启用了高可用性的配置，但没有为存储LUN提供保护，那么将会出现一个单点故障。
　　大多数的SAN具有在操作过程中建立完整的LUN快照的能力，保护它们所包含的驱动器内容。在大多数情况下，SAN能够创建多达512个包含它们内容的快照，然后依靠这些快照创建磁盘的备份，以避免对生产磁盘造成性能影响。需要确定这些是否已经足够，或者是否还需要通过某种形式将SAN复制到另一个站点。
　　基本上，组织需要考虑受保护数据的重要性和项目的预算，这将有助于确定应该使用哪一种策略。请记住，在数据中心，数据保护是存储准备最重要的方面之一。
　　5.3.4　选择最佳存储
　　与大多数的服务器硬件类型一样，存储厂商也有很多。然而，如果还没有部署任何存储，NetApp（www.netapp.com）可能是最好的选择。对于虚拟化，NetApp之所以值得推荐，主要有以下3个主要的理由。
　　▼NetApp存储设备全部使用相同的管理界面。可以从NetApp提供的最小型的设备开始，学习它的管理接口，然后再也不需要重新学习如何管理NetApp存储，即使使用的是企业级的设备。
　　■NetApp存储为所有的虚拟机提供了自动实时的重复数据删除。如果存储容器承载了15个Windows Server 2008虚拟机，NetApp将自动删除所有重复的内容。因为全部15个虚拟机的操作系统使用了相同的核心文件，NetApp只存储这些文件的一个单一副本。NetApp同样为Linux或任何其他虚拟机这样做。这样做可以节省所有存储成本的40%以上。其他技术在备份级别提供了重复数据删除服务，而不是在实时存储级别。
　　▲NetApp提供了同类产品中最佳的复制技术。这是因为它不是复制该驱动器的内容。相反，它是基于存储容器的字节级别来创建存储映射，并将此映射传送到另一个容器中，可以是远程存储容器，然后继续修改远程存储以匹配映射的内容。它可以通过各种自定义计划来执行，以确保驱动器的内容总是保持相同。其他技术的内容复制是基于逐个字节，持续从一个位置到另一个位置传送字节内容。
　　NetApp在默认情况下提供了这些功能，并且还提供了具竞争力的性价比。基于上述的原因，如果还没有部署共享存储容器，那么应该花点时间来研究一下NetApp的产品。依靠NetApp代表性的功能，确保你可以获得包括所有为支持虚拟化所需功能的产品。
　　



　　5.4　准备主机服务器
　　当准备主机服务器时，大多数人在脑海中会有一个主要的想法：我该如何恢复现有的硬件设备并重新使用它们以减少我的项目成本？此主题已详细讨论至今，但这里有一些额外的注意事项：
　　▼第一，需要确定服务器是否可以承载虚拟机，哪些最有可能，但它们可以通过适当的配置作为虚拟化主机吗？
　　▲主机服务器的关键是资源——处理器、内存、网络和磁盘。现有的服务器是否可以提供这些能力？请考虑下列因素：
　　■拥有最多的处理器或处理器内核的服务器就是最好的主机服务器。如果现有的服务器是在AMD处理器上运行的双核服务器，那么是幸运的，因为无须适配器套件就可以轻易地将双核处理器替换为AMD四核处理器。只需取出旧的处理器装上新的处理器。这将给你的服务器第二次生命。英特尔（Intel）处理器替换起来就没那么容易，所以如果用的是英特尔处理器，那么需要做出决定。
　　■最好的主机服务器是使用了相同的类似步进的处理器，以支持实时迁移。如果有一些服务器具有这些特点，那么请保留它们。
　　■具有大量RAM的服务器就是最好的主机服务器。如果服务器还有很多空闲的内存插槽，填满它们然后重新使用此系统。
　　■最好的主机服务器包含了大量的NIC。如果有可用的插槽，同时可以向服务器添加NIC，那么就加吧。
　　■最好的主机服务器将依靠共享存储来存储虚拟机。如果可以向服务器添加NIC以支持iSCSI或者主机总线适配器，那么请保留它们。
　　基本上，如果可以提高服务器的配置，与此同时，将它们捆绑到一起成为高可用性的配置（例如群集配置），那么可以保留服务器并将它们作为主机重新使用。
　　还需要确定是否将会纵向或者横向扩展主机系统。纵向扩展意味着使用较少的、功能更强大的服务器，如机架式服务器或者塔式服务器，但大多选择机架式服务器。横向扩展意味着使用更多较小型的服务器，如机架式服务器或者刀片系统。虽然这个问题通常对于应用程序服务器是无实际意义的，因为许多应用程序并不能充分利用由纵向系统提供的多个处理器或者处理器内核，但通过虚拟化，游戏的本质发生了变化，因为主机服务器设计为使用所有的系统资源。因此，很有可能通过纵向扩展进行虚拟化。
　　但是，必须考虑到主机服务器的维护。较大型的服务器将承载更多的虚拟机，如果需要关闭这些大型的系统，可能会出现潜在的停机。请记住，每次创建一个巨大的服务器主机来承载几十个或更多的虚拟机时，由于需要创建高可用性的配置，所以还需要创建它的备份。正因为如此，你总是需要创建具有足够资源承载其合作伙伴服务器工作负载的主机服务器配置。如果在群集中有4台服务器，那么每台服务器必须有足够的资源承载其合作伙伴的所有虚拟机（见图5-8）。当决定进行纵向扩展时，这些服务器的配置可能变得非常昂贵。
　　图5-8　群集成员必须具有足够的备用资源以支持其合作伙伴出现停机时间
　　但是，当进行纵向扩展时，可以依靠经验减少服务器的配置。例如，如果你认为在一个有6个节点的群集中，同一时间只会有2个节点发生故障，那么可以在每台主机上承载更多的虚拟机，确保在群集中的其他节点始终有足够资源来应付这些故障。这个经验将不包括整个群集的故障，但它将让你创建较廉价的纵向扩展群集并减少资源的浪费。
　　但是因为创建纵向扩展群集可能更加复杂，因此最好选择横向扩展，在群集配置中使用可以容易配置的较小型的刀片服务器以支持它们的双节点。刀片服务器非常容易获得，并且一旦设置好，它们的机箱就可以一次到位，这成为支持横向扩展的简单策略。事实上，最好的主机服务器似乎包含至少2个四核CPU、至少32GB内存、至少4个网卡（可能进行teaming），没有内置的磁盘（见图5-9）。系统可以由一个内部集成的hypervisor来运行或者从SAN启动，避免了对DAS磁盘的需求。
　　图5-9　理想的主机服务器配置
　　在执行他们自己的虚拟化项目时，处理器制造商英特尔公司发现在虚拟化的时候，大多数应用程序可以用一个1GB的内存来运行，在他们分析的3000台服务器中，1500台只使用了1GB或者更少的内存。这包括了大多数的文件服务器、Web服务器和备份系统。在某些情况下，他们发现包含电子邮件和数据库的服务器的内存利用率也偏低。他们还发现2GB的双列直插内存模块（Dual Inline Memory Module，DIMM））可以提供最佳的性价比。但是，由于这项研究是发生在2007年年底他们执行自己项目的过程中，所以今天，4GB的DIMM内存可能是更好的选择。
　　最后，需要确定哪种服务器最适合。如果有数千台机器需要进行虚拟化，那么纵向扩展是最佳的选择，它能最大限度地利用主机服务器的工作负载；但是，如果只有不多的虚拟机需要创建，那么横向扩展是最好的选择，因为较小型的服务器提供了更好的性价比，并且更容易引入和更换。
　　当关注现有的服务器时，可能会有以下发现：
　　▼塔式服务器将最有可能被保留仅用于测试和开发环境，因为它们不需要支持高可用性配置。
　　■在较小型的公司中塔式服务器也将被保留，因为只有少数几个工作负载需要进行虚拟化。
　　■机架式服务器可能需要加以调整，以支持虚拟化，但大多数是需要升级组件。
　　■刀片服务器也可以加以调整，以支持虚拟化。
　　▲运行电子邮件或者数据库的现有群集可以转化为主机服务器群集，其实可以是构成你的主机群集池的来源。但是，当你将其当前的工作负载转换为虚拟化时你必须非常小心。
　　无论你用现有的系统做什么事情，请确保都是以这样一种方式配置你的主机服务器，就是在短期内你将不需要更换或者升级它们。
　　注意：请记住，如果需要处理你的服务器，第1章指出了绿色处理资源，其中之一是www.GreenAssetDisposal.com。
　　5.4.1　资源池的服务器规划
　　如果选择使用新的服务器，那么千万不要安装符合最低要求的服务器。实际上，如果计划组建一个主机服务器网络，那么服务器不应该是推荐的基本配置，而应该配置为满足最佳的工作负载。这是通过执行一项正式的服务器规划工作来完成。这项工作将有助于确定每台主机服务器的硬件配置。它将告诉你：服务器应该是什么规格，需要用在什么地方，它应该提供什么服务。当执行服务器规划工作时，需要考虑以下各项：
　　▼确定服务器基本配置　基于你选择的hypervisor的功能（见第7章）确定你的虚拟机编组将在哪里，每台主机上将运行多少个虚拟机，如何对主机进行组队以实现高可用性，一个群组中将有多少台主机服务器。你需要确定你集中存放虚拟机的服务器将摆放在哪里。由于虚拟化也支持服务集中管理，这最有可能是在中心办公室。
　　■每台服务器上客户操作系统的数量　确定每台主机服务器上客户操作系统的最大数目。要提供指定的服务级别，确保永远不会有超过特定数量的客户操作系统，这取决于服务器的资源。平均来说，组织中每台主机运行10~30个的虚拟机。
　　提示：请记住，如果你要在服务器上面运行Hyper-V，那么所有的物理主机必须是64位服务器。如果你想要重新使用32位服务器作为主机，你可以这么做，但你需要在一个32位版本的操作系统上运行Microsoft Virtual Server或者VMware Server，以提供虚拟化服务。你也可以使用32位设备来运行VMware ESX Server，因为它基于32位代码。
　　■最大可接受的服务器负载　确定你希望服务器提供服务时的响应速度。对于主机服务器，此负载必须考虑到最大中央处理单元（CPU）的使用情况。通常CPU和内存是主要的瓶颈。要学习如何避免它们。实现此目的一个好的方法是在服务器上持续监控CPU和输入/输出（I/O）的性能。
　　■服务器差异　服务器的位置也必须要考虑，因为它通常决定了服务器的性质。大多数主机服务器位于中央数据中心，但在某些情况下，需要为远程办公室提供本地服务。虚拟数据中心在各区域运行2台带共享存储（如果可能）的主机，并运行适当数量的客户操作系统以满足需求。
　　■最小服务器能力　确定主机服务器能提供的最小硬件能力。请记住，希望将来需要更改它们。网络是为用户群提供高质量的服务。当你确定最小服务器能力时要考虑这一问题。能力规划应该是确定处理器的数目和大小、RAM的数量以及磁盘的大小。
　　■多处理器和多内核　应该确定主机服务器使用多处理器的服务器（拥有多个处理器的服务器）以及多内核处理器（具有多个CPU内核的处理器）。事实上，现在每台主机上包含至少2个四核处理器。如果可以包含更多的，那就增加吧。在短期内，将可以获得八内核或者更多内核的处理器。
　　■RAM的大小　规则很简单：拥有的RAM越多，服务器执行得越好。因此，RAM不是应该节省的地方，特别是对于主机服务器。主机服务器最小要有16GB的RAM，但是，许多组织都是直接配置为64GB。请记住，RAM的大小将影响页面文件。最佳的经验是将页面文件最小设置为RAM大小的2倍，最大为内存大小的4倍。此规则说明了你需要为页面文件保留的最小和最大的磁盘空间的数量。
　　注意：此交换文件规则主要适用于Microsoft Hyper-V。对于VMware ESX Server，此交换文件用于控制台操作系统，默认为544MB，与系统中的物理RAM的大小无关。但为了优化性能，许多部署使用了一个1600MB的ESX交换文件或者最大服务控制台内存的2倍即800MB。所有其他的页面基于虚拟机，由VMware内存管理驱动程序来协调。
　　■磁盘的大小　附加到每台服务器的磁盘的大小和数量，取决于多项因素。想要划分多少个分区？想要为操作系统、程序以及特殊元素如分页文件保留多少空间？保留多少空间用于数据存储？使用直接连接存储还是远程存储？无论选择如何，大多数服务器将最终有3个或者3个以上的分区：一个用于制造商的服务器实用程序，另一个用于操作系统和程序，以及一个用于数据。
　　对于主机服务器，数据分区应始终是在共享磁盘上，并且要与系统分区隔离。此外，数据分区常常很大。共享磁盘将允许你运行hypervisor，如果它不是嵌入服务器硬件或者数据驱动器中。此外，共享磁盘可以实现高可用性策略，以确保虚拟服务或产品始终是可用的。
　　■硬件保护　全部的这些数据都需要一定程度的保护。本地磁盘驱动器应通过RAID来保护。如前所述，许多人为系统驱动器选择了磁盘镜像系统（RAID 1）、为数据分区选择了带奇偶校验的条带集（RAID 5）或者镜像条带集（RAID 10）。
　　■存储策略　选择的硬件保护系统还取决于存储策略。主机服务器应该共享驱动器。许多制造商为区域网络提供了创新的包括2个主机服务器以及共享存储，以及所有组件都集成在一个便捷的冷却机箱中的一体化套装。对于中心服务器，应该基于你组织的需要部署共享存储。中小型组织将通常选择带有复制的DAS或者NAS设备，而较大型的组织需要部署SAN。Hypervisor将使用多种不同类型的共享存储；还要确保你所选择的组件必须包含在你的hypervisor提供商发布的硬件兼容性列表（Hardware Compatibility List，HCL）上。
　　■物理位置　物理位置就是服务器将占用的实际的物理空间，它将帮助你决定将是选择机架式还是塔式服务器配置。在大多数情况下，区域服务器是塔式服务器，集中式服务器是机架式服务器，因为它们集中在一个单一的物理空间中。如果选择机架式服务器，不如考虑使用刀片服务器。如前所述，它们非常适合需要横向扩展的主机。此外，刀片服务器提供了更紧凑的组件封装，通常可以节省多达70%的机架空间、减少50%的电力损耗、减少80%的电缆连接，而且比起其他的机架式服务器减少20%的热量。请记住：物理位置应该是可封闭的，而且要提供温度控制。
　　■备份方法　重申一遍，服务器的物理位置将有助于确定你所选择的备份方法。区域服务器通常使用磁带驱动器进行备份。根据广域网络（Wide Area Network，WAN）连接的速度和可用带宽，可能只需将所有的数据备份到一个中心位置。在以后讨论虚拟机保护策略时，将有更多关于这一主题的介绍。
　　▲扩展潜力　如果不想看到系统部署好后6个月就要被替换，那么请确保它具有扩展潜力。所有的系统都应该具有添加更多的处理器或者至少更换它们、更多内存和更多磁盘空间的能力。为此，需要考虑服务器的使用寿命——什么时候通过制造商引入服务器，服务器将在什么时候退休，服务器制造商提供了哪些预计的扩展潜力等。如果有详尽的计划，将能够部署可以满足期望的具有长久生命周期的服务器。在某些情况下，生命周期可以长达5年或者更久。
　　这项工作可以帮助确定每台服务器的容量。Dell、HP和IBM等多家制造商在其各自的网站上提供了主机服务器规划工具。可以依靠这些工具帮助创建最佳的主机服务器配置。
　　5.4.2　资源池的规划建议
　　已经知道了主机服务器应该是使用共享存储的64位系统。如果可能的话，它们也应该是刀片服务器，因为一旦配置好机箱之后，片服务器比其他服务器类型可以更快地署。它们应该包括多个NIC，这样它们以为运行的多个虚拟机提供足够的吞量。操作系统应存放在共享存储上，或在主机的硬件中，这将有利于资源调配。对于服务器的数据——虚拟机的存储间——应该是在共享存储上，并且应该配大量的磁盘空间分区。另一个较小的区用于存储备份虚拟机时需要的快照。
　　表5-1概述了对主机服务器的规划建议。
　　5.4.3　升级主机服务器
　　当迁移到动态数据中心时，不能在主机服务器上进行升级。每台主机服务器很可能是新安装的。然后，对即将虚拟化的服务产品进行升级或全新安装。建议你在任何时候都进行新的安装，但这显然是你的选择。请记住，在对现有系统执行升级之前，需要将其从物理转换为虚拟（P2V）装置。与其他厂商一样，Microsoft和VMware都提供了P2V工具。Microsoft的最佳P2V工具可以在System Center Virtual Machine Manager（VMM）（系统中心虚拟机管理器）中找到。关于VMM的详细信息可以在www.microsoft.com/systemcenter/scvmm/default.mspx找到。VMware提供了VMware Converter，一种可以用于将物理机转换为虚拟版本并可以在虚拟格式之间转换机器的图形工具。VMware Converter是免费的，你可以在www.vmware.com/products/converter找到它。当然，如果拥有VMware的虚拟基础架构，就已经拥有Converter的企业版本，此版本能够捕获运行中的机器并虚拟化它们。VMware Converter还可以用于转换虚拟机的磁盘格式，例如，从Microsoft的VHD转换为VMware的VMDK。在http://vmtoolkit.com/files/folders/converters/entry8.aspx可以找到更多的信息。还有第三方的P2V工具，例如PlateSpin（www.platespin.com），提供了更多的功能。将在第9章中对P2V进行详细介绍。
　　5.4.4　依靠硬件集成的hypervisor
　　VMware是第一个令它的hypervisor直接在服务器硬件中可用的厂商。VMware ESXi是一个只有32MB可以通过位于服务器硬件内部的USB拇指驱动器引导的小型hypervisor。因此，添加新的主机服务器到你的资源库将变得很容易。可以使用以下的步骤：
　　1.在机架式或者刀片式服务器的机箱内安装服务器。
　　2.开启其电源。服务器自动启动hypervisor。
　　3.配置管理密码以确保系统的安全（见图5-10）。
　　图5-10　在VMware ESXi中设置管理密码
　　4.为主机服务器配置静态IP地址（见图5-11）。
　　图5-11　在VMware ESXi中设置静态IP地址
　　5.通过管理控制台连接客户端到虚拟基础架构（见图5-12）。
　　图5-12　将VMware ESXi添加到被管理的基础架构中
　　如上所示，这个过程很容易实现。添加主机服务器是轻而易举的事，特别是现在的ESXi是免费提供的。
　　VMware并不是创建内置硬件/hypervisor配置的唯一厂商。Citrix也提供了一种原始设备制造商（Original equipment manufacture，OEM）版本的XenServer，Microsoft针对某些硬件配置提供了Hyper-V的自定义内置版本。每一种都像ESXi一样简单和易于部署。因此，应该考虑购买预置hypervisor的系统。
　　注意：如果在自己的硬件上下载并安装VMware ESXi、Citrix XenServer Expres或者Microsoft Windows Hyper-V Server（不是Windows Server 2008中包含的Hyper-V），那么不可能获取完整的hypervisor虚拟化功能集。需要购买VMware ESXi或者使用VMware虚拟基础架构的另外一个版本才可以获取更完整的功能集。XenServer Express需要替换为另一个版本的XenServer才可以获得支持通过单一界面管理多台主机服务器。而Microsoft Windows Hyper-V Server需要替换为内置Hyper-V的Windows Server 2008企业或数据中心版才可以获取如高可用性等高级功能。
　　5.4.5　建立你自己的hypervisor硬件
　　然而，可能并能安装已包括hypervisor的全新服务器。因此，需要创建标准主机服务器装置。创建一个虚拟机是很容易的。只需要复制一个虚拟机的文件、重命名它们、重新个性化服务器，那么创建虚拟机工作就完成了。但是，创建主机服务器却复杂的多，因为它是基于硬件的。要执行此操作的最佳方法之一是从SAN启动操作系统分区。通过从SAN启动，在部署的服务器上不需要任何直接连接的磁盘，并且可以像处理虚拟磁盘一样，以相同的方式更轻松地处理操作系统分区。这是因为SAN具有创建磁盘配置快照和复制它们的能力，与只需复制虚拟硬盘驱动器差不多相同的方式。如果有意从SAN启动，可以通过以下步骤来建立主机服务器：
　　1.在共享存储上创建主机操作系统。
　　2.复制至少包含一个主机操作系统的LUN。
　　3.将此LUN附加到主机服务器并且去除其个性化设置。对于Windows主机服务器，这意味着需要在其上面运行SysPrep命令。SysPrep将删除服务器名称、移除系统的全局唯一标识符（GUID）和系统的安全标识符（SID）。对于Linux主机，你必须运行自定义脚本来这样做。
　　4.从主机上分离此LUN。
　　5.每次需要创建一个新的主机时，只需创建此LUN的一个副本，并将其附加到新的主机上。然后引导系统和重新个性化它。
　　如上所述，这个过程比起使用任何其他的方法，可以更快地在物理服务器上创建主机分区。
　　如果你没有机会访问SAN，那么你将需要为你的服务器创建标准的安装，可能需要依靠磁盘映像来减少你需要在其他主机服务器上创建的标准安装。
　　注意：有关如何创建VMware安装的详细信息，请访问www.vmware.com/support/pubs/vi＿pages/vi＿pubs＿35u2.html。有关创建XenServer主机的详细信息，请访问http://docs.xensource.com/XenServer/4.0.1/installation/installation.html。有关Hyper-V的安装信息，请访问www.microsoft.com/windowsserver2008/en/us/hyperv-install.aspx。
　　



　　5.5　下一步工作
　　大多数组织开始都是先通过在测试和开发环境中使用虚拟化，然后才将其迁移到生产环境。这是很好的做法，因为这使你可以在与生产环境不一样的服务级别协议类型的环境中熟悉虚拟化基础架构。因此，下一章的重点将是如何在实验室中准备虚拟化环境。一旦完成此操作，在将虚拟化迁移到生产环境的过程中，可以做好更充分的准备。
　　



　　第6章　从测试环境开始
　　当准备通过筹备主机服务器来推进项目时，在开始进行从物理到虚拟的转换（P2V）的过程，将生产工作负载转换为虚拟机之前，需要先熟悉虚拟化技术方面的工作，以掌握其操作方式。实验室是最佳的起点。实验室由不断变化的工作负载组成。机器需要增加，系统需要被重新配置，整个环境需要被拆卸和定期重建。在物理世界中这是一个非常艰难的任务，而在虚拟世界中这一切变得十分容易。厂商甚至比虚拟化引擎提供了更多不同的技术，以促进实验室的管理，可以在短时间内建立、使用和拆卸整个虚拟环境。
　　从测试实验室开始，因为这也许是任何技术实施项目最重要的部分。在它们被部署到生产环境之前，测试和重新测试解决方案是确保高质量与避免问题的唯一方法。毕竟你会希望发现自己部署到网络中的是一堆废物。要想远离废物，实验室环境是项目最令人兴奋的地方之一。事情的进展可以很迅速，你正在使用新的技术，你是所有技术请求的中枢；这就是在实验室中工作有趣的地方。这正是你想让一切都正确部署方式的另一个原因。
　　无论是培训、测试或者开发，通过实验室你可以在几分钟内进入一个可用的工作环境，这实在是十分方便。这就是为什么需要虚拟实验室的原因。这个实验室今后将会成为所有虚拟化成果的来源，当项目完成时，还保持一个全面的测试环境。
　　但对于为IT项目提供这种类型支持的虚拟实验室，它们需要被视为在生产网络中拥有它们自己一席之地的正式系统。这就是为什么你需要为它们的创建找出结构化和标准化的方法。这就是本章将要讨论的内容：如何建立虚拟实验室、设置虚拟实验室、使用和重新使用虚拟实验室，对其实行长期的管理。这部分所描述的策略都源于涵盖各种使用场景的真实项目。这些策略将帮助你从实验室中获得有价值的东西，确保可以从你的努力中得到固定的投资回报（ROI）。例如，一个客户能够在不到32个小时内建立一个完整的协作测试环境。想想看：不到4天的时间就可以建立3台物理主机和10多个运行不同角色的虚拟机。此外，客户为了其他的测试目的可以重复使用这个环境。而且这是他们首次使用虚拟实验室！毫无疑问：这一级别的投资回报率在物理实验室环境中显然是无法达到的。
　　建立一个实验室——任何的实验室，需要关注以下4个不同的方面。
　　▼实验室说明　第一个方面要做的是对用于创建和执行的环境进行策略描述。
　　■实验室可交付成果　第二个方面可确定从实验室得到的可交付成果如何可以用于支持其他的测试或者开发方案。通过特定的虚拟实验室，可以非常容易地将包含预先构建的机器作为可交付成果提供给其他的项目使用。这是因为虚拟机其实只是建立在磁盘上的几个文件——无可否认的大型文件，但这是可以从远程位置传输、复制或者下载的文件。
　　■实验室管理方法　第三个方面需要关注实验室管理和操作的方法。重申一遍，文件管理将是这一行动的重要组成部分。
　　▲未来计划和预计增长　第四个方面需要将眼光放长远，随着越来越多的组织成员需要取得运行技术，为将来实验室的使用和分布式虚拟实验室结构的创建与管理，提供最佳的方法和建议。
　　这4个方面将帮助你建立并准备好一个可以用于支持任何数目的方案的虚拟实验室，例如：
　　▼企业开发环境　开发人员需要在他们工作的机器上拥有一定的自由，但由于这些机器是企业系统，因此他们必须受到控制。在虚拟环境中，他们可以在不影响生产安全的情况下获得他们所需的权限级别。
　　■测试环境　新的技术、新的产品、新的补丁、新的热修复程序……在把它们引入生产环境之前全部都需要经过测试。为了支持这些测试，可以使用虚拟实验室创建一个低成本的生产环境的副本。在这种情况下，这个实验室对于帮助你熟悉虚拟化技术和了解它们的工作方式非常有用。随后，可以依靠虚拟实验室来为虚拟服务或产品测试提供额外的新技术。
　　■支持环境　帮助平台技术员支持级别为1、2或3可以通过使用虚拟环境重现问题。这避免了必须给他们多个系统，可以让他们在不影响生产环境的情况下对多个方案进行彻底的测减。
　　■培训环境　虚拟实验室是理想的培训环境。你可以安装各种技术，模拟大多数的情况，让你可以在你想要验证的技术上面获得实际的经验。事实上，虚拟实验室可以让你对方案进行彻底的检验，这是在生产网络中不能简单复制的。
　　你可能已经正在使用如VMware或者Microsoft的虚拟化技术，但这里所述的方法将可以帮助你将一个特定使用的虚拟机迁移到正式的实施环境中，组织中的多个成员将可以从中受益。
　　



　　6.1　使用不同的测试级别
　　测试是在不同等级的过程中进行的，并会逐渐演变到越来越复杂的测试级别。对于虚拟化以及其他的IT整合项目，共有5个测试级别。
　　▼单元
　　■功能
　　■整合
　　■分阶段
　　▲试点项目
　　单元测试级别是专门为了信息发现。其目的是让技术团队的成员了解他们该如何实现设定的工作任务的功能。例如，团队应该使用此测试级别来了解创建虚拟机的实际工作、熟悉虚拟文件、了解如何修改虚拟机的选项，并通过整个虚拟化过程大概熟悉它们本身。
　　功能测试级别用于最初的解决方案测试。在这里，技术团队已经确定功能是如何工作的，现在他们想要测试他们正在准备的自动化机制。
　　整合测试级别开始把每个独立的技术解决方案组件集合到一起。
　　分阶段测试级别的重点是要把一切都准备好。基本上，这个级别将提供一个类似于生产环境的环境。在整合过程中，把解决方案的每一个方面都混合到一起；在分阶段过程中，要确保你可以顺利地重现从A到Z的每个技术方面。重复此过程，直到它绝对正确。通过这种方式，可以准确地知道当你迁移到生产环境时需要做什么，不会有任何的差错。技术的实现是需要经过80%准备以及20%的实施，只有对每个方面都进行了充分的测试，才能正确的实现技术。
　　最后的测试级别是试点项目。虽然所有的其他测试级别侧重于技术测试，但试点项目的重点是完整的解决方案，包括了过程的各个管理方面。此测试将会验证你的解决方案和技术方面的逻辑。在迁移之前，请确保你已经对每个方面进行了全面的评估。
　　这些测试级别需要从一个级别到另一个级别逐步进行（见图6-1）。每个级别将同时具有退出和进入标准。例如，要离开单元级别，技术人员必须证明他们已经了解了这一级别的所有活动。要进入功能级别，技术人员必须满足关键的需求等等。当你学会了更充分地使用实验室时，你将可以建立你自己的退出和进入标准；但基本上，它们应该朝确保技术小组可以充分准备从一个级别移动到另一个级别的目标发展。随着你对实验室资源的需求越来越高，你不希望团队在他们准备好访问资源之前独占资源。此外，你想要确保没有做出损害任何高级别环境的事情——例如整合阶段和分阶段——导致你必须从备份中恢复它们，或者更糟的是，从零开始重新创建它们。实验室是为所有的技术团队成员使用的，应永远不会被的一个技术解决方案的单一方面垄断。
　　图6-1　5个不同的测试级别
　　注意：对于用于整合体系结构的视图——用来建立和管理测试级别的体系结构——以及退出标准表格样本，可以在www.reso-net.com/articles.asp？m=8#g连接中看一下“Build the integration architecture（建立整合体系结构）”。这篇文章是关于企业体系结构7部分系列中的第6部分。
　　这种测试结构在行业范围是受到公认的，可帮助管理一个解决方案从开始到结束的改进。当使用虚拟化软件执行这些任务的时候，将虚拟机从一个阶段迁移到另一个阶段，逐步改善解决方案直到它已经为生产环境做好准备。为了支持这一过程，VMware提供了Stage Manager（阶段管理器），这是一个通过自动化策略来全面支持此过程的协调程序，它提供了控制整个过程的额外措施（见图6-2）。这是使用虚拟化来支持新解决方案的开发和准备的一个更大的优势。
　　图6-2　VMware Stage Manager（阶段管理器）全面支持5个测试级别
　　



　　6.2　依靠虚拟机软件
　　虚拟机软件是对实验室的理想补充。有许多的理由可以证明这个事实。首先，你可以在环境中虚拟化大多数的服务器。你还会发现虽然需要为生产工作负载分配大量的内存，但实验室的工作负载通常使用很少的内存。例如，Windows Server 2003的工作负载，只需要为虚拟机分配256MB的内存就可以很轻松地运行，而Windows Server 2008至少需要512MB。当然，当在服务器中添加多个角色的时候，可能需要增加内存的数量，但如果你有相应的主机，你应该可以很容易运行你需要的任何服务器角色。
　　通过虚拟机使用客户端计算机和服务器，将可以大大地削减建立实验室的成本。可以依靠Mi-crosoft、Citrix或者VMware的虚拟技术，因为它们所有的工具都提供了免费的版本，可以再次降低实验室的成本。这3者提供的所有工具全都支持运行Windows服务器和个人计算机，以及任意数量的操作系统（见第7章）。你还需要获取将物理机迁移到虚拟实例的转换工具（见第7章）。这可以节省大量的时间，因为你只需要指向你想要捕获的物理机器，轻松地将其转换为虚拟实例。
　　此外，使用虚拟机，可以“虚拟化”实验室。我们的很多客户购买了一些大型主机来运行他们的实验室。正如你在第3章中了解到的，理想的机器是运行多个多内核处理器、大量的内存以及大量磁盘空间的x64服务器。在实验室环境中，可能不需要共享存储。这一切取决于实验室操作的服务级别协议。服务器安装x64操作系统（OS）、安装选择的虚拟化技术，那么硬件准备工作就算完成，可以开始运行。当考虑到这些机器的成本比起拥有一个全部为物理机的实验室的成本，它们确实降低了你的总体成本。
　　你可以使用虚拟机进行一系列你使用物理机所不能进行的操作。例如，你可以轻松地创建一台源计算机。安装首个操作系统实例到虚拟机中、自定义其配置、更新其默认用户配置文件、更新其相关补丁程序，一旦已准备好，复制它并移除此副本的个性化。瞧！你现在已经拥有一台源机器，可以通过复制和重新使用源机器生成你需要的任何机器角色。这比起使用物理计算机实在是容易得多。
　　如果Windows Server是主机操作系统，另一个主要的优点是可以在Windows Server 2003（WS03）或者Windows Server 2008（WS08）上使用Volume Shadow Copy Service（VSS）（卷影复制服务）。由于虚拟机只不过是在硬盘上的一系列文件，所以可以通过启用VSS为它们提供自动备份保护，然后依靠先前版本的客户端快照几乎可以立即恢复损坏的虚拟机。VSS每日自动建立2个快照，可以存储最多64个不同的快照（在WS03中）或者512个快照（在WS08中），这就为你的虚拟机提供了足够的保护级别。它并不是取代正常的备份，但如果发生什么事情，它是至少是低成本的第一道防线。
　　注意：VMware从ESX 3.5 Update 2版本开始提供VSS Writer，为ESX提供了与Hyper-V类似的快照功能。
　　



　　6.3　物理与逻辑工作空间
　　在测试实验室中，虚拟机技术的另一个优点是，不需要一个常规实验室通常所需要的物理空间。如果通过在一组指定的服务器上承载一系列虚拟机的方法在数据中心创建实验室空间，那么主机服务器可以轻松地设在普通的数据中心内，并且可以像对生产服务器一样对虚拟机进行标准的操作——备份、补丁更新、防病毒更新等等。然后，你的技术团队可以通过普通的网络连接到这些虚拟机服务器主机。由于某些原因你可能要为你的团队提供一个独立的网段以隔离它们的网络流量，但如果所有的一切都是发生在数据中心内相同的服务器主机上，那么网络流量的问题已不成为问题。
　　



　　6.4　定义实验室需求
　　现在，你已经了解了实验室的各种需求，你可以开始准备建立实验室。为了能够正确地建立实验室，可能需要一些初始的采购。许多组织总是事后才想起建立实验室，使用网络中最古老的机器，任由实验室技术人员不得不拆取各种机器的配件以尝试把一些适用的配件组合到一起来组建实验室。千万不要犯这种错误！实验室是项目的中心，因此，请确保要正确地建立实验室。下面是一个你可能需要参考的示例。要求的范围将取决于你项目的规模。请记住，在所有的其他要求——内存、硬盘空间——都得到满足的情况下，可以在每个处理器上运行最多8个虚拟机。
　　6.4.1　主机服务器的配置
　　支持实验室所需的最小配置，应类似于下面的列表：
　　▼主机服务器（多台）
　　■双x64四内核SMP服务器
　　■为主机操作系统分配512MBRAM
　　■为在主机上运行的每个虚拟机分配256MB至512MBRAM
　　■至少使用2个磁盘来建立独立磁盘随机阵列（RAID）1（镜像）
　　■最好使用3个以上的磁盘来建立RAID 5（带奇偶校验的条带）
　　■尽你所能使用最大容量的磁盘，目前大约需要500GB
　　■为系统驱动器保留约50GB的空间
　　■为将用于存放虚拟机的数据驱动器分配大部分的空间
　　■为将用于存放由VSS产生的卷影副本保留约50GB的空间
　　■双网卡（NIC），最低速度为100Mbps以支持多个连接到由服务器承载的虚拟机；向虚拟化厂商核实，看看你是否可以对NIC进行组队
　　■技术员工作站（多台）
　　■1-GHz处理器（64位，如果可能的话）
　　■最少2GBRAM
　　■支持DirectX 9的显卡，至少有128MB的专用图形内存
　　■DVD-ROM驱动器
　　■音频输出
　　▲外置硬盘驱动器（多个）
　　■250GB的外置驱动器，7200转，使用USB 2.0或者FireWire（IEEE 1394）接口
　　这些系统应该可以支持长期的实验室要求。但是，如前所述，由于你使用实验室作为虚拟化项目的开始，那么你将需要使用共享存储的群集主机。一旦你准备好将虚拟化迁移到生产环境中，这些系统将走出实验室。
　　6.4.2　虚拟机的配置
　　应该按照以下列表来配置虚拟机：
　　1.标准服务器虚拟机
　　2.企业服务器虚拟机
　　3.裸金属虚拟机
　　4.Vista PC虚拟机
　　5.Windows XP PC虚拟机
　　在网络中，这些系统可以作为源虚拟机用于配置系统。
　　6.4.3　虚拟机用户账户
　　当建立虚拟机并分发到技术团队时，用户账户也是至关重要的。在单元和功能测试级别，可以在服务器和工作站虚拟机中安全地向项目团队的技术人员授予管理访问权限，因为它们是独立的环境。但随着测试级别的进一步升级，需要收紧更改权限，只授予实验室管理员具有高特权账户的访问权限。毕竟，对于基础架构来说，捕获更改需求才是这些环境的目的。
　　当给单元或者功能环境分发独立的机器时，应尽量将分发的服务器设置为域控制器。它们的作用与成员服务器不同，但可以更容易地为技术人员所需的账户分配不同的角色。在许多情况下，这些测试级别需要一个单独的PC虚拟机或者一个带有服务器虚拟机的PC虚拟机，在此情况下服务器可以扮演一系列不同的角色。
　　当你授予用户访问虚拟机（构成整合或者阶段测试级别）所需的权限时，正如技术团队将向你提供的信息所描述的那样，你应该给予他们具有相应访问权限的账户。
　　6.4.4　所需的服务器和工作站角色
　　在每一个测试级别中，需要指定或创建多个不同的机器角色。如前所述，在单元和功能测试级别中，服务器角色可以集成到一个单一的虚拟机中，但随着测试级别的不断提升，将需要分离不同的角色，以表示正在运行的是生产环境。例如，整合测试级别可能仍然是将多个角色一起加入多台机器中，但当到达分阶段级别的时候，应该尽可能地与生产环境相似。在开始对生产环境本身进行转变之前，分阶段是最后的技术测试，因此需要把测试彻底做好（见图6-3）。
　　图6-3　在虚拟实验室中所需的不同角色
　　提示：可以使用虚拟机模拟远程站点。服务器操作系统包括类似于Cisco设备的路由功能。例如，在Windows中，可以在2个不同的虚拟机上启用路由和远程访问（RRAS）服务，使用它们来模拟从本地到远程站点的数据路由。然后，可以将分支办公室服务器角色添加到位于远程路由服务器后面的站点中。
　　还可以从虚拟应用市场上下载一些好用的路由器虚拟机。如果许可是一个问题，免费的应用是一个很好的选择。可以在www.vmware.com/appliances中找到它们。
　　最后，实验室将需要提供多种不同的级别类型和多种不同的环境。请记住，当建立更长久的测试级别或者环境时，需要为实验室基础架构建立冗余。例如，分阶段测试级别应该至少有2个域控制器，如果模拟远程站点，还需要在解决方案中包含复制引擎，从一个位置复制对象到下一个位置。
　　虚拟机软件还有助于这一过程。一旦建立并准备好机器，在受控制或者自助服务的基础上，你可以为用户使用某些工具自动调配这些机器。Microsoft System Center Virtual Machine Manager（SCVMM）（Microsoft系统中心虚拟机管理器）是一个虚拟环境管理工具，让你可以通过熟悉的界面管理多台主机和虚拟机。它还提供了一个用于虚拟机创建和生成的自助服务门户网站（见图6-4）。然而，这个工具只支持同一时间生成一个机器。如果需要生成多台机器——例如，为了创建整个电子邮件环境，包括目录服务器、邮件服务器和最终用户设备——必须为测试人员一个一个地建立。然而，这正是虚拟实验室的主要优点之一：每一台机器、每一个环境都完全可以重复使用。
　　图6-4　SCVMM允许最终用户测试人员调整和控制他们自己的虚拟机
　　无论如何，对于允许最终用户测试人员可以创建虚拟机的策略你一定要小心控制。毕竟此目的主要原因是减少数据中心计算机的数目，而不是扩散它们。为了控制用户创建的虚拟机，你可以设置时间限制策略，一旦用户的工作完成后将会自动将其销毁。
　　VMware也提供了一个实验室管理工具。VMware Lab Manager（VMware实验室管理器）是一个用于管理和维护整个环境而不是单个虚拟机的工具（见图6-5）。因此，它是目前比Microsoft更强大的竞争对手。
　　提示：如果你没有使用VMware的工具，你可以查找其他的实验室管理工具。例如，VMLogix（www.vmlogix.com）和Surgient（www.surgient.com）也提供了这种类型工具。
　　图6-5　Lab Manager可以管理整个系统配置
　　6.4.5　每个测试级别的要求
　　表6-1提供了每个测试级别的要求准则。依据你自己的需要对它们进行调整。
　　这5个环境都有其自己的要求，但幸运的是，上一个级别要求可以在下一个级别中重复使用。下面是机器重新使用的分类。
　　▼单元级别　单个技术人员使用存储在外部磁盘他们自己的机器，并连接到他们自己的电脑上。
　　■功能级别　作为从单元升级到功能级别的团队成员，由于他们不再需要在这一级别进行测试，所以他们可以重复使用原来在单元级别中使用的机器。
　　■整合级别　所有团队成员开始共享相同的虚拟和物理机器的集合，因为他们开始将各自的一部分解决方案整合到单一的环境中。激活变更控制以捕获所有的实践。
　　■分阶段级别　所有技术团队成员共享生产环境的一个缩小版环境。变更控制是绝对要有的，并且没有跟踪就不能进行变更。测试程序已经全部完成，并且经过了从开始到结束的测试。
　　▲试点级别　针对所有的团队成员，包括行政职员，大约是全体员工的10%，向他们部署生产系统以进行测试。
　　



　　6.5　创建实验室环境
　　一旦了解了实验室环境的工作过程，实际创建它其实更为简单。如果想让你的技术团队成员可以尽早进行测试，那么需要做的就是为单元和功能测试准备好所需虚拟机。这些准备可以是相当的迅速，但仍应该谨慎处理。理想情况下，已经开始采购所需的虚拟机——外置驱动器和高性能的个人电脑——并且已经决定将要使用的虚拟化技术，并获取了虚拟化软件。这将是此实验室负责维护的许多源安装文件的第一个。还需要获得所有将要使用的操作系统的源安装媒介。由于ISO文件可以充当为虚拟机中的CD/DVD驱动器，所以建议将安装媒介转换为ISO文件，以方便日后的使用。
　　一旦做好准备，请按照以下顺序准备这2种环境。依靠具有足够能力的现有工作站来执行这些步骤。
　　1.在具有足够能力的工作站上安装虚拟化技术，以创建虚拟机。
　　2.创建第一个虚拟机，为其分配内存、磁盘空间和网卡。最好以机器名创建一个新文件夹，并在此文件夹中存储所有的虚拟机组件文件。
　　3.将虚拟机的CD/DVD驱动器连接到要安装操作系统的ISO文件上。
　　4.执行安装，通过组织中的操作系统安装标准程序来运行。
　　提示：由于你将使用物理到虚拟的转换工具来实际转换你的数据中心，所以可以通过将现有的物理计算机转换为虚拟机来创建这台机器。
　　5.像平时那样自定义计算机，更新默认的用户，并运行补丁和更新程序。
　　6.对Windows Vista之前的任何Windows的副本，从位于对应的Windows安装光盘上的Deploy.cab文件中复制以下文件到位于%systemroot%驱动器上的一个名为SysPrep的新文件夹中——通常是C：驱动器：
　　■Setupmgr.exe
　　■SysPrep.exe
　　■Factory.exe
　　■Setupcl.exe
　　对于Vista和Windows Server 2008系统，可以使用位于Windows＼System32＼SysPrep文件夹中的SysPrep工具。
　　对于Linux操作系统，可以使用自定义脚本来准备机器。
　　7.对于Windows Vista之前的版本，运行Setupmgr.exe生成SysPrep.inf文件。使用组织的标准来为此文件提供所需的答案。关闭Setupmgr.exe。
　　对于Vista和WS08，可以从Windows安装自动化工具包中运行计算机映像管理器（WAIK可以在以下地址中找到www.microsoft.com/downloads/details.aspx？FamilyID=C7D4BC6D-15F3-4284-9123-679830D629F2 & displaylang=en）。重申一遍，对于Linux可以使用自定义脚本。
　　8.复制此虚拟机的整个文件夹，重命名此文件夹并将此虚拟机文件命名为“machinename SysPrepped”，在你的虚拟机工具中打开此新机器。
　　9.在此机器上运行SysPrep.exe并选择Reseal选项，移除其个性化选项，然后将其关闭。现在，你已经拥有一台可以生成大量副本的源计算机。
　　10.重复此过程，直到已经复制了数据中心中的每个操作系统。
　　11.为每台机器建立文档，列出用户账户和功能；将它们复制到外置磁盘上；将此磁盘提供给你的技术团队成员。
　　现在，你的团队成员准备好继续完成自己的工作，你可以继续为实验室创建和准备工作环境，准备整合和分阶段环境。
　　6.5.1　虚拟机和软件许可
　　尽管使用的是虚拟机，但仍然必须意识到许可问题，特别是，如果你正在建立实验室。因此，不推荐使用软件或者操作系统的评估版本。下面是如何给虚拟机许可一般准则。应该向供应商确认，以确保这些准则满足他们的许可要求。
　　▼SysPrep机器　SysPrep机器不需要许可，因为它只是其他机器的种子机器，实际上并不会被使用。一旦已经复制了SysPrep机器，并开始对其进行个性化设置，那么需要为此机器提供一个许可证
　　■运行中的虚拟机　每台已命名并在运行中的机器通常都需要有它自己的许可证
　　■复制的虚拟机　虚拟机的副本不需要自己的许可证，只要它们不是在同一时间运行
　　▲复制和已重命名的虚拟机　每次复制一个虚拟机并将其重命名，那么需要为它分配一个许可证。重命名的机器被视为是一台完全不同的机器，因此它需要一个许可证
　　对Microsoft产品，可以使用Microsoft开发人员网络（Microsoft Developer Network，MSDN）或者TechNet Plus订阅，对于它的每个产品你可以获取10个许可证，虽然每个许可证都需要激活。这2种订阅都支持虚拟机的合法重新使用。
　　如果主机操作系统是WS03或者WS08的企业版，那么可以在不增加成本的情况下运行4个Microsoft服务器虚拟机。让主机系统运行此操作系统是一个很好的理由。关于更多Microsoft Windows Server虚拟机许可证的详细信息可以在下列地址中找到：www.microsoft.com/licensing/high-lights/virtualization/faq.mspx。
　　当准备建立实验室，并进行整合和分阶段测试级别时，需要执行以下操作：
　　▼对于主机服务器，从基本的服务器安装（安装多台）开始
　　■为实验室存储库创建文件共享
　　■在主机服务器上安装虚拟机软件
　　▲创建或者P2V用于模拟生产服务器的虚拟机，以及生产环境的其他方面
　　将发现需要大量的存储空间。必须为存储空间做好规划，请牢记以下的要求：
　　▼用于存放所有实验室数据的空间
　　■用于所有操作系统安装媒介的空间和所有所需软件产品的空间
　　■用于存储在测试过程中生成的映像的空间——包括虚拟机和主机系统（如果你没有使用集成的hypervisor）的映像
　　▲用于虚拟硬盘备份和复制整个虚拟环境的空间
　　平均来说，最少需要500GB的空间，但此数字会受到磁盘映像、项目涉及的虚拟机和应用程序数量的影响，这还没有包括主机服务器本身所需的存储空间。
　　在建立整合和分阶段测试级别的时候，请记住，它们需要尽可能与生产环境相似。还请记住它们不需要完全相同。例如，没有理由使用相同的Active Directory（AD）（活动目录）或者身份管理林或域名，因为它们不会影响PC的部署过程。理想情况下，使用合适的AD组件名，要求是有意义的和你可以长久记住的名字。最好还是根据目的来实际获取适当的域名，因为它们是永久性的，这样低的成本不会为项目的预算带来负担。
　　当使用实验室的部分客户端计算机时，使用它来测试当前使用中的相同功能和特性或者为生产环境中的使用做规划。包括相同类型的硬件、应用程序和网络配置。
　　注意：通过使用合适的硬件，实验室也可以转化为便携式的环境。多个制造商现在都正在发布强大的便携式硬件。例如，NextComputing和LLC都提供了基于其NextDimension系统的便携式实验室服务器。此系统可以包括多个双内核CPU，大量的内存，多个串行带有足够空间的ATA（SATA）驱动器，甚至多个监视器，所有这一切都在一个可移动的设备中。有关NextDimension的详细信息，请访问www.nextcomputing.com/。
　　6.5.2　建立完整的环境
　　既然已经创建了独立的机器，那么你就可以使用它们来建立整个环境。目标是建立一个可重复使用和容易重新调整其用途的环境，并且可以完全模拟数据中心的网络基础结构。这意味着实验室需要提供以下几个基本的服务。
　　▼身份管理，例如，通过Microsoft活动目录，在一个单独的域目录林中运行2个域控制器
　　■电子邮件功能，例如，通过Microsoft Exchange Server提供电子邮件功能
　　■数据库存储，例如，通过Microsoft SQL Server提供数据库存储
　　■群集技术，使用虚拟硬盘驱动器绑定为共享数据存储
　　■为客户端访问虚拟环境提供终端服务
　　▲为测试/证明概念的目的提供其他所需的技术
　　所有的虚拟机应运行在免费的虚拟化引擎上（见第7章）。用户和参与者访问测试环境的最佳方法之一是创建一台运行终端服务（Terminal Services）的计算机。使用终端服务的优点是用户可以像域的成员那样具有访问环境的权限，具有单点登录的体验。而用户生产环境的机器不需要做任何的变更，这是另一个优点。
　　当以上工作完成后，应该形成一幅描述每台机器在基础架构中所处的位置和扮演的角色的图形化地图（见图6-6）。这种类型的地图将十分有用，特别是将使用实验室的技术人员。它列出了每台计算机的位置、它的名字、功能和IP地址，并提供了一个各机器之间如何相互作用的全局视图。
　　虚拟实验室的可能性几乎是无限的。例如，一个由虚拟机构成的实验室还可以包含和支持以下技术：
　　▼前端服务器的网络负载平衡（Network Load Balancing，NLB）服务　允许你测试和决定如何进行故障转移，以及为了添加NLB群集的节点而建立一个副本服务器需要哪些程序。
　　■后端服务器的Windows Server故障转移群集　这可以让你测试服务器群集的工作原理和它需要如何设置，并作为测试故障转移的策略。
　　▲独立身份管理或者用于实验室的活动目录　要确保对现有网络服务的影响减到最小，应该设置具有独立身份管理基础架构的实验室。
　　图6-6　令技术员更容易使用和理解的环境的可视化地图
　　这是一个让你发挥想象力的好地方。如果你具有访问你的组织所有技术的权限，那么你可以尝试你能想到的任何场景。当技术员完成测试级别建立，他们应进行全面的测试以确保它们确实可以在生产环境重现，它们将会支持整个虚拟化解决方案的测试，包括创建新的虚拟机，以及现有物理工作负载的转换。然后，一旦这项工作完成，你的实验室将会为黄金时段做好准备，并为能够支持解决方案做全面的准备。
　　6.5.3　虚拟实验室可交付的成果
　　虚拟机所提供的巨大投资回报的另一个方面是你可以从它们中提取可交付的成果。由于准备的机器只不过是磁盘上文件夹中的一系列文件，所以它们可以被轻易地传送，用于与它们创建时不相同的其他目的重复使用。虚拟机的性质还允许特别的管理用途，并可以执行一些在物理机上不可以实现或者就算它们是可以实现，但需要经过更加复杂过程的操作程序。下面是一些可以从虚拟实验室中期望交付成果的示例：
　　▼核心计算机　在实验室中这些计算机用来生成所有的计算机。需要确保这些计算机包括以下的内容：
　　■已经使用所有可用的安全补丁程序对这些计算机进行了更新，并更新了所有所需的组件。
　　■为了便于创建新的用户配置文件需要更新默认用户环境。此默认用户配置文件应包括在Windows工具栏的快速启动区域中创建特别的管理快捷方式。
　　■为了支持特别的功能如群集支持，为这些计算机添加2个虚拟网卡。
　　■为每台计算机创建一个单独的磁盘，磁盘C：。其他的磁盘可以在计算机有需要时添加。
　　提示：可能想要从开始就创建多个磁盘。例如，对于服务器虚拟机，最好是将所有临时或短暂的数据存放在单独的虚拟磁盘上。这对于在站点之间使用异步复制时有很大帮助。临时的虚拟磁盘可以方便地标识和用后抛弃。这样做可以节省大量的复制通信流量，而且在站点之间有些文件将不会被复制，如虚拟机的页面文件。
　　■重命名管理员账户。
　　■最后，将这些计算机保持在自动更新状态下，以便于当Microsoft发布新的安全补丁程序或操作系统升级时它们能自动更新。
　　■2台SysPrep计算机　接下来，保留一份这些计算机已移除的个性化的副本。使用这些计算机构成虚拟实验室。为了支持这个目的，还将需要执行以下步骤：
　　■在每台物理主机上对特殊的虚拟机或源文件夹建立2个计算机映像（所有文件）的副本。
　　■每次需要一台新的计算机，建立本地的已移除个性化计算机的相应版本的副本。将这台新计算机放置在一个标识其目的的文件夹中，并且重命名构成此虚拟机的文件。重命名的过程包括其父文件夹的名称、配置文件的名称和虚拟硬磁盘驱动器的名称。
　　■根据计算机的目的，可以添加第2个或第3个磁盘。这可能是实际的需要，例如，在Exchange或SQL Server主机中，这些磁盘将被用于运行数据库和事务日志。
　　■当计算机准备就绪，就可以在虚拟工具中打开它。由于它是一台已移除个性化的计算机，它需要进行个性化设置。这包括新的计算机名称和管理员密码。然后，在操作系统中进行计算机的个性化设置，并重新启动它。
　　■当计算机重新启动，管理员需要重新设置它的IP地址，确定是否需要第2个网卡，将它加入域中（如果适用），并格式化其他的磁盘（如果有需要）。
　　■一旦完成以上步骤，此计算机就可以用于其目的——也就是说，它可以在其环境中加载特殊的软件，以实现其目的。
　　■基础环境　接下来，可以使用SysPrep计算机的相应版本构建基础环境。标准网络应该包括以下计算机组成：
　　■LDAP服务器A　此服务器作为新的AD目录林中的第一个域控制器（Domain Controller，DC）。
　　■LDAP服务器B　此服务器作为新的AD目录林中的第二个域控制器。还将需要扩建活动目录的基本结构。
　　■电子邮件服务器A　在新域中支持电子邮件。
　　■终端服务器A　允许用户在域中互动。这台计算机可以包括的组件如Microsoft Office、Microsoft Visio、Windows Messenger和一个集成开发环境（IDE）工具，如Visual Studio。
　　数据库服务器A　这是SQL Server群集的第一个节点。
　　■数据库服务器B　这是SQL Server群集的第二个节点。这些机器有以下的特点：
　　■为了支持其新目的的软件，确认所有计算机已安装了所需的补丁程序和服务包。
　　■在域中创建组策略对象以便于计算机的操作以及用户对环境的访问。
　　■当这些计算机准备就绪后，为所有的计算机建立备份副本，以便于重新生成用于其他目的环境。
　　▲核心测试环境　使用相应的已移除个性化的计算机构建核心测试环境。这包括了创建以下的计算机：
　　■Web前端服务器A　它是NLB群集承载协作服务的第一个节点。
　　■Web前端服务器B　它是NLB群集的第二个节点。
　　■搜索服务器A　一台运行着索引和其他作业的服务器。
　　重申一遍，可以捕获这些机器的快照，并提供到其他项目的环境中进行测试。
　　这4个可交付的成果可在任何时候被任何其他组织成员重复使用（见图6-7）。由于每台计算机可以包括数GB的信息，因此它们不便于传输。在某些情况下，可以将它们复制到DVD中，但交付这些计算机的最佳方法是使用便携式USB磁盘。将磁盘挂接到服务器上，复制所有需要交付的计算机，瞧，这就交付了一个现成的网络环境。还可以将它们集中存放，并通过终端服务授予用户访问权限。
　　图6-7　从实验室中生成的4个可以交付的核心成果以及可以如何使用它们的示例
　　可以使用这些计算机做很多事情，有很多工作需要它们来完成。由于其本身的性质，前2个阶段易于重复使用，它们将会生成新的和未命名的计算机，但第3阶段和第4阶段需要更多的考虑。例如，轻型目录访问协议（Lightweight Directory Access Protocol，LDAP）环境需要重新命名，以确保对测试环境、重命名计算机的保护，修改它们的IP地址以避免冲突，重置所有的密码以确保没有人可以重复使用你自己的虚拟机。
　　



　　6.6　实验室可交付成果的重复使用
　　要能够重复使用你的可交付成果，需要3个关键项目。
　　▼他们至少需要2台具有足够内存和硬盘空间的物理主机来承载虚拟机。如果实验室有足够的资源，那么还可以通过集中虚拟机存储的方式来提供它们。但你可能会考虑收费程序，让测试人员为他们所需的环境付费。
　　■为运行的虚拟引擎购买适当的许可数量。如果你使用免费的虚拟化工具，那么你不需要担心此项。
　　▲访问虚拟机的核心映像并重新生成它们，将它们复制到新的环境中。请注意，这些计算机最少有4GB RAM——有时候会更大。因此，复制这些计算机会影响网络带宽。大多数情况下，最好的方法是使用可移动磁盘，如USB硬盘启动器来进行复制，或者是将它们存放到共享存储上，使用共享存储的复制功能，这就避免了影响网络带宽，并且可以提供高速的复制。
　　重新使用过程有所不同，这取决于其他测试人员决定使用的可交付成果。
　　6.6.1　可交付成果的重新使用第1个阶段：核心计算机
　　第一次可交付的成果就是创建的核心计算机。当有人请求重新使用这些计算机时，应在提交它们之前执行以下步骤：
　　1.建立一个原始计算机副本。
　　2.重命名此计算机的文件；重命名文件夹、配置文件和虚拟磁盘文件。
　　3.在虚拟化引擎中打开每一台新的计算机。
　　4.修改每台计算机的计算机名和IP地址。
　　5.应该对每台计算机进行更新。应该使用所有的补丁程序和升级包。
　　6.下一步，修改管理账户密码，以保护新计算机的安全。
　　7.（可选）在交付给请求者之前，可以移除每台计算机的个性化设置。
　　6.6.2　可交付成果的重新使用第2个阶段：移除个性化的计算机
　　需要牢记的第一件事是，这些计算机的时效性。只有在这些计算机相对较新的情况下才能使用。这是因为你不想必须对从这些映像中创建的所有计算机进行多次的安全更新。
　　已移除个性化虚拟机的使用应执行以下的步骤：
　　1.在新的实验室中，此虚拟机应该被复制到所有的物理主机上（如果正在将其移动到新的位置上）。
　　2.相应的虚拟机应该被复制到新文件夹中，构成这台虚拟机的基本文件应该被重命名。
　　3.在虚拟引擎中打开新的虚拟机，并且对其进行个性化设置。
　　4.应用虚拟机的核心功能。
　　5.每台计算机应该根据需要进行更新。
　　你可能需要为已移除个性化或核心虚拟机的请求者提供的另一个有用的项目是你用于创建虚拟实验室的安装和配置文档。请牢记一件事，文档要保持简短和突出重点，提供安装所需的信息摘要，还要提供关键的细节（见图6-8）。这将使第1阶段和第2阶段的可交付成果对于组织中的其他群组更加有用。
　　图6-8　建立文档的示例
　　6.6.3　可交付成果的重新使用第3个阶段：基础环境
　　正如你所推测，这种环境的使用需要一些特殊的程序，以保护其他现有的环境，包括实验室免受潜在的损害。当选择向其他团体提供基础环境时，为了可以为他们节省大量的准备时间，需要根据以下的步骤为此做准备：
　　1.必须向虚拟实验室管理员发送正式的请求。此请求必须包括：
　　■新环境的名称
　　■新域的DNS名称
　　■新域的低级别的名称
　　■计算机名称的3个字符的前缀
　　■每台计算机的IP地址列表
　　2.一个可以在虚拟机的准备过程中使用的通用管理密码。虚拟机提交之后，可以更改此密码。
　　3.一旦收到此请求，虚拟实验室团队可以开始为提交做准备。所有的虚拟器需要重新命名。在现有的计算机名称前添加代表新实验室的目的的3个单词的首字母缩写词应该是足够的。
　　4.域/目录林/安全上下文也需要重新命名，避免在内部网络上的重复。对于活动目录，执行此操作的工具和程序可以在以下地址中找到www.microsoft.com/windowsserver2003/downloads/domainrename.mspx。
　　5.所有的管理密码需要更改。
　　6.所有的IP地址需要更改。
　　一旦完成以上步骤，新环境就可以交付使用。由于该环境由多个虚拟机构成，交付的理想机制是通过可移动的USB硬盘，如果你有共享存储，那么你也可以通过集中存储的方式来交付。
　　6.6.4　可交付成果的重新使用第4个阶段：核心环境
　　与可交付成果第3个阶段一样，要重复使用此可交付成果需要特殊的步骤。有2种方法可以重复使用这套虚拟机。第一种方法是重命名安全上下文和所有的虚拟机，就像第3个阶段的重复使用一样使用相同的步骤。第二种方法是只需提供整个环境的原样。使用第二种方法的问题是要找到一种可以重复使用整个计算机集而不会影响其他现有的环境的方法。如果你设置了一个隔离网络运行实验室的新示例，就可以实现该方法。但因为该方法很容易出错，而且你不希望对实验室造成任何的宕机时间，所以为重复使用此交付的最好的方式是使用与交付成果第3个阶段相同的过程。
　　为这2个阶段的可交付成果提供另一个有用的工具是实验室建立路线图（见图6-9）。这个路线图以图形方式描绘了创建这2个阶段的可交付成果需要完成哪些工作，因此，让其他的用户可以更好地了解可交付成果的复杂性。
　　图6-9　虚拟实验室建立线路图的示例
　　对于这些实验室，你的组织可以通过此方法和实验室可交付成果的重复使用获得最大的优势之一是大的投资回报（ROI）和极少的总拥有成本（TCO）。想象一下：现在，你可以用2台物理机运行复杂的测试和培训环境，这在以前每个任务需要一台独立物理机。以前，为了创建一个实验室你不得不到处寻找剩余的硬件。现在，你不需要使用这种方法，因为你可以证明2台合适容量的低成本计算机也能创建实验室，特别是你提供了交付测试环境的结果。
　　



　　6.7　虚拟基础架构实验室管理实践
　　可以提供更低的总拥有成本（TCO）的另一个方面是在实验室管理实践中。因为这是一个提供持续服务级别的生产环境实验室，你需要为管理人员和实验室的管理设计适当方法。由于实验室运行在免费的虚拟化工具上，可以使用和必须执行几个特别的方法，确保环境的稳定性和安全性。这些步骤包括多个不同的领域：安全性、特别的建立步骤、备份和灾难恢复、以及维护。这些步骤的每一步都需要加以论述，以满足实验室的目的。
　　6.7.1　安全实践
　　虚拟基础架构中一个关键方面是安全性。它适用于环境的所有级别。例如，因为它是一个实验室，并且因为它基于虚拟机进行测试，所以操作员可能会应用不严格的安全规则或者甚至完全没有应用安全规则的倾向——密码可以自由地交换，相同的密码应用于所有的账户，等等。但这种情况是不应该出现的。由于实验室环境的目的是模拟现实，所以它应该尽可能地与生产环境有相同的安全性。因此，作为起点，在虚拟实验室中应该强制执行以下的安全实践：
　　▼要对所有默认的管理员账户重新命名。
　　■关键的密码，如每台计算机的本地管理员和安全上下文中的域管理员密码，只有关键人员才知道：实验室管理员和指定的系统管理员。只有实验室管理员才允许透露此密码给其他人，而且仅是在极端紧急的情况下。
　　■当密码被破解时，必须立即重新设置。
　　■要给所有的服务账户指定特别复杂的密码，并且将密码只分发给核心管理员。此密码与管理账户的密码是完全不相同的。
　　■用户账户使用一个通用密码，该密码可以通过内部电子邮件分发给用户，但当用户登录到系统后，需要立即重新设置该密码。
　　■在环境中使用适当的授权策略，只授予操作者在执行其工作中绝对需要的那些权限。
　　■在LDAP环境中创建适当的组织单元结构，以支持委派模式。
　　■安全补丁程序的交付，应该通过适当的基础架构来管理。例如，在Windows环境中你可以使用Windows Server更新服务，使计算机在任何时候都是保持最新的状态。
　　■应该安装企业级防病毒工具，并在每台机器上自动更新病毒库。
　　▲物理主机是工作组的一部分，不属于虚拟实验室管理的安全上下文部分。需要在这些计算机上创建特殊的操作员账户，让操作员无须使用本地管理员账户就可以登录到物理计算机。
　　由于虚拟实验室的安全上下文服务器是虚拟机，所以最后一项是非常重要的。由于需要主机启动后虚拟机才能启动，所以在物理主机上将它们加入安全上下文将导致登录问题。这些主机可以是生产域的一部分，而不是工作组，但实践发现将物理主机设置为具有与实验室的安全上下文的低级别名称相同名称的工作组成员，往往更加简单、更容易设置。通过这种方式，在网上邻居中它们都显示在一起。
　　这里所述的做法并不是意味着这是保证环境安全所需行动的完整列表；它们需要辅以强制执行安全环境的标准专业的做法。它们通过突出显示虚拟实验室所需的某些特定项目来提醒你注意。
　　6.7.2　特殊的建立过程
　　虚拟机的本质使它可以更方便地支持复杂的系统建立过程。这意味着在复杂的建立过程中每次执行一个关键的操作，你都可以对构成此虚拟机的文件建立一个备份副本，甚至更好的方法是为此虚拟机创建快照。快照可以让你的虚拟机返回到一个特定的时间点上。因此，当你正在建立一个复杂的系统时，你可以建立多个备份映像或者快照。
　　这些临时的备份副本和快照的优点是每当一个操作失败时，备份副本令虚拟机可以轻易地返回到上一步并重新开始。这在物理服务器上是不可能实现的事情——除非你使用磁盘映像工具，但这比起虚拟机的简单的磁盘复制需要更多的时间。一旦完成复杂的安装操作，就可以放弃这些临时的备份。在虚拟机的建立过程中应该考虑这一策略。
　　6.7.3　备份和灾难恢复
　　备份也是一个你可以利用虚拟技术优势的地方。虚拟机很大的优势之一就是它们是由位于文件夹内的文件组成的。因此可以启用多种类型的保护级别。
　　▼第1个级别的保护由手动虚拟机备份提供。在任何指定的虚拟机上设定每当有关键的事件发生时，就暂停此虚拟机，保存其状态，并对包含其文件的文件夹建立副本。然后，重新启动此虚拟机，继续执行操作，如果一切正常，此手动备份虚拟机就被删除。否则，操作员可以迅速返回到虚拟机先前的版本。
　　■第2个级别的保护是由Windows Server附带的强大功能来提供（如果你的主机运行Windows）：卷影复制服务（VSS）。VSS是一种默认的服务，可以自动保护存储在共享文件夹中的数据。默认情况下，VSS一天创建2次快照，任何激活了VSS服务的驱动器或卷可以存储多个快照（WS03可以存储64个，WS08可以存储512个）。要恢复损坏的虚拟机，打开其文件夹的属性，还原到先前的版本。若要确保此项服务适用于所有的虚拟机，它们的文件夹应该存储在一个共享的文件夹内，由于磁盘在默认情况下是共享的，所以VSS自动将每个卷看做是一个共享的文件夹。
　　■第3个级别的备份是默认的备份技术，就是对虚拟机内部的内容进行备份。每当在系统上发生了关键的事件，就可以使用这项技术来恢复。
　　■第4个级别的备份可以由实用程序如Windows Server 2003资源工具包中的Robocopy提供。如果你有2台主机，你就可以创建一个Robocopy作业计划，获取一台主机上的所有虚拟机，并将它们复制到另一台主机上，反之亦然。由于Robocopy可以智能地仅复制更改过的文件，因此并不会占用太大的开销。
　　▲第5个级别的备份可以由你的企业备份工具提供。由于虚拟机只是文件，所以在磁带上使用文件系统代理应该足以保护这些虚拟机。
　　在生产环境实验室中，备份是实验室整体运作的重要组成部分。
　　6.7.4　实验室维护程序
　　由于虚拟实验室的性质，还需要为它提供特殊的维护方法。这些方法包括许多在传统计算机上管理方法的变化，如以下所示：
　　▼每周安全扫描　对于Windows系统，系统管理员必须在整个域中使用Microsoft Baseline Security Analyzer（Microsoft基准安全分析器）每周执行一次扫描，确保所有的计算机都是安全的。这可以减少Windows Server更新服务的使用，因为此更新服务保护的不仅仅是操作系统。对于非Windows环境请使用适当的工具。
　　■每周病毒核查　每周一次，系统管理员应确保将最新的病毒定义应用到所有的计算机上，确保不存在不受保护的计算机。此外，应错开病毒（AV）扫描的运行时间表。当所有的虚拟机尝试在同一时间运行病毒扫描时，可以防止物理主机上的性能问题。
　　■每周维护窗口　每周一次，如果有需要，对环境保留一个特别的维护窗口，以执行主要的维护活动。
　　■每周可用空间核查　每周一次，系统管理员要核查物理主机和虚拟机磁盘上是否有适当数量的可用空间。
　　■每周事件日志核查　每周一次，系统管理员要在实验室中的各台计算机上核查其事件日志中是否有不良的事件。
　　■每周备份核查　每周一次，备份管理员要确保对所有的计算机正确地执行备份，并要向系统管理员报告。此外，系统管理员要在物理和虚拟机上核查卷影副本是否正常工作。
　　■更改日志　每次执行了对环境的更改都要写入一条实验室更改日志。这有助于确保正确记录事件。
　　▲特殊的虚拟机删除程序　每当虚拟机上发生重要的事件时都要执行手动计算机备份。如果事件或更改是成功的，此特殊的备份应该被删除，但有时候这个备份没有被删除。因此，必须进行定期删除事件备份。由于在文件系统中的工作与虚拟引擎没有实际联系，所以容易引起混乱，因此可能会删除错误的虚拟机。若要确保这种情况不会发生，在删除之前应将需要被删除的机器移到一个特殊的将被删除的文件夹中。然后，应进行一次整体的系统检查。如果在你的虚拟引擎中的所有虚拟机都运行正常，那么就可以将备份删除。如果将不正确的虚拟机复制到此文件夹中，在虚拟引擎中的一个或多个虚拟机将不再可用。这同样适用于快照。大多数的虚拟引擎可以存储多达512个虚拟机快照。你必须经常整理这些快照，只需保留有效的副本。
　　这些程序已添加到适用于所有IT环境的正常维护程序中。
　　



　　6.8　虚拟实验室最佳实践摘要
　　可以从虚拟技术的使用中得到的最重要发现之一是，可以在短短的几个星期内，在网络环境中建立和测试几乎所有的功能，有时候甚至是几天。现在，你可以使用核心虚拟机，一套全面的安装指令集，因此准备工作环境所需的时间应该可以大大减少。此外，这里有一些最佳实践的建议。
　　▼为了增加测试环境的执行速度，可以从虚拟实验室中重复使用可交付成果。
　　■为了支持测试环境，硬件采购过程应该简化使效率更高。也许你认为在任何时候都有一堆服务器在手。然后这堆服务器可以作为一个资源池，分配给不同的测试环境使用。为了方便这个池的创建，可考虑将所有当前的测试环境迁移到虚拟基础架构。这样做应该可以腾出多台机器。当虚拟化生产服务器时，你还可以添加更多的服务器到这个池中。
　　■第9章将讨论P2V工具，它肯定是整体实验室工具包的一部分。在即将执行的实际迁移工作中也将需要它们。
　　■用于支持测试的服务器应该是包含许多内存和大量磁盘空间的多处理器系统，以便它们可以支持多种虚拟机。
　　■培训或者熟悉虚拟机对于任何虚拟实验室的成功是必不可少的。对虚拟机技术只有很少或者没有经验的技术人员将会发现在开始的时候容易产生困惑。
　　■词汇表和术语是一个很好的主意，可以确保每个人的认知都是一致的。
　　■在测试环境中保持主机在你创建的安全上下文之外。否则，这可能会成为一个问题，因为计算机管理的安全上下文针对的是虚拟机，并且虚拟机需要物理主机启动后才可以运行；然而，要登录到物理主机，你需要访问这些服务器。
　　■准备好一份沟通计划是不错的主意。例如，可以参考2篇文章制作一份介绍性的文档。这样一份文档对于新技术人员快速掌握虚拟技术非常有帮助。
　　■向技术人员提供虚拟实验室的图形表示形式是一个很棒的主意。这种图形地图通常是操作员使用的最重要的一份文档。
　　■此外，记录你测试环境中的所有活动的变更日志。当你尝试排除系统故障时，此日志将会十分有用。
　　▲最后，应该考虑为你的员工提供一些虚拟机的实际操作经验。对于Windows环境来说，可以访问Microsoft当前通过MSDN或TechNet承载的虚拟机。两者都提供了直接在虚拟机上运行特定的练习设置的能力，比起所花费的时间，让你无须任何其他成本就可以获得宝贵的经验。这可能是让技术人员快速掌握这项技术的最佳方式，并且它是完全免费的。要了解更多有关TechNet虚拟机的信息，请访问http://technet.microsoft.com/en-us/bb738372.aspx。
　　现在，你已经运行了虚拟实验室，你可以开始收获其益处。本节概述了许多要点，但有一点将肯定是你最重视的，或者说，让你的上司最重视的是你将把所有测试环境从物理迁移到虚拟环境中获得的成本节约。还有，加上虚拟机具有物理机所没有的灵活性，从现在开始，将可以极大地提升你的工作和学习新技术的途径。
　　



　　6.9　迁移到虚拟数据中心
　　建立虚拟实验室是熟练使用虚拟化技术的最佳方式。你可以熟悉虚拟机的内容、虚拟机的建立、虚拟机的管理方法等。通过良好的实践来打好坚实的基础。下一步将是建立主机系统并开始创建资源池。在这种情况下，你肯定需要使用hypervisor和共享存储。然后，你就可以准备开始测试P2V迁移，将数据中心转换到虚拟基础架构中。
　　



　　第7章　使用服务器虚拟化
　　服务器虚拟化技术是迁移到动态数据中心的驱动力。虽然建立一个可以动态地响应业务需求的数据中心的概念已有数十年，但直到VMware引入了生产级别的服务器虚拟化技术才让真正的动态数据中心成为可能。
　　多年来，分析公司Gartner一直宣扬的IT成熟度的4个阶段是：
　　▼基本的　组织只使用特定的IT程序。大多数管理员做自己的事情，并且即使有，也只有少数的标准程序。
　　■标准化　组织开始使用标准作业程序（SOP），并且所有的管理员都依靠它们来运行数据中心。由于每个人都知道问题的起点，因此问题更容易处理。
　　■合理化　组织开始从网络中移除多余的设备和服务。虽然以前阶段的组织只有一种倾向，就是在需要时添加基础设施的设备，合理化的组织会按照规则和指导准则办事，以避免添加基础设施的设备，除非是有绝对的必要。例如，对于中心的文件共享，组织需要审查存储中的文件、确定其有效性、存档过时和未使用的文件，从现有的资源中整理出额外的可用空间，而不是添加更多的存储空间。
　　▲动态的　组织可以动态地响应业务需求。可以根据需要生成临时的工作负载，一旦他们的需求得到满足，将从数据中心中移除此工作负载。工作负载自动运行时需要按照既定的策略。所有的操作都是已经过简化的，很少会发生问题，但IT人员处理这些问题，往往会更复杂和更有趣。
　　4个阶段服务中的每个阶段是下一个阶段的基础。操作基于3个关键的要素——人员（People）、个人电脑（PC）和过程（Process），即基于IT的3个P（见图7-1）。
　　图7-1　IT架构完全成熟的4个　阶段及它们的基础
　　▼人员是组成任何数据中心的核心。他们是实现精简操作标准的驱动力。
　　■个人电脑代表数据中心的技术方面。通过选择适当的技术，组织可以减少开销、简化IT管理。
　　▲过程形成了操作实践的核心。标准的过程是基于SOP的，以确保当需要执行任务时，所有人员都以相同的方式做出响应。
　　当迁移到服务器虚拟化时，你可以立即获得动态IT的优势，但如果其他的基础要素还没有准备就绪，那么就会增加操作的复杂性，并且很可能发现自己处于泛滥使用技术的状况，这甚至比以往任何时候都更加严重。
　　注意：要了解更多关于如何建立基于标准作业程序的动态数据中心的详细信息，请参阅《Windows Server 2008：The Complete Reference》一书，该书由Ruest和Ruest编著（McGraw-Hill 2008年出版）。
　　当决定如何实施动态数据中心的时候，你会发现可以在数据中心内运行此项技术之前，需要先解决服务器虚拟化的4个关键方面。这些方面包括：
　　▼如何选择服务器虚拟化技术
　　■如何使用虚拟工作负载
　　■如何提供新的虚拟机
　　▲如何为现有的物理工作负载提供虚拟机
　　当你解决了所有这些方面的问题，一旦服务器虚拟化技术部署妥当，你会越来越熟悉如何管理你的数据中心。
　　



　　7.1　选择服务器虚拟化技术
　　你选择的服务器虚拟化技术必须满足你的所有需求。要做出正确的选择，必须知道和了解有哪些主要的选择以及在你自己要求的基础上哪一种技术提供了最多的功能。第2章介绍了服务器虚拟化的概念，概述了在这一领域的主要参与者。虽然有一些不同的厂商提供虚拟化引擎，但实际上只有3家提供了全面的功能集：VMware，x86服务器虚拟化技术的创始者；Citrix，在2007年购买的XenSource，现在提供了XenServer产品线；还有Microsoft，现在通过在Windows Server 2008中的Hyper-V代码提供了虚拟化技术。大多数其他的厂商都是通过基于Xen的开放源代码来提供虚拟化技术。这意味着诸如Oracle、Sun、Virtual Iron以及更多的厂商，提供的技术比起Citrix没有很大的不同，因为他们提供的一切都是基于相同的代码。
　　但为了可以根据需求来选择正确的产品，你首先必须清楚了解每个供应商提供了哪些产品及其产品的结构是什么。接着，你将会想了解价格和实施成本。一旦你开始了解哪种产品最适合你的预算，你必须明白需要做什么和如何可以最佳地实现方案。这一决策过程是基于在第3章中介绍的虚拟化实施流程图，但这次的重点是放在服务器虚拟化上。重申一遍，了解每家厂商的产品对于你的决策过程将会有很大的帮助。最后，你的决定将具体体现在对每个主要的hypervisor的分析指标上——在一台主机上可以运行多少个虚拟机、主机的管理方式、在虚拟层支持哪些操作系统，等等——这可以帮助对市场上的每家厂商进行定位，观察其长期价值。
　　



　　7.2　技术和应用场景
　　3家主要的虚拟化厂商提供了多种不同的虚拟化解决方案。表7-1提供了每家厂商所提供的不同产品的简介，并将它们分类为软件虚拟化（SoftV）或者硬件虚拟化（HardV）。
　　这些主要厂商中的2家——VMware与Microsoft——还提供了其他的基于桌面的产品，可以模拟SoftV并可以在多种操作系统上运行。例如，VMware最先为世人所知就是通过其旗舰产品VMware Workstation来为其虚拟化引擎引入最新的功能集。这些引擎中的每一个，SoftV和HardV，都是实现虚拟化解决方案的一部分。例如，在第6章中，你主要是依靠免费的虚拟化技术来将你的实验室转换成一个虚拟的开发和测试场地。这是大多数组织开始使用虚拟化引擎的过程。实际上，大多数组织要实施服务器虚拟化技术可以使用一个标准的流程（见图7-2）。
　　图7-2　服务器虚拟化实施的4个阶段
　　一般从测试和开发环境来开始。然后，当掌握了这些技术，才将其生产工作负载迁移到虚拟化。几乎所有的工作负载都可以被虚拟化，并且只要准备了合适的主机（按照第5章的介绍），这样做就可以极大地减少数据中心的物理设备。一旦你对服务器工作负载进行了虚拟化，接下来就可以研究业务连续性解决方案。由于你所有的工作负载都变成了一个文件夹中的文件，这些策略就可以更容易地实现。最后，一旦基础架构变得安全和受到保护，就可以开始使用更高级的虚拟化策略来将你的工作负载转换为基于策略运行的动态服务。这些策略可以决定工作负载必须放置的位置、必须为虚拟机分配多少资源，以及虚拟机应该在何时运行。在这个阶段，你才进入了动态数据中心领域，并且开始真正将IT作为一种服务提供给最终用户客户。
　　但是，在可以实现动态地生成和管理工作负载之前，还有几个实施阶段，你将发现每一步对于其本身都是值得的。
　　7.2.1　服务器虚拟化的应用场景
　　正如你所见，多种应用场景可以通过服务器虚拟化主机的实施得以支持。它们受限于成本和功能，但其提供的每一个功能都是使用物理机器所不能轻易支持的。
　　▼系统测试　每个IT组织为了评估和了解新的技术以及如何使它们能融入网络，都已经架设了某种形式的测试实验室。通常，这些测试环境都是由从生产网络中剩下的零零碎碎的设备收集到一起而组成的。其结果是得到一个低成本、但不是很实用的测试环境。如在第6章中所见，虚拟化可以使用较少的物理设备来承载大量的虚拟机而建立一个全面的实验室环境。使用可撤销磁盘和虚拟机复制，IT可以通过复制生成任何应用场景并创建复杂的虚拟测试环境。它甚至可以使用将物理转换为虚拟（P2V）的捕获引擎来为生产中运行的物理机生产一个虚拟的副本。
　　■软件开发　每个软件开发人员都面临需要系统高权限的情况。这是完全可以理解的，因为在开发过程中，开发人员需要安装和测试软件。在锁定的环境中，如果你没有使用虚拟机来支持开发工作，这可能会成为一个重要的问题。通过在开发人员的工作站上运行虚拟机，开发人员就可以在虚拟机中自由地拥有完全的访问权限，而物理工作站可以保持全面的锁定。最重要的是，所有你需要做的就是支持原始的虚拟机。如果开发人员弄坏了虚拟机，你只需要为他们提供原始虚拟机的另一个副本。
　　■培训　负责支持计算机培训中心的每个技术人员将必定可以从虚拟化中受益。这是因为在通常情况下，每次运行一项课程时，你必须设计一种将每台PC返回到课程起点的方法。此外，你还需要设计一种可以重新调整PC用途，以支持其他课程的方法。有多个理由说明虚拟机非常适合用于培训。第一，它们很容易重新调整其用途——你需要做的就是针对课程创建一个原始计算机副本，然后在课程完成后简单地将培训的虚拟机删除掉。第二，虚拟机可以包含任何x86操作系统。这意味着，即使是最初创建的用于支持生产力培训，如办公自动化软件工具培训的教室，也可以成为一个甚至可以教授高级操作系统安装课程的完整和全面的技术培训中心。所有你需要的只是具有适量内存的PC，更大的磁盘驱动器用于存放虚拟机映像，以及快速的网络用于从中心位置复制虚拟机。一旦具备这些条件，你的培训室就可以支持操作系统、复杂的IT基础架构甚至开发培训。值得注意的是，现在有多家公司提供了完全依赖于虚拟机的技术培训课程。
　　■桌面帮助　在提供桌面帮组和支持服务的环境中，虚拟化可以带来巨大的效益，特别是如果技术人员需要支持多种操作系统更是如此。以前，技术人员需要通过将键盘、屏幕和鼠标的开关从一台PC转换到另一台PC，以能够访问多台PC。今天，每个技术支持人员只需要一台具有多个虚拟机的PC，就可以支持任意数量的客户端。这对于拥有多种不同客户类型的外包支持中心特别有用，因为每个技术支持人员都可以拥有他们自己特定的桌面环境。
　　■环境标准化　虚拟化的另外一个使用目的是控制和部署自定义应用程序。通过使用虚拟机，IT团队可以准备一个应用程序的工作版本，而不需要在物理计算机上部署应用程序就可以将完整的虚拟机部署到最终用户。这样做可以确保符合标准要求，并且可以帮助降低支持成本。更多关于这方面的内容将在讨论虚拟桌面基础架构的第10章中进行深入的探讨。
　　▲物理服务器整合　在过去的十年中，组织已经看到了由于一些不同的原因而导致出现服务器主机不断增多的情况。在许多情况下，这些机器只是以它们最小的资源利用率在运行。虚拟化为整合服务器硬件提供了机会，可以减少在数据中心中运行的物理主机的数量，但对于当前部署在组织中的每个功能都保持为独立的虚拟机。此外，现有可用的物理到虚拟机迁移工具使得此应用场景变得非常有吸引力，而且在任何数据中心中都易于部署。对于部署服务器虚拟化这是最具成本效益的理由。
　　关于虚拟化最需要记住的重要的一点是，每一个虚拟机都可以被视为网络中的一台物理机——一台可以与其他虚拟或物理机进行通信的计算机。IT可以通过与管理所有其他计算机相同的方式管理虚拟机。实际上，IT甚至可以向物理主机发送命令以便在开始操作（如软件部署）之前唤醒虚拟机。并且，许多虚拟化厂商都已采取了额外的步骤，包括全面的虚拟化管理工具，以解决当同时使用物理和虚拟引擎时你将会遇到的任何情况。
　　7.2.2　其他厂商的产品
　　第1章概述了现实很可能是你最终不得不在数据中心中运行多个hypervisor。当你运行的是3个主要厂商提供的hypervisor时，影响并不会那么严重，这是由于这几家厂商都已经投入了大量的工作以确保其管理工具支持其他厂商的产品。但如果你必须运行你已选择的管理接口所不支持的hypervisor，那么将会出现问题，因为要维护和运行多个管理界面。由于不能通过策略集中地管理虚拟工作负载，这将对动态数据中心有负面的影响。
　　以Oracle为例，Oracle正式宣布他们将不支持他们的产品运行在任何其他的hypervisor上，除了自家的Oracle VM（请参见在www.oracle.com/technologies/virtualization/docs/ovm-faq.pdf中的“Support Detail”（支持详细信息）下的Oracle VM Frequently Asked Questions（Oracle VM常见问题解答））。实际上，他们现在以“模板”的形式提供了其应用程序的所谓准备好运行（仅在Oracle VM上）和不需要安装的预封装版本。这种情况十分奇怪，因为他们提供了在多种服务器平台上运行的产品——IBM、HPUX、Microsoft Windows、各种Linux和更多平台——但是，因为这项政策，组织在数据中心中选择使用Oracle应用程序的时候将需要做认真的考虑，为这些应用程序采用另一种非主流的hypervisor及其附带的管理工具是否合理。Oracle VM仍是免费的基于Xen开源hypervisor的另一个版本，但由于Oracle修改了此代码，所以你必须依赖Oracle在Oracle VM中提供的自定义的基于浏览器的管理实用程序来控制其操作。对于企业级的Oracle客户，Oracle提供了Enterprise Manager（企业管理器），其中包含Oracle VM管理。
　　Novell和RedHat在他们的Linux发行版本中也提供了基于Xen的虚拟化引擎。重申一遍，这两者都不是由主流虚拟化管理引擎来管理的版本，因此，将需要增加其他的管理工具。
　　Parallels（www. parallels.com）提供了Virtuozzo，这是一种支持将硬件资源划分到独立的容器中，允许在相同的硬件上同时运行多个不同的虚拟机的分区平台。最初，这种产品设计的目的是运行其自定义操作系统的多个实例。Parallels（以前是SWSoft）一直致力于开发一种更通用的虚拟化引擎，以便与VMware的产品竞争。通过此新的虚拟化引擎，Parallels还与其他组织进行了合作——例如，Quest Software——以支持虚拟桌面基础架构。他们真正的虚拟化引擎虽然是市场上新的参与者，但就目前情况而言似乎采用的人不算多。
　　在市场上所有其他的厂商中，Virtual Iron（www.virtualiron.com）为其虚拟化平台提供了最先进的功能选择。多年以来，Virtual Iron一直以低成本的数据中心虚拟化解决方案来推销其产品，但随着3个主要厂商之间的竞争不断加剧，Virtual Iron的产品已经在很多方面失去了其原先的优势地位。
　　有一点可以肯定的是：由于各种原因，大型数据中心将结束管理多个hypervisor。因此，当他们选择使用某一种虚拟化管理系统的时候，仔细选择对于这些组织非常重要。关于这一主题的更多内容，第16章将进行详细的讨论。
　　7.2.3　VMware技术组件
　　VMware通过VMware Virtual Infrastructure（VI，虚拟基础架构）来提供其虚拟化技术，这是一套建立在其免费的hypervisor产品（ESXi）或者其收费的hypervisor产品（ESX Server）之上，为动态数据中心创建的完整的管理工具集合。VMware是当前提供了最全面的虚拟化管理工具的厂商，涵盖了所有数据中心运行虚拟工作负载所需的最重要的管理活动。这些功能包括以下内容：
　　▼中央管理控制台。
　　■可以同时为hypervisor和虚拟工作负载更新管理。
　　■同时为主机和虚拟工作负载提供了备份技术。
　　■为主机服务器提供磁盘共享技术，以支持高可用性。
　　■提供高可用性组件，以管理主机和站点的故障转移。
　　■提供实时迁移组件，可以将工作负载从一个主机实时迁移到另一个主机。
　　■提供实时存储迁移组件，可以将工作中的虚拟机从一个存储容器实时迁移另一个容器中。
　　■提供主机资源管理组件，可以将占用大量资源的虚拟机迁移到具有足够可用资源的主机上。
　　■提供电源管理组件，可以按照需求来开启或者关闭主机服务器。
　　■提供实验室管理组件，以支持生成和管理整个工作环境和单独的虚拟机。
　　■提供阶段管理组件，可以通过各种测试和开发阶段迁移成为IT解决方案。
　　▲提供脚本组件，以管理和自动化虚拟机与主机的管理。
　　在目前的市场上，此工具的选项是最全面的。VMware已经在虚拟化市场发展了10多年，因此，他们的产品仍然是所有可用产品中最成熟的。
　　此外，VMware产品是根据用户需求来划分的（见图7-3）。组织可以使用免费的虚拟化技术——基于ESXi作为免费的集成式hypervisor。通过在第5章中讨论的ESXi下载，组织可以访问VMware Infrastructure Client（VMware基础架构客户端，见图7-4），这使得他们能够独立管理主机服务器。ESXi是一种占用较少空间并作为一个管理平台将硬件资源分配给虚拟机使用（见图7-5）的真正的hypervisor。组织使用ESXi将自动获得在第2章中讨论的访问虚拟机文件系统（VMFS）创建的共享存储容器，同时虚拟对称多处理（Symmetric Multiprocessing，SMP）引擎允许虚拟机访问多个处理器内核。总之，这些工具为所有组织构造了一个良好的开端，尤其是它们还是免费的。
　　图7-3　VMware提供的基础产品
　　请注意，当在使用ESXi组件时出现了问题，要获取支持是要单独收费的。组织可以基于每个事件购买支持服务，也可以购买3次或5次套装的事件支持服务包，或者为每台主机服务器购买黄金或白金支持服务。
　　图7-4　通过VMware基础架构客户端管理主机和虚拟机
　　图7-5　VMware ESX和ESXi的基础结构
　　VMware ESXi和ESX之间的区别是ESXi映像只包含了hypervisor，而ESX映像同时包含了hypervisor和服务器的管理分区。当运行ESXi时，你必须使用远程计算机——物理或者虚拟——来管理主机。当使用ESX时，你可以依靠管理分区来管理和维护本地主机。
　　VMware ESX和ESXi最强大的功能之一是对关键内存管理功能的支持。这些功能包括：
　　▼针对虚拟机的最小/最大内存设置　此功能允许你对虚拟机指定一个最小值和一个最大值的内存设置。当虚拟机正在运行时，ESX开始将会以最小的内存数量分配给虚拟机。如果虚拟机需要内存，ESX将为虚拟机增加内存的数量，直到达到最大设置值。
　　■内存的过量配置　此功能允许你为虚拟机分配超过主机现有内存的更多的内存。当你建立一个虚拟机或者转移一个虚拟机到一台ESX主机上时，你可以通过最小/最大内存设置为虚拟机指定最小和最大的内存值。最大内存值甚至允许你分配超过主机可用内存的内存设置。然后，如果虚拟机需要使用你分配给它的所有内存，ESX将依靠基于策略的虚拟机管理来将虚拟机迁移到另一台拥有适当资源的主机上。
　　■透明页面共享　此功能只将重复文件的一个副本存储在主机内存中。此功能确实十分强大，这就是为什么VMware主机可以在内存明显低于其他hypervisor的主机上运行大量虚拟机的原因。例如，如果你的系统承载着10个Windows Server 2008虚拟机，那么每台虚拟机将只存储在操作过程中构成其核心进程文件的一个副本到内存中。在某些情况下，这可以节省多达40%的运行虚拟机所需的内存。
　　▲内存漂移　此功能允许你从不再使用的或闲置的虚拟机中回收内存，并将其分配给其他的虚拟机。这让ESX通过动态修改分配给虚拟机管理的内存，可以管理更多的工作负载。
　　这些功能令ESX和ESXi成为当今功能强大的hypervisor。
　　当组织越来越熟悉ESXi时，他们就可以向基础版的虚拟基础架构迁移，这包括3个额外的工具。第一个是VirtualCenter（现在的vCenter）——所有VMware VI管理的中心（见图7-6）。VirtualCenter的设计目的是随着组织不断增长的需要，可以像添加新工具一样添加特性和功能到基础架构中。因此，管理员永远不需要学习另一种工具，只需要熟悉其所承载的额外功能即可。
　　图7-6　VMware VirtualCenter的管理界面
　　此外，基础版的虚拟基础架构还包括了Update Manager（更新管理器）和Consolidated Backup（统一备份）2个工具，这2个选项也可作为VirtualCenter中的其他功能来启用（见图7-7）。更新管理器可以管理主机组件和虚拟机（见图7-8）的更新。例如，当更改或更新ESXi时，它可以替换整个固件映像，并且如果更新出现了错误，还为此提供了回滚的途径。当更新虚拟工作负载时，它是依靠客户端内置的更新引擎，如Windows虚拟机内的Windows Update。
　　图7-7　VMware VirtualCenter支持额外的功能插件程序
　　图7-8　VMware Update Manager可以同时管理主机和虚拟机
　　对于虚拟机的备份，可以依靠VMware Consolidated Backup（VMware统一备份）来进行（见图7-9）。统一备份通过使用共享存储技术支持创建快照，然后从此快照中生成备份，这对于虚拟机和管理它们主机的操作只有很小的影响或者根本没有影响。
　　VI（虚拟基础架构）标准版扩展了规模并提供了额外的服务。标准版提供的最重要的额外可用功能是High Availability（高可用性），这已经在第5章中进行了相关的讨论，它是结合VMFS来为主机提供类似群集的服务。如果一台主机发生了故障，它管理的所有虚拟机可以自动进行故障转移，并在群集中的另一台主机上重新启动。虚拟机会被重新启动，这是因为当原始主机发生故障时，虚拟机也会发生故障，直到它们被迁移到另一台主机上。请注意，此功能与VMware的实时迁移功能的工作方式是不相同的，实时迁移功能可以迁移操作中的虚拟机。
　　图7-9　VMware Consolidated Backup可以备份主机，虚拟机和内在的操作系统
　　VI（虚拟基础架构）企业版为组织提供了最先进的工具以支持动态数据中心。首先，此版本增加了VMotion，这是由VMware最早提出的著名的实时迁移功能（见图7-10）。在虚拟机运行中，VMotion可用来将虚拟机内容从一台主机迁移另一台主机上。要使这项功能可以运作，主机系统必须使用具有相同步进的相同的处理器，或者根据第5章中所述的ESX Server的Enhanced VMotion Compatibility（增强VMotion兼容性）功能。
　　图7-10　运行时的VMware VMotion
　　此外，企业版还增加了Storage VMotion（存储实时迁移）功能，这与VMotion类似，通过与VMotion结合将工作中的虚拟机从一个存储容器迁移到另一个存储容器中（见图7-11）。能够以无中断的方式将虚拟机文件从一个位置迁移到另一个位置，把管理员从传统的共享存储限制中解放出来。这意味着如果需要为主机服务器添加额外的共享存储，可以在不损害虚拟机操作的情况下添加新的容器。
　　图7-11　运行时的VMware Storage VMotion
　　然后，当你准备要在新的存储中运行虚拟机时，你可以简单地使用Storage VMotion将虚拟机文件迁移到新的存储中。这允许组织可以在不影响实际的最终用户操作的情况下来管理存储。请注意，与VMotion不同，Storage VMotion不需要在同一个存储容器中工作。
　　通过这些VMotion技术，VI的企业版中增加了2个功强大的工具。Distributed Resource Scheduler（DRS，分布资源调度程序）允许你为虚拟工作负载指定资源管理策略因为VMware支持通过最小值和最大值为虚拟机分配资源它可以不断监控虚拟机的需求，如果虚拟机需要比主机上可用资源更多的资源，就会通过VMotion将此虚拟机迁移到另一台主机服务器上。DRS定期扫描虚拟机和主机服务器以维护各自的最佳性能（见图7-12）。Distributed Power Management（DPM，分布式电源管理）与DRS一起协同工作以监控主机服务器的需求。如果不需要使用某台主机服务器，它将自动被转换到节能状态。
　　图7-12　VMware Distributed Resource Scheduler（DRS，分布式资源调度程序）
　　然后，当工作负载增加，需要系统支持它们时，DPM将启动此服务器并且指示DRS新的主机服务器已经可用。这些工具可以智能地监控数据中心的资源，动态地结合业务周期将服务器打开和关闭。它们是动态数据中心概念的核心。
　　虽然这3个收费的VI版本提供了对工具的补充，但每个工具也是可以独立使用，并且有些只能独立使用。例如，在第6章中讨论过的2个工具Stage Manager（阶段管理器）和Lab Manager（实验室管理器），都是只能以独立的方式来使用。但是，你必须具有某些VI的版本才能充分利用这些额外的工具。
　　VMware还为中小型组织提供了套装软件（见表7-2）。这些套装软件由一系列不同的组件组合而成，为最小数目的主机服务器提供支持。此外，可以使用第5章中提到的VMware的Total Cost of Operations（TCO，运营总成本）计算器来确定潜在的成本节约，此计算器可以通过购买VMware解决方案得到。
　　注意：要了解更多关于VMware的可扩展解决方案的详细信息，请访问www.vmware.com/solutions/smb/whats＿new.html。要获得VMware的运营总成本计算器，请访问www.vmware.com/products/vi/calculator.html。
　　重申一遍，每一种软件套装都为各种规模的组织提供了多种选项和工具。表7-3概述了VMware的虚拟基础架构组件的功能。
　　注意：要了解更多关于VMware基础架构的详细信息，请参阅www.vmware.com/solutions/consolidation。
　　正如你所见，VMware提供了相当多的工具以支持动态数据中心。难怪大部分已经实现了服务器虚拟化的数据中心最终都是依靠这种技术。
　　7.2.4　Citrix虚拟化技术
　　Citrix也为其虚拟化引擎提供了多种不同的工具。Citrix在2007年年底收购了XenSource——XenServer的制造厂商，并且依靠这次并购，创建了其虚拟化产品的基础。XenSource是由为Linux开发Xen扩展的开源项目而召集到一起的几位开发人员创建的一家公司。这些开发人员想要通过额外的技术，凸显和增强Xen hypervisor的能力，让Xen更上一层楼。
　　终端服务供应商Citrix通过收购XenSource将它作为自己的品牌，加入到hypervisor的竞争中。这使得Citrix能够加入到4种主要的虚拟化产品的虚拟化竞争中。
　　▼XenServer是其hypervisor产品线。
　　■XenDesktop是其用于集中式虚拟桌面管理的解决方案。
　　■XenApp（以前的Presentation Server）是其用于虚拟化应用程序的解决方案。
　　▲XenApp还支持终端服务和应用程序共享，支持其Presentation Virtualization产品。
　　虽然它提供了免费版本的XenServer——Express Edition（速成版），但Citrix没有提供SoftV产品，其所有的服务器虚拟化产品都是依靠HardV来运作。因此，在这方面它不同于Microsoft和VMware。表7-4概述了Citrix的XenServer产品。
　　与VMware不同，Citrix在提供hypervisor时没有提供额外的管理或者操作工具（至少在写作本书时还没有）。但是，Citrix已经宣布，它将致力于开发额外工具，特别是通过已知的标准，支持跨多种hypervisor平台的虚拟机的相互操作和管理的工具。它还宣布它打算免费提供这些工具。这一点在评估不同的虚拟化引擎的能力时绝对值得考虑。
　　Citrix的XenServer与Microsoft和VMware的产品相比有一个显著的优势，它能够从一个核心的虚拟机映像中生成不同的虚拟机。这意味着不需要生成多个吉字节大小的虚拟机，就可以依靠XenServer从一个单个虚拟机生成多个虚拟机，并且仅需捕获每个虚拟机文件中的差异。这个基于软件的功能，可以节省最多50%的你需要为虚拟机准备的存储空间，并且可以对你的存储底线产生积极的影响。VMware将这个功能加入到其最新版本的ESX Server中。然而，Microsoft仍旧不支持此功能。
　　注意：关于Citrix XenServer的详细信息，可以访问www.citrix.com/xenserver。
　　7.2.5　Microsoft虚拟化技术
　　自从2003年收购了Connectix，Microsoft就一直在开展服务器虚拟化业务。当时，Microsoft有打算收购VMware，但这笔交易被其法律团队以“如果Microsoft收购了VMware，它将成为世界上最大的Windows许可的单一所有者，因为当时VMware出售包含Windows操作系统的虚拟机作为其产品线的一部分”的理由禁止了。从那以后VMware停止发布预捆绑Windows操作系统的虚拟应用程序，但Microsoft仍然需要获得虚拟化技术，将它纳入其软件产品阵容中。最终留下了Connectix——Virtual PC的原始制造商。
　　Connectix之所以出名，是因为其最初发布的虚拟化软件可以让Macintosh用户在其系统上运行Windows应用程序。随后，Connectix将其虚拟化软件移植到PC上。当Microsoft收购Connectix的时候，它原来是专注于Virtual PC的PC版本，但很快地将它变成2种产品：Virtual PC和Virtual Server。两种都是SoftV类型的产品。此外，Virtual Server需要安装互联网信息服务（IIS）才能运行，因为它的管理界面是基于Web的（见图7-13）。
　　图7-13　Microsoft Virtual Server可以运行多种32位虚拟机
　　稍后Microsoft发布了Virtual Server的集成版，其中的System Center Virtual Machine Manager（SCVMM，系统中心虚拟机管理器）无须IIS就可以部署Virtual Server（见图7-14）。
　　图7-14　Microsoft Virtual Machine管理器是System Center的一部分
　　在2008年，Windows Server 2008（WS08）发布4个半月后，Microsoft发布了Hyper-V——一个集成在WS08操作系统中的HardV hypervisor。这是Microsoft的旗舰级虚拟化技术（见图7-15）。Hyper-V可以在Server Core（推荐）或者WS08的完全安装版本的模式上运行。此外，Hyper-V管理工具可以作为独立的工具来部署，以管理多个Hyper-V主机。
　　图7-15　Microsoft Windows Server 2008能够以完全安装（本图所示）或者Server Core的模式来运行Hyper-V
　　Microsoft随后修改了它多个现有的管理工具，以便与Hyper-V及其他的虚拟化技术进行互动和操作。表7-5列出了Microsoft的虚拟化工具集。
　　注意：可以在www.microsoft.com/virtualization/products.mspx找到有关Microsoft虚拟化的详细信息。
　　Microsoft在一段时间里一直在努力整合其管理策略，因此迅速地得到了提高，现已提供了广泛的虚拟化管理工具。同样的，它为其本身和其他的hypervisor提供了全面的方法来进行虚拟化（见图7-16）。
　　图7-16　Microsoft的虚拟化策略
　　7.2.6　虚拟机格式
　　当IT管理员实施虚拟化的时候，特别是如果他们实施多种hypervisor时，他们都会面临的其中一个挑战就是虚拟机的格式。正如第2章所述，多种不同类型的文件构成了虚拟机——配置、磁盘、内存中的内容、日志文件等。但是，对于这些文件，每种虚拟化引擎都是倾向使用其自身的格式。例如，Microsoft对于硬盘驱动器使用VHD格式，而VMware使用虚拟机磁盘（Virtual Machine Disk，VMDK）格式。
　　为了促进制定一种虚拟机的单一标准，VMware与IT行业一起制定了开放虚拟化格式（OpenVirtualization Format，OVF）。OVF已经被行业指导机构台式系统管理任务组（Desktop Management Task Force，DMTF）所接受，并且多家厂商正在推动使用这种格式。例如，正如先前所提到的，Citrix是开发OVF管理工具的首批厂商之一。VMware也拥有一种虚拟机转换工具——VMware Studio，让你可以将虚拟机捆绑到OVF格式中。
　　注意：要了解更多关于OVF的详细信息以及要取得VMware的OVF转换工具，请访问www.vmware.com/appliances/learn/ovf.html
　　OVF是一种单一的文件格式，可以用于将构成虚拟机的所有文件捆绑到一个单一的、可传送的实体中。它还可以用于将一系列的虚拟机捆绑到一个单一的文件中。这使得它不仅有益于包含虚拟应用的单个虚拟机的创建，而且也有益于整个计算环境的创建，所有都捆绑为一个单一的文件。OVF是基于可扩展标记语言（Extensible Markup Language，XML）标准而建立的。请注意，虚拟硬盘驱动器是在OVF文件的创建过程中转换的，当把OVF文件导入到hypervisor的时候会转换回来。
　　OVF的优点是：
　　▼它简化了虚拟机的分发。它依靠公共密钥基础架构提供内容验证和完整性校验。此外，它为虚拟机中的软件许可管理提供了一种基本方案。
　　■在安装过程中，对OVF软件包的内容进行验证。此外，OVF标准包括面向用户的文档，可以通过虚拟化引擎导入此文件对它进行访问，为封包的内容提供额外的执行指引。
　　■可以用于将单个或多个虚拟机打包到一个单一的容器中。
　　■OVF对于hypervisor是中立的，支持所有当前的虚拟磁盘格式，使其成为虚拟机传输的理想格式。它还是可扩展的，可以支持更多的将在未来出现的虚拟磁盘格式。
　　■虚拟应用（Virtual Application，VAP）——包含特定应用程序的预配置虚拟机——可以配置为OVF文件，使得它们可用于任何的hypervisor。供应商只需要配置VAP一次。
　　■OVF的设计是有意地设定为可扩展的，以支持未来VAP的使用和新的hypervisor技术。
　　■OVF支持本地化，使供应商可以为全球市场创建特定语言的VAP。
　　▲OVF是一种由虚拟化市场的领导者共同创建的开放标准，因此它目前是由DMTF——一家标准制定机构来负责管理。
　　总之，OVF类似于Microsoft用于Windows Installer安装文件的Microsoft Installer（MSI）格式。当然，MSI格式并不是一个开放的标准，但它是一种特殊的封装格式，供应商使用它向Windows的用户提供其应用程序。使用OVF，供应商将使用类似的过程来将准备好运行的应用程序打包到标准格式中。
　　今天，VMware和Citrix都对OVF提供了支持，而Microsoft打算在Hyper-V的未来版本中增加对这种格式的支持。以OVF格式封装的虚拟机可以被导入到hypervisor中，将它们转换为hypervisor的格式或者不用转换直接运行。但是，由于OVF是一种支持可传输的和虚拟机内容完整性校验的格式，如果你以OVF格式运行一个虚拟机，那么上述两种目的都将失效。一旦OVF文件由于直接运行而被修改，就不能再被认为它包含的是VAP的黄金镜像。正如你所见，OVF再一次类似于MSI，因为你为了使用它包含的应用程序，必须先安装MSI。
　　注意：可以在www.vmware.com/pdf/ovf＿whitepaper＿specification.pdf获取OVF的规格说明。此技术规格白皮书是由VMware和XenSource共同发布的。
　　7.2.7　虚拟机磁盘类型
　　由于OVF只适合于传送虚拟机，因此你需要了解和使用你实施的hypervisor所支持的实际的磁盘格式。表7-6概述了可以在服务器虚拟化技术中使用的不同类型的磁盘。
　　在高性能的存储卷上，应该把目标定在尽可能多地使用动态扩展磁盘；但是某些工作负载使用固定大小的磁盘将能更好地运作。如第5章所述，使用精简资源调配将动态扩展磁盘连接到虚拟化存储中可以为你节省大量的物理硬盘空间。
　　虚拟机磁盘使用一种平面文件格式，提供了对内容的快速访问。虚拟机磁盘与数据库文件非常相像，在虚拟机容器中添加新文件就像是在添加新的数据。但是，当内容被删除时，它们不会自动恢复未使用的空间。为了收回未使用的空间，必须进行压缩，并且通过你所使用的虚拟机管理工具中的专用接口对磁盘进行碎片整理。例如，在WS08 Hyper-V中，磁盘管理是通过编辑磁盘的属性来完成的（见图7-17），而在VMware中，是通过编辑虚拟机的属性来完成（见图7-18）。在这两种情况下，都必须先暂停虚拟机才能够控制其磁盘的属性。
　　图7-17　Hyper-V磁盘管理
　　图7-18　VMware磁盘管理
　　使用虚拟磁盘驱动器时，请注意下列事项：
　　▼虚拟硬盘也可以设置为可撤销磁盘。在这种情况下，它们可以是持续或非持续的模式。
　　■可撤销磁盘在虚拟机关闭时询问是否保存所做的更改。如果要提交所做的更改，回答是；如果不要，回答否，这台机器将恢复到其最后一次保存的状态。
　　■可撤销磁盘是一种比较陈旧的技术。虚拟化引擎现在使用的都是磁盘快照，而不是可撤销磁盘。
　　■可在任何时候提取快照，甚至计算机正在运行的时候。
　　■在提取快照的同时，快照提取磁盘的映像。
　　■快照包含了虚拟机内存中的进程，以及在进行快照时虚拟机当时的设置。
　　■当快照提取完成，更改将存储在日志文件中；由于大多数hypervisor支持多达512个快照，所以这些文件将会占用大量的空间。
　　▲不能提取物理磁盘的快照，除非你可以利用内置的快照技术，如Windows Server中的卷影复制服务（Volume Shadow Copy Service，VSS）或者共享存储的类似功能。
　　快照比可撤销磁盘有用得多。它们对实验室环境也十分有用。但是在生产环境中，对于工作使用到的虚拟机，你可能更愿意依靠快照作为一种保护机制。例如，在你对虚拟机进行更新之前，要建立先提取虚拟机快照的习惯。如果更新出了问题，可以恢复虚拟机的快照映像。
　　你将会认识到，正是因为这些功能，虚拟硬盘驱动器比起物理驱动器更加实用。
　　



　　7.3　虚拟化技术价格
　　价格总是在随时变动，由于虚拟化是当前的热点，所以市场上也有很多类型的厂商，因此竞争十分激烈。但在你为数据中心做选择的时候，你必须对每种技术的成本有大概了解。表7-7列出了在编写本书的时候各种产品定价的示例。虽然当你读到本书的时候，价格很可能会有很大的不同，此表仍然可以提供对3家市场领导者预期价格的参考。
　　正如你所见，每家厂商都需要不同的组件，以提供一个完整的虚拟和物理基础架构管理环境。Citrix严重依赖第三方产品。Microsoft严重依赖于其现有的Windows环境管理工具。VMware一直致力于创建一个全面的虚拟机管理套件。
　　在所有情况下，如果你决定运行Windows基础结构，那么你将需要Microsoft Windows Server许可。Microsoft的一个优点是通过购买Windows Server许可，可以同时获得主机和虚拟机的许可。但是，请注意，如果你决定使用一个非Microsoft的hypervisor，那么Windows Server版本所支持的虚拟机许可也是适用的（见表7-8）。
　　如果你想要一个低成本的环境，那么可以依靠由Citrix、VMware或Microsoft提供的免费技术。Citrix XenServer速成版仅支持在每台主机上运行4个虚拟机。VMware ESXi免费为你提供VMware hypervisor的所有功能。而Microsoft Virtual Server也可以在每台主机上运行多个虚拟机，但它只支持32位的虚拟机。在以上每种情况下，免费技术只提供了在同一时间管理一个独立主机的工具。虽然小型企业有可能以这种方式来运行，但这种方式并不灵活，并且对那些拥有大量虚拟机的人，从长远来说这种方式是不能胜任的。此外，使用免费的技术不会为你提供技术支持。
　　但价格不是让你决定应依靠哪一种技术的唯一条件。请确保在做出决定之前，对每个环境和每个工具的能力已经有了充分的了解。为此，下一节可以为你的决定提供宝贵的意见，因为其中会比较每个hypervisor的功能集，概述每个hypervisor所能提供的虚拟机技术支持。
　　



　　7.4　hypervisor市场领导者的指标
　　每一个hypervisor都是不同的。有些是原生的x64 hypervisor，而其他的可能是32位但包括对重要任务的x64组件的支持，例如内存管理。表7-9针对3家主要的厂商列出了每家的一些核心指标。可以使用此表来确定每个主机运行多少个虚拟机以及如何配置主机。依靠这些值比较每一种hypervisor，对在自己的网络中应该使用哪一种hypervisor做出明智的决定。
　　阅读表7-9时需要注意一些事项。
　　▼因为VMware使用集成的hypervisor——ESXi，它只占用非常少的空间，所以其开销可忽略不计。Hyper-V和XenServer都需要一个CPU内核来操作，因为它们还包括了一个与hypervisor一起的父分区。
　　■三者之中，Hyper-V支持最多的主机内存，因为它基于Windows Server代码。然而，当前并不存在具有2TB内存的物理主机。
　　■每台主机上的hypervisor需要占用一些内存用于运行，为了管理每个虚拟机还需要占用一些内存。在VMware的情况下，每个虚拟机的开销是30MB加上分配给虚拟机内存的15%。Microsoft的每个虚拟机需要32MB的内存。Citrix以内存的百分比来计算开销。并且，为了限制Hyper-V主机服务器的内存开销，你要确保你仅是在Server Core（服务器内核）模式下运行它，而不是在完全安装的Windows Server 2008模式下。
　　■主机服务器支持的最大CPU插座数是以逻辑内核的数量来计算的——而不是通常的物理内核——这解决了大部分服务器配置中内核最大数量有限的问题。请注意，Microsoft在2008年10月24日更新了Hyper-V，使其支持最多24个内核，以支持Intel新推出的六内核处理器。虽然XenServer号称它支持“无限”的核心，但这只是该产品的企业许可才具有的一个特性。而实际的数量受限于物理服务器的配置。
　　■每个客户机的虚拟CPU内核最大数量通常受到客户操作系统的影响。在VMware中，对于支持多处理的大多数客户操作系统最多支持4个虚拟内核。这同样适用于XenServer，但其客户操作系统可以运行多达8个虚拟内核。在Hyper-V中，唯一能够以4个虚拟内核运行的多处理操作系统是Windows Server 2008。其他Windows Server支持的版本只使用2个虚拟内核。
　　■每个hypervisor都至少需要一个管理网卡。
　　■池或群集的数量受限于hypervisor的功能。VMware通过其高可用性（HA）和虚拟机文件系统（VMFS）2个功能来支持池。Citrix具有内置的资源池功能。而Microsoft依靠Windows Server 2008的故障转移群集功能，每个群集中最多可以有16个节点，而且，这些节点可以位于同一站点内或者不同的站点内。
　　■每个hypervisor都支持为客户机分配一个最大内存，但是，很少有组织会将内存的最大数量分配给客户机操作系统，因为这种做法没有为主机保留大量的内存。分配最大值通常会产生所谓的“单一虚拟机”主机——一台只运行一个单一虚拟机的主机——这通常会造成成本过高。
　　▲每个逻辑（这里理解为物理的）处理器内核支持的虚拟处理器内核的数量通常与可以在主机上运行的单个虚拟处理器内核虚拟机的数量相同。此数字通常与下面的值有关联：同时活动的客户机/主机。但是，其他的因素如可用内存，限制了你可以运行尽可能多的虚拟机。Citrix XenServer已经被配置为32个内核和50个虚拟机。Microsoft和VMware还没有宣布他们可运行虚拟机的硬性限制数量，但VMware比起Hyper-V和XenServer有一个优越的地方，因为其独特的内存管理功能是其他两者所没有的。因为这些功能有可能会在ESX主机服务器上过度分配资源给虚拟机，所以，分配比主机实际可用的更多的资源给虚拟机。VMware支持可变资源的虚拟机，而其他两者只支持固定资源的虚拟机。在固定资源虚拟机模式中，对于虚拟机数量的硬性限制是内存，而不是CPU内核。
　　事实上，就相关联的数字而言，每一种hypervisor都具有类似的功能。但在现实工作中，在类似的硬件配置上组织倾向于使用VMware，因为比起其他两者它可以运行更多的虚拟机。这是因为它支持资源过量配置功能。毕竟，组织之所以迁移到虚拟化的首要原因是因为其物理服务器资源在大部分时间里未能充分利用。因此，创建一个具有最小和最大资源设置的虚拟机是非常有实际意义的——在低负载的时候虚拟机以最少资源来运行，而在高负载期间可以使用最大的资源。但是，对于这项工作，必须运行在具有备用资源的服务器池中。这样做可以允许你当虚拟机需要比起当前主机上可用资源更多的资源时，将虚拟机迁移到另一台主机服务器上。无论如何你需要在资源池中至少添加一台额外的主机，为所有你的虚拟机提供高可用性。
　　此外，在客户机中主机所支持的各种操作系统都是不相同的。表7-10列出了每种hypervisor所支持的客户操作系统。
　　重申一遍，VMware比起其他两种64位hypervisor支持更多的客户操作系统。比起其他两者它还支持更多的x64客户操作系统。虽然这对于你来说可能不是很重要，但在决定实施哪一种hypervisor之前，你必须要知道这些事实。
　　鉴于每种hypervisor的功能集，很明显每家厂商都提供了自己的一套产品。Microsoft提供了虚拟化的民主发展。通过将其hypervisor直接置入其操作系统中，Microsoft让其客户可以获取服务器虚拟化。许多小型企业选择此工具只不过是因为它容易获取。Citrix则着重于低成本的企业虚拟化。但是，小型企业使用Citrix往往必须依靠第三方工具来创建一个完整的动态数据中心。当前，VMware仍然是市场的领导者。他们的产品可能看起来是最昂贵的，但其hypervisor提供了更高的物理服务器密度。如果在你的心目中使数据中心变得更加环保是首要的任务，那么VMware可能是你唯一的选择，因为它在物理服务器整合方面提供了更高的数值。
　　因此三者的定位已各自获得了一定程度的市场份额，并且在不久的将来会继续发展。
　　



　　第8章　使用虚拟工作负载
　　现在，你已经了解了每一种hypervisor的基本功能集，你可以准备进一步使用虚拟机。为此，你需要先了解虚拟化决策过程应该要做的工作。基本上，这一过程以最符合他们虚拟化类型来满足业务需求。第3章介绍了全面的虚拟化决策过程，但在这里，你将会专注于此过程的服务器虚拟化内容。
　　此外，你需要了解在虚拟化层中运行的虚拟服务或产品的结构。如何构造这些虚拟机？如何分配虚拟机的优先事项？附加哪些策略类型到每个虚拟机中？在虚拟层内运行全部的工作负载之前，这些都是你必须考虑的事情。
　　最后，你需要考虑如何将资源分配到你的虚拟机。某个虚拟机会与另一个虚拟机争夺相同的资源吗？主机服务器将如何决定如何将资源分配给每个虚拟机？如何决定虚拟机放置的位置？最后，如何配置主机？每台主机应该运行多少个虚拟机？
　　这些问题的答案可以帮助你了解如何操作虚拟工作负载，如何最佳利用提供给它们的物理资源。
　　



　　8.1　服务器虚拟化决策过程
　　你之所以进行虚拟化，当然是为了要节省电力、冷却、空间，还有金钱。但即使通过迁移到虚拟基础结构来获得这种强大的优越性，目的还是要持续并尽可能改善数据中心响应业务需求的方式。如你所见，使用虚拟机比使用物理机快得多，但必须注意虚拟机无计划的扩展，为此，你创建的每个虚拟机必须符合特定的目的，并且如果可能的话，虚拟机要受到基于时间的限制，以便一旦完成其目的，就可以将它从数据中心内移除。
　　管理这一过程的最佳方法是依靠一种特定的决策过程。在此情况下，需要的是服务器虚拟化决策过程（见图8-1）。首先需要确定业务需求；然后，确定是否在服务器上或者在桌面上实现此业务需求。
　　图8-1　服务器虚拟化决策过程
　　由于你当前正在考虑服务器虚拟化的要求，你知道在这种情况下，你将实现通过服务器虚拟化技术产生的业务需求。
　　接下来，你需要确定需求是否满足测试、开发或者生产环境。测试和开发两种需求可以通过以下3种方式之一来解决：
　　▼你将使用哪一种分布式解决方案，运行在请求者桌面上还是数据中心管理权限以外的服务器硬件上。如果做出了选择，那么你应该依靠免费的虚拟化技术，最常见的是软件虚拟化（SoftV）产品。例如，依据你的hypervisor的选择，你可以使用VMware Server、Microsoft Virtual PC或Microsoft Virtual Server来满足这一需求。请记住，Microsoft的产品无疑会生成虚拟硬盘（VHD）格式的虚拟机，但也仅支持32位的虚拟机。而VMware的解决方案，只要它是安装在x64操作系统的之上，就可以轻易地运行32位或者64位的虚拟机。这种类型的虚拟机最好是集中地准备，可能是通过你在第6章中创建的虚拟实验室，分发到具有特定服务级别的最终用户手中：此虚拟机是直接可用的，如果它发生了任何问题，可以直接再次提供。而且，如第6章所述，测试人员和开发人员将要使用的工作站配置应该是：
　　■具有4GB以上内存的高级工作站。
　　■独立外置的USB磁盘，或者更好的是独立外置的串行高级技术附加装置（SATA）磁盘。在独立于系统卷的磁盘上运行虚拟机可以提供更佳的性能（见图8-2）。
　　图8-2　对于测试人员和开发人员，在独立的磁盘上运行虚拟机可以提供更佳的性能
　　■如果客户需要比免费SoftV产品更高级的功能，那么可以建议他们使用付费的虚拟化引擎。例如VM-ware Workstation，这是来自VMware的旗舰SoftV产品，包含了免费的VMware Server所不具有的强大功能。例如，可以通过Workstation界面，使用VMware Workstation直接记录图片和影片（见图8-3）。屏幕捕获为BMP文件，影片捕获为AVI格式。在影片捕获过程中甚至可以删除空白屏幕。此外，使用Workstation中的组队功能可以更容易地创建关联在一起的多层应用程序的虚拟机集合。基于上述的原因，建议客户使用付费的VMware Workstation副本将最能够符合他们高级的要求。当然，你应该使用一种计费系统，以确保他们项目预算能支付这项服务。
　　▲如果需求是针对复杂的测试或者开发环境，如在第6章中讨论的整合或分阶段级别，唯一的解决方案是向他们提供对托管的虚拟机环境的远程访问。在这种情况下，你可能还要调用VMware Lab Manager（VMware实验室管理器）或者VMware Stage Manager（VMware阶段管理器）以进一步细化你提供的服务。
　　如果需求是针对生产解决方案，那么答案就简单得多：你可以向客户提供集中托管的虚拟机或者是数据中心hypervisor上生产负载所管理的虚拟机。
　　图8-3　使用VMware Workstation捕获一段影片
　　



　　8.2　虚拟服务或产品的结构
　　在生产中，你想要同时获得主机和虚拟机的最高性能。毕竟，你既想提高物理资源的利用率，还想确保所有的系统都是在其最佳性能状态下执行。因此，你需要关注你将要运行的虚拟服务或产品。实现此目的的最佳途径是采用一种结构化的方法。从对你的虚拟服务或产品中的服务器工作负载进行分类开始。你将发现通常有8种主要的生产服务器类别（见图8-4）。你还需要在实验室中运行的测试系统和开发系统，但这些服务器也是包含在这8种主要的类别当中。
　　图8-4　8种服务器类别
　　正如你所见，依据服务的相似性对8种类别进行了服务类型分组。某些类型的服务或功能不属于一类，而其他的自然就倾向于归在同一类中。因此，你将拥有由所运行的软件服务器的类型和它们所交付的服务的类型来定义的角色。此结果的类别包括：
　　▼网络基础结构和物理服务器　这些服务器提供了核心的网络功能，如（IP）编址，动态主机配置协议（Dynamic Host Configuration Protocol，DHCP），专用于旧式系统的名称解析，如Windows网络命名系统（Windows Internet Name System，WINS）。然而，自从Windows Server 2008的域名系统（DNS）提供了单一标签命名功能，这些已不再是真正的需要。这些服务器还提供了虚拟专用网络（VPN）以及路由和远程访问服务（Routing and Remote Access Services，RRAS）。由于它们是基础级别的服务，所以它们在物理机上通过hypervisor技术来运行虚拟化角色。
　　■身份管理服务器　这些服务器是网络的核心身份管理器。它们负责整个企业的所有用户和用户访问权限的身份数据库的控制和维护。对于Windows Server 2008（WS08），这些是运行活动目录域服务（Active Directory Domain Services，ADDS）的服务器。此功能尽量不要与其他的服务共用服务器，除非它是核心的网络功能，如名称解析——在这种情况下是指DNS。
　　■文件和打印服务器　这些服务器主要是为网络提供存储和结构化文档服务。它们同时包括网络文件系统（Network File System，NFS）和通用网际文件系统（Common Internet File System，CIFS）。它们还包了括标准和网络打印服务器。
　　■应用程序服务器　这些服务器为用户社区提供了应用程序服务。WS08的示例包括，电子邮件系统如Exchange Server，后端数据库如SQL Server等——实际上是指由Windows Server系统，包括中间层系统和故障转移群集所提供的所有服务。
　　■终端服务器　这些服务器通过表现层虚拟化为用户提供了一个集中的应用程序执行环境。因为它们的整个执行环境驻留在服务器上，所以用户只需要拥有一个最小化的基础架构，以访问这些服务器。请注意，远程桌面协议是用于访问所有虚拟机的协议。
　　■专用的Web服务器，这些服务器专注于为用户社区提供Web服务。它们还包括了网络负载平衡（Network Load Balancing，NLB）系统。
　　■协作服务器　这些服务器为企业内部的协作提供了基础架构。它们的服务包括了协作技术如Windows SharePoint Services（WSS）或者Office SharePoint Server、流媒体服务以及实时通信服务如Office Communications Server。
　　▲故障安全服务器　这第8种角色专注于冗余和通过在待机模式下保持与生产服务器完全相同的镜像来提供业务连续性。当生产服务器出现故障时，故障安全版本自动变为在线。这种服务器构造最重要的方面是复制技术，确保故障安全服务器总是保持最新而且没有数据丢失。由于虚拟服务器只是需要在另一个位置复制的一组文件，因此现在已可以非常容易创建这种类别的服务器。由于它们只运行单一角色并且是通过集成的hypervisor来运行，因此也容易复制物理服务器。
　　此外，服务器的布局也会产生影响。布局是指建筑接近度或者是在端到端的分布式系统中服务器的位置。以下3种位置都是可行的：
　　▼在企业内联网中
　　■在安全边界中——通常被称为非军事区（Demilitarized Zone，DMZ），虽然对于大型的组织，边界通常包括的不仅仅是DMZ
　　▲在企业外部
　　随着虚拟化的到来，服务器的布局趋于模糊，如在物理主机上的某个虚拟机可能是在某一个区域中，而在同一主机上的其他虚拟机是在另一个区域中。当你针对你网络中的每个区域安置虚拟服务器时，请确保你已谨记服务器的放置。
　　注意：对于那些运行的Windows工作负载，Microsoft提供了Windows Server Virtualization Validation Program（Windows服务器虚拟化验证程序）。此程序使厂商能够验证不同的配置，以便Windows Server的客户可以在虚拟化的环境中获得技术支持。客户使用经过验证的解决方案，可以从常规Windows Server技术支持框架中受益。要了解更多的信息，请访问www.windowsservercatalog.com/svvp。
　　如果已做好了计划，那么你应该能够百分之百地虚拟化工作负载。目前，虚拟化基础架构可以运行几乎所有的工作负载。在2007年7月针对VMware客户进行的一项调查，VMware发现在接受调查的361个客户中的大多数人已经在其虚拟化引擎上运行了高级的工作负载（见图8-5）。
　　有多个原因可能造成你不能虚拟化服务项目。例如，你可能决定继续在较旧的32位硬件上运行一些服务，仅仅是因为你还没有准备好脱离这些系统。但要考虑运行虚拟机的优点。因为它们是虚拟的，所以它们可以在任何硬件系统上装载。此外，它们易于部署和保护——只需将磁盘文件复制到另一个位置。
　　图8-5　常见的虚拟工作负载
　　维持物理服务项目的另一个原因可能是在区域中使用了较旧的32位硬件。重申一遍，你应尽量以虚拟实例来运行这些服务。如果你在数据中心中发现你需要保持较旧的硬件并继续运行它，那么为什么不使用虚拟机来承载系统？诚然Hyper-V不能在32位的平台上运行，但你仍然可以依靠工具，如Microsoft Virtual Server、System Center Virtual Machine Manager或VMware Server。
　　以上全部都可以在32位系统上运行，给予它们更长的寿命，代替实际的物理主机向用户提供服务。通过这种方式，所有你的物理计算机——32位和64位——都可以是主机，并且所有你的服务项目都可以实现虚拟化。
　　



　　8.3　虚拟资源分配规则
　　现在，你已经对各种服务器工作负载进行了分类，你需要考虑如何将它们分配到主机上。如果一台主机服务器打算要运行多达20个虚拟机，那么这些虚拟机不能或者不应在同一时间争夺的相同的资源。实际上，在主机服务器上要尽量配置异构的虚拟工作负载，避免配置同构的工作负载。为此，你必须研究工作负载，找出它们所需要的进程和资源以及人们在什么时候需要它们。
　　例如，如果你正在你的网络中运行Windows服务，那么你可以预期它们的行为如下所示（见图8-6）：
　　▼域控制器（DC）在高峰时间（清晨，午餐后）需要网络和处理器资源。
　　■文件和打印服务器在非高峰时间需要处理器和网络资源（上午中段，下午中段）。
　　■Web服务器关注网络资源，如果正确地构造，将需要源源不断的资源。
　　■SQL Server和Exchange Server全天都需要大量稳定的资源，主要集中在磁盘和处理器资源。
　　■测试和开发系统通常是在业余时间内使用。
　　▲企业应用程序通常具有定期的资源需求。例如，薪资计算应用程序排定为每2个月或者每2周将会运行。
　　图8-6　随着时间的推移服务器对资源的需求
　　你会注意到，并非所有的工作负载在所有时间都是繁忙的。实际上，有些工作负载是处于“停驻”状态并且很少运行。这些对于合理化都是很好的候选者。
　　由于服务器工作负载在不同的时间需要不同的资源，因此你应该以异构方式配置你的工作负载（见图8-7）。这意味着一台主机服务器可以运行一台DC、一台网络基础结构服务器、一台文件服务器、一台或者多台Web服务器、测试和开发服务器，甚至一个企业应用程序。关键是把重点放在不同时间需要不同资源的工作负载上。
　　当然，如果你运行了一个监控工具，如VMware的分布式资源调度程序（Distributed Resource Scheduler，DRS），并且为你的虚拟机分配了适当的策略，那么系统将自动地将工作负载从一台主机迁移到另一台主机，以保证所需的资源级别。同样的，使用系统中心虚拟机管理器（SystemCenter Virtual Machine Manager，SCVMM）、Operations Manager和Hyper-V的组合，你可以依靠SCVMM的性能和资源优化功能优化虚拟机布局。
　　图8-7　分配异构工作负载到主机服务器中
　　8.3.1　依靠布局规则
　　当分配工作负载的时候，需要依靠主机服务器的布局规则。例如，每次在Microsoft的System Center Virtual Machine Manager中创建虚拟机的时候，依靠布局规则，将新的虚拟机分配到一个主机上（见图8-8）。
　　图8-8　在Virtual Machine Manager中使用虚拟机布局规则
　　为此，它给每个主机服务器评定一个星级。具有可用资源的主机服务器最高可以被授予五星，而具有现有工作负载或者较少可用资源的主机服务器，只会授予低级的星。
　　这些评级是可以自定义的。默认情况下，SCVMM依靠负载平衡确保每台主机服务器运行大约相同数量的工作负载，或者至少使用了相同数量的资源。所需的资源集中在处理器、内存、网络以及磁盘的输入和输出上（见图8-9）。你也可以侧重于第2种布局目标：资源最大化。在这种情况下，SCVMM将不断分配虚拟机到主机上，直到消耗完所有的主机的资源。
　　图8-9　在Virtual Machine Manager中使用布局选项
　　SCVMM还允许你通过控制你对主机服务器的CPU、磁盘I/O和网络使用情况制定期望数值（见图8-10）来自定义主机的评级。使用这些资源分配策略，让你可以最大化地消耗你系统上的主机资源。这是你保证你的物理服务器上运行的工作负载的使用率高达80%。
　　每种虚拟化引擎都允许你以这种方式来管理资源。请确保你使用hypervisor管理工具来正确配置和分配这些资源。
　　图8-10　在Virtual Machine Manager中自定义主机评级
　　8.3.2　单一虚拟机主机与多虚拟机主机
　　当组织刚开始运行虚拟工作负载时，他们想要最大化硬件使用率。此外，在服务器虚拟化早期时代，hypervisor技术是非常、非常昂贵的。实际上，许多供应商如Virtual Iron和XenSource（现在的Citrix）通过提供较低花费的解决方案，使他们得以打入hypervisor市场。现在，随着许多免费的或者价格低廉的hypervisor的出现，组织正在以不同的目光研究服务器虚拟化。
　　在2007年之前，组织仅可以对低资源需求的工作负载进行虚拟化，以便他们能够在主机服务器上装载尽可能多的虚拟机，最大化他们的投资。如今，随着低成本虚拟化的出现，可以虚拟化任何的工作负载，甚至是高度资源密集型的工作负载。而在2007年以前，虚拟化的重点是多虚拟机的主机服务器，而在今天，还可以考虑单虚拟机的主机（见图8-11）。通过虚拟化工作负载，把它们从物理服务器中解放出来。然后，可以更轻松地对它们进行资源调配、保护和管理。
　　图8-11　多虚拟机主机与单虚拟机主机
　　作为最佳的做法，应该使用单虚拟机主机来承载大量占用资源的虚拟机，密切监控主机的资源。如果资源的利用率比预期的少，就可以添加更多的工作负载，最大化主机的利用率。在许多情况下，当完成虚拟化后，虚拟服务器工作负载比其对应的物理工作负载运作得更好和更快。VMware在VMWorld Europe 2007上首次证明了这一点，它们当时展示了在相同的硬件上虚拟化的Exchange 2007 Server的性能比其物理安装表现得更好。因此，就算有的话，也只是有很少的工作负载你不能虚拟化。
　　8.3.3　使用网络层
　　正如在第5章中所提到的，可以通过hypervisor的属性提供多个虚拟网络。有3种网络可以提供：公共、专用的和主机。虚拟机能够以不同的方式使用这些不同的网络，因此，你应该在你准备的主机系统中提供以上每一种网络。
　　例如，每个虚拟机的目的是必须通过公共网络向最终用户提供服务项目。因此，这些虚拟机必须至少具有一个连接关联到在主机服务器上创建的公用虚拟网络接口上。公共网络还允许位于不同主机的虚拟机之间进行相互通信。在每台主机上创建多个公用网络路径是一个很好的做法，可以为服务提供冗余。
　　主机模式的虚拟网卡用于提供通过主机才能访问的虚拟机。例如，如果你要更新虚拟机，你就可以通过主机模式通信通道来进行更新，避免了在公共接口上的额外流量。主机模式通信是直接由主机到虚拟机之间的通信，并且使用主机的内部通信通道来进行。
　　专用虚拟网卡也用于避免公共接口上的流量。例如，当建立故障转移群集的时候，必须在群集的所有节点之间创建专用通信通道。此专用链路用于群集的每个节点之间交换心跳信息，以确保节点不会进行不必要的故障转移。通过为此通道提供专用虚拟网络接口卡（NIC），你可以依靠hypervisor的内部能力支持此通信。请注意，当在2台不同的主机上承载群集节点时，这种通信必须使用公共通道。
　　虚拟机之间的专用通信的另一个例子是Exchange传输服务器和域控制器之间的通信。所有的Exchange配置存储在AD中，定期进行查询为Exchange提供拓扑信息。将此通信连接到专用网络可以为其他流量腾出公用网络。
　　为此，应该在每台主机上提供每一种网络类型，然后将各种虚拟机组件连接到相应的虚拟网卡上。
　　



　　8.4　服务器虚拟化的最佳实践
　　正如你所见，有很多方法可以实现服务器虚拟化。你将很快了解到它是一个功能强大的操作模式，项目的投资回报是绝对值得的。此外，管理工作负荷将减少，变得更加有趣。使用虚拟机你可以做如此多的事情，这是你使用物理服务器所不能做到的。
　　请记住，尽量规范管理所有的主机服务器。选择能够满足虚拟机增长需求的服务器。可以考虑把虚拟化管理系统放到物理服务器上，以确保持续可用性。否则，要确保包含此工具的虚拟机设置为跟随主机服务器自动启动，以便你可以快速和轻易地进入管理环境。
　　要为虚拟机配置适当的策略。例如，如果你正在运行VMware，为在特定时间内需要大量资源的应用程序指定分布式资源调度的优先级。另外，还要确保你的ISO文件是易于访问的。最好在文件共享以上创建一个中央文档库，使其能够被所有设备和所有机器都访问得到。
　　最后，要密切关注Microsoft的许可授权。虚拟机比起物理机需要更少的许可，这就是为什么值得迁移到动态数据中心的原因之一，而且虚拟机也容易生成。每当创建一个新的虚拟机的时候要谨记一点：不要由于虚拟化而引出更多的问题；你的目的是解决这些问题。
　　



　　第9章　提供虚拟机
　　所有计算机都有一个生命周期，无论它们是物理的还是虚拟的。生命周期由4个阶段构成，物理机和虚拟机之间略有不同。在动态数据中心内，物理机仅是主机服务器，因此它们的生命周期被大大地缩短和简化。但虚拟服务或产品持续需要更长久的生命周期（见图9-1）。
　　生命周期包括了4个不同的阶段，如下所示：
　　▼规划　为部署确定和准备解决方案
　　■准备和部署　获取、封装、配置、安装和测试部署策略
　　■生产　在生产网络中发现问题、修改、优化和行政管理
　　▲退役　置换/升级规划和移除过时的技术和程序
　　图9-1　服务生命周期的4个阶段：计划、准备与部署、生产和退役
　　规划阶段的重点是确认业务需求和哪些技术可以帮助达到目标。对于虚拟机，不需要购买物理服务器，当然，除非没有现有的主机可以用于承载这个新的虚拟机。这是主机服务器必须转换为共享基础架构的成本所在。因为不再需要购买虚拟机，所以采购过程变成了需求分析的过程。由于虚拟机包括了减少许可成本，所以提供操作系统的虚拟实例比物理实例更加的简单和容易。在这里，需要把重点放在系统需求上——处理器内核的数量、随机存取内存、磁盘的空间和虚拟机所需的网络接口——在创建操作系统实例之前。但是，可能需要为将运行实际工作负载的虚拟机获取单独的许可。
　　注意：此服务项目的生命周期最初是出现在《Windows Server 2003：Best Practices for Enterprises Deployments》一书中（由Danielle Ruest和Nelson Ruest编写）（McGraw-Hill 2003年发行）。该模型的原始模型来自Microsoft提供的名为“Planning，Deploying，and Managing Highly Available Solutions（规划、部署和管理高可用性解决方案）”的白皮书中，1999年5月出版。可以在www.microsoft.com/technet/archive/ittasks/plan/sysplan/availsol.mspx？mfr=true找到原始的Microsoft IT服务生命周期模型。
　　准备和部署阶段的重点是技术架构的过程，这个阶段是紧接着规划过程或者可能会与规划过程同时发生。技术架构提供了其安装过程中和网络中其生命周期其余部分应用的特定技术参数。它基于企业架构所概述的目标，应该详细说明实施的细节。
　　生命周期接着进入到安装和初始化配置以及封装/分段阶段。如果此服务产品是依靠软件产品或者是添加到当前的网络，那么就使用封装。如果此服务是依靠新操作系统的功能，就使用分段。例如，对于Windows Server 2008，你将需要同时依靠封装和分段，由于你将趋向于以初始化安装或者对你的服务器进行分段来开始，接着将在网络中充当特定功能的应用程序或者服务器角色。封装通常用于自动化软件或者服务提供的安装过程，甚至是将虚拟机转换为其他类似需求来源的虚拟设备。
　　测试是下一个阶段，而且它是至关重要的，因为它确保引入到生产网络中的任何新服务的稳定性。最后，用于部署的服务提供准备完毕。此部署可以在几个阶段内完成。另一种概念验证（Proof of Concept，POC）可以用于对运行中的服务产品进行最后的验证。POC的目标读者通常由项目团队和某些最亲密的合作伙伴组成。其次，通过试点项目测试此部署方法的各个方面，包括技术和管理程序。在试点项目成功后，接下来就是进行大规模的部署。此外，虚拟机必须要正确地放置在具有足够的资源来运行该工作负载的主机上。至少应该预留一个额外的服务器，以便当原本的主机需要维修或者发生意外时，可以为此工作负载提供故障转移。
　　一旦部署了服务产品，它就进入了生命周期的生产阶段。在这里，需要管理和维护一份完整的服务清单、控制更改、处理问题和支持其用户。必须为部署的每个服务产品实施和管理服务级别协议（SLA）。SLA侧重于性能和能力分析、冗余规划（备份、群集、故障安全和恢复程序）、可用性、可靠性以及服务的响应能力。
　　IT服务产品生命周期的最后阶段是退役。当服务达到一定程度的陈旧时，它必须从网络中退役，这是因为其运行成本通常大于其带来的益处。使用虚拟机，这一过程很容易实现，在某些情况下甚至可以自动完成。
　　工作流产品常常是实施这种类型的提供过程的最合适的工具。例如，可以通过WindowsWorkflow Foundation（Windows工作流基础——是Microsoft Office SharePoint System的一部分）构建这一过程；还可以依靠VMware的Lifecycle Manager（生命周期管理器），它包括了内置的用于虚拟机生命周期管理的工作流（见图9-2）。正如你所见，它从开始到结束持续地跟踪对原始虚拟机的请求，然后依靠定义好的布局规则智能地将虚拟机放置到最适当的主机。
　　图9-2　VMware的Lifecycle Manager（生命周期管理器）可以帮助管理虚拟机提供过程
　　可以依靠虚拟机生命周期确保不会扩散服务器虚拟机。由于虚拟机可以很容易地创建，因此很容易落入虚拟机蔓延的陷阱。通过一种标准的生命周期过程，可以控制冲动并根据需要创建虚拟机，或者至少是通过基于时间限制的策略来提供它们，一旦它们不再需要，可以自动地将它们从网络中移除掉。
　　警告：在用户具有系统管理权限的环境中，他们可以很容易地下载和安装免费的SoftV产品，开始创建他们自己的虚拟机。这些用户具有访问虚拟机的权限，不是什么问题，但更多的事实是他们没有受过正确配置复杂操作系统的培训。在这种情况下，最好是创建标准的虚拟机，并根据需要和在合理的基础上提供给他们。这样做，你就不会发现在你的网络中存在未安装补丁程序模式下运行的粗系统。
　　在虚拟机生命周期的4个阶段中，最重要的部分之一是虚拟机提供。有2种方法可以提供虚拟机。
　　▼从新建源模板中提供虚拟机
　　▲通过物理到虚拟（P2V）的转换处理提供虚拟机每一个过程都有其自身的特殊性。
　　



　　9.1　在你开始前
　　你的目标是将数据中心中的物理机转换为虚拟服务产品提供。但要实现此目标，你需要了解从哪里开始。要做到这一步的有效方法是依靠SCOPE——一种概念分类工具（见图9-3）。SCOPE让你可以快速地确认以哪些工作负载来开始。SCOPE的用法十分的简单；它是以最简单的工作负载开始，然后逐步提升直到你的最复杂和最关键的业务。
　　图9-3　SCOPE曲线可以帮助确定首先对哪些服务器进行虚拟化
　　SCOPE划分工作负载，如下所述：
　　▼简单的工作负载包括实验室的计算机或者用于测试和开发的计算机。培训的计算机也符合此类别，还包括运行Web服务的系统、在Windows网络中的域控制器以及网络基础架构系统如DHCP服务器。Web服务器是此类别中最适合的，因为它们通常运行的是无状态的工作负载或者只读的工作负载。
　　■生产工作负载包括运行打印机、文件共享、协作服务的系统，如Office SharePoint Server和其他作为前端到n层应用程序的服务器。此外，还包括用于集中共享应用程序的系统，如终端服务器。
　　■操作工作负载包括任何用于管理基础架构的系统。通常这些是一些复杂的实施，但要迁移仍然相对比较容易，因为它们通常包括了将角色从一台服务器转移到另一台服务器的能力，使得从物理到虚拟的转移——称为P2V——比较简单。
　　■复杂的工作负载包括运行高可用性或者负载平衡服务，以及那些具有高I/O吞吐量（如数据库）的系统。如果是一个负载平衡系统，由于你可以添加具有此角色的新虚拟机并将它们集成到负载平衡群集中，因此迁移可以被简化。当有足够的机器实现虚拟化时，你就可以取消物理的节点。
　　群集计算机也可以使用这种模式。例如，对于Windows Server 2008，你必须从Windows Server先前的版本迁移群集。迁移到由虚拟机组成的群集与迁移到物理群集是同样的简单。高I/O的工作负载是比较棘手的迁移，但在开始转换这些工作负载的时候，你应该已经非常熟悉你的虚拟化基础架构的功能和虚拟机。
　　▲特别的工作负载被保留到最后，让你有机会获得过程中的经验。这些工作负载的数目通常比较少，包括的项目如关键业务、制造和旧式应用程序。为了虚拟化工作负载并确保它一旦转换后仍然正常运行，在这里你必须依靠特别的步骤。
　　在某些时候，你可能会与商业指标的价值有冲突——这个时候比一般时候需要采取更多的努力，你开始怀疑这样做是否值得。我们可以肯定百分之百的转换基础架构是最终的目标。一旦所有的系统都被转换，你将会拥有一个真正的动态数据中心；所有面向最终用户的工作负载都被虚拟化，在网络中唯一的硬件就是运行虚拟工作负载的主机服务器。
　　现在，你已准备好继续前进以提供你的工作负载。
　　



　　9.2　提供新的虚拟机
　　当你提供虚拟机的时候，你应该根据需要创建可以重复使用的自定义模板。在物理的世界中，组织可以依靠系统镜像简化虚拟机的提供。在虚拟的世界中，你可以依靠虚拟机模板。使用虚拟机模板可以使工作变得更简单，因为要创建一个新的虚拟机，所需要做的就是复制组成它的文件，并将它启动。但是，你必须创建标准的虚拟机配置。对于每个虚拟机，这些配置必须是以下各项：
　　▼每个虚拟机处理器或者处理器内核的数量
　　■每个虚拟机内存的总量
　　■每个虚拟机磁盘和磁盘空间的数量
　　▲每个虚拟机网络接口卡（NIC）的数量
　　随着时间的推移，你将能够扩展这些标准配置到不同的工作负载，准确地了解到底需要为每一种服务器类别分配多少资源，以提供足够的服务——满足为你的用户设置的服务级别协议的服务。
　　你还必须确定如何提供虚拟机。如果你不使用较早前建议的生命周期，那么你必须执行一个标准的请求过程。这个过程应该有2个方面：
　　▼管理　虚拟机的请求者必须通过一个类似于物理计算机的请求过程。新的虚拟机必须将成本计算到客户端。你必须具有一个关于基础架构成本的规定。当需要一台新的主机或新的刀片机箱时，成本必须由整个组织来负担，而不是由每个客户端来分担。
　　▲技术　你必须使用一种标准虚拟机的创建过程。理想情况下，你可以依靠预创建的虚拟机作为新虚拟机的种子。
　　此过程将帮助你控制内部虚拟机的泛滥。
　　9.2.1　创建种子虚拟机
　　要创建种子机可能不是那么的简单，但在虚拟的世界中，你只需要创建它们一次。在物理世界中你可以依靠系统镜像，而在虚拟世界中你可以依靠虚拟磁盘驱动器的复制来生产新的虚拟机。因此，你必须创建正确的源虚拟机，以避免传播垃圾到网络中。基本上，在生成服务器的磁盘镜像之前，你应该以你通常用于创建参照服务器相同的过程来创建种子虚拟机。
　　例如，在Windows网络中，你可能需要生成多个不同的操作系统和或操作系统版本的源虚拟机，如以下所示：
　　▼Windows Server 2008（WS08）标准版，WS08企业版，WS08 Web
　　■Windows Server 2003（WS03）标准版，WS03企业版，WS03 Web
　　■Windows 2000 Server（W2K）标准版，高级版
　　▲Windows NT Server（希望不需要）
　　如果你为上述每一个服务器操作系统创建了源虚拟机，那么你将需要9个不同的种子虚拟机，这还没有包括各种的Linux发行版本。为此，标准化操作系统的基础架构是一个很好的主意，可以减少你网络中服务器操作系统的数量。重申一遍，标准化和合理化是存在于任何动态数据中心的2个核心程序。
　　你需要创建的每个源虚拟机的2个副本。在物理的世界中，创建一个参照系统，使其为复制做好准备，然后从参照系统中捕获系统镜像。但是，每次当需要更新参照系统的时候，需要重新应用系统镜像对计算机进行个性化设置，更新它，并再一次重复整个准备过程。使用虚拟机，你只需保留每台虚拟机的2个版本：一个是参照系统，另一个是准备用于复制的系统。第一个源虚拟机用于支持每月补丁安装和更新，而SysPrepped或者已移除个性化设置的源虚拟机用于支持多机的提供。
　　确保你已注入虚拟机驱动程序到机器中。在某些情况下，操作系统已经被“启发”——这是指它们已经意识到它们正运行在虚拟环境中。这些操作系统能够非常智能化地共享核心的资源，并且已经包括了许多运行所需的驱动程序。在其他的一些操作系统中，它们仍然是标准的操作系统，必须注入相应的驱动程序。在准备过程期间，你需要安装组件如VMware Tool、Hyper-V集成组件或者基于你所运行的hypervisor的其他的hypervisor组件。
　　9.2.2　使用种子机来提供
　　当你的源服务器已准备好时，你可以使用标准程序生成新的种子虚拟机（见图9-4）。
　　1.保持参照虚拟机在待机状态下，直到需要安装补丁程序。
　　2.在每个星期二（每月）补丁日更新源计算机。
　　3.检查和压缩组成此虚拟机的虚拟磁盘。
　　4.根据需要重新进行SysPrep，如在每次将补丁程序应用到参照VM的时候。
　　5.复制虚拟机并对SysPrepped虚拟机重新进行个性化设置，以提供一个新的系统。
　　图9-4　管理参照虚拟机
　　你可以标准化这个过程，每月定期使用以便每年可以更新你的源虚拟机12次。
　　多种工具可以自动更新源虚拟机。例如，Microsoft的Offline Virtual Machine Servicing Tool（脱机虚拟机服务工具）可以自动地启动关闭的虚拟机，为它们安装补丁程序，然后按计划将其再次关闭。VMware的更新管理器使用类似的过程执行类似的任务。依靠你的hypervisor工具包减管理多个虚拟机镜像所需的开销。
　　9.2.3　物理与虚拟提供
　　正如你所见，提供一个虚拟机比起使用物理计算机快得多。过去，对于新的服务器你必须由获取硬件开始，一旦到货后就马上对其进行配置、安装操作系统，然后安装和配置应用程序旨在提供预期的工作负载。一旦此工作完成，你将会测试此系统，为它分配一个IP地址，并且可能会配置网络来支持它。在系统准备好之前，这很容易就花费掉6个星期的时间。今天，通过使用适当的种子虚拟机，你可以在快得多的情况下提供一台服务器，有时候只需短短的20分钟（见图9-5）。
　　图9-5　比较物理与虚拟提供的过程
　　这对于创建新的服务提供所需的工作量会有很大的影响。当你依靠虚拟设备，就可以更进一步减少工作负载。
　　9.2.4　依靠虚拟设备
　　虚拟设备（Virtual Appliance，VAP）就是一种有时候以开放的虚拟化格式（Open Virtualization Format，OVF）出现，包含了预配置的操作系统和应用程序的虚拟机模板。由于虚拟机是配套齐全的和可传送的，因此它们可以在预配置的状态下作为虚拟应用来提供。由于许可的成本，VAP最常被设计运行在Linux操作系统之上。有一些供应商已经基于Microsoft技术创建了VAP，因为他们必须要这样做，才能成为Windows经销商。
　　不过，VAP可以进一步减少新应用程序部署到生产环境的时间，因为它们是预配置的和准备好运行的。鉴于此，你可能永远不需要再另外安装产品；只需获取它的VAP格式并运行它。
　　虚拟设备提供了多个优点。物理IT设备已经存在了很长的时间。多种不同类型的设备可供使用：网络入侵检测系统、搜索引擎、防火墙、存储服务器、配置管理服务器、网络负载平衡服务器等。这些设备的强大之处是它们是真正的易于部署和使用；将它安装在机架上，为它提供一个IP地址，然后登录其中并对其进行配置——这个过程与集成了hypervisor的主机服务器非常相似。配置通常是通过浏览器在一个Web界面中进行：使用你为此设备分配的IP地址打开配置页面，更改或指定一个管理密码，并进一步配置此设备所包含的功能。
　　虚拟设备甚至比物理设备更易于设置。将组成VAP的文件复制到服务器上的一个文件夹中，或者如果它们是OVF形式那么就将其导入，然后启动构成设备的虚拟机进行最终的配置。但即使它们易于设置和安装，你仍然需要仔细地准备你的虚拟设备。在物理的世界中，你主要关注的是该设备是否适合你的机架。但是，在虚拟的世界中，你必须确保你获得的虚拟设备可以兼容你已决定在网络中部署的虚拟化技术。例如，如果你选择VMware作为你的虚拟化提供商进行标准化，但你却选择了来自于另一种格式的虚拟设备，那么你很可能选择放弃获取它。毕竟，如果你可以避免，你就不会想要运行多个虚拟化引擎。当然，你总是可以转换设备，但是这样做可能会令制造商提供的任何担保变成无效，因为你这样做会改变虚拟机的本质，当然，除非它是以OVF格式封装的，使创建的VAP可以支持任何的hypervisor。
　　此外，当你依靠一个你信任的制造商提供给你的设备时，你不必担心许可的问题，因为这些问题是产品制造商所提供担保的一部分。你知道你可以安全地部署此设备，无风险地使用它，因为制造商已经考虑到在设备的制造过程中任何潜在的许可问题。
　　你面对产品的另一个问题可能是服务器的更新过程。当你获得并安装你自己的工具时，你还必须制定一项你自己的策略，使它们的补丁程序和服务包保持为最新。使用商业设备，你不需要担心这些更新，因为它们是设备本身的一部分和包含的功能，附带了它的支持程序。当然，你必须确保你可以支持此更新过程，但你不必自己来制定它。
　　当你选择一个商业VAP时，请牢记下列注意事项：
　　1.这是一个完全的配置和安全的虚拟设备吗？
　　■它是否包括一个操作系统的最低版本，只包括支持此应用程序所需的这些组件，或者包括了额外的不需要使用的组件？
　　■操作系统是否经过增强设置，如果是，如何说明此增强设置？
　　■操作系统是否是最新的，是否包括了最新的补丁程序和更新？
　　■制造商有什么其他的安全措施已应用于设备中？
　　2.供应商有哪些更新和升级策略？
　　■供应商是否具有文档化的更新和升级策略？
　　■供应商更新是否只解决设备内应用程序的更新？它们也解决底层操作系统的更新吗？
　　■供应商的更新计划是什么？如何发送更新通知？
　　■更新是否已包含在此设备支持费用的一部分，有额外的费用吗？
　　■将VAP从一台主机移动到另一台主机时，有许可和操作上的影响？
　　■创建VAP的虚拟机快照有成本或者其他方面的影响吗？
　　■此VAP是否经过你所选用的虚拟化供应商的认证？
　　■在升级过程中是否可以恢复现有的配置和管理数据？
　　■升级过程是怎么样的？它是否与实施新的VAP、同步数据、删除旧的VAP同样的简单？
　　3.供应商首选的部署过程是什么？
　　■供应商为VAP评估提供了哪些选项？
　　■VAP评估和测试的必要条件是什么？
　　■产品的评估时间有多长？
　　■当你将VAP迁移到生产中时，是否可能保留在评估期间生成的数据？
　　■你如何将VAP从评估迁移到生产？它与输入一个有效的许可密钥到VAP中是同样的简单吗？
　　4.你需要扩展部署呢？
　　■供应商为实施额外的VAP提供了哪些选项？它与使用不同的许可密钥部署相同的VAP同样的简单吗？
　　■供应商是否提供了一个单一的集中式控制台，允许你在一个地方配置多个VAP？
　　■是否可能以相同的设置同步多个配置？
　　■扩展部署如何影响许可和支持费用？
　　5.如何方便地管理和维护VAP？
　　■所有的VAP功能是否可以通过一个单一的基于Web的界面来访问，或者是需要通过控制台来访问？
　　■VAP是否可以自动执行常见的维护任务，如备份和磁盘碎片整理？
　　■VAP是否提供了关于其状态的警报和通知？
　　基于以上这些考虑，将可以确保你选择到最佳的VAP——一个可以在你需要它的时候，为你提供业务支持的VAP。
　　9.2.5　虚拟设备的优点
　　满足了前面所述因素的设备将可以确保组织能够迅速地认识到VAP的许多优点。
　　▼快速部署　使用虚拟设备的最大优点是你不需要运行整个软件包含的安装过程。只需将虚拟设备与通过传统的分发方式提供的产品比较一下。除此以外，虚拟设备与物理设备的工作方式都是一样的。主要的区别是它们不是以物理设备来提供，而是通过软件版本来提供，这使得它们可以更容易地部署。对于那些想要减少他们数据中心内物理装置的管理员，虚拟设备可能更为受用。
　　■易于使用　虚拟设备另一个主要的优点是它们可以节省大量的时间。对于中型企业的IT专业人员，系统管理设备——物理的或者虚拟的——是一大方便，因为它们让你无须增加大量的工作负载就可以控制你网络中的更改。实际上，由于虚拟设备可以帮助集中所有管理和管理任务，它们通常可以减少你的工作负载。
　　■最佳实践和安全配置　此外，默认情况下，虚拟设备可以为你提供安全的实施。这是因为设备是由产品制造商建立并配置好的。在这方面谁能比制造商做得更好呢？制造商清楚的了解其产品的细节，可以确保所有的预配置都使用最佳的做法来执行。如果制造商可以安装和配置产品，然后以预配置的状态将其提供，那么你为何还要试图自己来处理这些麻烦事，增加自己的困扰呢？通过依靠虚拟设备，你可能永远不再需要安装服务器产品。由制造商提供的预配置还可以确保安全和防护性高的安装，只要你连接上它就可以马上运行。
　　■可支持性　由于制造商创建和控制该产品的配置，所以你可以确保它的每一个方面都受到完全地支持。制造商可以为他们的产品提供这一级别的支持，因为他们清楚了解要把虚拟设备的正确设置放在首位。
　　■可扩展性　由于其虚拟性质，升级虚拟设备的资源会变得很简单。只需停止这台机器；添加更多的处理器、更多的内存或更多的磁盘以及网卡；然后再次重新启动它。它将可以自动利用新的资源。只需添加少量的配置更改，例如，映射一个IP地址到网卡中，它就已经准备好运行。在某些情况下，你甚至不需要停止此虚拟设备就可以添加新的资源。这一切取决于你所使用的虚拟化引擎和你要添加资源的类型。
　　■可移动性　虚拟设备与虚拟机一样运行在物理主机服务器上。因此它们是可移动的，所以可以将它们从一个硬件资源移动到另一个硬件资源。暂停这台计算机，移动它，然后再次启动它。这便于在峰值负载期间为虚拟设备提供所需的资源。有些虚拟化基础架构甚至可以基于一套策略自动化地移动虚拟机。
　　■业务连续性　可以将硬件资源连接到共享存储上，虚拟装置可以包含在此共享存储中。当硬件主机发生问题时，虚拟设备可以通过一个对最终用户透明的过程，自动地从一台主机移动到另一台主机上。有些虚拟化基础架构甚至可以在无任何服务中断的情况下移动VAP。对于长期的业务连续性，还可以使用复制技术将虚拟设备的磁盘文件复制到远程位置。
　　灾难恢复　由于虚拟机的性质，VAP可以通过快照进行定期的备份，或者能够在指定的时刻捕获虚拟机的状态。如果虚拟设备在关键维护、更新和安装补丁程序的过程中出现了某些错误，那么就可以返回到这些快照。这可以极大地提高VAP的可靠性。
　　▲可购性　因为它们不需要专用的硬件，所以VAP更加经济实惠。此外，它使得部署额外的VAP版本变得简单，在工作负载增加时提供了可扩展性。
　　VAP是未来的方向。在很短的时间内，所有的应用程序将会以VAP方式提供，你将不再需要担心安装和配置复杂的应用程序。
　　9.2.6　创建你自己的虚拟设备
　　如前所见，当涉及开源系统的时候，VAP是可以下载的。但当涉及Windows系统的时候，只有少数的VAP可用。为此，你必须创建你自己的Microsoft VAP。创建你自己的VAP的过程与为新虚拟机创建种子机的过程非常的相像，除了要安装操作系统和为了使用而配置它之外，你还要在移除此虚拟机的个性化设置之前先安装应用程序。通过这一过程，你可以创建很多不同类型的Microsoft VAP。
　　▼运行互联网信息服务器（IIS）的Web服务器
　　■SQL Server后端数据库服务器
　　■Windows SharePoint Services前端服务器
　　■流媒体服务器
　　▲DHCP服务器等
　　一旦VAP准备就绪，你就可以使用与种子虚拟机相同的移除个性化设置过程；当你要重新使用它的时候，你可以根据需要复制和个性化设置此VAP。
　　注意：可以在http://itmanagement.earthweb.com/article.php/31771＿3718566＿2中找出如何创建一个SQL Server VAP。
　　请记住，你不能创建必须先要加入域的VAP，例如域控制器，某些Exchange服务器角色等等。由于与域有关联，这些工作负载不能进行移除个性化设置和复制。因此，你应该记录下来并且尽量自动化这些角色的安装。
　　



　　9.3　执行物理到虚拟的转换
　　创建虚拟机的第2种方法是物理到虚拟的转换处理。P2V转换过程将物理服务器的操作系统、应用程序和数据从其物理容器中分离，迁移到承载虚拟机客户的虚拟化平台上。在转换过程中，驱动器由物理转换为虚拟，然后这台计算机就适合运行hypervisor。
　　P2V的方法有3种。
　　▼手动P2V　手动地创建一个虚拟机，将所有的操作系统、应用程序和数据文件由源计算机复制到虚拟机中。此过程的好处是运行在虚拟机操作优化的操作系统上。
　　■半自动P2V　使用一种工具将服务器由物理状态迁移到虚拟机中，如Microsoft的System Center Virtual Machine Manager（系统中心虚拟机管理器）或者VMware免费的转换器。
　　▲完全自动P2V　使用的一种工具，在无须用户交互操作的情况下迁移网络上的服务器。除了供应商提供的工具之外，在市场上存在多个这样的工具，如PlateSpin或Vizioncore，两者都支持VMware、Citrix和Microsoft的平台。
　　在每一种情况下，在转换之前，你都必须认真地准备物理计算机。
　　9.3.1　P2V准备任务
　　正如第1章到第5章所提到的，在你开始将它转换为虚拟数据中心之前，你需要充分地了解你的环境。然后，你需要尽可能地执行环境的清理操作。例如，你不会想要发现你自己在大量文件服务器转换时，却发现服务器上90%的文件在几个月以来和准备进行归档的时候从未被访问过。使用SCOPE曲线可以最佳地确定应该首先迁移哪些计算机。此外，可以依靠标准如硬件需求、软件的依赖关系、许可需求和当前资源利用率进行准备任务。
　　迁移很大程度上是依靠网络将数据从一台计算机移动到另一台计算机中。基本上，迁移过程是将物理磁盘驱动器的内容复制到虚拟磁盘驱动器中，但要这样做的话，所有的这些内容都需要通过网络来移动。这可能会导致一段停机时间。虽然有几种技术支持实时P2V转换，但在大多数情况下，你将会在维护期间脱机执行这些转换。你甚至可能需要放在一个特定的迁移时间段请求当中，这将允许你将所有的目标计算机迁移到虚拟机。
　　当计算机具有冗余服务，停机的风险将少很多。例如，如果你迁移一个域控制器及其附随的域名系统（DNS）服务，你应该不会经历任何的停机时间，因为在生产环境中你很有可能拥有另一个可以在此期间接手此负载的DC。请记住，这一策略不适用于使用多功能一体服务器的组织中，如小型企业服务器（Microsoft Small Business Server，SBS）。因为所有的服务器角色都运行在同一台服务器上，虚拟化SBS将肯定会导致一些停机时间。
　　还要确保你为迁移做好准备。你是否有足够的存储来虚拟化所有你的目标计算机？你应该使用存储虚拟化与自动精简资源调配，目标是创建动态扩展虚拟磁盘以尽量减少所需的存储空间。你的网络是否能够在转换过程中满足此负载？如果你正处于今天的峰值性能，增加转换工作负载可能会为你的网络带来过度的压力。
　　最后，检查供应商查看他们是否支持虚拟化其应用程序是一个不错的主意。与10年前不同，现在不支持虚拟化的供应商确实是越来越少了，但检查一下总是好的。例如，供应商如Oracle支持虚拟化他们的应用程序，但仅可以在他们自己的虚拟化平台上进行。在其他情况下，某些供应商将提供尽最大努力的支持政策。例如，Microsoft对于其应用程序在非Microsoft虚拟化环境的支持提供了尽最大努力的政策。其他的供应商可能实际上会要求你将工作负载转换回物理平台以针对特殊的问题为你提供支持。当你选择了你将要使用的P2V工具时，请谨记这一点。为此，你还应该考虑选择具有能够将机器从一种状态转换为另一种状态的集成备份工具的优点。
　　注意：Microsoft的支持政策被记录在知识库文章编号为897615的文档中，链接为http://support.microsoft.com/kb/897615。
　　物理到虚拟的转换通常是简单的：指向一台物理服务器并将它转换为虚拟机。当然，你用于执行P2V转换的工具必须支持将操作系统物理安装的驱动器转换为你依靠的虚拟机引擎或hypervisor。这通常是转换最困难的地方。你还应该瞄准能够执行反向转换的目标发展——你可以实现从虚拟到物理的转换，而不是从物理到虚拟。虽然随着时间的推移，反向转换的需求将会消失，但它在动态数据中心实施的早期阶段可能仍然是必要的。
　　正因为如此，你可能需要一种不仅可以执行P2V转换，而且还可以执行V2P转换的工具。那么，或许你可以使用的最佳策略是将备份和恢复的需求与机器转换的需求结合起来。P2V转换其实只不过是物理驱动器的备份。在理想情况下，你可以使用一种能够备份所有机器——物理的或虚拟的——然后将此备份存储在一个中央位置的工具。在这种情况下，磁盘镜像备份通常是最好的。当需要恢复的时候，可以将镜像从这个中央备份位置移动到任何可能的目标上，重申一遍，可以是物理的或虚拟的。你需要确认的关键功能是能够在运行恢复过程的时候，更新操作系统的驱动程序。许多这类工具能够指向中央驱动器存储区以首先获取它们，然后将它们注入正在恢复的镜像中（见图9-6）。从那时起，此工具将支持所有机器的备份、恢复和转换，无论是资源库还是虚拟服务提供。
　　图9-6　P2V使用的备份或镜像工具
　　市场上提供了多个支持这方面功能的工具。磁盘镜像供应商，如Acronis，提供的True Image产品线，Symantec提供的Ghost产品线，都是评估需求的最佳工具。
　　9.3.2　执行P2V
　　当你准备好执行P2V操作的时候，可以使用以下的方法：
　　1.确定迁移候选者的有效性。
　　2.清楚供应商对虚拟工作负载的支持。
　　3.考虑许可成本，如有必要进行调整。
　　4.确认虚拟机相应的主机。
　　5.确认虚拟机的CPU和内存的需求。
　　6.确认虚拟机文件的存储位置。
　　7.确认网络需求，确保在主机上有适量的虚拟网卡可用。
　　8.确认虚拟机的故障转移策略。
　　9.使用标准命名策略来区分新虚拟服务提供与用于运行该工作负载的物理主机。
　　10.计划停机时间以支持迁移。
　　11.准备你的新虚拟机测试计划。
　　12.一旦它通过了所有的测试，准备虚拟机的上线计划。
　　按照重要性的顺序来选择合适的候选对象。以低风险的、非关键性业务的工作负载作为开始，如你运行的测试和开发环境。这将使你可以在对业务没有任何负面影响的情况下了解P2V过程的细节。对于最初的转换，Web服务器也常常是很好的候选对象。如果正确地设置了你的Web站点，你可能已经具有通过网络负载平衡运行的冗余的Web服务器。冗余服务可以降低风险，特别是第一次P2V实验的风险。接着，对那些低利用率但承载了少数关键应用程序的系统进行转换。下一步，将转换那些不是关键的但利用率较高的系统。这可能包括特定的应用程序服务器或者路由/虚拟专用网络（VPN）服务器。
　　最后才迁移那些运行了关键工作负载的服务器。这时，你应该已经十分熟悉这个过程，并为任何可能发生的情况做好了准备。这包括的应用程序如Exchange、SQL Server和关键业务的应用程序。
　　你将发现有多种支持物理到虚拟迁移过程的产品，同时提供了免费和付费的版本。选择一种最适合你需要的产品。下面执行P2V转换的一些最受欢迎的方法：
　　▼VMware Converter
　　■PlateSpin PowerConvert
　　■用于BartPE的Ultimate-P2V插件
　　▲Microsoft转换工具
　　每一种工具提供了各自的功能和性能级别。
　　9.3.3　使用VMware Converter
　　VMware Converter有2个选择：Converter Starter（入门版）和Converter Enterprise（企业版）。Converter Starter是免费的版本，允许你在一个接一个的基础上执行单线程的转换。而Converter Enterprise同时支持在线实时和离线的转换。表9-1列出了这2个工具之间的差异。
　　此工具可以运行在各种硬件上，支持最常用的Microsoft Windows操作系统。VMware Converter可以在无任何中断或停机的情况下，将本地和远程的物理机转换为虚拟机（见图9-7）。此工具还可以通过一个集中式的管理控制台和转换向导，同时完成多个转换。请注意，同时执行多个转换会加重网络的负担。
　　图9-7　VMware Converter企业版
　　Converter还可以用于将其他的虚拟机格式——如Microsoft Virtual PC和Microsoft Virtual Server，或者物理计算机的备份映像，如Symantec Backup Exec System Recovery或Norton Ghost 12——转换为VMware虚拟机。这个过程被称为虚拟到虚拟（Virtual to Virtual，V2V）的转换。此外，它可以将虚拟机的合并备份（VMware Consolidated Backup，VCB）镜像还原为运行中的虚拟机，或者克隆和备份物理机到虚拟机作为灾难恢复计划的一部分。
　　注意：要了解更多关于VMware Converter的详细信息，请参阅www.vmware.com/products/converter/overview.html。
　　9.3.4　使用PlateSpin PowerConvert
　　对于那些可能使用多个hypervisor的更全面的环境，可以依靠的工具如PlateSpin PowerConvert。此工具可以通过网络在物理服务器之间迁移和保护工作负载，无论是平台、虚拟主机或者镜像档案。只需通过一个简单的拖放操作，它就可以远程地将工作负载从底层的服务器硬件中分离出来，并将它们迁移到任何的物理和虚拟主机上。
　　可以在物理和虚拟主机之间任何的方向实现移动：物理到虚拟（P2V）、虚拟到物理（V2P）、虚拟到虚拟（V2V）、物理到物理（P2P）、常见的和不常见的镜像格式等。此工具支持任何的虚拟引擎：Citrix、Microsoft或VMware。它可以转换Microsoft Windows服务器和客户端操作系统以及Linux。它的目标甚至可以是由Acronis或Symantec生成的镜像档案，或者是Double-Take提供的备份解决方案。
　　注意：要了解更多关于PowerConvert的详细信息，请参阅www.platespin.com/products/power-convert/overview.aspx。
　　9.3.5　依靠BartPE的Ultimate-P2V插件
　　BartPE是一个免费的预执行环境，通常由IT管理员和技术人员使用，在使用没有安装操作系统的计算机时取代DOS。Ultimate-P2V是一个由Qui Hong、Chris Huss和Mike Laverick共同创建的免费插件。这个插件允许你克隆物理计算机到虚拟机中，执行所需的系统重新配置任务以使其可启动。它附带了2个用户指南。第一个指南讲解了插件和驱动程序的手动创建过程，而第二个指南提供了可以下载到的所有插件和驱动程序。解压缩这些驱动程序和插件在BartPE中安装，通过Ultimate-P2V建立一张准备使用的CD。此工具支持将VMware和Microsoft的虚拟磁盘格式作为目标，将机器转换为适用于VMware、Citrix或Microsoft的hypervisor的虚拟机。
　　注意：要了解更多关Ultimate-P2V的详细信息，请参阅www.rtfm-ed.co.uk/？page＿id=174。
　　9.3.6　Microsoft转换工具
　　Microsoft也提供了转换工具。Microsoft迁移工具集（Microsoft Virtual Server 2005 Migration Toolkit，VSMT）可以免费下载，它允许你将物理机转换为Microsoft的虚拟机格式——VHD（虚拟硬盘）。你可以将这种格式导入到VMware Server或VMware Workstation中，因为这2种工具可以将VHD文件转换为VMware虚拟机磁盘（VMDK）格式。
　　为了能够使用VSMT，你需要访问Windows Server 2003的自动部署服务（Automated Deployment Services，ADS），这个服务也是免费的，但只能在Windows Server 2003企业版上运行。当然，这个工具的目的是将Microsoft工作负载转换为虚拟机。
　　注意：要了解更多关于VSMT工具的详细信息，请参阅www.microsoft.com/technet/virtualserver/downloads/default.mspx。
　　Microsoft还可以通过系统中心虚拟机管理器（System Center Virtual Machine Manager，SCVMM）中的一个向导界面支持P2V的转换（见图9-8）。不过，要想通过SCVMM执行转换，你还必须具先取得Windows自动安装工具包（Windows Automated Installation Kit，WAIK）的访问权限，因为SCVMM是依靠Windows PE——包含在WAIK中——将服务器内容复制到虚拟硬盘之前引导一个交替的操作系统。SCVMM转换并不支持所有的Windows版本。此外，通过DNS可以访问到虚拟机，或者使用其IP地址使SCVMM可以找到它。基本上，向导可以定位计算机，收集有关它的信息，如果有需要允许你重命名虚拟机，允许你配置虚拟磁盘卷，允许为新虚拟机选择目标主机和路径，最后允许你为虚拟机指定额外的属性。请注意，SCVMM不是免费的，必须作为你的虚拟基础架构的一部分来获得。
　　注意：要了解更多有关P2V与SCVMM的详细信息，请访问http://technet.microsoft.com/enus/library/bb963740.aspx。
　　图9-8　使用SCVMM转换计算机
　　



　　9.4　提供最佳实践
　　正如你所见，有很多不同的方法和工具可以用于P2V转换。最好的方法之一是创建一个新的虚拟机，或者是将物理服务器的内容还原到虚拟机中，或者甚至更好的做法是迁移虚拟机的工作负载到新的虚拟机中。将内容从一台物理服务器迁移到虚拟机可能是最佳的做法，因为它允许你基于标准配置生成原始状态的虚拟机，然后通过适当的工作负载加载它们。现有的多种工具可以迁移所有的工作负载，从文件服务器到Exchange。
　　注意：有关如何通过工作负载迁移将企业网络工作负载由物理转换为虚拟的方法，请参阅《Windows Server 2008：The Complete Reference》一书，该书由Ruest和Ruest编著（2008年由McGraw-Hill发行）。
　　请仔细考虑P2V的策略，因为你不希望转换的虚拟机不能在最佳状态下运行。当虚拟机在生产环境中运行时，它们将成为共享的资源。没有什么比配置不正确的虚拟机更差了，一开始就占用所有主机服务器的资源。不要将问题由物理转移到虚拟世界。此外，在执行P2V转换之前，请考虑以下的最佳实践：
　　▼确保可以转换到目标计算机。例如，如果正在运行Microsoft Virtual Server，那么就不能转换到64位的计算机。
　　■在开始之前，确定是否可以执行在线迁移。某些工作负载不适合进行在线迁移。在某些情况下，必须在源（物理）服务器处于脱机状态下才能执行迁移。
　　■确保主机系统为转换保留了足够的空间和资源。当转换系统时，必须有空间来承载运行中的实例，为支持高可用性加上在别处承载虚拟机的空间。
　　■在执行转换之前准备好源服务器。执行磁盘检查以确定是否存在坏的扇区。执行碎片整理以加速转换过程。使用动态虚拟磁盘将空间的使用减到最小。
　　▲验证迁移后的目标服务器。执行P2V后的清理。此清理包括的项目如移除所有的供应商代理，移除在虚拟化环境中不再需要使用的驱动程序，以及移除任何不必要的设备。
　　使用这些实践将有助于你建立最佳的动态数据中心并执行无错误的P2V转换。
　　



　　第10章　使用桌面虚拟化
　　自从台式机第一次出现在市场上时，它们就一直是令管理员头疼的根源。台式机是分布式系统资源的访问点，因此必须进行标准化以尽可能地减少潜在的问题。然而，太多的组织没有锁定他们的桌面，即使他们已经对台式机进行了标准化管理。对于那些让最终用户具有本地管理员权限的开放的台式机或者桌面，因为从它们部署的那一刻开始它们就具有更改的权限，因此难以管理。实际上，它们可能是虚拟机（VM）泛滥的原因，因为本地管理员的用户可以轻易地安装虚拟机软件，开始创建他们自己的虚拟机，为桌面管理员和技术人员造成更多的问题。
　　如果桌面没有被锁定，就不可能受到控制并且总有很多问题。然而，可以在锁定系统的情况下仍然允许他们进行正常的工作。我们的一个客户在1996年就开始锁定他们的Windows NT桌面。结果：他们减少了800%的与桌面相关的帮助请求呼叫！如果锁定一个古老的操作系统如Windows NT的桌面对他们来说是可行的，那么对Windows XP或Windows Vista做同样的事对所有人来说应该也是可行的，这2个操作系统为了这个问题进行了大量内置的改进。然而，由于这是繁琐的工作，很多管理员今天仍然怕麻烦甚至不去尝试。用户已经习惯于控制自己桌面上的一切，他们不会放弃这种自由，因为他们现在已经认为这是一种既得的权利。
　　这个问题是来源于我们用于台式机的名称：个人计算机（PC）。组织应该要强调其系统计算机的名称，而不应沿用个人计算机这个名称。使用它的本义来定义PC一词，会给每个用户造成先入为主的错觉——计算机是属于他们的。嗯，但情况并非如此。位于桌上的计算机，是属于组织的，而不是属于个人的，因为如此，它更应该被锁定和集中控制。这项计划的关键是谁拥有PC的哪一部分。用户的权限应该从哪里开始，又到哪里为止？什么权限是属于公司的和什么权限是属于IT的？在PC上定义好这些属性区域的每一部分，通过与用户进行大量的沟通使他们清楚明白，使得锁定计划能够实现。
　　



　　10.1　使用系统堆栈
　　分布式PC的另一个主要问题是需要管理和部署相当数量的应用程序，不管组织的规模和用户数量多大，他们在每个用户运行的应用程序的数量上是相对固定的。在最坏的情况下，他们要为每个用户管理一个以上的应用程序；在最好的情况下，他们要为每个用户管理少于一个应用程序，但当你想到一个具有1000个用户的组织，可能需要管理1000个或更多的应用程序时，你就会了解并可能分享他们的痛苦。要对1000个应用程序进行封装、部署、更新、授权、监控和支持。这是一项繁重的工作。更糟的是试图让多个应用程序正常地共存在同一系统上。现在已是一个挑战。
　　这就是为什么需要创建一个标准系统堆栈的原因。使用系统堆栈可以简化组建PC的方式和管理应用程序的方式，因为它制定了如何从头到尾建立计算机系统。少数组织甚至需要在同一台计算机上安装200个或500个产品。使用一种为系统设计的模型将可以确保对应用程序进行正确的分类，重新分组为一同工作的家族，满足你组织中特定的工作角色所需的功能。为此，我们花了15年多的时间一直在推行安全服务访问点（Point of Access for Secure Services，PASS）模式（见图10-1）。依靠这个系统堆栈的组织具有正确系统和应用程序管理的已证实的追踪记录。
　　图10-1　PASS系统构造模型
　　此系统堆栈是基于以下3种方式响应公司需求的计算机系统结构：
　　▼PASS系统的“内核”是用于满足大多数或一般用户的需求。它包含了实现基本的办公自动化和协作任务所需的所有软件组件。此外，它被划分为一系列类似于开放系统互联（Open Systems Interconnection，OSI）网络模型的层次。与OSI模型一样，它使用了7层来提供核心企业服务。由于该功能是所有人员所需要的功能，所以这个内核安装在所有的计算机系统上。
　　■在内核之上添加基于角色的应用程序和商业软件以满足在组织内扮演特定IT角色的每个人的需求。
　　▲最后，通过一个特定的层来响应高度专业化的、经常以个人为基础的IT需求。这个特定的层可以应用在任何时间并贯穿传统的各类IT角色。
　　注意：在此模型中，内核被认为是一个封闭的、可以在所有系统上复制的组件。对于所有的系统，位于内核之上的层被认为是可选的。
　　基于系统堆栈，如PASS模型，构建系统极大地减少了系统管理的工作量，因为它减少了必须在任何系统上共存的程序的数量。
　　首先，大部分的系统，有时候高达50%或更多，将只需要系统的内核。请记住，内核应包含那些无版权费用和整个组织都需要的一切程序（例如，Adobe的Acrobat Reader或新的Microsoft XPS Document Reader）；每一个由内部策略授权的程序——例如，防病毒工具；组织获取了企业范围授权许可的每一个程序（例如，许多组织都获取了Microsoft Office的企业授权许可）。
　　第二，通过基于角色的配置对程序进行分组，组织可以减少必须在一个系统上共存的应用程序的数量。基于角色的配置包括了IT角色分组的每一个成员所需的每一个程序。例如，Web编辑将需要Web编辑工具、图形工具、基于Web的动画工具和其他特定的Web实用程序。这一组工具可以个别地封装，但在所有属于IT角色的系统上应作为一个单一的单元来提供。基于角色的配置通常包括10个至30个单独的程序，这取决于不同的角色。只有这些分组需要对彼此和对系统内核的内容进行验证。对于包含在不同配置的程序的共栖，并没有验证或测试的需要，因为它们不太可能在同一系统上共存。
　　第三，特定的程序甚至可以进一步降低系统管理的工作量，因为在组织内只有很少的用户需要它们。它们仍然要被封装，以便可以集中地分发和自动地安装，但重申一遍，它们只需要对内核和它们将共存的配置进行测试，然而，由于特定的性质，它们可以与所有可能的配置共存。
　　每个应用程序都具有其自己的生命周期，独立于系统构建模型内的位置。不同之处在于你为应用程序申请的生命周期活动的速率。内核组件将有一个加速的生命周期速率——因为它们是位于所有的系统之上，它们相比于其他的组件往往会以更快的速度演变，因为它们由整个公司范围内的资金来支持——而在模型外层中的产品将会有较慢的生命周期速率，这将由需要它们的群组来提供资金。理想情况下，对于每个非内核的应用程序，这些产品的演变速率将由主题专家或者你的组织确认的应用程序赞助商来监控。
　　注意：有几项活动的监控是由应用程序赞助商来负责的，其中4个涉及应用程序的专业知识；应用程序封装的验收测试；应用程序监控或者观察新版本或补丁程序；合理化的理由或者证明为什么将此应用程序放在整个软件组合中的首位。
　　当建立和管理分布式系统的时候，使用这些策略将可以减少全局性问题，但策略并不能全面减少这些问题。
　　



　　10.2　桌面管理问题
　　过去，系统没有被锁定并且它们很少进行标准化的管理，直到组织迁移到Windows XP情况才有了改变。但考虑到大多数组织最近才完成在Windows XP上实现标准化管理，他们准备重新开始只是为了要锁定他们的系统？答案是否定的。这与迁移到Vista是相同的答案。执行大量的分布式桌面部署是一项艰巨的任务，主要是因为需要对组织管理下的每一个应用程序进行重新访问以检验兼容性，可能要将它升级，重新封装它，然后将它部署在新的操作系统（OS）上。这确实是一项高付出低收益的工作。现今的Vista部署究竟是什么情况？究竟什么是桌面？这些问题的答案可以帮助了解到迁移到桌面虚拟化或者创建标准桌面镜像是运行在虚拟化软件之内，而不是在物理硬件之上。
　　10.2.1　Vista当前的情况
　　到目前为止，只有少数的组织部署了Vista，尽管Microsoft尽了最大的努力，但在Windows 7发布之前这种情况不太可能会发生改变。然而，根据Microsoft，Vista是该公司历史上销售速度最快的操作系统。
　　▼到2008年年中已售出超过100000000份。
　　■在2008年，2500个应用程序已取得Vista的认证，2006年有254个。
　　■今天，Vista已名列100个最畅销应用程序排行榜的第98位。
　　■150种企业级的应用程序可以在Vista上运行。
　　▼在2008年，78000种设备已取得Vista的部署认证。
　　鉴于这些统计数字，你会觉得在Microsoft已经发布了相当长时间的操作系统中，Vista是最受欢迎的，但是，情况似乎并非如此——至少Kace Systems在2008年完成的一项调查的结果得知情况并非如此。
　　▼有90%的管理员关注Vista，但只有13%有关于Vista部署的明确计划。
　　▲44%管理员正在考虑另外一种操作系统，但50%以上管理员表明其他操作系统的系统管理问题会阻止他们这样做。
　　但是，无论是选择Vista还是其他的桌面操作系统，分布式的桌面总是难以管理的。它们分布于整个组织的办公室中。它们可以是台式机或移动系统。它们可以在办公室内或在办公室外。当然，当用户具有管理权限的时候，一旦它离开了你的桌面，你永远不会知道你的操作系统是处于什么状态。
　　注释：如果你是极少数实际部署了Vista的一位管理员，那么你可以参考这2本书：免费的《Definitive Guide for Vista Migration（Vista迁移权威指南）》，由Ruest和Ruest编写，可以在以下地址获得：www.altiris.com/campaigns/vista/vista＿ebook.aspx；《Deploying and Administering Windows Vista Bible（部署和管理Windows Vista圣经）》，由Ruest和Ruest编写（2008年由Wiley发行）。
　　10.2.2　桌面的分析
　　归根结底，桌面具有3个核心的组成部分（见图10-2）：
　　▼核心操作系统层，其中包括了操作系统本身和它所需的补丁程序。它涵盖了除了生产力层的PASS模型的内核。
　　图10-2　桌面的分析
　　■应用程序层，目的是为最终用户提供额外的功能。它包括了生产力应用程序层，基于角色的层，以及包含在PASS模型中的特定的应用程序层。
　　▲用户数据层，包含了所有用户的数据，包括用户生成的文档、演示文稿等，以及应用程序的配置设置和桌面的个性化设置。
　　这些就是桌面的3个关键组成部分，如果可以将这些层一个一个地抽取出来，那么可以极大地减少桌面管理的开销。这正是桌面虚拟化产品可以帮助的地方。因为桌面是包含在虚拟机内，所以当计算机已从物理转换到虚拟，你就可以获得所有的优势，虚拟机管理只会带来少数的问题。
　　



　　10.3　迁移到桌面虚拟化
　　越来越多的组织转向虚拟桌面以简化桌面管理模式。桌面虚拟化比管理物理桌面往往更有意义的原因有以下几个。
　　▼首先，可以在任何终端设备上为用户提供集中式的管理桌面——台式机、瘦客户端、Web客户端等。
　　■第二，可以锁定虚拟桌面，因为它们是集中控制的，因此更容易提供——只需创建一个单一的桌面镜像，在需要的时候复制它。
　　■可以在终端上花更少的时间——实际的物理PC——因为它们不再需要进行严格的管理。毕竟，你只需这些终端提供到虚拟桌面的过程桌面连接。
　　■可以只需为中央的桌面提供服务级别协议（SLA），而不需要为终端本身提供。用户可以是终端上的管理员，但只对虚拟桌面进行锁定。这让他们可以在终端上做他们想做的事情，但保持了对公司PC内的控制。
　　■可以降低成本提高服务的稳定性，因为你了解每台PC的起点的所在：来自于黄金虚拟桌面镜像。
　　■可以创建锁定的和加密的、可以受时间控制以满足时间性需求的虚拟桌面镜像。例如，如果你们有一个员工加入满足季节性的业务需要，你可以为此工作期限生成受时间控制的PC镜像。
　　■通过将虚拟桌面保持在数据中心内，可以保护信息的安全。这可以让你更好地控制知识产权（Intellectual Property，IP）；你所要做的就是锁定你创建的镜像，使它不具有访问外部设备的权限。当集中存储IP，不能放在数据中心时，符合规定很容易。
　　▼对复杂或者敏感的应用程序进行封装，并隔离到特定的PC虚拟机中，以确保正常的操作。通过这种方式，此应用程序并不需要与任何其他的应用程序进行交互和共存。
　　以外，虚拟桌面基础架构（VDI）可以支持以下的需求：
　　▼由于资源只是集中地而不是本地的需要，所以新操作系统的迁移可以更容易实现。由于终端只需要远程桌面功能，所以对硬件的更新只有相当小的影响。
　　■由于所有的桌面是集中化的，所以合并和收购可以更容易管理。
　　■替代工作区可以根据需要提供给雇员。
　　■可以使用自定义的虚拟桌面向承包商提供安全、加密的计算机，以可以在你的环境中工作。使用这种方式，他们自己的计算机永远不需要连接到你的网络。
　　▲虚拟PC还可以支持测试和开发的环境，如虚拟实验室的构建（见第6章）。什么是虚拟桌面？你如何运行它？
　　注意：要了解更多关于VDI的优缺点，请在www.virtuall.nl/articles/PublishedArticles/LanVisionVDIenglish.pdf中查阅由Ruben Spruijt编写的《VDI Makes Sense》。
　　10.3.1　可用的桌面虚拟化产品
　　有多种不同类型的桌面虚拟化引擎。它们通常适用于2种不同的虚拟化模式：本地和集中。本地桌面虚拟化模式，通常称为客户端桌面虚拟化，重点是使用终端本身的资源来运行虚拟桌面。虚拟化软件安装在物理桌面上，并提供公司的虚拟桌面镜像给最终用户。然后，最终用户在其物理桌面之上运行虚拟桌面。
　　第二种模式是集中，通常称为服务器托管的桌面虚拟化。在这里，虚拟桌面将运行在生产hypervisor之上，由最终用户远程地访问。最终用户需要的是支持远程桌面连接的设备。运行在主机服务器上的虚拟桌面使用共享存储以确保桌面的可用性。
　　此外，本地模式同时支持托管和非托管产品的使用。托管产品的使用意味着PC镜像是由中心机构提供，并且是集中地控制的。非托管的意味着用户可以创建和运行他们自己的虚拟桌面镜像的版本，因为他们所使用的软件支持这种能力。表10-1概述了对于本地和集中的虚拟桌面，由各家制造商提供的不同产品的选择。桌面虚拟化是一个非常活跃的市场，当你读到这里的时候说不定已经又增加了几个新产品。但是，表10-1中列出的供应商已经在市场上存在了一段时间，并且提供了令人满意的各种产品。
　　正如你所见，有多种不同类型的产品和平台用于虚拟桌面机的控制，包括了本地和集中。
　　10.3.2　虚拟桌面授权许可
　　当使用虚拟桌面时，与使用虚拟服务器一样，你必须要考虑授权并确保每个用户的桌面都有一个适当的许可，无论是物理或虚拟。如果你使用Windows，你可以从Microsoft那里得到更大的支持，因为Microsoft已经发布了Vista企业集中化桌面（Windows Vista Enterprise Centralized Desktop，VECD）的许可。VECD为运行虚拟化桌面提供了独特的许可，包括本地和集中。它还包括以下的特点：
　　▼可以在服务器上无限次的安装Windows Vista企业版或者无限次的安装降级的桌面操作系统。
　　■虚拟桌面可以由访问设备进行授权，无论是什么样的设备。
　　■每个用户在访问设备上一次最多可以运行4个虚拟实例。
　　■组织可以运行静态或动态的托管桌面架构。
　　▲虚拟桌面可以在Microsoft或者非Microsoft的基础架构上运行。
　　正如它名称一样，此许可是依靠于Windows Vista的企业版，默认情况下需要一个Microsoft的企业授权协议。
　　请注意，与Microsoft签署了企业协议，你还可以访问Microsoft的软件保证计划，其中包括了对组织的一些益处，特别是软件保证的Microsoft桌面优化包（Microsoft Desktop Optimization Pack，MDOP）。MDOP包括了多个专为支持组织运行Windows桌面的工具。Microsoft Application Virtualization（应用程序虚拟化），Microsoft Enterprise Desktop Virtualization（企业桌面虚拟化），Advanced Group Policy Management（高级组策略管理）、Asset Inventory Service（资产库存服务）、Diagnostics and Recovery Toolset（诊断和恢复工具集）以及Desktop Error Monitoring（桌面错误监控），都是MDOP软件包的核心。
　　如果你正在使用非Windows桌面，那么你必须与你的制造商合作，确保你具有对桌面上每个用户和每个实例的适当的权限。
　　注意：更多关于VECD的信息可以在下面地址中找到：www.microsoft.com/virtualization/solution-product-vecd.mspx。更多关于MDOP的信息可以在下面地址中找到：www.microsoft.com/windows/products/windowsvista/enterprise/benefits/tools.mspx。
　　10.3.3　潜在的桌面虚拟化应用场景
　　有不同的桌面虚拟化应用场景，如在表10-1中产品的所述。有些产品集中于通过用户的桌面功能来运行虚拟桌面；其他的一些产品集中于在中央数据中心内的服务器虚拟化平台上运行虚拟桌面。实际上，可以依靠4种不同模式的虚拟桌面。
　　第一种模式的重点是锁定和加密桌面虚拟机。集中地准备虚拟机，然后进行加密以保护它们的内容。通过便携设备将它们分发给最终用户，如USB记忆棒、DVDs外置的USB磁盘驱动器或其他的可移动存储设备。因为它们是加密的，所以它们完全不会受到干扰。用户必须提供相应的解锁钥匙来启动虚拟机。因为它运行在用户自己的桌面上，此模式可以为你提供创建标准的锁定虚拟机的能力，满足公司所有要求（见图10-3）。支持此模式的产品包括VMware ACE和Microsoft的Kidaro——已改名为Mi-crosoft Enterprise Desktop Virtualization（Microsoft企业桌面虚拟化）——虚拟桌面。ACE运行在VMware Player之上，因为用户只需要执行虚拟机的能力，而不是创建它。Kidaro依靠Microsoft Virtual PC的锁定版本来执行虚拟机。Player和Virtual PC都必须预先部署到用户的桌面上，或者当用户收到虚拟机的时候，他们必须具有运行安装所需的管理权限。
　　图10-3　锁定的和加密的桌面虚拟机依靠桌面功能来运行
　　非托管的桌面虚拟化源于工具的使用，如VMware Workstation或Microsoft Virtual PC。这2种工具都是本地安装在用户的桌面上，依靠桌面的处理能力来运行虚拟机。用户还可以依靠其他的工具，如VMware Server或Microsoft Virtual Server，但这些工具还需要安装Web服务器，这会消耗更多的PC资源。因此，最好使用桌面工具以最大化PC的资源，运行尽可能多的虚拟机。
　　这种虚拟化的形式被称为非托管，虽然可以对其进行管理。在非托管模式下，用户安装他们自己的虚拟化软件版本，创建并运行他自己的虚拟机（见图10-4）。此模型最重要的问题是执行这些安装的用户往往没有受过这方面的训练。这可能会导致可能运行了未安装补丁程序或未受保护或者更糟的是不受支持的操作系统的流氓虚拟机，这可能会为恶意用户提供一个进入点。
　　图10-4　非托管的桌面虚拟化可会在组织内导致问题
　　例如，我们的客户有一个安装了他自己的虚拟化软件的用户，然后他在虚拟机内安装了一个未安装补丁程序的Linux版本。更糟的是这台虚拟机还开放了一系列的传输控制协议/
　　网际协议（Transmission Control Protocol/Internet Protocol，TCP/IP）端口以运行电子邮件服务，这相当于在因特网上广播。当然，组织的防火墙已为他们官方的电子邮件服务开放了端口，这是受到保护的，但Linux虚拟机的电子邮件服务是敞开的。因此，这很容易被垃圾邮件制造者利用，使用它作为电子邮件中继。将有非常多的电子邮件通过此服务器发送出去，导致互联网服务提供商（Internet Service Provider，ISP）的整个电子邮件服务被击倒。当ISP联系他们以查明究竟发生了什么事情的时候，该组织才获悉流氓Linux计算机的存在。不用说，现在，该组织的IT人员已对进出其防火墙的信息保持密切的关注。他们还为最终用户制定了一个虚拟机管理程序。他们准备好虚拟机，然后作为一种IT服务将虚拟机提供给需要它们的用户。
　　正如你所见，当允许用户安装自己的虚拟化软件并创建他们自己的虚拟机时，很容易就会面临虚拟机泛滥的情况。这就是为什么IT应该要为任何需要它的用户制定一个正式的虚拟机创建程序的另一个原因。例如，使用第6章所概述的虚拟实验室将有助于减少组织中出现虚拟机泛滥的机会，因为虚拟机将作为一个正式的IT服务。
　　第三种模式，有状态的虚拟桌面，重点是集中管理与每个特定用户相关联的桌面。在这种模式中，每个用户连接到他或她自己的特定桌面虚拟机。这些虚拟机被存储在中央共享存储容器中，其做法就像是你在虚拟化服务器软件。运行生产hypervisor的主机服务器管理所有的桌面虚拟机，并确保它们高度可用。这个模式往往需要大量的存储器，因为每个虚拟机可以很容易就占用掉几十兆字节或更多。用户依靠远程桌面连接与他们的虚拟机PC连接（见图10-5）。
　　图10-5　有状态的虚拟桌面在用户和他们依靠的虚拟机之间提供了一种直接的相互关系
　　最后一种模式，无状态的虚拟桌面，重点是根据需要生成虚拟机。当用户连接的时候才生成虚拟机，或者是当发生一个连接请求时，它们可以预先生成并连接到用户。这种模式的优点是虚拟机是完全非永久性的和动态建立的。生成核心桌面镜像，然后在连接过程中确认用户，他们需要的应用程序就会应用到桌面镜像中（见图10-6）。在登录时用户的数据和首选项也会被应用。虽然你可能认为此过程非常耗时，可能会引起用户的不满，实际情况不会这样。理想的非永久性桌面是只有当用户实际要求它们的时候，才依靠应用程序虚拟化来配置应用程序。因为一切都是发生在后端存储区域网络上，通过高速的磁盘到磁盘的交换来提供应用程序和用户的配置文件，所以这一切对于用户几乎是透明的，甚至多个用户也没问题。
　　图10-6　无状态的虚拟桌面是在用户连接时按需生成的
　　最后的模式通常是最受欢迎的。鉴于桌面是非永久性的和临时的，它们只在使用过程中才需要存储空间。应用程序和用户数据存储在桌面镜像以外，也因为如此，组织没有必要为每个用户保留一个单独的镜像。由于每个桌面由一个单独的镜像生成，所以当有可用的补丁程序时，你只需更新一个目标。这极大地简化了虚拟桌面管理的模式。
　　10.3.4　确定桌面虚拟化的用户
　　鉴于虚拟桌面使用的各种模式，特别是集中的、非永久性的桌面模式，很容易理解在几乎所有的组织内采用此模式完全是可行的。终端不再是用户必须依靠的核心计算机。终端只是被视为具有远程桌面连接能力的设备。因此，你不再需要花费过多的资源来管理终端。相反，你只需集中管理和锁定用户实际上使用的执行他们工作的虚拟桌面镜像。但是要很好地管理虚拟桌面，为每个用户提供最佳的体验，你必须对用户群进行分类，并为每个目标用户指定合适的解决方案。有3种用户类型你将需要与之共事：
　　▼基本生产力工作者将需要较少的应用程序类型。通常，他们需要的只不过是先前提到的在PASS模型上构建的系统的内核。他们将会间歇性地使用，并且主要是基于文本的使用。他们将有限地使用鼠标和有限地使用打印机。这种桌面用户类型将在不同的时段登录，并将在中央主机服务器上创建一个可变的工作负载。这种工作者类型是标准虚拟化桌面的理想对象。
　　■知识工作者将需要一个更强大的集中式桌面，因为他们往往会在同一时间运行多个业务和生产力应用程序。他们会使用图形比较丰富的应用程序，因此每个用户需要更多的内存。知识工作者还往往会在同一时间登录。如果你的PASS系统内核设计得当，应该同样可以满足大多数知识工作者的需求。这意味着在内核中的生产力套件必须至少包括基本的图形工具。他们使用的虚拟桌面将需要更丰富的图形体验，每个虚拟机需要更多的资源。
　　▲丰富的桌面用户很可能会在同一时间运行多种计算密集型和图形密集型的应用程序。工程师或交易员就是这种用户类型的例子。他们经常需要专门的工程或交易的外围设备，经常需要同时连接多个显示器。他们还需要高端的图形分辨率，这些都是大多数主机服务器缺乏的东西。为此，解决这些用户的需求最佳的方法是使用刀片式PC——将PC集中地托管在数据中心内的刀片机箱中——而不是使用虚拟桌面，尽管虚拟桌面的能力正在提高。例如，Microsoft在2008年收购了Calisto Technologies。Calisto专门研究通过三维加速改善最终用户的远程桌面体验。这种技术将会嵌入到Windows中，当他们连接到虚拟桌面，将改善远程桌面连接的用户体验。此外，VMware正与Teradici和Wyse一起合作，改善其产品中的远程协议支持。在这些情况下，可能不再需要刀片式PC。
　　正如你所见，不同用户类型需要不同的集中式解决方案。但是，正如较早前指出的，集中桌面并不总是最好的解决办法。表10-2描述了可用于降低分布式桌面计算成本的不同的解决方案。它列出了几种解决方案，其中很多都已经讨论过，但它还包括了Presentation Virtualization（表现层虚拟化）的技术，这是真正的基于服务器的计算，和PC刀片。它还概述了每个解决方案对最终用户体验的影响。
　　依靠这个表来决定哪一种解决方案最适合你自己的用户。用3种核心用户类型对它们进行分类，然后确定适用于他们需求的解决方案。要做到这一点，需要正确地理解各种桌面虚拟化技术，确定将最适合你的组织和你的用户群需求的技术。
　　



　　10.4　集中式桌面虚拟化基础架构
　　当你运行一个桌面虚拟化基础架构（VDI）时，你需要在3种支持模式中确定最适合你组织的需求的模式。这3种模式包括：
　　▼永久的或指定的桌面　此桌面绑定到一个单独的用户上，每次他或她登录时为用户提供相同的桌面。正如先前所述，这个模式需要大量的中央存储空间。如果你只有很少的用户或者如果存储空间并不是你的组织要关注的问题，那么可以使用此模式。
　　■非持久的，非永久性的或共用的桌面　一种新的通用的桌面，每次他或她登录基础设施时提供给用户。应用程序和用户配置文件的数据是在登录时提供到自定义的共享镜像中，以满足此用户的特定需求。此模式需要相当少的存储空间，因为每个用户的环境是从一个中央镜像生成的。针对特定用户的所有内容存储在一个差异文件中。一个包含着用户特定设置的数据库用于自定义镜像和生成自定义的内容，如计算机的安全标识符（Security Identifier，SID）、计算机的名称以及在活动目录环境中必须是唯一的其他的数据。
　　▲永久的克隆桌面　在用户首次登录的时候，生成一个个性化设置的克隆桌面；从此以后，每次他或她重新登录的时候用户都是依靠那个克隆桌面。这种模式只需要存储用户已登录而生成的自定义桌面镜像。
　　每种模式都有其自己的优点和其自己的缺点，但非永久性桌面往往是最受欢迎的，这是因为其最小的存储需求和其减少的更新管理开销。然而，集中式桌面虚拟化的关键是桌面中间件或者是在登录时使用户与特定的虚拟机——非永久性或永久的——相匹配的软件组件。中间件使得IT管理员能够动态地给每个用户分配自定义设置。没有这个中间件，IT管理员就需要手动管理此项分配工作，或者让用户连接到特定的计算机名称或IP地址。没有这个中间件，就不可能有非永久性虚拟桌面的概念。
　　多家供应商为集中式桌面虚拟化提供了解决方案，或者通常被称为VDI。市场上3家主要的中央桌面虚拟化供应商与服务器虚拟化的供应商是相同的。他们包括VMware、Microsoft和Citrix。VMware是首家提供VDI解决方案的组织——或者说是他们的客户，是他们开始使用服务器虚拟化技术来托管桌面。在看到集中桌面的潜在市场后，通过将其服务器虚拟化引擎与一个自定义桌面中间件进行基本结合，VMware创建了VDI解决方案。
　　通过将其所有的虚拟化解决方案结合在一起，Citrix也创建了一个VDI解决方案——XenDesktop。XenDesktop依靠XenServer虚拟化引擎，Citrix的表现层和应用程序虚拟化解决方案：Xe-nApp。它还使用Citrix的独立计算结构（Independent Computing Architecture，ICA）客户端改善最终用户的远程桌面体验。此外，XenDesktop可以与VMware和Microsoft的hypervisor一起使用，这使它成为一个很好的选择，无论你运行哪一种hypervisor。例如，Microsoft没有其自己的桌面中间件。因此，它要依靠Citrix XenDesktop解决方案，但这一次，是使用Windows Server 2008 Hyper-V虚拟化引擎作为后端。
　　如前所述，还有其他提供桌面中间件的公司，并由此得出桌面虚拟化解决方案。其中包括InstallFree、Quest和Desktone。
　　每个解决方案都有各自的优势。在你实施虚拟桌面解决方案之前，你必须仔细地选择。
　　10.4.1　VMware虚拟桌面管理器
　　大多数组织运行Windows作为其桌面基础架构。但这种情况正在改变，由于大多数VDI解决方案的目的是链接和集成Windows技术。这正是VMware的虚拟桌面管理器（Virtual DesktopManager，VDM）所做的事情。VMware VDM也可以称为VMware View，是一个在一对一的基础上为用户提供虚拟桌面自动配置的解决方案。它为每个用户创建一个虚拟机镜像。这些虚拟机可以是永久的或是非永久性的。在编写本书时，VDM是最受欢迎的集中式虚拟桌面解决方案，全球超过20000家客户正在依靠它。根据VMware所说，这些客户包括了100%财富100强公司。
　　VDM包括以下的功能和组件：
　　▼虚拟化后端是由VMware虚拟基础结构（Virtual Infrastructure，VI）中的ESX服务器或ESXi来提供。如果虚拟桌面需要高可用性，那么虚拟基础架构需要同时提供可扩展性和高可用性。它还提供了基于策略的资源管理，让系统根据需要将虚拟机迁移到适当的主机上，向它们提供所需的资源。
　　■后端管理是通过VirtualCenter来执行，这与你运行服务器虚拟化时是相同的。
　　■VDM为账户配置提供了与Microsoft的活动目录（AD）直接集成。请注意，AD集成不是可选项。为了运行VDI，你必须具有一个结构设计正确的现有的AD。请注意，VDI与你的AD集成不需要进行架构的更改。
　　■VDM可以依靠现有的用户账户和策略将桌面虚拟机分配给用户。如果需要双重身份验证，可以将VDM与RSA SecurID集成。VDM与AD结合提供了单点登录的解决方案，让最终用户访问VDM变得更加简单。他们只需要启动VDM客户端，登录AD，就可以获得他们自己特定的虚拟机。
　　■VMware的桌面中间件是虚拟桌面管理器，它为最终用户提供桌面配置。其最强大的功能之一是它能够充当每次用户重新连接时将用户重新链接到现有虚拟桌面的中间件。
　　■VDM的管理是通过一个Web界面来执行的。使用此界面，管理员可以从一个中央位置分配和部署桌面。他们还可以控制注销策略和配置规则。
　　■VDM提供了一个选项，可以在外围网络的虚拟机中部署虚拟桌面，让远程和旅行的用户访问桌面虚拟机。
　　■VDM依靠各种常见的终端连接到它们的VDM虚拟机。这些终端包括运行Windows操作系统的计算机——请注意，一个专用的客户端是必需的；瘦客户端设备；或者运行在Windows、Linux或Macintosh操作系统上的浏览器。
　　■VDM中的永久性桌面是从通用模板生成的。必须由管理员通过VDM界面手动为用户关联一个虚拟桌面。通过这种方式，每个用户获得一个专用的桌面。以后的每次连接，用户都会连接到同一个桌面上。
　　▲VDM中的非永久性的桌面也是从通用模板生成的；但是，每次使用后，每个孤立的桌面会返回到桌面虚拟机池中，因为每个桌面在注销的时候将恢复为其预定的状态，以备将来使用。如果想保留用户设置，你必须将它们存储到桌面虚拟机镜像以外。
　　正如你所见，整个VDM解决方案是由多个可移动的部件组成（见图10-7），但它可以为集中式虚拟桌面提供功能强大的基础架构。
　　表10-3概述了VMware提供的各种可用的VDI版本。如果你选择依靠VDM来部署集中式桌面虚拟化，请选择最适合你需要的版本。请注意，你可以使用入门套件，获得完整的捆绑软件包，或者只是将虚拟桌面管理器添加到一个现有的虚拟基础架构中。还请注意，因为ESX Server同时支持32位和64位的虚拟机，VDM可以让你运行你最喜欢桌面的x86或x64版本。
　　图10-7　VMware的虚拟桌面管理器
　　注意：要了解更多VMware VDM的详细信息，请访问www.vmware.com/products/vdi。
　　10.4.1.1　VDM与EMC Celerra一起运行
　　如先前所述，运行一个虚拟桌面基础结构需要一个集中式的共享存储解决方案。默认情况下，当你使用共享存储运行VDM时，它会为每个用户生成一个虚拟机，这需要消耗相当大的空间。但是，EMC——VMware总母公司提供了一种称为Celerra的特殊存储引擎，提供了特殊功能，其中包括除了其他的功能外，能够极大地减少虚拟桌面镜像所需的存储数量。使用Celerra的SnapSure功能允许你通过使用原始磁盘镜像的差异文件来生成虚拟桌面镜像的副本。每个差异文件只会占用正常镜像所需的一小部分空间。这种存储方法比传统的存储方法更有效。
　　你需要使用共享存储来运行VDM，这是因为它需要VMware的虚拟基础架构，共享存储是运行VI的必要条件，你应该认真考虑使用哪一种技术，如EMC的Celerra作为存储容器，或者至少使用一种包括类似于SnapSure功能的存储容器。要不然，你将最终要为每个虚拟桌面镜像存储数GB的文件。SnapSure可以节省磁盘空间，因此可以在磁盘驱动器方面节省相当大的成本，还为你提供VDM正常运作所需的所有功能。
　　注意：请记住，由于NetApp具有删除重复实时存储内容的能力，通过使用NetApp存储，你可以自动地获取此功能。因此，当使用相同操作系统的存储虚拟机时，NetApp存储容器可以降低高达40%的存储成本。
　　10.4.1.2　VMware View
　　2008年9月，VMware宣布了一个新的集中式桌面虚拟化蓝图，将传统的VDM产品基本上转换为一种可以让用户链接到一个单一的中央虚拟机，无论它们在什么位置，即使它们可能处于离线状态。VMware View是一套协同工作的工具组合，可以从任何设备或位置，甚至可以在离线方式下访问的标准桌面中，为用户提供一个所有他们的应用程序和数据的单一视图。
　　由于他们是第一家提供VDI的公司，所以VMware在这方面的优势使这个愿景在随后的几个月成为了现实。VMware开发了虚拟桌面管理器（Virtual Desktop Manager，VDM），让管理员创建桌面虚拟机（DVM），并通过活动目录将它们分配给用户。尽管事实上是他们首先向市场推出VDI的，但VMware的产品在某些关键领域中落后于其他的产品。例如，Citrix的XenDesktop具有从一个只读的核心虚拟机中创建桌面虚拟机的能力。所有的其他虚拟机是作为绑定到此虚拟机的差异文件来进行管理。当你考虑到每个桌面虚拟机（DVM）很容易就达到10 GB的大小，你很快就认识到XenDesktop在每台虚拟机占用其自己的空间方面比起VDM更有优势。由于这项功能，XenDesktop可以轻易地节省托管桌面虚拟机（DVM）所需的所有磁盘空间的50%以上或更多——而且这不是它超过VDM的唯一功能。然而，VMware的任意位置桌面的设想超越了每个桌面虚拟机（DVM）的差异文件。它还包括能够离线运行桌面虚拟机（DVM），今天即使有的话，也只是少数产品可以提供此功能。当前，集中式桌面虚拟化受到了基于服务器的计算，如终端服务，相同弱点的困扰：你必须已连线以访问该服务。要做到这一点，VMware集中推出了其相当强大的桌面虚拟化工具阵容，将它们与VDM连接起来为用户创建一个无缝的桌面虚拟机（DVM）体验。VMware View允许用户依靠任何的设备——运行Windows或Macintosh操作系统的标准台式机或笔记本电脑、Web浏览器、公共计算机、瘦计算设备或者甚至是手机，如iPhone——访问它们的桌面虚拟机（DVM）。此外，用户能够在可移动设备，如USB记忆棒中携带他们的桌面虚拟机（DVM），或者在他们的笔记本电脑上离线运行它们。更好的是，用户能够进行离线修改他们的桌面虚拟机（DVM），一旦它们重新连接，它们自动地与它们的集中式桌面虚拟机（DVM）进行同步。
　　VMware一直保持全面的桌面虚拟化产品线，因此具有在相当短的时间内将梦想变成现实的能力。为了让VMware View能实现广告所述的工作，VMware不得不推出多项不同的创新，将它们与他们现有的桌面虚拟化产品连接起来（见图10-8）。
　　图10-8　VMware View允许用户从任何位置来访问他们的桌面虚拟机（DVM），甚至以离线方式来使用它们。不以粗体显示的项目现在已是VMware View所包含功能的一部分
　　首先，VMware需要工具以支持从任何地方访问DVM；但是，它已经拥有了其中的几个。VMware的虚拟桌面基础架构包括了虚拟桌面管理器，这是一个DVM中间件并将DVM分配给每个用户。VMware Workstation是VMware的旗舰桌面虚拟化引擎，通过其Unity功能可以在不接触虚拟桌面本身的情况下体验桌面虚拟机中包含的应用程序。这为用户提供了一个无缝的交互操作，让他们更容易使用虚拟机。然而，VMware依靠VMware Player——一个免费的虚拟机执行引擎，通过Web浏览器在Windows桌面上或Windows笔记本电脑上运行离线的DVM。VMware ACE已经可以让用户在USB记忆棒上携带其DVM。VMware Fusion让你在Macintosh操作系统上运行DVM。因此，VMware在这个级别上已经准备好了。
　　其次，VMware需要改善在终端设备上的DVM图形性能。为此，VMware已宣布它将与制造商Teradici合作，进一步发展Teradici的PC-over-IP协议，替换默认内置于Windows的远程桌面协议（Remote Desktop Protocol，RDP），改进图形控制。重申一遍，Citrix的独立计算结构（Independent Computing Architecture，ICA）在这方面比VMware略胜一筹，ICA是一种比Microsoft的RDP有着极大改进的远程协议。Microsoft还在努力改善RDP的图形性能。
　　尽管如此，VMware通过VMware View、通过额外的几个组件，现在重新确立了VDI的优势地位。
　　▼能够在个人数字助理（Personal digital assistant，PDA）如iPhone或者Windows Mobile设备上运行DVM。这将需要一个新的虚拟机播放器或者VMware计划的自定义远程桌面协议。
　　■一种更佳的远程桌面协议的集成，它将作为核心实用程序安装在台式机和远程设备中。VMware已宣布它与Teradici进行合作，集成其PC-over-IP协议以满足这一需要，但这并不是它在这一级别的唯一的改进。VMware还与Wyse Technology合作——瘦客户端的制造商——准许通过Wyse的TCX MMR软件改善远程多媒体的体验，增加对多屏显示的支持。这2个软件产品在终端设备上运行，因此将不会影响后端服务器的性能，同时改善了最终用户的体验。这些软件产品将同时适用于瘦客户端和完整的PC。总体而言，VMware将提供多协议的支持，让用户在默认的Microsoft RDP、Teradici PC-over-IP、Wyse的产品，或者来自HP和Sun的其他协议当中进行选择。
　　■离线运行桌面的能力，允许用户从中央数据中心存储中登记后取走一个虚拟桌面，并离线运行它，当虚拟桌面重新连接到数据中心时，对它进行最终的核对。
　　■能够以数据流方式将DVM保存到离线容器，如笔记本电脑中。此外，能够以数据流方式将虚拟应用程序分发到非永久性桌面中。流式桌面和应用程序像流媒体视频一样：你只需要一个核心的信息量——有时不超过10%——就能够开始使用此工具，可以节省带宽和支持按需提供应用程序的概念。VMware现在已通过Offline Desktop（离线桌面）做到这一点。Symantec也通过其软件虚拟化解决方案（Software Virtualization Solution，SVS）专业产品提供了应用程序虚拟化，它通过收购AppStream，获得了市场上最好的流处理引擎之一。AppStream能够以数据流方式分发桌面和应用程序，但到目前为止Symantec还没有在其产品中使用这个组件。
　　■能够从一个中央只读DVM镜像中创建差异DVM，并根据用户的需求来提供它们。目前，XenDesktop可以按照用户的预期需求预生成非永久性的DVM。例如，如果你有500个用户在上午8点至9点之间登录，XenDesktop可以确保预先创建好所有所需的DVM，以增加系统响应用户需求的速度。VMware具有作为中间件的VDM，现在使用VMware Composer作为差异引擎和提供工具。
　　■能够虚拟化用户配置文件以支持非永久性桌面和捕获用户的更改。不过，这可以通过基本的Windows技术，如漫游配置文件和文件夹重定向来完成，因此对第三方工具没有迫切的需要。Microsoft通过在Windows中嵌入这种能力，首家发明了配置文件虚拟化，通过将数据缓存在本地设备中提供了支持离线这一能力。通过桌面虚拟化，配置文件虚拟化有了新的意义，成为VDI解决方案的核心部分。
　　VMware在做出其最初的产品公告的3个月内交付了VMware View。支持数百个或者甚至数千个DVM从一个单一核心镜像上运行；在有需要时，只需对一个单一镜像进行更新和修改；你可以在任何时间从任何位置访问这个镜像；捕获和保护所有你的在线和离线的更改；基本上将用户捆绑到一个单一的桌面镜像是集中式桌面虚拟化的正确方向。VMware View有2个可用的版本。企业版提供了类似于VDM的功能。专业版包括了在真正的DVM解决方案中所需的所有工具。
　　注意：要观看VDM的运行视频，请访问http://blogs.vmware.com/vmtn/2008/02/bring-on-the-vd.html。
　　10.4.2　Citrix XenDesktop
　　正如先前所提到的，Citrix也提供了一种集中式桌面虚拟化解决方案——XenDesktop。Citrix XenDesktop是一种根据需要为用户提供虚拟桌面预置的解决方案。默认情况下，它依靠一个单一的基本镜像，与VMware VDI和EMC Celerra存储区域网络的组合或者VMware View非常相像。所有桌面软件都是通过软件从一个单一镜像中提供，在核心镜像的基础上运行，无论你使用了哪一种共享存储容器。此核心镜像在任何时候都不会重复。仅这个功能就可以节约40%的存储空间，这是一个相当大的节约，往往可以抵消XenDesktop解决方案的原始成本。
　　XenDesktop是由XenServer服务器虚拟化引擎的功能与Citrix的XenApp交付机制的功能，以及从收购Ardence获得的功能集组合而成的。Ardence提供了从核心桌面镜像生成差异文件所需的技术。这个技术现在允许XenDesktop依靠一个数据库来自动重定向对关键PC项目的注册表查询，如计算机名称、活动目录的域相对ID（RID）等。此方法允许XenDesktop基于一个单一镜像管理成百上千个差异镜像。
　　这是一个关键的功能，因为通常你需要通过系统准备工具（SysPrep.exe）自定义每个PC的镜像。SysPrep将自动清除Windows PC镜像的个性化设置，以便它可以根据需要复制许多次。当打开此PC镜像时，SysPrep过程会自动对镜像重新进行个性化设置，为它提供正确的SID、RID、计算机名称等等。当你使用XenDesktop时，你不需要执行这个任务；然而，你需要创建一个参照计算机镜像，并依照你组织的标准将其准备好。然后，通过你的黄金镜像创建第2个读副本，而不是对通过SysPrep生成的源镜像进行移除个性化设置。第2个读副本接着将成为由XenDesktop使用的核心镜像。它保持在只读模式下。当用户退出时，捕获用户的更改和自定义设置到差异文件中，要么丢弃（无状态的PC镜像），或有到个人用户文件中（有状态的PC镜像）。差异文件是只捕获针对核心镜像所做更改的块级文件。
　　这是最令人印象深刻的XenDesktop的功能之一。然而，因为XenDesktop来自于Citrix，并且Citrix在远程Windows计算方面具有多年的经验，所以XenDesktop还在远程桌面交付方面提供了改善，因为它是依靠Citrix的ICA协议，而不是Microsoft的RDP协议。ICA比RDP有了相当大的改善，特别是在图形渲染方面，这使得最终用户的体验可以更丰富、更逼真。XenD-esktop中的这套技术被称为SpeedScreen。
　　注意：要查看RDP和ICA之间的体验区别，可以在YouTube上观看演示。www.youtube.com/watch？v=＿RMTM7vaMnI。
　　传统上，XenDesktop将需要XenServer作为后端，而XenDesktop——则担当桌面分发控制器或者桌面镜像提供引擎——需要XenApp分发服务器通过ICA协议提供远程桌面连接到桌面镜像（见图10-9）。但是，因为XenDesktop的某部分是来自Ardence收购，Ardence最初支持VMware ESX Server，因此它还支持完整的VMware后端。此外，由于Citrix与Microsoft是强有力的伙伴关系，XenDesktop已经进行了调整以支持Windows Server 2008 Hyper-V后端。这意味着你可以与任何主要的服务器虚拟化引擎一起使用XenDesktop解决方案。这对于每个组织都是一个好消息，因为服务器虚拟化的早期使用者很多已经同时拥有Citrix Presentation Server（现已被命名为XenApp）和VMware ESX Server或Microsoft Virtual Server的技术。由于他们已具有一个服务器虚拟化基础架构，并他们已经拥有Citrix产品，添加XenDesktop通常是一个低成本的解决方案。
　　图10-9　Citrix XenDesktop解决方案的组件
　　XenDesktop具有多个版本，每个版本包含了其自己的功能集。表10-4列出了这些版本以及它们所包含的功能集。正如你所见，由于Citrix在表现层虚拟化（PresentV）方面具有丰富的经验，所以其PresentV的许多功能已被包含到每个XenDesktop版本中。其中一个版本甚至包括了Citrix EasyCall——一种将电话通信与应用程序集成的功能，它源自Citrix收购XenSource和Ardence的之前的原始的Presentation Server。
　　XenDesktops可以是永久的或共用的。永久桌面保留由每个用户生成的差异信息。每次他或她重新连接时，用户会被连接到这个特定的差异文件。共用镜像就是无状态的镜像，每次用户注销，会被重置为标准的状态。显然，共用镜像占用更少的存储空间。每种镜像模式，永久的与共用的，适用于不同的用户类型。永久镜像将最有可能适用于永久的用户，而共用镜像最适合临时或基于任务的不需要保留自定义设置和偏好的员工。共用的或永久的镜像可以是桌面操作系统的x86或x64版本，因为它们都受到虚拟化引擎的支持——VMware ESX Server、Citrix XenServer或Microsoft Hyper-V——同时支持32位和64位的虚拟机。
　　由于每个镜像是基于中央核心桌面并在登录时生成的，你可能认为当用户在第一次试图通过登录来激活它时，它需要花一些时间来建立镜像。它确实需要花费一些时间，特别是如果有数千个用户在同一时间登录时，即使差异文件是一个小文件。但是，Citrix通过镜像预配置解决了这个问题。XenDesktop允许管理员设置在用户开始登录之前将预先生成镜像的镜像生成策略。例如，考虑以下几种情况。组织A有3个主要的办公室。办公室A是在纽约并包含了500个用户。办公室B是在盐湖城并包含了200个用户。办公室C是在旧金山并包含了400个用户。每天的早上，用户在上午7：00至9：00之间登录；但是，因为每个办公室是处于不同的时区，后端主机服务器上的负载会稍微减弱。
　　通过使用预生成策略，在组织A的管理员可以在用户开始登录之前提前获得XenDesktop生成的镜像。此策略在东部时间上午6：30在纽约生成500个虚拟机，在山地时间上午6：30（2个小时后）生成200个虚拟机，在太平洋时间上午6：30生成400个虚拟机（1个小时后）。虽然这种情况有点不现实，因为没有人会在西海岸的早上7：00开始工作，但它说明了预配置以及XenDesktop策略的能力。通过XenDesktop的广域网（WAN）加速功能，所有的桌面可以驻留在纽约的数据中心，但所有的用户仍然可以具有一个丰富的虚拟桌面体验。
　　注意：要了解关于XenDesktop的详细信息，请访问www.citrix.com/english/ps2/products/product.asp？contentID=163057。观看VMware VDI与Citrix XenDesktop的视频，请访问www.youtube.com/watch？v=J＿i＿EpZHMLc & feature=related。
　　10.4.3　其他的技术
　　如先前所提到的，Citrix和VMware不是唯一提供集中式桌面虚拟化产品的厂商。InstallFree、Quest和Desktone也提供了类似的产品。在这3家厂商之中，只有InstallFree提供了一种管理其自己PC镜像的技术。Quest与Desktone对于其他的虚拟化技术确实只提供了前端的产品。
　　10.4.3.1　The InstallFree Desktop
　　InstallFree使用了一个自定义的引擎，可以生成一个基于本地计算机的资源上运行的迷你桌面。此技术依靠InstallFree的应用程序虚拟化引擎，但不是从操作系统上生成分离的应用程序，而是将这些应用程序封装到迷你桌面内，使它们就像是在真正的桌面上运行。InstallFree Virtual（IFV）通过活动目录对桌面进行集中控制，但因为它们是在本地进行处理，依靠PC自己的资源，所以它们在在线和离线状态下都可以使用。因为它们是基于IFV应用程序虚拟化引擎，它们并不是真正的虚拟机，因此在后端并不需要一个虚拟化引擎。可以运行Windows的x86或x64版本的虚拟机；但是，为了运行x64版本，在主机或者物理桌面上的操作系统必须是一个x64操作系统。
　　InstallFree应用程序虚拟化引擎是一个可以在任何系统上加载的可执行文件，无论你是否具有管理权限，因为它是运行在主机操作系统的用户模式下，而不是内核模式。这意味着你可以在便携式USB记忆棒中携带虚拟桌面，并将其插入几乎所有的PC中，甚至是一台锁定的公用电脑。这为你在组织的内部和外部提供了很大的灵活性。即使它们不是基于传统的虚拟化引擎，IFV桌面镜像的显示和操作与传统的PC镜像是一样的。它们可以被本地化、个性化，甚至为保护内容而进行加密。
　　用户数据是存储在桌面外部的一个加密文件中，以便它在任何时候都可以受到保护。应用程序必须使用IFV引擎进行虚拟化，必须提前做好准备。InstallFree Desktop是当前提供虚拟桌面离线支持的唯一解决方案，但它的准备需要全部使用InstallFree的解决方案。更多关于这一主题的内容将会在下一章我们讨论应用程序虚拟化的时候进行讨论。无论如何，如果你同时需要在线和离线访问虚拟桌面，也许InstallFree是最能满足你的需求的解决方案。
　　注意：要了解更多关于InstallFree Desktop的详细信息，请访问www.installfree.com/pageload.aspx？page=products＿InstallFree＿Desktop.html。
　　10.4.3.2　Desktone的桌面即服务
　　Desktone是独一无二的，因为他们同时为企业和服务提供者提供虚拟桌面配置，因此取名为桌面即服务（Desktop As A Service，DAAS）。企业供应商可以管理他们自己内部的虚拟桌面，但不需要使用一个完整的数据中心基础架构，因为整个服务器虚拟化基础架构是托管在一个异地的数据中心中，由一个运行DAAS的桌面服务提供商（DSP）拥有并管理。这使所有规模的组织都可以访问虚拟桌面，允许他们降低它们的成本，因为它们不需要拥有支持桌面虚拟化的设备。
　　DAAS依靠2个关键的组件：Virtual-D Platform（虚拟—D平台）和Desktone Access Fabric（Desktone访问结构）。Access Fabric是连接用户与他们自己特定桌面的桌面中间件。它旨在基于策略、用户权利、接入点以及数据中心的可用资源，提供一个“最合适”的桌面给每个用户。此基础架构链接到现有的活动目录，让你可以完全控制桌面的分发和分配。
　　后端已完全从数据中心中移除，并托管在DSP的中心。这使得更易于部署和运行虚拟桌面基础架构，因为你不需要实施服务器虚拟化组件——主机服务器、共享存储以及更多——托管虚拟桌面镜像所需的组件。这是一种新颖的方法，很可能可以满足你的需要，如果你不想和还没有实施服务器虚拟化。
　　根据Desktone所述，他们的解决方案可以更容易实现，因为你不需要担心后端主机环境。你甚至不需要知道它正运行在哪一种虚拟化引擎上。你所该做的就是与DSP衔接起来，并开始虚拟化你的桌面。在写作本书的时候，Desktone拥有2个DSP伙伴：IBM和HP。经过一段时间后相信会有越来越多。
　　如果运行VDI，但不想带来实施主机服务器基础结构的麻烦，Desktone可能是最佳的解决方案。
　　注意：要了解更多Desktone DAAS的详细信息，请访问www.desktone.com。
　　10.4.3.3　Quest的Provision Networks虚拟访问套件
　　Quest Software也通过收购Provision Networks提供了一套VDI工具。新的虚拟访问套件（Quest Virtual Access Suite，VAS）是一个提供VDI的桌面中间件，独立于你运行的后端服务器虚拟化引擎。在编写本书的时候，VAS已支持VMware、Citrix、Microsoft、Virtual Iron和Parallels的虚拟化引擎，让你可以使用任何你可能已经准备就绪的引擎。VAS是由4个核心产品和功能组成的。
　　▼虚拟访问中间件，通过与内部活动目录进行链接，将用户与虚拟桌面连接起来。
　　■访问基础架构，这是指管道，即允许终端如桌面PC或瘦客户端通过一个Web界面与虚拟桌面连接起来。
　　■增强最终用户体验和最后一米功能（Last-Mile feature），旨在为虚拟桌面的用户提供丰富的图形体验。
　　▼终端计算机，这是通过Web界面将最终用户的需求与应用程序和数据连接起来的组件。这些工具组成了Quest的VAS，并提供了一个完整的VDI实施解决方案。当然，你必须已准备好服务器虚拟化基础架构。如果你需要一个独立的VDI解决方案，也许Quest VAS就是你想要的解决方案。
　　注意：要了解更多Quest VAS的详细信息，请访问www.provisionnetworks.com/solutions/vas/vas.aspx。
　　



　　10.5　从VDI中获益
　　正如你所见，当使用分布式桌面的时候，虚拟桌面基础架构提供了很多简化桌面管理的方式，减少了你面临的各种问题。桌面可以迅速地和可靠地交付到任何已连接的位置。你可以控制连接到虚拟机的设备，因此控制数据的管理并可以减少知识产权的潜在损失。你可以显著地减少每个桌面的成本，有时候可以多达40%。你可以减少要管理的镜像数量，尤其是当你使用非永久性的PC镜像时。虚拟机可以更容易地安装补丁和更新，因为你通常只有一个核心镜像需要进行更新。
　　基本上，VDI改变了桌面的生命周期，减少了它的组件（见图10-10）。传统上，你必须取得、生成镜像、进行安全设置、部署，然后监控、维护、备份以及最终回收你的物理桌面。通过VDI，你只需要通过创建一个参照计算机来生成原始的镜像，使用它作为所有系统的核心镜像，对它进行个性化设置（这通常由VDI引擎来执行），然后监控和更新它。当用户注销时，镜像会由桌面中间件自动回收。
　　图10-10　传统的PC生命周期与VDI的生命周期
　　然而，使用诸如XenDesktop和其他的技术是否会在PC镜像的构建和管理方面带来挑战？理想情况下，组织将需要一个单一的PC镜像，如较早前在讨论PASS系统构建模型时所述的那样。使用一个单一的镜像以满足每个用户的需求，这意味着你需要制订一个系统，可以在登录时自动提供镜像以及所需的应用程序和用户数据。要做到这一点，最好的办法是依靠应用程序虚拟化（在第11章介绍）以及用户配置文件保护机制（在第12章介绍）。用户配置文件数据绝对必须存储在PC镜像的外部，如果它要受到保护。XenDesktop在本书编写的时候并没有提供此功能，但Citrix显然打算在将来的某个时候提供它。然而，Windows已经通过漫游配置文件和文件夹重定向提供了一种配置文件保护机制。
　　应用程序的提供则更为复杂，因为它需要能够在他们需要应用程序时，为最终用户提供他们所需的应用程序。使用传统的应用程序交付方法将不再可行，因为它们需要时间来安装和部署。如果这是你所使用的方法，那么你的用户将会对VDI感到非常不满，因为他们在登录的时候需要为将他们所需的应用程序连接到桌面镜像等待很长一段时间。这就是为什么VDI不能独立工作的原因。它绝对必须与应用程序虚拟化进行绑定，才能发挥它的效用。当你在准备和选择你的桌面虚拟化解决方案时，请记住这一点。
　　10.5.1　主要供应商的定位
　　正如你所看到的，有多种桌面虚拟化解决方案。重申一遍，3家主要的供应商提供了类似的解决方案，但每一家都有一些独特的功能。此外，也有第三方的解决方案，有时提供完全不同的方法来解决问题。其中，InstallFree是最具创新性的，因为它们不需要使用后端虚拟化引擎。如果你没有或不打算实施服务器虚拟化解决方案，这可能是正确的选择。但是，在未来数年中，没有服务器虚拟化解决方案的组织将是罕见的和少数的。Microsoft通过其终端服务功能提供了表现层虚拟化。Citrix提供了强大的企业桌面虚拟化，可以在任何的后端平台上运行。VMware有最成熟的解决方案，特别是因为VMware View现已提供。当你选择一个解决方案时，请考虑这些选项。
　　10.5.2　制定桌面虚拟化的决策
　　请记住，有多种不同的桌面虚拟化解决方案。在你确定虚拟化桌面的决策时，你应该首先考虑业务的需要，然后才是你将会应用于此问题的解决方案（见图10-11）。如果你需要运行可共享的应用程序，或许最好的解决方案就是实施表现层虚拟化，许多组织已经部署了一些解决方案。如果你想要确保安全和集中数据，就选择一个虚拟桌面基础架构。如果你的用户需要能够离线访问虚拟桌面，就选择一种安全和加密的解决方案，让虚拟机运行在他们自己的桌面上。
　　图10-11　桌面虚拟化决策过程
　　请记住，无论如何，VDI和桌面虚拟化往往不能独立地工作，需要额外的组件，这些组件会在未来的章节中介绍。VDI是一种功能强大的解决方案，减少了桌面管理成本，是动态数据中心的一部分。重申一遍，你会发现在你实施和使用这一解决方案的时候，你将可以学到更多。
　　



　　第11章　使用应用程序虚拟化
　　分布式系统管理最严格的方面是软件资产管理——在组织中科学地编号、封装、部署和维护软件资产。基于组织的规模，在网络中可能会有几十个到几百个应用程序在运行中。封装和测试每个应用程序，确保它们可以正常地与在同一个目标系统上的其他应用程序共存是管理员面临的最大任务之一。更糟的是，你每次更改操作系统，这项任务必须重复地执行，这使其成为IT现今最繁重的任务之一。
　　传统上，组织管理通过分层的方法来管理终端，首先建立操作系统，再应用核心操作系统实用程序，如磁盘碎片整理、反垃圾邮件和防病毒工具，以及必须在组织中的每个系统上应用的其他核心组件。一旦核心操作系统准备就绪，应用程序也需要分层来部署。第一个应用程序层涉及组织中每个人都需要的应用程序——工具如Office、图像查看器、数据库引擎和更多。第二层涉及专用的应用程序，其中涉及用户在组织内执行的特定功能：平面设计师需要高级的图形工具，应用程序开发人员需要应用程序构建工具，财务用户需要自定义的财产管理工具等。由于这些用户的功能不是在整个组织内广泛使用，因此第二层仅需部署到特定的计算机群组中。最后，最后一个应用程序层是在特定的基础上部署不同用户所需的高度专用的工具。这正是在第10章中所概述的安全服务访问点（Point of Access for Secure Services，PASS）系统构建模型的结构。
　　必须通过这种方式对应用程序进行分类，以避免冲突和减少应用程序管理及支持的开销。但在今天，由于虚拟化技术的出现，有了更好的方法。
　　



　　11.1　应用程序管理问题
　　Windows的基本结构也是管理员面对很多应用程序的麻烦的原因。Windows是应用程序操作的基础。功能如应用程序的信息交换、应用程序交互操作、打印、图形显示、通信及更多全部都嵌入到核心操作系统中。应用程序开发人员不需要将这些功能编程到他们的应用程序中，只需学会在需要的时候调用它们。但是，开发人员通常要学习他们访问的核心组件，在Windows内的动态链接库（Dynamic Linked Library，DLL），是定期更改的。有时候这些更改会令他们的调用不再起作用。为了保护应用程序的操作，开发人员往往将Windows DLL集成到该应用程序的安装中，有时候需要在目标计算机上替换较新的组件。被替换的DLL将只能用于他们的应用程序，但将不再适用于其他的应用程序，这会导致他们原来的应用程序发生中断。
　　DLL冲突是所有系统管理员的痛苦之源，通常被称为DLL Hell（DLL地狱）。DLL是所有可执行文件的核心。当应用程序制造商决定在其应用程序中包含共享组件时，这些冲突就会出现。为此，应用程序管理员已经学会了管理应用程序的最佳方法是检查他们安装的每个组件，并将它们与系统上所有的其他组件进行比较，以避免和主动修复冲突。但若要减少这种应用程序管理的开销，管理员应该对该对应用程序进行分类，并确保尽可能少的应用程序可以同时共存于一个系统上。
　　为此，组织必须管理多个应用程序类别：新发布的商业应用程序、遗留的商业应用程序和已更新的或者新的定制应用程序——内部开发的应用程序、遗留的定制应用程序和定制的商业应用程序（用于制造）。遗留的应用程序最有可能会受到DLL Hell的影响，而新的应用程序会受到其他潜在冲突类型的影响。所有这些应用程序都必须进行管理。
　　11.1.1　传统的应用程序管理解决方案
　　DLL Hell导致管理员和开发人员要想出各种方法来解决应用程序管理的麻烦。首先，他们花时间来确定并将应用程序融入到一个生命周期中。然后，他们依靠此生命周期来使用Windows Installer服务——一个Microsoft已集成到Windows中的服务以帮助标准化应用程序的安装。另一个解决方案是在服务器上安装应用程序，通过基于服务器的计算机（虚拟机）或表现层虚拟化将它们提供给用户。但是，每种方法都有它自己的问题，并且都不是一个完美的解决方案。
　　11.1.1.1　依靠应用程序生命周期
　　所有的应用程序，无论他们的类别，都会有一个生命周期，并且组织必须对应用程序的整个生命周期进行管理（见图11-1）。生命周期包括4个阶段。第一阶段涉及应用程序的获取，或者如果应用程序是内部开发的，首先考虑应用程序的必需条件和应用程序的需要。第二阶段涉及实施。在这个阶段执行了大部分针对DLL Hell的主动预防性工作，为部署应用程序做好准备。第三阶段涉及应用程序的维护以及最后一个阶段涉及应用程序的退役。不幸的是，这最后一项动作很少执行，正如组织没有从系统中移除过时的应用程序——每个人都持着“你永远不知道移除哪一个应用程序可能会破坏稳定”的态度——宁愿定期重新镜像系统。
　　图11-1　传统的应用程序生命周期
　　11.1.1.2　使用Windows Installer
　　为了帮助组织对应用程序的整个生命周期进行妥善的管理，为了在Windows中帮助标准化应用程序的安装，Microsoft开发了Windows Installer服务（WIS）。WIS是一个通过使用一个一致性的数据库来支持软件安装的工具。每个产品都有它自己的一致性数据库。这个数据库用于提供全面的应用程序安装支持功能。如自我修复、应用程序安装监控、应用程序安装失败的回滚以及更多，所有这些功能都是WIS功能集的一部分。然而，了解和使用WIS本身也是一门艺术。
　　注意：有关Windows Installer服务及其内部工作情况的全面信息，可以从www.resonet.com/articles.asp？m=8#p下载标题为Working with Windows Installer（使用Windows Installer）的免费白皮书。
　　要正确地管理Windows Installer，系统管理员需要将应用程序封装为MSI格式。要做到这一点，他们可以依靠商业工具，如Altiris Wise Package Studio或者源自Acresso Software的InstallShield AdminStudio。WIS的目的是消除应用程序安装造成的DLL冲突，但它并不能解决所有的问题，因为其他的冲突继续存在。这就是为什么应用程序冲突检测仍有必要，甚至要检测MSI软件包。冲突检测应该包括以下项目（见图11-2）：
　　图11-2　MSI冲突检测是必需的，即使你使用如PASS模型这样的系统堆栈
　　▼产品组件
　　■产品文件
　　■注册表项
　　■快捷方式和INI文件
　　■开放数据库互联（Open Database Connectivity，ODBC）资源
　　■NT服务
　　■文件扩展名
　　■产品属性
　　▲操作系统内核驱动程序
　　以上每个项目都是WIS标准的一部分，但当应用程序在没有经过检验的情况下就进行部署，那么每个组件都可能是造成问题的原因，有时候你可以通过创建自动化应用程序部署来修复这些在MSI内的项目。
　　尽管Microsoft已经改善了Windows各种版本的WIS，但仍然存在一些问题。例如，如果你正考虑迁移到Windows Vista，那么你将需要使用Windows Installer 4.5。当安装需要它时，Vista依靠Restart Manager（重启管理器）来停止和重启应用程序。此外，Windows Installer已与User Account Control（用户账户控制）集成，应用程序可以利用提升的特权自动地安装，它们存储在Windows的HKEY＿Local＿Machine注册表配置单元中，等同于通过WIS命令接口：msiexec.exe使用ALLUSERS=1的属性。此外，如果你是在标准用户模式下支持应用程序的修补，那么应用程序与WIS 4.5集成必须进行数字签名。由于在Windows Vista中具有新的Windows资源保护功能，如果有系统文件包含在软件安装包中，Windows Installer将会跳过系统文件的安装，在继续安装之前会记录一项条目到日志文件中。
　　11.1.1.3　使用应用程序封装过程
　　使用WIS，尽管它确实解决了一些遗留的安装问题，但也意味着要使用一个全面的应用程序准备过程（见图11-3）。这个过程是由5个特殊的步骤组成的，可以由技术人员团队以类似于制造的过程来执行。每个团队成员执行一项任务，并通过此工作流将软件包交给另一位成员。
　　第一步集中在请求管理。如果你的组织关注减少是应用程序管理问题，那么这一步将包括一个合理化策略，以确保只将绝对必要的应用程序引入到系统中。
　　第二步准备产品集成和开始应用程序分析过程。应用程序的必要条件是什么？它是否会与其他应用集成？其安装过程是怎样的？在创建软件包之前，这些都是这个步骤打算要回答的问题，并准备进入下一个阶段。
　　第三步测试初始的软件包，以确保它工作正常，并已经与组织的安全和其他标准进行了集成。以封装的自动化结束这一步。
　　第四步执行对封装的质量保证（Quality Assurance，QA），同时测试远程和交互式安装，确认冲突是否继续存在，确认该软件包是否可以在无剩余问题的情况下在目标系统上被移除。
　　一旦软件包已经通过了QA测试，它就进入到发布管理，然后是为部署做好准备。此软件包进行了完整的记录，并与你网络中的软件存储库集成在一起。然后，将它部署到所有的目标系统中。
　　图11-3　使用软件封装过程
　　正如你所见，虽然WIS确实可以帮助保护系统，但准备MSI软件包是一种需要规划和慎选的综合性任务。
　　11.1.1.4　使用表现层虚拟化
　　当软件包采用MSI格式时，它们通常是通过传统的电子软件分发（Electronic Software Distribution ESD）系统部署到所有目标计算机上。例如，若要部署Office，组织常常通过单播通信发送超过500 MB的数据到数以百计的分布式PC中。然后，一旦Office安装到每个分布式节点上，这些组织必须管理它的更新并维护它的整个生命周期。
　　这种部署可能会导致大量的问题。首先，部署所需的带宽是巨大的，正如实际执行部署所需的时间窗口一样。然后，由于许多组织已对他们的用户授予本地管理权限，所以他们以原始状态部署的应用程序经常被修改得面目全非，导致了更多的问题。此外，本地磁盘驱动器故障和系统需要进行重镜像。需要部署服务包以维护Office，这些服务包有时候会比原来的部署更大。
　　由于这些问题，许多组织都已迁移到基于服务器的计算机或表现层虚拟化（PresentV）。PresentV是依靠在多个用户间之间共享的基于服务器的安装。这个策略提供了很多的优点。
　　▼由于软件是安装在服务器上，因此只有少数可能发生冲突的位置。这减少了冲突管理的开销。
　　■也只有少数位置需要更新和维护。
　　■但你仍需使用MSI，尽量维持WIS的优势。但是，这些应用程序必须在共享模式下安装。
　　▲如果你依靠的是Windows Server内置的PresentV功能，特别是Windows Server 2008（WS08），那么不需要额外的商业系统就可以使用PresentV。WS08已能够逐个发布基于服务器的应用程序，向最终用户提供完全透明的体验。
　　Windows依靠远程桌面协议（Remote Desktop Protocol，RDP）来提供对这些远程应用程序的访问。在WS08之前，Microsoft的终端服务为用户提供访问一个完整的远程桌面，这可能会造成混乱。为此，许多组织选择实施Citrix的远程应用程序解决方案，当时称为Presentation Server（演示服务器）。Presentation Server提供了对应用程序一对一的访问，使它们看起来就如同他们确实是安装在桌面上。Citrix后来已将Presentation Server的名称更新为XenApp；然而，并非所有的客户都选择升级到这个版本。
　　在WS08中，Microsoft已经集成了相同或类似的功能，可以只发布应用程序。然而，即使有了这种改善，基于服务器的计算机仍然存在问题。
　　▼当移动用户在路上时，他们访问不到集中式应用程序。
　　■基于服务器的计算机仅适用于已连接的系统。已断开连接的系统访问不到远程的应用程序。
　　▲基于服务器的计算机，需要强大的服务器配置和大型的服务器群，以实现应用程序的高可用性。
　　由于应用程序是共享的并且同时有多个用户远程访问它们，所以托管它们的服务器必须具有强大的处理能力，这种配置的主机服务器通常保留用于运行hypervisor。
　　正如你所见，传统的应用程序管理，无论是在分布式系统上或者是在远程服务器上，仍然可能造成很多的问题，特别是如果它没有正确地部署它们。
　　



　　11.2　重新设计应用程序管理
　　幸运的是，随着虚拟化技术的引入，现在有一种更好的方式来管理应用程序，均匀分布的应用程序：应用程序虚拟化（AppV）。应用程序虚拟化通过移除所有的应用程序冲突的可能性，通过将它转变成拉取而不是推送机制，改变了传统应用程序管理过程。使用适当的AppV技术，你的用户将可以在需要使用它们的时候才请求应用程序，你将不再需要预先部署设备。这些只是AppV提供的其中2个主要优势。
　　11.2.1　使用虚拟化层
　　虽然应用程序虚拟化是在前几年推出的，但它至今仍然没有成为主流。组织继续专注于传统的软件管理和安装程序，建立WIS软件包并依靠ESD系统将这些软件包部署到终端。但今天，随着虚拟化成为世界各地数据中心管理策略的一个核心部分，应用程序虚拟化也正在走向舞台的中心，因为系统管理员开始认识到它为分布式系统管理带来了强大的优势。
　　这是因为AppV提供了尽管实际上操作系统运行了大量的软件包，但仍保持为一个原始的操作系统的能力。对于所有的组织和管理员这无疑是一个福音，各地都开始寄希望于此功能从而可以显著地减少应用程序管理和支持的成本。
　　基本上，应用程序虚拟化创建了一个围绕操作系统的保护层来保护它，防止通过实际安装一个应用程序做出的任何更改。AppV的核心理念不是捕获一个软件的安装，例如当为Windows Installer服务封装安装时，AppV捕获应用程序的运行状态。正是这种运行状态然后将它“安装”到目标系统上，但由于它只是一个运行的状态，并不是一个实际的安装，因此并没有对操作系统进行任何的更改，当然，除了驻留在其上面的新文件。
　　应用程序虚拟化层将这个运行状态转换为操作系统和其他应用程序可以理解和交流的指令，始终保持核心操作系统为原始状态，并且以这种方式包含应用程序的组件，这样它们可以永远不会与其他应用程序发生冲突。传统的应用程序安装会渗入操作系统并更改它的配置，但AppV保护操作系统不会受到任何的修改（见图11-4）。
　　图11-4　AppV创建一个保护层以保护操作系统免受更改
　　AppV通过保护操作系统免受文件系统和注册表的更改，彻底地将应用程序与操作系统的文件系统和注册表以及其他应用程序隔离开来。但此应用程序将保持与操作系统和其他应用程序正常地交流。因此，AppV允许应用程序的不同版本无冲突地彼此共存在同一系统上。AppV完全支持能够运行众所周知会发生冲突的应用程序，如Microsoft Access 97、Access XP，Access 2003和Access 2007同时在同一系统上运行，然后甚至让你可以从一个应用程序剪切和粘贴内容到另一个应用程序，这证明每个应用程序可以保持与其他应用程序进行正常的交流。
　　AppV另一个强大的优势是它可以分成两种独立的解决方案——工作在它自己独有的系统上——或者可以将它集成到传统的（推送安装）和流处理（拉取安装）软件交付解决方案中。当与传统的ESD系统一起使用时，AppV会交付经过充分配置的应用程序到终端。但当它与流处理系统结合在一起使用时，最初只交付运行基本应用程序功能所需的字节——通常不超过应用程序的10%——而应用程序组件的其余部分将会在用户需要使用更多的应用程序的功能和特性的时候按需交付。更好的是，只有最终用户实际使用的应用程序才将会被交付。如果用户在会话期间不需要应用程序，没有字节会被交付。
　　然而，为了创建一个完整的系统管理策略，组织应考虑所有3个元素在IT基础架构中的使用。
　　▼AppV帮助解决所有有关应用程序的使用和管理的最常见的问题，同时保持终端系统的完整性。
　　■流处理系统在及时和正好的基础上帮助部署应用程序和更新到终端。
　　▲ESD有助于维持和管理你的IT基础架构的更多的传统组件——核心桌面实用程序和服务，基于服务器的部署，以及如果该选项在你选择使用的工具中是可用的，操作系统就部署和更新。
　　11.2.1.1　AppV的组件
　　市场上有一些产品可帮助解脱应用程序管理的痛苦，因为所有的AppV软件包是独立于底层操作系统的。此过程很简单。从准备一个虚拟化的应用程序开始。要做到这些，你应捕获应用程序的运行状态，并将其存储在AppV软件包中。这个软件包包含了所有运行应用程序都所需的文件、流程和设置。每个应用程序都被捕获到一个特定的软件包中，然后将被部署到目标系统中。下一步，你通过传统的ESD系统或者通过流处理技术将此软件包提供给终端。由于它们减少了的开销，因此流处理系统是首选的方式，因为它们只向系统提供应用程序的快捷方式，并且只在用户点击此快捷方式时程序才会被部署。
　　在你选择AppV解决方案时，你应该寻求一些功能，包括：
　　▼应用程序隔离或沙盒
　　■Windows版本的独立性
　　■基于代理与无代理的操作
　　■激活或非激活的支持
　　■流处理交付机制
　　■终端AppV缓存控制
　　■活动目录集成
　　■许可控制
　　■基于项目生产的封装
　　■软件即服务（SaaS）的支持
　　以上提供了广泛的功能，可以减少整体应用程序管理生命周期，并消除了许多的麻烦。
　　11.2.1.2　AppV系统堆栈
　　第10章概述了如何通过PASS模型构建传统的桌面。然而，因为AppV提供了对操作系统的保护，并因为AppV可以使用流处理技术按需提供应用程序，所以正在迁移到应用程序虚拟化的组织需要重新设计PASS模型，并迁移到瘦系统内核（见图11-5）。系统构建模型的核心——内核——现已减少了范围，只包括以下项目：
　　图11-5　使用AppV和流处理的组合可以完全转变终端的构建模式
　　▼核心操作系统及其所需的更新。
　　■核心实用程序，如防病毒、反间谍软件、防火墙、管理代理和虚拟化代理如果它们是必需的。
　　▲从那时起，你所虚拟化的一切别的东西。
　　应用程序层被转换为3层。PASS系统内核和广义的应用程序层（GAL）以满足平常或一般用户的需求。将基于角色的应用程序和商业软件添加到新的瘦内核上以满足特殊IT角色的需求，最后，特定层响应高度专业化的IT需求。通过这个系统堆栈，内核或核心操作系统始终保持在原始状态；基本上，它保持你建立它的方式。
　　11.2.1.3　Windows版本的独立性
　　除了转变系统的构建模式，因为它的工作方式，AppV可以减少应用程序封装的工作量。每个AppV系统可以支持多个Windows版本。这意味着当你封装了一个AppV应用程序后，你永远不需要再次将其封装。
　　因为AppV引擎管理应用程序和操作系统之间所有的事务，所以它具有将这些指令翻译为特定目标操作系统所需格式的能力。有些AppV产品将可以追溯到Windows NT，允许你通过Windows 2000、XP Vista运行一个来自NT的AppV软件包。
　　这种独一无二的功能是非常有价值的。传统上，每次发布一个新的操作系统并且他们的组织已经选择部署它时，应用程序封装器必须重新审视此应用程序。当选择升级桌面操作系统时，这项活动是组织面对的一个最昂贵的应用程序管理活动，这是为什么Windows Vista还没有看到预期的采用率的主要原因之一。
　　但因为Windows操作系统的独立性，AppV软件包只是运行在Vista上，即使它们最初是为Windows XP创建的。同样的情况也将适用于Microsoft发布的Windows 7。当然，你将需要等待，直到你依靠的AppV引擎已升级到可以在Windows 7上使用，但你不需要重新审视每一个AppV软件包。
　　这使得升级操作系统变得容易得多，极大地降低了新操作系统部署的成本。
　　11.2.1.4　基于代理与无代理的AppV
　　AppV引擎有2种类型。第一种是基于代理的，在目标系统上需要一个已预先部署的代理运行虚拟化应用程序，与中央AppV存储库进行沟通。第二种是无代理的，或者说代理已嵌入到虚拟化的应用程序中或代理是由应用程序随身携带的。两者都有各自的优点和缺点。
　　基于代理的AppV意味着在虚拟化应用程序可以运行之前，此代理必须可供使用。这意味着代理必须通过标准电子软件分发工具进行部署，安装到核心操作系统中，或者在某些情况下通过流处理引擎来部署。在后者的情况中，流处理引擎本身也需要一个已预先部署的本地代理。在某种程度上，基于代理的AppV是一种保护机制，为此虚拟化的应用程序将不能运行，除非代理是可用的。请记住，虚拟化的应用程序将可以在任何的Windows版本上和在任何系统上运行。如果AppV引擎是基于代理的，那么应用程序会受到保护，因为就算恶意用户想要以某种方式带走应用程序，在能够使用它们之前，还需要获得和具有安装代理的能力。
　　部署代理并不是一项艰巨的任务，因为在核心操作系统镜像内，瘦PASS内核通常将需要其他的代理和实用程序，例如：
　　▼财产清单代理用于保持对所有系统的追踪。
　　■支持软件部署的ESD代理，例如，活动目录部署代理就是组策略客户端，已经是Windows的一部分。
　　■补丁部署代理，重申一遍，Windows补丁代理就是Windows Update客户端，也是Windows的一部分。
　　■防病毒和反恶意软件，重申一遍，在Windows中的反恶意软件代理就是Windows Defender。
　　▲搜索引擎，在Windows中，这将是Windows Search或第三方工具。
　　但即使核心系统需要一个代理或一系列的代理，管理这些实用程序仍然比管理传统的应用程序简单得多。
　　无代理的AppV（指代理已嵌入到虚拟化的应用程序中）意味着这种虚拟化的应用程序是通过它本身来传输引擎，可以直接运行在任何的Windows平台上。好处是你不需要担心必须预先部署代理。这些AppV应用程序是完全可移植的，将可以在任何没有超过标准用户权限的系统上运行。这包括你自己的锁定系统、公共系统、信息端计算机以及更多。用户可以传输其整个应用程序环境——例如，Microsoft Office，连同其文件——到通用串行总线（USB）盘中。只需通过插入USB盘，启动应用程序，它们就可以在任何计算机上激活它们的应用程序。
　　这是一种功能强大的模式；但另一方面，你确实需要担心应用程序的安全。无代理的AppV应用程序是完全可移植的。这意味着任何用户可以复制一个无代理的AppV应用程序，并把它拿到任何系统上运行。另外，如果你不希望你的许可被到处散布，那么你必须采取某些手段以保护这些应用程序。这意味着你必须嵌入许可和许可保护机制到已封装的应用程序中，以确保它们只能在你的环境中运行。
　　11.2.1.5　本地存储库管理
　　每种AppV技术，无论是基于代理的或无代理的，都依靠本地的缓存来运行应用程序。当激活了应用程序，应用程序的内容是通过本地来提供运行应用程序。这个本地的存储库是一个存放应用程序的临时容器。它可以是非永久性的，也就是说，当用户一经注销，缓存会立即被清除。它可以是临时的，也就是说缓存仅可以在一定的时间内可用。例如，如果你的团队需要进行一项为期3个月的项目，你为他们提供一个3个月长的Microsoft Project的缓存。在3个月后，缓存被自动清除，应用程序不再可用。缓存也可以设置为半永久性的，这意味着它不会过期直到你手动修改它。后面这种模式对于需要访问此应用程序的移动计算机，无论它们是已连接或已断开连接的，都是非常的有用。
　　使用缓存控制允许你可以制定你所需应用程序的持续性。因为应用程序不是实际部署到目标系统上，所以当应用程序到了需要更新的时候，只需更新中央存储库。下一次启动该应用程序时，系统将与中央存储库进行核对以查看是否进行了任何的更改，如果进行了更改，它将自动更新本地缓存，同时更新应用程序。
　　应用程序还可以是预先缓存的，然后根据需要来激活。应用程序无法执行安装或者更改操作系统；由于不需要进行“安装”，你甚至可以使用XCopy将内容放置在目标系统上，但任务是在主机计算机本地处理，就好像已经安装了应用程序。
　　11.2.1.6　活动目录集成
　　大多数的AppV技术将直接与活动目录（Active Directory）进行集成，允许你可以通过安全组分配来分派AppV应用程序。创建一个组，在AppV管理工具中将其附加到应用程序分配中，然后通过将用户账户放置到这个组内，简单地分配应用程序。
　　而传统的应用程序必须被分配到计算机——否则每次用户登录的时候，安装将总是发生——这条规则不适用于AppV应用程序。因为AppV应用程序不是传统意义上的部署，你可以将它分配给用户。AppV应用程序只会在用户通过双击此应用程序的快捷方式来激活它们的时候才进行部署。当将用户的账户添加到一个已与此应用程序链接的活动目录（AD）组时，此快捷方式将自动显示在桌面上。然后，要决定应为应用程序分配多少个许可，所有你需要做的就是查明在应用程序的组中有多少个用户。
　　要根据在瘦PASS模型中应用程序的层次来分配应用程序，你可以使用一个流程图来决策过程（见图11-6）。如果此应用程序是包含在全局应用程序层（Global Application Layer，GAL）中，它会被分配给所有的用户。如果它是在基于角色的层中，它会被分配给特定的组，其角色对应的分组；如果它是一个特定的应用程序，它会被分配给特殊的用户。
　　图11-6　通过活动目录安全组分配AppV应用程序
　　11.2.1.7　AppV软件封装
　　封装也是完全不同的。在传统的封装过程中，每次启动一个新项目的时候，你一定总要返回到原始状态的操作系统。但使用AppV，因为应用程序不是真正地安装在系统上，所以你只需捕获运行状态，你并不需要严格要求的环境。虚拟应用程序封装过程将软件隔离出来，因为所有的系统组件都会被虚拟都化。应用程序被封装为一种特殊的格式——“沙箱”应用程序，以提供与系统的完全隔离。
　　然后，一旦应用程序封装完成，它们会被放在一个核心软件存储库中，最终用户从这个位置上拉取它们到终端。如果你有多个站点，你只需根据需要复制此存储库到需要它的地方。例如，在Windows环境中，你可以使用分布式文件系统复制（Distributed File System Replication，DFSR）引擎，这是一种增量差值复制引擎，只将更改的内容从一个位置复制到另一个位置。
　　注意：要了解有关DFSR的详细信息，可查看《Microsoft Windows Server 2008：The Complete Reference》一书，由Ruest和Ruest编写（2008年McGraw-Hill发行）。
　　然而，AppV封装仍然必须是结构化，还必须包含质量控制（见图11-7）。你会注意到此过程相比传统的封装有一个主要的区别：不再需要执行冲突检测，因为AppV隔离了所有的应用程序。这是一个很大的优点，加上每次你更改操作系统的时候，你不再需要更新软件包这个事实，这种方法极大地节省了时间。
　　图11-7　AppV封装过程
　　11.2.1.8　运行软件即服务
　　最后，AppV支持软件即服务的模式，由于你可以按需提供AppV应用程序。AppV还支持自助服务软件提供和按需交付。只需设置一个链接到应用程序的Web页面，允许用户请求他们自己的应用程序，向管理人员要求授权支付应用程序的许可费用整合为一个工作流，一旦授权已被处理，自动在应用程序组中添加用户账户。
　　此外，应用程序完全是可移植的。你可以通过网络共享交付它们，甚至在Windows中使用脱机文件，将它们缓存在终端本地上。你可通过USB盘或只读媒介如CD或DVD来交付它们。你还可以通过Web页面使用WebDAV、超文本传输协议（Hypertext Transfer Protocol，HTTP）或文件传输协议（File Transfer Protocol，FTP）来交付它们。为此，当涉及AppV的时候，传统的系统管理工具绝对是可选的。
　　此外，市场上有一些工具可以让你将所有你的应用程序从Windows Installer MSI格式转换为AppV。如果你已经花时间为所有你管理的软件创建了MSIs这可能是你迁移到AppV的最好的方法。
　　注意：工具——InstallShield AdminStudio，可以通宵地批处理转换MSI文件并且支持2种格式：Citrix XenApp或VMware ThinApp。计划支持更多的格式。要了解更多信息请访问：www.Accresso.com。
　　11.2.2　应用程序流处理：一种新的分发策略
　　如先前所述，AppV引擎还包括一种新的软件交付机制，从操作系统中提取软件。AppV软件包被捕获为一种特殊的结构，将应用程序软件包转换为4（Kb）的分段，把它们转变成流化组件——组件可以划分为多个不同类别的种类，这取决于你使用的引擎。
　　▼大多数的引擎都支持启动块或者启动应用程序所需的组件，允许用户使用它。在许多情况下，这些组件占整个应用程序不到10%。例如，使用Microsoft Word，有足够的代码使用户可以开始在一个新的或现有的文档中输入资料。
　　■有些引擎支持第二种类型——预测块。当整个组织中的用户持续使用流化的应用程序时，流处理服务器分析使用数据，以确定哪些应用程序的块是最常见的请求。然后，这些块被确定为预测块，被设置为自动流到已激活应用程序的终端上。当没有使用过已包含在预测块中功能的用户开始使用它们时，这些块已经在系统上并提供了更好的响应级别。预测块通常不会超过应用程序的10%，当启动块下载——结束后就会立即开始流处理。
　　▲所有的引擎都支持最后一种块类型——按需块。这些块是根据需要提供给最终用户，主要是因为它们所包含的功能很少会使用到，并且不保证会预先缓存在终端上。
　　这些体验对于最终用户是完全透明的。在大多数情况下，流处理引擎会在屏幕右下角的系统托盘中显示一个图标。如果你愿意，你可以让流处理代理向最终用户显示流处理事件；然而，隐藏这些事件可以提供更好的最终用户体验。
　　应用程序打包被封装为数据流；这种方式，应用程序只需要很少部分的内容就可以启动。例如，Microsoft Office超过500 MB，但通过流处理过程，用户只需9MB就可以运行Microsoft Word，而且启动块流到桌面通常不会超过10秒。
　　如先前所述，流式应用程序是缓存在本地的，因此所有用户都可以访问它们，只要它们的配置文件或活动目录的访问权限允许。移动用户具有断开连接权限，可以携带此应用程序一起旅行。流处理过程不需要复杂的基础架构；它往往像文件服务器一样简单；或者如果你拥有一个完整的流处理引擎，那么此服务器更像是一台媒体服务器。因此，基础架构可以通过使用像是网络负载平衡（NLB）服务——一种向终端提供一个单一的地址，但却运行多台服务器来提供连续性服务的技术来构造高可用性（见图11-8）。包含管理数据所需的数据库也可以通过Windows故障转移群集服务来构造高可用性。
　　图11-8　一种AppV流处理系统的结构
　　应用程序流处理系统
　　应用程序流处理系统向组织提供了一台多功能的主机。
　　▼第一是按需部署。通过使用流处理控制台——通过任何浏览器访问一个标准的Web界面——确定哪些用户可以访问哪些应用程序，自动地使应用程序的快捷方式在终端上可用。这是因为流处理代理将会向用户访问的终端提供已授权的应用程序。然后，当用户启动应用程序时，它将自动地流到终端，在数秒内即可使用。在流处理过程中，应用程序的流快捷方式将被替换为实际的快捷方式，再次通过一个对于用户是完全透明的过程。
　　■第二是远程访问。当将应用程序分配给用户时，管理员可决定它是否将会被缓存在本地。如果是，应用程序变成离线也可以使用。如果不是，每次用户访问它时，应用程序需要重新流到终端。
　　▲第三是许可控制。流处理代理自动持续不断地向服务器报告应用程序的实时使用情况。因此，任何的流式应用程序会持续不断地提供使用数据。其结果是固定的许可证遵从原则，可以大量地减少授权成本，有时可高达50%，因此你可以轻易地和快速地回收未使用的许可。正如你所见，动态许可管理为其本身提供了一个引人注目的商业案例。
　　AppV在提供这些关键功能的同时还提供了其他大量的功能。例如，显著地减少了终端硬盘的使用，因为每个应用程序只有一部分驻留在磁盘上。现在可以实现在线或离线应用程序分发。通过Active Directory（活动目录）中的组成员身份或任何其他的轻型目录访问协议（Light-weight Directory Access Protocol，LDAP）目录来执行应用程序的分配；只需将用户放入组中，将应用程序分配到组而不是单个的用户。整个系统可以容易地进行冗余，因为它依靠标准的HT-TP协议，工作方式非常像是一台Web服务器。
　　



　　11.3　AppV对组织的益处
　　应用程序虚拟化是当今最引人注目的可用于任何规模数据中心的技术之一。无论你是在一拥有20个还是20000个用户的组织，你都将可以从AppV中获益。一旦它准备就绪，你的流处理基础架构可以扩展以满足你组织的任何需要。甚至在合并或收购的情况下，你可以轻易地更新你的流处理系统，以整合任意数量的新客户端，无论它们是集中式的还是分布式的。
　　因为应用程序是缓存在本地，所以用户始终可以访问它们，无论是他们连接与否。如果你需要更新应用程序，只需创建一个更新软件包，它将在下一次用户访问此应用程序时自动进行更新。请记住，流处理引擎将不会替换整个应用程序，而传统的安装方式的应用程序将会被替换；它将只替换已更改的内容，进一步降低了对带宽的需求。
　　此外，应用程序虚拟化和流处理提供了充分的灵活性——传统的系统管理工具不能提供的灵活性。请考虑以下这些关键点：
　　▼可管理性　由于管理界面是一个Web界面，访问只需要一个Web浏览器，因此可以从你组织中的任何终端对系统进行管理。
　　■安全性　由于你同时需要流处理和虚拟化代理——在系统上或者在AppV软件包内——来操作，因此所有的应用程序都是完全安全的。此外，你可以依靠像活动目录软件限制策略这样的技术对每个应用程序进行数字签名，确保只有获得授权的应用程序才能在你的网络基础架构中运行。
　　■复原力　你的流处理系统中的每个组件都可以轻易地进行冗余，提供最大限度的可恢复性。
　　■灵活性　你可以动态地管理许可，可以轻易地回收未使用的许可，将它们按需重新分配。想象一下通过传统方式部署的应用程序能否做到这一点。
　　■灾难恢复　由于应用程序内容是被最终用户的系统拉取的，所以用户可以依靠你网络中的任何计算机，并立即获得他们要使用的应用程序。在灾难发生时，用户甚至可以通过因特网来访问他们的应用程序，在远程系统上工作。此外，AppV是虚拟桌面基础架构（VDI）的理想搭配，因为它可以提供基于用户需要动态建立系统的能力。
　　■可移植性　应用程序不需要驻留在特定的工作站上。它们可以被缓存或不被缓存，这由你来决定。由于操作所需的内容不超过应用程序的10%，所以可以在数分钟甚至数秒内提供给任何系统上的用户。
　　▲最优化　你终于可以优化应用程序许可在你组织中的使用情况，因为你总是可以实时地知道谁正在使用什么应用程序。
　　最终用户也可以受益，因为他们可以获得最好的应用程序体验。可以在他们不知情的情况下更新应用程序，因为每个应用程序已被虚拟化，他们将永远不会再次需要面对应用程序冲突问题。如果应用程序发生了意外的状况，只需将其重置为原始的虚拟化状态，就可再次随时使用。
　　



　　第12章　使用AppV
　　应用程序虚拟化（AppV）提供了许多的益处，可以批准立即采用，但它需要对所有的应用程序进行重新部署。这意味着需要替换已经正在运行的应用程序——卸载应用程序，然后将它作为虚拟应用程序进行重新部署——但卸载可能会导致操作系统处于潜在不稳定的状态。执行此操作的理想时间是在操作系统迁移过程中部署全新“干净”的计算机或者迁移到虚拟桌面基础架构（VDI）的时候。
　　你应该尝试着开始，集中在你网络中最棘手的应用程序，然后经过一段时间发展到所有的应用程序。这可以保证你将永远不会返回到“旧”的应用程序安装模式。但首先，你必须选择要使用的AppV解决方案。
　　



　　12.1　比较应用程序虚拟化产品
　　有多种不同类型的应用程序虚拟化引擎。表12-1概述了在市场上可用的几种不同的产品。注意，3家主要的虚拟化供应商——Citrix，Microsoft和VMware——每家都提供了AppV产品。因此，对于你的数据中心虚拟化项目的所有方面，选择同一家供应商可能是最合理的。
　　因此，对于你的数据中心虚拟化项目的所有方面，选择同一家供应商可能是最合理的。
　　正如你所见，还有多家潜在的AppV供应商。你选择哪一家将取决于你如何实施虚拟基础架构，你是否准备好迁移到VDI基础架构。无论你选择了哪种解决方案，应用程序虚拟化将可以在很短的时间内收回成本，因为它使应用程序独立于底层的操作系统。无论你是使用真实的或虚拟的桌面，受保护的桌面总是不太昂贵的桌面。为方便你的决定，表12-2根据AppV的功能集对最重要的几家AppV供应商所提供的产品进行比较。在此表内，一个大“X”表示该工具完全支持此功能，而小“x”表示该工具不完全支持此功能。空白表示此功能在该产品中不可用。
　　正如你所见，每种主要的产品都支持大部分的AppV功能集。
　　注意：要了解最新的这几家供应商，请参阅The Application Virtualization Solutions Overview and Feature Maxtrix（应用程序虚拟化解决方案概述和特征矩阵），由Ruben Spruijt编写，地址为：www.virtuall.nl/articles/applicationanddesktopdelivery/ApplicationVirtualizationSolutionsOverviewand FeatureMatrix.pdf。
　　12.1.1　Citrix XenApp
　　虽然它的重点是应用程序虚拟化和流处理，但Citrix XenApp模糊了应用程序和表现层虚拟化之间的界限，因为它源自于Citrix以前的Presentation Server。为了支持AppV，Citrix添加了大量的功能到Presentation Server引擎中。由此生成的AppV引擎——XenApp——具有3个版本（见表12-3）。每个版本建立在另一个版本之上，以提供完整的功能集。与XenServer一样，XenApp也已被集成到XenDesktop产品中。
　　12.1.2　InstallFree Bridge
　　InstallFree Bridge的操作原理与InstallFree Desktop是相同的，都使用本地PC的资源来运行应用程序。应用程序还针对流处理进行了优化，虽然此产品没有提供流引擎。只需简单地将应用程序放在用户可以访问的文件共享上。应用程序的访问是通过活动目录集成来支持的。
　　InstallFree需要一个的代理，但其代理也是虚拟化的，它将使用标准用户访问权限运行在任何的Windows平台上。这意味着InstallFree AppV应用程序是完全可移植的。只需在任何计算机上启动代理，你就可以运行任何的虚拟化应用程序。
　　此外，代理是运行InstallFree封装过程的工具。因此，你可以在不影响工作站的情况下，在任何工作站上封装任何的应用程序，并且全部通过标准用户权限来进行。
　　此外，InstallFree具有内置的应用程序集成机制。若要让2个虚拟化的应用程序一起工作，只需将它们放在同一个文件夹中即可。当它们启动后，每个应用程序将会自动发现对方。这使得InstallFree成为一种功能强大的AppV产品。
　　12.1.3　Microsoft应用程序虚拟化
　　当Microsoft收购SoftGrid时，他们也加入到AppV的战场中。他们稍后花时间重写了SoftGrid代码，重新发布为Application Virtualization（应用程序虚拟化）。MS App-V提供了3种不同的部署方案。你可以通过System Center Application Virtualization Management Server（系统中心应用程序虚拟化管理服务器）提供的一套完整的AppV和流处理功能集来部署它。此解决方案需要活动目录（AD）和数据库。你还可以使用一个轻量级的系统中心应用虚拟化流处理服务器，不需要AD集成，但仍然提供了AppV和流处理的功能。较小型的公司可以部署Microsoft应用程序虚拟化的独立版本。这个版本提供了AppV功能，但不包含流处理功能。
　　目前，应用程序虚拟化只能在32位的客户端版本中使用，但Microsoft正在开发64位的版本。MS App-V同时支持桌面和基于服务器或者终端服务的应用程序。只有拥有Software Assurance（软件保证）的客户才可以通过Microsoft桌面优化包（Microsoft Desktop Optimization Pack，MDOP）来使用它，没有拥有软件保证的客户端是不可用的。
　　MS App-V能够支持动态虚拟化，让你在它们可用于多个虚拟化应用程序软件包这样一种方式下封装中间件应用程序。例如，一旦它们实现了虚拟化，一个单一的虚拟化.NET Framework软件包就可以支持多个.NET应用程序。
　　12.1.4　Symantec SVS Pro
　　当它还是由Altiris拥有的时候，软件虚拟化解决方案（Software Virtualization Solution，SVS）是首个向市场推出AppV功能集的产品。后来，Symantec收购了Altiris，它还收购了AppStream，并将这2个功能集结合在一起创建了SVS Pro。SVS使用筛选器驱动器来虚拟化软件包。软件包被创建为存档文件（.vsa），然后使用一种通用的压缩格式（例如，WinZip）压缩成可交付的单元。因为这样可以通过WinZip实用程序来查看虚拟软件包（.vsp）。将VSP部署到终端，一旦部署完成，就可以激活或停用。如果出现问题，可以将VSP重置为其原始的状态，重置此应用程序使它可以重新正常运行。
　　通过AppStream的组件，SVS Pro可以最大限度地支持流处理。实际上，此组件为任何的AppV工具提供了最好的流处理功能集。如果有需要，AppStream甚至可以流处理虚拟化的桌面。因为它支持所有3种流处理的块类型——启动、预测和按需——AppStream可以确保所有的系统都是根据你设置的策略来构成的。这提供了最佳的用户体验。
　　由于Altiris的产品线中包含了强大的功能集，所以将SVS Pro与Altiris ESD解决方案结合在一起可以为任何的分布式桌面环境创建一个全面的管理集合。
　　12.1.5　VMware ThinApp
　　自从2007年年底VMware从ThinStall收购了ThinApp后，ThinApp的功能得到了显著的增强。其赖以成名的功能是无须代理就可以运行虚拟应用程序，这是因为运行库代理是包含在软件包中。这使得应用程序是完全可移植的；但是，这要求你实施特别的程序保护应用程序免受盗窃。
　　ThinApp应用程序可以同时在32位和64位的Windows版本上运行。ThinApp不包括分发机制，但ThinApp应用程序在建立的时候对流处理进行了优化。这意味着组织必须依靠传统的部署工具，如ESD系统或Active Directory进行部署。部署系统也可以是简单的文件共享或者部署Web页面。
　　若需要更新应用程序你需要做的就是替换原来的应用程序，无论它位于哪里。ThinApp包含了一个称为AppSync的功能。AppSync将在目标工作站上自动更新已部署的应用程序。为了做到这一点，你必须在应用程序的.ini文件中添加AppSync的Web站点。此外，.ini文件名称必须与应用程序的每个版本完全相同；否则，应用程序将不会被更新。此过程没有被记录在ThinApp的文档中。例如，为了将Winzip 10.0更新至WinZip 12.2，你要确保WinZip 10.0的.ini文件指向了相应的Web页面。然后，当你创建Winzip 12.2软件包时，你命名其.ini文件要与你以前用于WinZip 10.0版本的名称完全相同。应用程序将在下一次用户启动它时自动进行更新。
　　ThinApp还包括了Application Links（应用程序链接），可以将虚拟化的应用程序链接到一起。例如，你可以分别虚拟化Microsoft Office和Adobe Acrobat，一旦虚拟化完成，仍然可以将它们互相集成在一起。ThinApp应用程序可以在任何版本的Windows上运行，从Windows NT到Windows Vista。
　　注意：如果你通过文件共享来提供应用程序，那么你在Windows中仍然可以通过使用基于访问权限的枚举（Access-Based Enumeration，ABE）来控制哪些人可以看到哪些内容。ABE将只会显示此用户有权访问的文件。通过将访问控制列表与AD安全组链接起来以控制访问权限，你将获得一个类似于流处理的效果。要了解更多有关ABE的详细信息，请访问：www.microsoft.com/windowsserver2003/techinfo/overview/abe.mspx。
　　12.1.6　主要供应商的定位
　　正如你所见，供应商采取不同的方法实现AppV，但结果是极其相似的。然而，每个供应商都有其自己的特点。
　　▼Microsoft通过Microsoft桌面优化包（Microsoft Desktop Optimization Pack，MDOP）来提供应用程序虚拟化，这限制了其可用性。因此，如果你不具有软件保证（Software Assurance），那么你可能需要选择另一种解决方案，即使你是一家全部使用Microsoft产品的公司。
　　■Citrix提供了XenApp，这是Presentation Server的更新，是结合了表现层虚拟化（PresentV）最佳的AppV。
　　■VMware Thinstall和InstallFree Bridge都无代理的，使应用程序可移动的，但同时出现许可的质疑。
　　▲Symantec因为其全面的流处理功能使得SVS Pro可以领先于其他对手。
　　在你决定选择哪一种平台之前，请考虑以上的定位，并评估每个功能集。
　　12.1.7　使用AppV决策过程
　　与其他2个主流的虚拟化过程一样，要做出关于AppV的决定是基于你面对的实际业务需求（见图12-1）。
　　图12-1　AppV决策过程
　　然而，在这种情况下，此决定可以解决移动PC的需求。如果需要的是一个完整的桌面，那么请选择一个安全的虚拟机；如果你只需要访问应用程序，那么虚拟化它们。桌面PC并没有包括在此决策树中，因为所有的应用程序都是在组织内进行虚拟化。
　　



　　12.2　AppV的关键点
　　各地的组织都花费了大量的资源来管理应用程序安装包，确保这些应用程序在他们的网络中始终保持正常运行。更糟糕的是，应用程序的封装或重新封装是操作系统迁移的最大障碍之一，因为组织不想面对大量的应用程序准备工作。
　　为了减少应用程序的管理工作，大多数组织设计了包括整个应用程序集的系统镜像。这些组织需要管理存放在任意位置的数十到数百个系统镜像，需要定期对每一个镜像进行更新。虽然这使得镜像易于恢复，但它麻烦、耗时，为了让它发挥作用需要大量的管理开销。
　　由于所有的镜像都需要核心操作系统和基本的实用程序，现在你就可以有一个或2个单一的系统镜像。所有的其他镜像都是从中央位置流出。实际上，你可以重新建立一个系统镜像，一旦系统重新启动完毕，最终用户可以在数分钟内启动和运行，因为在任何一个时间，流处理仅会发送用户需要的内容。这不是一种更好的桌面管理模式吗？
　　请考虑下列因素，然后再决定你是否准备好从AppV流处理中获益：
　　应尽可能地虚拟化应用程序，一劳永逸地解决应用程序冲突。执行“污点”虚拟化，重新封装你拥有的最棘手的应用程序，马上就能从应用程序虚拟化中获益。虚拟化应用程序还可以使它们独立于操作系统的版本，让它们在任何操作系统上运行。这将移除操作系统迁移的最大障碍。
　　通过流处理应用程序，你可以简化应用程序的访问，减少应用程序分发对你网络的压力。以Microsoft Office为例：当安装完成后，你必须将数百兆字节发送到终端，但当你通过数据流发送它时，你只需发送整个应用程序集的10%至20%到终端。内容只在用户需要的时候才发送，不是一种大规模的单播分发。
　　使用应用程序虚拟化，你现在可以通过一个更简单的方式来集中创建PC。创建一个包含基本实用程序与更新的核心镜像。确保你的SVS Pro代理包含在此镜像中。通过流处理引擎分发应用程序，通过将内置的Windows功能：漫游配置文件和文件夹重定向结合起来保护用户数据和配置设置。
　　使用AppV，你现在可以建立一个单一的参照计算机，并且在捕获应用程序的时候始终保持其“干净”，为流处理做好准备。由于少数应用程序是依靠硬件的，对于这种系统你甚至可以依靠虚拟机。
　　完整的终端管理意味着要使用最适合它们的端点技术。依靠你的ESD系统管理核心操作系统、它的更新和它所包含的基本实用程序。依靠AppV保护应用程序，对于多种目标操作系统只需封装它们一次。依靠流处理向最终用户提供应用程序。依靠你的目录服务管理应用程序分组和最终用户的数据。使用这些集成技术可以一劳永逸地结束应用程序管理的噩梦，并迈向21世纪的动态数据中心。
　　要实现这一策略，可以依靠AppV的10项告诫：
　　1.学习应用程序虚拟化如何可以更新应用程序的生命周期。
　　2.确定哪种产品最适合你的需求。
　　3.试验工具以了解其细节。
　　4.对你的应用程序进行分类，使用应用程序赞助。
　　5.合理化所有的应用程序。
　　6.使用标准的体系构建模型和标准的系统堆栈。
　　7.移至应用程序虚拟化模式。
　　8.请记住封装的最佳做法仍然适用。
　　9.依靠应用程序流处理实现交付。
　　10.学会管理本地缓存。
　　将这些告诫谨记于心，期待一个全新的应用程序生命周期（见图12-2），可以取代传统的应用程序管理方法。
　　在此新的生命周期中，一旦应用程序已获批准集成到你的应用程序组合中，你首先要捕获应用程序的运行状态。然后，你将它放置到存储库中并配置AD组和应用程序的缓存模式。这比传统的部署更加简单。当用户登录时，快捷方式图标将出现在用户的桌面上。激活它后，应用程序通过数据流传送到桌面。
　　如果需要更新，将它们应用到软件存储库中。在下一次启动此应用程序时，它会自动更新到本地缓存中。当应用程序到了退役的时候，只需消除本地缓存，将其从存储库中移除。这是一种功能强大的新的应用程序管理模式。
　　图12-2　AppV生命周期
　　



　　12.3　集成应用程序、配置文件和桌面虚拟化
　　桌面虚拟化提供了集中简化的承诺。应用程序虚拟化提供了按需应用程序的承诺。配置文件虚拟化提供了在任何时候都保护数据的承诺。结合所有这3种技术让你可以创建一个全新的桌面管理方案。所有这3种技术现在可以应用于整个系统构建模型中，时刻对它进行持续的保护。实际上，这使你可以专注于终端的关键组件并对它们提供保护，如下所示：
　　▼使用标准的系统构建实践建立核心操作系统。可以依靠模型，如PASS系统内核来做到这一点。
　　■安装核心实用程序到系统中——例如，运行软件组件所需的代理，包括AppV和流处理，以及防护机制，如防病毒和反恶意软件。
　　■将核心操作系统转换为将要部署到所有系统或者作为只读桌面虚拟化镜像部署的镜像。
　　■接下来，依靠传统的ESD技术管理已安装的实用程序并根据需要更新它们，管理核心操作系统更新。
　　■将所有其他的应用程序封装为虚拟应用程序，为流处理做准备。
　　■将所有的软件包存放到流处理存储库中。
　　■以组或特定的基础上全局流传送应用程序，使它们在用户登录时可用。
　　■使用流处理系统更新所有的流式应用程序，管理应用程序缓存参数。
　　■使用流处理系统管理和回收所有的应用程序许可。
　　▲通过Windows内置的用户个性保护功能保护所有的用户数据，如漫游配置文件和文件夹重定向，还可以通过与流处理系统大致相同的方式将用户数据缓存在本地。
　　这一策略极大地简化了桌面管理的模式。
　　12.3.1　按需分配应用程序
　　当你使用分布式系统时，你需要几个不同级别来管理组件。首先，你需要管理和更新操作系统本身。其次，你需要管理和更新任何已部署的核心实用程序或驱动程序，以支持你的组织所选定的物理技术。这两个级别的管理通常最好是通过ESD系统来控制，因为这些系统的目的就是用于为物理设备控制和重生成镜像提供支持。ESD系统也是最适合你需要同时部署AppV和流处理管理代理的管理工具。
　　此外，AppV和应用程序流处理的数据中心将支持新的桌面管理模式。
　　▼在AppV和应用程序流处理的数据中心内，很少或无须表现层虚拟化或者在允许多个用户共享访问应用程序的集中式服务器上操作应用程序。技术如Windows终端服务需要实际连接的客户端来运行。此外，它们需要大量的包括多个处理器和大量内存的服务器以支持应用程序共享。使用应用程序流处理系统，你不再需要这种应用程序管理模式，因为流式应用程序可以缓存在本地并且在用户断开连接时仍然可用。此外，应用程序流处理服务器只不过是一个已优化的文件或Web服务器，比终端服务器需要更少的资源。
　　■通过虚拟化台式机以及应用程序，你可以获得最理想的工作环境。依靠于AppV、流处理和用户信息保护策略的桌面会变成完全的非永久性。这意味着你不需要将特定的台式机分配给最终用户。每次用户连接到虚拟桌面，通过生成标准桌面、分配用户所需的应用程序，并根据需要部署用户的数据来实时地建立相应的桌面。由于虚拟桌面镜像、虚拟化的应用程序，以及最终用户的数据是全部集中于存储区域网络（SAN）后端，其系统结构是极为快速的——不需要进行网络传输，并且所有的数据都位于同一磁盘集上。
　　▲对于需要高图形处理功能的最终用户，你可以依靠集中式刀片PCs——位于数据中心并分配给特定用户的物理系统。刀片PCs包含针对图形的硬件加速，提供最佳的集中式桌面体验。重申一遍，由于对所有的数据和应用程序进行了集中化，访问这些系统是极其快速的，并且为图形密集使用型的用户，如工程师或图形艺术家提供了最佳的体验。
　　为了要同时支持分布式和集中式PCs，每种模式都提供了一种快速和高效的访问方式。
　　12.3.2　使用非永久性的桌面虚拟机
　　下一个级别是生产力应用程序层。此级别包括和处理所有你管理和提供给你的内部和外部用户的虚拟化和流式应用程序。最后一个级别是数据级别，目的是时刻保护最终用户的数据和配置选项。用这种方式设计你的分布式系统管理基础架构，让你可以创建一个现代的数据中心，这对于减少传统系统管理的麻烦将会有极大的帮助。
　　这个简单的过程使你能够管理你所有的系统，为你提供一个有效的管理模式。实际上，所有你的终端被转换成一种由3个关键层组成的“靶心目标”（见图12-3）。
　　▼第一层由操作系统本身组成。
　　■第二层是所有虚拟化应用程序所在的应用程序缓存层。
　　▲第三层是用户数据和配置层。
　　所有3个层在任何时候都是完全受到保护的。对于IT管理员，这意味着你可以在任何时候很轻易地对任何PC进行重镜像。对于用户，这意味着他们可以依靠组织中的任何PC——物理的或虚拟的——使用他们自己的数据和他们自己的应用程序来工作。
　　这种新的构建模型可以同时应用到物理计算机实例和虚拟桌面上，让你依靠于一种新的“非永久性”的系统构建策略。但要做到这一点，你需要在数据中心实施新的元素。
　　图12-3　新的“靶心”终端系统堆栈
　　12.3.3　虚拟化用户配置文件
　　虽然许多AppV供应商正在尝试将可以时刻保护用户数据的特殊功能组合到一起，但你可以通过Windows的内置功能立即做到这一点。在Windows中，用户数据是存储在用户配置文件中。此配置文件构成了每个用户环境的个性。
　　个性保护可能是操作系统管理最重要的方面；这当然不是来自技术人员的观点，而是来自最终用户的观点。虽然作为IT专业人员的我们将计算机视为一个我们需要建立和维护的系统；但最终用户将它视为他们需要用于执行其作业功能的不得已要使用的工具。对于他们来说：个性——数据、收藏夹、桌面设置、应用程序自定义等等——才是此系统最重要的方面。
　　这是因为用户认为他们计算机的个性是作为其工作区的一部分，他们中的许多人将花费大量的时间为他们所做的工作对桌面进行优化。对于许多用户来说，失败的打印机设置、电子邮件配置、Microsoft Word模板或者甚至放置在他们自己桌面上的快捷方式都可能会损害其舒适度以及系统的有效性。这种定向障碍会降低生产效率并增加帮助台的工作负载，因为它会导致不必要的最终用户支持电话和培训。
　　因此，保护每个用户的个人计算机环境是减轻操作系统管理策略的生产效率影响的关键步骤。
　　12.3.3.1　定义你的个性保护策略
　　为了定义你的保护策略，你首先需要了解个性或配置文件以及它们的工作方式。配置文件是在用户首次登录系统时生成的。基本上，在用户首次登录时，会复制默认的用户配置文件的内容并为用户进行个性化设置。系统自动重置这些内容的安全参数，以便用户具有对它们的独占访问权限。这就是为什么当你使用不同的操作系统时，正确地管理默认用户配置文件的内容是如此重要的原因之一。通过创建一个单一的默认用户视图，你可以对最终用户访问你部署给他们的计算机系统的过程和与这些计算机交互操作的过程进行标准化。当然，他们会不断演变此配置文件，但你至少可以确保某些关键元素在所有配置文件中保持为共通的。
　　用户可以通过域，登录依靠活动目录（AD）的身份验证或者通过本地系统，依靠可以在每个Windows系统上找到的本地安全账户管理器（SAM）数据库。每次第一次登录时，将创建一个配置文件。这意味着为了修护目的而登录到系统的技术人员将会自动生成一个配置文件，同样的情况也会发生在其他用户以其他目的登录到系统的时候。
　　大多数本地登录是非永久性的，因为只有少数组织会在没有集中的身份验证数据库，如AD所提供的数据库的情况下运行他们的网络。这意味着在大多数的情况下，你可以从你的保护策略中放弃本地配置文件——也就是说除非你拥有只在工作组中运行的自定义系统。许多组织使用这种系统来监控和维护连接到非军事区（Demilitarized Zone，DMZ）的系统，例如建立在外围网络中的那些系统。你可以进行时机评估以确定当升级这些机器时是要保护这些本地配置文件，还是由管理员和技术人员重新创建它们。如果你正确地创建了默认用户配置文件，那么保护本地配置文件的价值将会是最低的。
　　因此，保护策略应该专注于通过域登录生成的配置文件。如果你的网络向每位主要用户提供一台独立的PC，你的策略将相对容易制定，因为所有你将要做的就是找出系统上主要用户的配置文件，保护它并放弃所有其他的配置文件。如果你的网络使用的是共享的计算机，那么这将会稍微困难一些。还可以通过其他的方式保护域登录的配置文件，例如漫游配置文件——将配置文件存储在网络上，并在用户登录时下载到每台计算机上——或者文件夹重定向策略——一种可以将在配置文件中找到的本地文件夹内容移动到网络位置的组策略对象（Group Policyobject GPO）。如果你希望制定一个可以满足你网络中每个用户需求的保护策略，那么你的分析将需要考虑到这些因素。
　　某些组织，特别是那些必须24/7全天候运行的组织，在他们的网络中还将具有通用账户。通用账户是允许操作人员共享一台计算机无须在他们轮班结束时登录或注销的共享账户。有两种类型的通用生产账户。第一种类型是涉及24/7全天候操作和无须登录或注销来运行一台计算机所需的账户。操作员共享此账户的密码，因此可以在不关闭会话的情况下进行轮班。
　　第二种类型用于具有高度人员流动的环境。在这方面海军舰艇是一个很好的例子。由于舰艇几乎每次停靠码头时都要更换官员和工作人员，船员也会轮换，某些组织选择使用通用的基于角色的账户，而不是指名账户。例如，舰艇大副将使用First Officer账户，而不是一个以他或她名字命名的账户。在这种情况下，密码可能或不可能被共享。这取决于的行政人员是否愿意承担每次船员变动时的工作量。他们可以根据他们的需要重置每个通用账户的密码或者什么都不变。很明显，一项需要每次船员变动时重命名指名账户或者每次船员变动时更改密码的策略，要比一个共用的密码安全得多。
　　12.3.3.2　选择要保护的配置文件
　　由于在网络中存在各种类型的配置文件，你需要一种方法来确定要保护哪一种配置文件。要实现此目的最好方法是使用一种可以确认哪一种配置文件需要保护以及在何种情况下需要保护的流程图（见图12-4）。请记住你为什么将会或不会保护一个指定个性文件的原因。
　　你的决策流程应包括以下准则：
　　仅保护那些位于不是域的一部分的特殊计算机上的本地配置文件，而且这些配置文件不能被自定义默认配置文件替换。
　　图12-4　使用决策图来决定个性保护策略
　　■保护那些最近使用过的并经常使用的域配置文件。
　　■仅保护那些具有实际内容的配置文件（基于配置文件的大小）。
　　■仅保护活动的配置文件。
　　▲如果你的计算机有主要的用户，那么他们的域配置文件时刻都要受到保护。除此之外，还有其他的注意事项，但这些决定应成为你的个性保护策略的要点。
　　12.3.4　创建个性化保护策略
　　现在，你已知道哪些配置文件需要保护——主要是域配置文件——你可以进一步创建你的配置文件保护策略。Microsoft已经做了很多的努力使得个性保护成为一个日常的过程。没错——整个用户文件夹的结构被设计成为一件事情提供支持：文件夹重定向和通用配置文件保护。
　　文件夹重定向是Group Policy（组策略）的一项功能，可以自动将用户文件夹重定向到中央位置。当与脱机文件夹缓存相结合时，文件夹重定向可以为用户提供世界上最好的保护，无论他们是否正在漫游。文件夹被放置在可以对它们进行备份和随时可用的网络共享中。它们的内容被缓存在本地，因此，即使移动用户已断开连接的情况也能够访问他们的数据。如果本地做出了任何的更改，它们会在下一次网络连接可用的时候自动进行同步。这意味着已连接和已断开连接的用户都可以不间断地访问他们的数据。
　　你可以将文件夹重定向与漫游用户配置文件结合到一起，获得2种世界上最好的保护。非永久性的项目，如NTUser.dat文件——一个包含了配置文件所有内存中内容的文件——不包含在文件夹重定向中。这意味着单单依靠文件夹重定向可能会为用户提供不完整的体验。此外，单单依靠漫游配置文件也会限制体验，因为数据不像文件夹重定向那样是实时可用的。配置文件是庞大的文件，在登录过程中可能需要较长的时间才能变得可用。
　　通过将两者结合起来，你可以利用文件夹重定向管理配置文件中的数据并使其尽快可用，利用漫游配置文件管理其余的部分。在这种情况下，在文件夹重定向中包含的数据会从漫游配置文件中排除。其结果是加快了加载配置文件的速度，因为它的内容变少了，而且用户可以通过文件夹重定向随时访问数据。将两者结合起来的另一个好处是让你可以在Windows XP或Vista中支持漫游用户，或者如果你有需要，甚至可以同时支持。
　　但对于许多人来说，这意味着要重新考虑他们该如何为用户数据提供保护。许多组织过去一直都是依靠用户主目录和/或漫游配置文件来提供这种类型的保护。
　　主目录的初衷是提供一种简单的方法在网络上映射用户共享。在Windows NT、Windows 2000和Windows Server 2003中，当你创建一个新账户时，在模板账户中使用%username（用户名）%变量可以自动生成主目录文件夹，应用适当的安全设置，给用户对整个文件夹的完全所有权。当用户登录时，此文件夹自动映射到H：驱动器或者你指定的任何其他盘符。但今天，你不应该再依靠映射的驱动器了。你应该依靠分布式文件系统（Distributed File System，DFS），特别是DFS名字空间。
　　DFS名字空间使用通用命名约定（Universal Naming Convention，UNC）共享来为用户映射资源。但不是使用＼＼servername＼＼sharename（＼＼域名＼＼共享名）的方法，DFS名字空间使用＼＼domainname＼＼sharename（＼＼域名＼＼共享名），每个名字空间被映射到你组织网络来每个站点上适当的目标。DFS复制将这些目标共享的内容在广域网上的保持同步。
　　注意：要了解更多关于DFS的详细信息，请访问：www.microsoft.com/windowsserver2003/technologies/storage/dfs/default.mspx。
　　自从Windows 2000以来，Microsoft一直关注作为所有用户文档的主目录——My Documents（我的文档）文件夹的使用。这个文件夹是自Windows 2000以来所有Windows版本安全策略的一部分，即使在Windows Vista中它已被重新命名为Documents（文档）。这个文件夹存储在用户的配置文件中，自动受到保护免受所有其他用户的影响（当然，具有适当访问权限的管理员除外）。
　　12.3.4.1　Windows XP中的文件夹重定向
　　在Windows XP中，文件夹重定向可以管理4个关键的文件夹，为每个文件夹指定网络共享。这些文件夹包括：
　　▼Application Data（应用程序数据），存储了所有应用程序的特定设置。
　　■Desktop（桌面），包括用户存储在桌面上的一切东西。
　　■My Documents（我的文档），这是用户的数据存储文件夹。将My Pictures（我的图片）子文件夹存储在网络上是可选的。
　　▲Start Menu（开始菜单），包括用户所有的个人快捷方式。
　　当通过Group Policy（组策略）激活重定向时，系统基于用户的名称创建一个特殊文件夹（就像是以前的主目录创建过程），应用适当的安全设置。每个提到的文件夹是创建在用户的父文件夹内。这些文件夹中的数据从桌面PC被重定向到适当的网络文件夹，因此，客户端，如移动用户还可以脱机使用。当用户断开连接时，数据存储在本地上；当他们重新连接时，脱机文件夹自动与网络文件夹进行同步。
　　但是用户配置文件包含的信息远远不止是这4个主要的文件夹。实际上，非常不固定的信息如Local Data（本地数据）和Favorites（收藏夹）是不受保护的。因此，你不能只依靠Windows XP的文件夹重定向正确保护系统的个性。
　　注意：对于漫游到远程办公室的用户，你可以将文件夹重定向与DFS名字空间一起使用，将文件夹的内容复制到远程位置的DFS目标共享中。请确保你正在运行Windows Server 2003 R2或更高的版本，以便可以利用DFS复制中新增量压缩复制引擎。
　　12.3.4.2　Windows Vista中的文件夹重定向
　　这一切在Windows Vista中发生了变化，因为它最终提供了一种真正的文件夹重定向和个性保护机制。这体现在Vista组策略对象（Vista Group Policy，GPO）中文件夹重定向的可用设置。正如你所见，它包括的重定向设置比Windows XP所能够实现的多得多（见图12-5）。
　　图12-5　Vista的文件夹重定向组策略
　　由于它对用户是完全透明，这使得文件夹重定向对于长期的个性保护是一个极佳的选择。虽然他们认为他们使用的Documents（文档）文件夹是位于他们的计算机上，但他们使用的文件夹实际上是位于网络上。通过这种方法，你可以确保所有的用户数据时刻都受到保护。
　　使用文件夹重定向策略而不使用主目录可以简化用户数据管理的过程，允许你利用Windows网络的高级功能。例如，即使数据是存储在网络上，它可以通过脱机文件缓存在本地。当通过GPO激活它们时，重定向的文件夹会自动通过客户端的缓存区进行缓存。这些文件夹中的数据还可以通过加密文件系统（Encrypted File System，EFS）进行加密。实际上，所有的脱机文件都可以被加密。
　　Vista允许你重定向10个不同的文件夹。当你将这些文件夹的重定向与漫游配置文件结合到一起时，你为用户提供了比单独使用漫游配置文件对网络通信具有更低影响的最佳的漫游体验（见表12-4）。
　　Vista文件夹重定向策略比XP包含了更多的设置。例如，你可以从你的PC上自动删除较旧的或未使用的用户配置文件（见图12-6）。
　　此外，你可以用于个性保护的设置比先前的Windows版本所包含的更加详细。Music（音乐）、Pictures（图片）和Video（视频）文件夹都可以设置为自动遵从你针对Documents（文档）文件夹所设置的策略。
　　图12-6　Windows Vista允许控制每台PC上用户配置文件的行为
　　你还可以使用相同的策略同时管理Windows XP和Windows Vista的文件夹重定向（见图12-7）。这个策略提供了功能强大的系统管理功能，允许你只需设置一个策略就可以应用到2种操作系统上。
　　图12-7　Vista中的文件夹重定向比Windows XP提供了更多的选择，但允许你只需设置一个策略就可以同时应用到Vista和XP上
　　12.3.4.3　与漫游配置文件一起启用文件夹重定向
　　当启用文件夹重定向的时候，有一些特殊的考虑。首先，你需要确保每个用户将被重定向到相应的服务器。不应发生将纽约的用户重定向到洛杉矶的服务器的情况。要做到这一点，你必须创建特殊的管理组，用于重新编组用户，确保每个用户被指派到相应的服务器；你很可能已经拥有可用于此目的安全组。你还必须确保正确地配置脱机设置，以保证用户正在使用脱机文件的最新版本。
　　警告：要确保你为每个用户的文件夹重定向分配了适当数量的存储。如果你限制了能够用到的磁盘空间，这是不可接受的，会使这项工作变得没有任何意义。
　　通过用户分组进行文件夹重定向，实际上类似于创建区域，或者说基于地理位置的用户分组。由于每台服务器都是一个实际的位置，你将需要为每个位置创建一个用户组。首先列举将用于托管用户文件夹的每台文件服务器的位置，然后相应地命名每个全局组。一旦创建了这些组，你就可以开始重定向处理。使用组可以允许你限制实施文件夹重定向所需的GPO的数量。
　　使用下列步骤来准备你的文件夹重定向和漫游配置文件策略。请确保你正在运行Windows Server 2003 Service Pack 1（SP1）、R2或Windows Server 2008作为你的服务器操作系统。此外，还要确保已做好对Vista with SP1计算机的所有GPO设置的准备和修改，以获取使用最完整的设置。
　　1.首先创建将用于支持重定向和漫游的共享。你将需要最少2个共享：一个用于用户配置文件（例如User＿Profiles），一个用于文件夹重定向（例如Folder＿Redir）。如果你已经在使用XP的漫游配置文件，可以将此共享用于配置文件。
　　2.由于Vista和XP在登录和注销的过程中不会显示太多的用户信息，所以你可能需要更改此默认行为。将一个GPO应用到所有的PC，然后在Computer Configuration（计算机配置）Policy（策略）下选择Administrative Templates（管理模板）System（系统）Verbose Vs Normal Status Messages（详细与正常状态消息）选项。这会让用户知道在登录过程中发生了什么事情，并且它还可能有助于问题的调试。
　　3.漫游配置文件的验证已被设置在AD的用户账户属性中。如果你同时使用XP和Vista，那么每个用户将拥有2个配置文件——版本1用于XP和版本2用于Vista。为了区分它们，Vista会添加.v2扩展名到配置文件的文件夹名称中（例如JDoe.v2）。
　　4.为了减少漫游用户配置文件的内容，并因此可以限制网络通信量和登录次数，需要从漫游配置文件的内容中排除关键的文件夹。在User Configuration（用户配置）|Policy（策略）下使用Administrative Template（管理模板）|System系统User Policy（用户配置文件）|Exclude Directories In Roaming Profile（排除漫游配置文件中的目录）选项。列出Vista的文件夹重定向所支持的10个文件夹中的每一个（见表12-4所提到的文件夹名称）。输入与它呈现在Windows资源管理器中一样的名称，并用分号（；）来分隔每个名称。
　　5.依靠表12-4中的建议设置你的文件夹重定向策略。在User Configuration（用户配置）|Policy（策略）下使用Windows Setting（Windows设置）Folder Redirection（文件夹重定向）选项执行此操作。更改每个文件夹的属性。将它们重定向到你的文件夹重定向共享。下面是几个注意事项：
　　■当你对Windows XP和Vista同时支持的文件夹设置文件夹属性时，在设置选项卡下使用Also Allow Redirection Policy（同样允许重定向策略）选项（见图12-8）。
　　图12-8　Vista针对Documents（文档）文件夹的警告信息
　　■当重定向AppData Roaming（应用程序）（漫游）时，你将会收到兼容性警告消息（见图12-9）。这是因为较旧的Windows操作系统不支持Vista文件夹重定向的全部功能。
　　图12-9　Vista针对AppData（应用程序数据）文件夹的兼容性警告信息
　　■当重定向Documents（文档）文件夹的时候，你也将获得一条警告消息。在这种情况下，它告诉你由于你选择支持较旧的操作系统，将自动更改Picture（图片）、Music（音乐）和Video（视频）文件夹的行为；默认情况下它们将受到保护，并设置为Follow The Documents Folder（跟随文档文件夹）。如果你不想保护它们，设置策略明确地指出每个文件夹。
　　在将策略部署到生产之前，必须先在实验室中对其进行测试。要确保你的策略是正确的，需要有专家级用户签名证实它通过了验收测试，以确保他们满意其操作。
　　



　　12.4　完成个性化保护策略
　　花时间去维持那些可以令你的用户在他们进行工作时感觉到一帆风顺和舒适的事情，这样做将会得到回报的。当还原映射的驱动器时，正如他们先前所做的，打印机会出现，数据、快捷方式和收藏夹都与用户离开它们的时候完全一样；用户的焦点转向使用系统来执行他们的任务，而不是固定他们的配置文件。他们将会因此变得更加富有成效。
　　如果您花时间通过文件夹重定向和漫游配置文件来准备适当的长期保护策略，你将可以为非永久性PC提供全面的支持做好准备。
　　



　　12.5　完美桌面的关键点
　　当你设置了非永久性PC策略时，请牢记以下要点：
　　▼建立仅包含绝对需要的组件、实用程序、更新程序和驱动程序的核心系统镜像。
　　■虚拟化所有的应用程序，通过流处理引擎来提供它们，以提高其可用性的速度。
　　▲虚拟化所有的配置文件，并在PC镜像之外保护它们。确保已将配置文件重定向到长期共享文件的文件夹中。使用DFS简化共享文件夹的访问。
　　通过这种方式，你所有集中式桌面虚拟化镜像可以完全是非永久性的，可以在用户登录时即时创建。这将可以节省大量的磁盘空间用量，将完善由技术，如XenDesktop或VMware View所创建的基于增量的差异虚拟机文件。
　　这是你要迈向虚拟桌面和创建动态桌面数据中心策略时使用的唯一策略。
　　



　　第三部分　巩固优势
　　第13章　保护你的虚拟基础架构的安全
　　安全是一个普遍性的问题，因为它几乎涉及你的网络中的所有东西。安全的对象就是要保护信息。确定你需要保护信息的价值将有助于确定你需要应用到其上的安全级别。
　　虽然保护传统的网络不是什么新鲜事，但保护虚拟基础架构所带来的挑战可能是你之前从未面对过的。第一，你需要了解在资源池中——你的主机服务器的分组——将会出现哪些类型的挑战。第二，你需要学习你创建的用于运行你的虚拟工作负载的基础架构会否出现未知或不可预见的挑战。划分基础架构为物理机和虚拟机需要新的方法并对安全措施的认真反思。
　　但是，传统的安全措施仍然适用，即使你拥有2个不同的基础架构需要保护。要保护其中的每一个基础架构，你都必须实施一种将能够提供执行下列活动的分层保护系统：
　　▼识别进入每个基础架构的人员。
　　■为在每个环境中工作的人员确认适当的许可级别，一旦通过确认就为他们提供适当的访问权限。
　　■确认修改数据的人就是有权修改数据的人（不可撤销或不可否认性）。
　　■一旦信息存储到你的基础架构中，要保证它的保密性。
　　■保证在你的基础架构中信息的可用性。
　　■确保存储在你的基础架构中的数据的完整性。
　　■监控每个基础架构内的活动。
　　■审计网络中的安全事件，安全地存储历史审核数据。
　　▲实施适当的管理活动，以确保网络的各个级别各个时刻都是安全的。对于其中的每一个活动，有各种不同的相互作用范围。
　　▼本地　人们在本地级别与系统进行交互操作；这些系统必须受到保护，无论它们是否已连接到网络。
　　■企业内部网　人们与远程系统进行交互操作。这些系统也必须时刻受到保护，无论它们是位于局域网（LAN）或广域网（WAN）。
　　■因特网　被认为是公共的系统，也必须受到保护以免受所有类型的攻击。这些是更糟糕的情况，因为它们暴露在内部网络的边界之外。
　　▲企业外部网　这些系统通常被视为内部的，但暴露给合作伙伴、供应商和/或客户。企业外部网和因特网系统之间主要的区别是身份验证——虽然在因特网系统上可能存在身份识别，但访问企业外部网环境总是需要身份验证的。
　　无论是哪种网络，安全是一项依靠3个关键要素的活动（与所有的IT活动一样）：人、PC和流程。
　　▼人　是安全过程的执行者。他们也是它主要的用户。
　　■PC　代表技术。它们包括一系列的工具和支持安全过程的组件。
　　▲流程　是由工作流组成的模式、程序和安全应用的标准。
　　这3个要素的结合将有助于你设计一个适用于你的整个组织的安全策略。
　　



　　13.1　城堡防御系统
　　制定一项安全策略的最佳方法是使用一种模型。我们十多年来一直依靠的模型是城堡防御系统（Castle Defense System，CDS）。在中世纪时期，人们需要设计一种主要基于堆积障碍物来防止进入的防御系统来保护他们自己和他们的财产，或者就像我们今天所说的——深度防御。应该采用与你保护你的物理网络环境相同的方式来保护你的虚拟环境。使用城堡作为例证是因为几乎所有的人从“用户到技术人员以及管理人员”都对其相当熟悉。
　　注意：要了解更多关于Castle Defense System（城堡防御系统）的详细信息以及你如何将它应用于虚拟工作负载中，请参阅《Microsoft Windows Server 2008：The Complete Reference》一书，由Ruest和Ruest编著（McGraw-Hill 2008年发行）。
　　IT防御系统应该采用与CDS相同方式进行设计。正如CDS一样，IT防御系统需要多种保护层。实际上，5个保护层似乎是适当的。从内部开始，你将会发现：
　　▼第1层：关键信息　系统的核心是你寻求保护的信息。这就是所谓的信息库。
　　■第2层：物理保护　对于信息系统，安全措施应始终以物理保护级别来开始。这是与城堡本身进行比较。
　　■第3层：操作系统强化　一旦已经实施物理防御，你就需要对每台计算机的操作系统进行“强化”，以尽可能地限制潜在的攻击面。这相当于庭院。
　　■第4层：信息访问　当允许你访问你的数据时，你需要确保每个人都是已通过身份验证、已授权和已审核的。这些相当于城墙和你在其中打开的门。
　　▲第5层：外部访问　最后一层的保护涉及外面的世界。它包括外围网络及其所有的防御。这相当于你的城堡的护城河。
　　这就是城堡防御系统（见图13-1）。为了成为一个完整的安全策略，它必须补充2个元素：人员和流程。这两个元素围绕着CDS，完成它所代表的安全策略描述。
　　图13-1　城堡防御系统的5个层次
　　13.1.1　资源池与虚拟服务或产品
　　当运行虚拟基础架构时，面临的挑战是确认如何区分安全级别。虚拟服务或产品（VSO）将运行所有与你的最终用户进行交互操作的网络化服务。因此，当你承担建立和设计这些服务时，传统的安全措施仍然适用。事实上，用户与虚拟机而不是物理机进行交互操作不会改变在此基础架构中所有级别对严密安全的需求。
　　你需要做哪些更改来保护资源池。由于其本质，资源池并不需要与用户进行交互操作。它们只不过是运行虚拟化引擎的主机服务器。因此，它们只由管理员和技术人员进行处理。运行Microsoft Outlook的最终用户将永远不会与资源池本身有任何的交互操作。相反，最终用户将与一些运行Active Directory（活动目录）、Microsoft Exchange和协作引擎如Microsoft Office SharePointServer等不同的虚拟机进行交互操作。由于这些机器全部都是虚拟的，所以用户和主机服务器之间不存在直接的交互操作（见图13-2）。
　　图13-2　用户与资源池和虚拟服务或产品的交互
　　因此，你应考虑同时为资源池和虚拟服务或产品创建隔离的安全上下文（见图13-3）。通过分离安全上下文，你可以确定不可以从一个环境渗透到另一个环境。例如，如果你使用了2个完全不同的安全上下文，来自VSO环境的最终用户将不会对资源池进行访问。
　　图13-3　资源池和虚拟服务或产品之间隔离的安全上下文
　　通常是用你运行网络服务的特有技术实现安全上下文隔离。例如，许多组织依靠Windows在虚拟工作负载中运行用户生产力基础架构。如果这是实际情况，并且你已经决定使用Citrix XenServer或VMware Virtual Infrastructure（ESX或ESXi服务器），那么隔离将会自然发生，因为这2个hypervisor是运行在修改过的Linux基础架构上。但是，你需要确保你不会实施支持集成Windows和Linux之间安全上下文的技术。例如，你可以在活动目录与Linux的安全上下文之间创建一个Kerberos领域。这将允许你可以在2个网络之间使用单点登录。但由于目标是保护主机服务器免受最终用户的访问，所以你将有意识地确保这些技术没有以这种方式连接到一起。
　　如果你使用Linux交付你的虚拟服务或产品，并且你使用了Citrix或VMware的hypervisor，那么你就会遇到类似的情况——如果你使用Windows建立VSO，使用Hyper-V作为hypervisor。在这种情况下，这2个环境使用了相同的技术来提供安全上下文。因此，你需要有意识地创建分离的安全上下文来保护主机服务器的访问。例如，在Windows中，你将创建一个活动目录（AD）林用于你的生产用户，创建另一个用于你的资源池。这2个目录林不会被链接到一起，时刻都保持分离。此外，虽然你用于生产的AD目录林很可能拥有复杂的组织单位（Organization Unit，OU）结构，但你创建用于资源池的目录林应该是一个实用的目录林，因此，应该依靠最基本的OU结构。
　　13.1.2　保护资源池的安全
　　由于你将使用隔离的安全上下文，所以你需要采取双管齐下的方法来设计你的CDS。如先前所述，用于VSO的CDS应该类似于你已经沿用至今的标准防御机制，因此，在这里不需要太多的深入介绍。
　　相反，你需要侧重于创建一种用于资源池本身的城堡防御系统，因为这对于你和你的团队是一项新的活动。这个池必须包含严格的保护策略，因为通过它就可以很容易偷走整个虚拟机。持有iPod和有机会接近虚拟机的任何人都可以轻易地将它们复制，并把它们带走。
　　因此，用于资源池的CDS需要特别注意在表13-1中级别确认。
　　资源池是IT中的一个新概念，因此，当涉及它们安全设置的实施时，需要特别注重细节。你需要确保你已经了解你需要应用到此基础架构的保护范围（见图13-4）。此范围将只需处理数据中心内的主机服务器（最好是刀片或机架安装式服务器）、远程办公室中集成全部功能的服务器、用于控制主机的计算机以及作为控制台用于访问主机服务器管理接口的计算机。最后一组计算机可以是以虚拟机冗余配置运行管理服务器的虚拟机，使用虚拟桌面绑定到资源池的安全环境，以连接到管理界面。
　　图13-4　资源池的保护范围
　　13.1.3　保护虚拟服务或产品的安全
　　虚拟服务或产品也将需要CDS的应用程序。但在这种情况下，你需要把重点放在所有生产网络中的安全元素。因此，表13-2提供的已确认的项目仅用于你的审阅，因为涵盖对生产网络安全设置的全面实施已超出了本书的范围。但是，你可以依靠此表作为一种清单，确认应当如何处理生产网络的安全。
　　虚拟服务或产品在安全设置方面比资源池需要更多的保护，因为它们旨在与最终用户进行交互操作，因此，会有更多的服务内置到基础架构中。VSO的保护范围将取决于你组织的规模。某些安全技术被预定用于资源池，同样地某些被预定用于虚拟服务或产品。例如，在资源池中几乎不需要运行数字权限管理，因为这一基础结构并不是生产性网络。当你审阅你的虚拟机提供给你的用户的服务的安全设置时，请记住这一点。
　　



　　13.2　将城堡防御系统应用到资源池
　　要解决资源池的安全，所有你需要做的就是遵循表13-1中的准则。一层接一层地解决城堡防御系统的每一层，确保资源池尽可能的安全。安全措施将基于你所选择要运行的hypervisor会有所不同。它们还将基于你所完成的虚拟化的水平而有所不同。例如，如果你仅使用服务器虚拟化，那么你将只需要保护环境和构成它的虚拟机的安全。如果你已选择使用桌面虚拟化，那么你将需要保护核心虚拟机的安全，因为你应该使用非永久性的并且可以分派给任何用户的只读桌面虚拟机。如果你正在使用应用程序虚拟化，取决于你是否正在使用基于代理的或无代理的应用程序虚拟化（AppV），你将需要考虑该如何确保安全并保护虚拟应用程序。
　　以下各节将讨论每个问题。
　　13.2.1　第1层：关键信息
　　首先以你需要保护什么来开始。在资源池方面，你需要保护2个数据层。
　　▼在VSO网络中构成每个虚拟机的虚拟磁盘驱动器。这包括在线和正在运行的计算机、离线计算机、虚拟设备（VAP）或虚拟机模板，以及任何其他的虚拟机容器。
　　▲包含在管理数据库中的数据。你用于存储此数据的数据库引擎将会有所不同，这取决于你所选择运行的hypervisor，但几乎每个hypervisor管理引擎都依靠数据库来存储信息，如设置文件、绑定到虚拟机的策略、主机配置设置等。
　　需要特别注意的：
　　13.2.1.1　保护虚拟磁盘驱动器
　　保护虚拟磁盘驱动器意味着不仅要保护构成你的虚拟机的.vhd文件或.vmdk文件。你还必须保护配置文件、快照文件、日志文件以及在你网络中任何可以组成虚拟机的其他文件。这还将包括任何的模板或你以开放虚拟化格式（Open Virtualization Format，OVF）获取的虚拟设备，以及企业内部创建的VAP，例如基于Windows的虚拟机模板。它还将包括你用于存储源操作系统和其他服务器技术的ISO文件。
　　在大多数情况下，虚拟机和相关的文件都将位于以下6个不同类型的容器中。
　　▼位于数据中心的服务器虚拟机将驻留在某种形式的共享存储中。无论你使用网络附加存储（Network Attached Storage，NAS）还是使用存储区域网络（Storage Area Network，SAN），存储容器的引擎将提供技术和功能以支持数据的保护和安全。
　　■位于远程站点的服务器虚拟机将驻留在一台集成全部功能的服务器中，同样也应该使用共享的存储。依靠存储基础架构的功能来保护内容。
　　■共享的内容，如ISO镜像和源软件通常都包含在一个库文件共享中。对于VMware和XenServer，通常是一个网络文件系统（Network File System，NFS）的共享，但同时也可以使用通用网络文件系统（Common Internet File System，CIFS），这通常可以在Windows中找到。在这2种情况下，确保磁盘是以相当于新技术文件系统（New Technology File System，NTFS）的格式进行格式化，并提供严密的文件共享权限。此容器还可能存储脱机虚拟机或OVF文件。请务必为包含这些文件的文件夹提供严密的保护。
　　■单元和功能测试以及开发的虚拟机可以存放到外置USB磁盘驱动器中。如果你在Windows上运行你的测试和开发环境，至少应使用NTFS来格式化驱动器。你还可能考虑使用加密文件系统，以进一步保护这些驱动器中的内容。
　　■数据保护策略包括备份虚拟机和创建虚拟机快照。这些应集中地保存在数据中心内，并应在共享存储托管，以提供最高的安全级别。如果你备份到磁带，确保脱机存储库是绝对安全的，就像你传送到存储区的方法。
　　▲对于虚拟机，业务连续性策略包括从一个位置到另一位置的复制，通常是从核心数据中心到远程备份数据中心。确保你在2个数据中心内实施相同或类似的安全策略。
　　任何时候都可以进行虚拟机器的转移。此外，虚拟机是自成一体的，并且通常会包含高度敏感的信息的，例如密码和访问权限。如果有人能够在你不知情的情况下偷走你的虚拟机，那么他们可以在任何地方慢慢来破译它们，并发现你最严密的秘密。确保你的管理人员是完全值得信赖的，以保护此类信息。
　　13.2.1.2　保护管理数据
　　每种hypervisor管理系统都运行在数据库上。VMware VirtualCenter可以运行在Microsoft SQL Server或Oracle数据库上。它还可以使用Microsoft SQL Server 2005速成版，但这个引擎最多只支持5个主机服务器的生产环境。Microsoft System Center Virtual Machine Manager（系统中心虚拟机管理器）也需要一个数据库，由于这是Microsoft的产品，因此数据库运行在SQL Server中。
　　Citrix XenCenter是例外的情况。它不需要依靠数据库。相反，它将所有的配置数据存储到每台主机上的扩展标记语言（Extended Markup Language，XML）文件中。当你建立资源池时，主机配置文件被集合在一起，或者通过主/从关系用高可用性配置将服务器连接在一起。这类似于传统的主/从域名系统（DNS）服务器的关系。由于每台主机都包含了所有资源池配置文件的副本，所以当其他主机中的一台出现故障时，它可以作为主服务器。
　　当通过hypervisor的管理工具直接运行hypervisor时，例如，在VMware中通过虚拟基础架构客户端或者在Windows中通过Hyper-V管理器，你不需要使用数据库，因为设置是位于单独的主机服务器上。与XenCenter不同，这些文件不会从一台计算机复制到另一台，但如果你想要这样做，你就可以轻易地做到。
　　将管理数据集中到一个数据库中，只要你确保此数据库始终保持高度可用，那么这样做就是有意义的（见第15章）。但是，从数据安全性的角度上看，有2个方面你必须考虑。
　　▼你必须确保只有适当的人员才能获得访问管理数据库中数据的权限。此外，在2个层次上保护你的数据。第一，它通过与你用于文档的相同的机制来保护它，因为数据库跟文档一样以文件形式存储信息。第二，通过用于存储信息的数据库系统的功能来保护它。
　　▲你还必须确保你的数据库引擎的安装是已强化的和受保护的。特别是SQL Server的漏洞已经广为人知。当然，Microsoft在其2005年和2008年发布的版本中已经做了大量的工作来加强SQL Server的安全，但这不是你不确保数据库引擎的安装和配置为尽可能严紧的理由。
　　无论数据是在分布式存储库中，还是在等中式数据库中，都要确保它时刻都受到保护。
　　注意：有关SQL Server安全最佳实践的详细信息，请访问：download.microsoft.com/download/8/5/e/85eea4fa-b3bb-4426-97d0-7f7151b2011c/SQL2005SecBestPract.doc。你也可以依靠Mi-crosoft基准安全分析器检查你的SQL Server的安装（http://technet.microsoft.com/en-us/security/cc184924.aspx）。有关Oracle数据库安全最佳实践的详细信息，请在访问Oracle安全技术中心：www.oracle.com/technology/deploy/security/index.html。
　　13.2.2　第2层：物理保护
　　安全的第二个层次就是对你的计算系统的物理保护。物理保护涉及各种问题。一台位于某区域办事处楼梯底下的物理服务器不会被视为是受到了任何方式的保护，当然，除非它是存放在一个适当的系统机架中，类似于由Kell Systems（www.kellsystems.com）所提供的产品。
　　正如你所想象，这一层主要适用于资源池，但它还可以扩展到你的PC或者任何有权限连接到你的网络的物理系统，即使它们只是与VSO进行交互操作。当然，由于大多数组织是从物理基础架构迁移到虚拟基础架构，所以这一层中的大部分元素你应该已经熟悉，并且你应该已经部署了它的大部分元素。
　　在物理保护层中你需要涉及的元素包括：
　　▼地理位置　你的建筑物的物理位置是否处于环境濒危的地点？是否会有洪水、雪崩或者可能会影响你做生意的建筑物坍塌的可能性？建筑物是否靠近可能会受到事故影响的马路？
　　■社会环境　你的技术人员是否清楚地明白物理访问到的任何计算机设备都应时刻受到保护？他们是否意识到在任何情况下他们永远不应泄露密码？
　　■建筑安全　你们的楼宇安全吗？入口有监控吗？访客出入所有地点是否经过确认吗？任何时候都有人员陪伴着客人吗？不受管理的计算机设备允许进入你们的建筑物内吗？建筑的电气输入是否受到保护；是否有专门针对数据中心的备份？大楼的空气调节是否受到保护；它是否有备份系统？所有的建筑物是否具有良好的防火保护计划？建筑内部和外部的布线是否安全？无线辐射是否安全？
　　■建筑结构　建筑的结构是否安全？你的数据中心的墙壁能否防火？数据中心的门是否防火？地板是防静电材料吗？楼宇内是否有发电机，它是否处于安全和受保护的位置？计算机房是否保护通信设备和计算机设备？建筑物是否有安全摄影机以协助监控？
　　■服务器安全　服务器是在被锁上的房间内或者所有地点的服务器柜是否已上锁？访问服务器机房是否受到监控和保护？服务器本身是物理安全的吗？访问物理服务器是否受控？Windows Server 2008的管理员账户支持智能卡的使用。在高度安全的环境中，你应该为所有的管理员分配智能卡。使用新的低成本的智能卡，特别是USB智能卡，几乎没有理由不执行这项策略。
　　■BIOS安全　所有的计算设备在BIOS级别应该具有某种形式的保护。对于物理主机服务器，这还应包括开机密码。对于所有的系统，BIOS设置应该受到密码保护，像所有的密码一样，这些密码应该受到高度的保护并定期进行修改。新的桌面管理接口（Desktop Management Interface，DMI）管理工具允许对BIOS密码进行集中管理。
　　■寄存安全　所有的物理安全策略是否扩展到安装有物理系统的寄存房间？当寄存设施是安全开放的，那么它不可以作为高度安全的计算机房间。请注意，比起传统的系统寄存，使用内置的hypervisor来寄存主机服务器可以花费更少的时间，但无论你是运行Microsoft Hyper-V还是仍旧建立物理的计算机，你都将需要一个安全的、受保护的寄存区域。
　　■PC安全　工作站和移动设备是否受到保护？移动设备是否使用了硬件识别系统，如生物识别和智能卡？设备在运送的时候，移动设备上的数据是否受到保护？从移动设备到内部网络的外部连接是否受到保护？你是否有控制恶意USB设备的连接？
　　■网络安全　网络及其服务是否受到保护？例如，是否会出现有人引入恶意动态主机配置协议（Dynamic Host Configuration Protocol，DHCP）服务器的可能性，在Windows Server 2008和Windows 2000/2003中，DHCP服务器必须获得授权才能分配地址，但是只有当它们是基于Windows的DHCP服务器时。是否存在无线网络？它是安全的吗？恶意无线用户能够渗透网络吗？
　　▲冗余　你的关键系统是否具备冗余？这应该包括所有的系统——数据系统、消防、因特网和WAN连接、空调、电力等。
　　必须对你安装的物理设备的所有方面进行维护和记录。此外，必须将适当的物理保护计划传达给各级员工。但是请注意，主机服务器系统将不需要进行用户交互操作，因此，可以从一般终端用户沟通计划中删除，但对于技术人员和管理员需要保留。
　　最后，物理保护必须辅以监控计划。重申一遍，这一部分可以由各级人员来进行。每个员工必须意识到，他们可以而且应该参与对任何可疑活动的监控，或者任何可能会损害你的信息系统的不良事件的通知。
　　13.2.3　第3层：操作系统强化
　　操作系统强化的目的是减少你的服务器和个人计算机的攻击面。为此，你需要移除系统上不必要的东西。对于运行裸机hypervisor的主机服务器，此强化过程十分简单，因为hypervisor已经实行了精简，只保留了基本的组件。
　　但是，主机服务器的基础结构包括了多个不同的组件（见图13-4）。
　　▼hypervisor，就像是在每个主机上的裸机操作系统（OS）
　　■控制台系统，大多数情况下运行在Windows服务器上
　　■桌面或远程系统管理员通过管理客户端使用和访问控制台
　　■存储关于资源池的配置和策略信息的数据库或文件存储库
　　■用作存储所有虚拟机的存储容器
　　■存储所有资源和ISO文件的文件共享
　　▲用于在资源池中分配管理角色的安全上下文
　　而且，正如先前所提到的，根据你所运行的hypervisor的类型每个元素的结构将有所不同。但无论你运行哪一种系统，你应该考虑下列构成资源池基础结构的每一个组件：
　　▼系统安全配置
　　■反恶意软件策略
　　■目录服务安全
　　■文件系统安全
　　■打印系统安全
　　■NET框架安全（在Windows中，尤其是使用PowerShell）
　　■Web服务器安全性
　　▲系统冗余
　　对于资源池，这些元素需要特别注意。
　　13.2.3.1　主机服务器的系统安全配置
　　系统安全配置涉及在计算机执行过程中安全参数的应用。当你安装一台机器，尤其是服务器时，你需要执行一些对默认安装的修改，以确保你的计算机受到保护。
　　对于VMware ESX服务器，此操作相对简单；只需在安装过程中设置Security=high，那么它将自动配置hypervisor为安全模式。这是VMware ESX的默认安装设置。它自动加密所有进出服务器的通信、用户名称，密码永远不会以明文形式发送，不允许通过FTP访问服务器。
　　对于Citrix XenServer，你必须通过标准Linux安全实践来强化主机操作系统的安全。对于Microsoft Hyper-V，你必须首先确保你在主机上安装Server Core，然后尽可能通过标准Windows安全实践来强化此装置的安全。幸运的是，Windows Server 2008本身在强化操作系统安全方面已经做得很好，尤其是Server Core，因为它只安装了最基本的组件——包含Hyper-V角色的完整安装，小于2.6 GB——然后可以向服务器添加所需的角色和功能。由于它是Server Core，它没有包含.NET Framework（框架）或者默认的Internet Information Services（互联网信息服务），还不包含任何的图形用户界面组件，如Microsoft IE浏览器或Windows媒体播放器。
　　此外，Citrix XenServer和Windows Server 2008的安装都是真正的64位操作系统，其中，在默认情况下，包含有额外的安全组件。然而，只有32MB的VMware ESXi已受到严格的控制，尽管它是一个32位的引擎。
　　由于Windows Hyper-V和Citrix XenServer运行在更完整的操作系统上，所以你还应该在每种服务器上执行2项额外的设置。
　　▼第一，执行一些安装后的安全配置修改。
　　▲第二，根据服务器角色将安全模板应用到服务器。在Windows中，此系统配置过程的第二部分可以依靠安全配置向导（Security Configuration Wizard，SCW）自动将安全设置应用到基于其角色的系统中。在Linux中，你可能需要使用第三方安全配置工具来加强安全设置。
　　尽可能地加强操作系统的安全，以充分保护主机服务器。
　　注意：若要了解更多关于保护Hyper-V主机安全的信息，请参阅由Ruest和Ruest合著的《Microsoft Windows Server 2008：The Complete Reference》一书的第10章（McGraw-Hill，2008年发行）。若要了解更多关于保护ESX Server安全的信息，请参阅《The Top 10 Recommendations for Improving Vmware ESX Security》：（提高VMware ESX安全的10大建议），地址为：http://blogs.vmware.com/vmtn/2007/02/top＿10＿recommen.html。
　　13.2.3.2　控制台服务器的系统安全配置
　　控制台服务器大多数在运行Windows Server之上。理想情况下，你使用Windows Server 2008（WS08），因为它是Microsoft已经发布过的最安全的服务器操作系统。但是，由于此服务器是一台Windows服务器，所以你应该执行最小安装并尽可能不要向服务器添加任何额外的角色。如果你正在使用WS08，你还将需要执行一个完整的安装，因为控制台组件需要图形组件的安装。
　　在这种情况下，你应当使用安全配置向导进行安全配置，加强所有服务器组件的安全。移除或者至少禁用无用的服务。SCW是保护Windows服务器安全的最佳的工具，因为它对每个你选择要启用或禁用的项目提供了完整的信息，让你明白你到底在做些什么（见图13-5）。此外，你可以使用SCW创建模板，将相同的更改应用到其他的你需要创建或安装的控制台服务器。
　　图13-5　Security Configuration Wizard（安全配置向导）对于其应用的每个安全元素提供了大量的信息
　　如果你不熟悉它，你可以在审计模式下运行SCW。这样做可以使你更好地了解它的工作过程，不会对系统进行任何实际的更改。然后，当你对这个工具已经比较熟悉后，你就可以使用它来加强你的Windows服务器的安全。
　　注意：若要了解更多关于安全配置向导的信息，请访问http://technet.microsoft.com/en-us/library/cc771492.aspx。
　　13.2.3.3　反恶意软件策略
　　关于运行反恶意软件已经谈了很多，包括主机系统上的防病毒软件。如果你正在运行Hyper-V或XenServer，你应为Windows或Linux考虑一套标准防病毒程序。包含完整系统的操作系统都必须运行这种类型的保护，即使它会影响系统性能。
　　如果你正在运行ESX Server，那么就应该运行VMsafe。VMsafe直接运行在ESX hypervisor上，并为运行在其之上的公用防病毒和反恶意软件工具提供应用程序编程接口（见图13-6）。由于它运行在hypervisor之上，所以你不需要在虚拟机内添加反恶意软件或防病毒技术。你放置在使用VMsafe的hypervisor上的VM都将自动受到保护。VMsafe扫描VM的关键组件，如内存、CPU、网络和磁盘资源。为了防护，它甚至会扫描内部VM进程。
　　图13-6　VMware的VMsafe直接运行在hypervisor之上，为所有的VM提供全面的保护
　　VMsafe提供了一种新的方式保护VM。例如，如果你在hypervisor上运行带有合适的防病毒引擎VMsafe的虚拟机中运行控制台系统，那么在控制台VM内你不再需要添加防病毒引擎的系统开销。这极大地方便了VM的创建，可以为VM提供持续的保护。
　　注意：要了解VMsafe的更多信息，请访问www.vmware.com/overview/security/vmsafe.html#。请注意在本书编写的时候VMsafe尚未可用。
　　事实证明VMsafe模式是如此的引人注目，以致Linux发行版本中的Xen虚拟化组件的开发人员也正在开发类似的功能。此功能应会在将来发布的基于Xen的hypervisor中提供。
　　13.2.3.4　文件和打印系统安全
　　文件系统也是操作系统安全加强的一部分，以支持一个安全的环境。如果你正在运行Windows，那么就必须使用NTFS。尽管据报道它存在一些缺点，但毫无疑问NTFS是绝对必要的，它是城堡防御系统的一大支柱。没有NTFS，就没有加密。在Linux中，你必须运行一种安全的文件系统。
　　安全文件管理重要的方面之一是当未经授权的更改发生时，要能够记录所有文件的变更并提醒组织。这可以以某种文件访问审计的方式实现，但对于关键的数据文件，专业的帮助是必要的。此帮助可以来自如像Tripwire for Servers这样的一个实用程序（www.tripwire.com/products/
　　servers）。Tripwire监控所有的文件变更，甚至也监控文件的校验属性。因此，它可以在关键文件已被未经授权人员修改时通知管理员。
　　此外，在Windows Server 2008中NTFS的安全性已经得到了很大改善。NTFS使用继承概念来应用访问权限。为了稳定的目的，它还可以将强大的安全设置应用到用户组中。这意味着用户可以不再担心运行旧版的应用程序会修改如位于Program Files和Windows敏感文件夹中的文件。管理员需要采取特别的措施，确保旧版应用程序能运行在Windows Server 2008系统的普通用户中。
　　WS08还包括Windows Resource Protection（Windows资源保护），这是一个当发生由软件安装或其他突发事件导致的损坏时，用于修复系统文件和注册表项目的功能。可以在WS08的帮助系统中找到这些功能的详细信息。
　　请确保所有的文件存储库都是通过支持它们操作系统的最佳功能来进行保护。
　　至于打印系统，很少需要为主机基础架构内的打印系统加强安全，因为所有的VM通信都是通过远程桌面连接（Remote Desktop Connection，RDC）来进行，你只需简单地设置RDC，就可以将你自己桌面的打印机连接到远程系统（见图13-7）。这意味着在保护主机基础架构安全方面你可以少一层考虑。
　　图13-7　使用远程桌面连接设置，你可以连接本地打印机到任何的会话
　　13.2.3.5　目录服务安全加强
　　由于控制台运行在Windows之上，许多组织发现可以容易地在资源池中配置一个Active Directory（活动目录），以提供集中式的访问控制。那么如果你运行的是Hyper-V，那么即使是在Server Core上，你也需要实施一个活动目录域服务（Active Directory Domain Services，ADDS）目录。
　　在任一种情况下，你应该创建一个所谓的实用程序目录。实用程序目录使用一个简单的森林结构，通常包括单个根域。由于没有用户与此目录进行交互操作——只有管理员和技术人员——所以你可以在主机环境中运行实用程序目录，因为你不需要为在此目录中根级别的访问提供保护。
　　在诸如VMware ESX Server的hypervisor中，你可以依靠实用程序目录为控制台组件提供基于角色的访问控制。只需在ADDS中创建一系列不同的安全组并给每个组分配VirtualCenter所支持的不同角色（见图13-8）。然后，通过Groups命令将你的ADDS安全组与控制台中的角色关联起来。VMware提供了基于角色组的精细控制（见图13-9）。
　　图13-8　VMware VirtualCenter提供了多个默认的访问角色
　　图13-9　在VirtualCenter中配置自定义的访问角色
　　Citrix XenServer hypervisor还没有（至少在写作本书时）支持基于角色的访问控制，所以它要使用实用程序目录，只有在你的存储容器运行Windows并且你想要集中存储容器访问控制时才有用。
　　Windows Hyper-V必须运行在实用程序目录内；否则，所有的访问角色将被包含在工作组中，位于每个独立的主机服务器上。因此，你必须通过ADDS集中主机服务器的访问权限。使用目录的最简单的形式，但在ADDS安全中继续使用最佳实线。一旦此目录是可用的，你将能够为系统中心虚拟机管理器（System Center Virtual Machine Manager，SCVMM）映射用户角色。但是，你需要通过Windows服务器管理器的本地用户和组功能来配置用户角色（见图13-10）。与任何的Windows基础架构一样，成员服务器通过已绑定到相应的目录组的本地组来控制访问。
　　图13-10　通过Windows Server Manager管理SCVMM中的角色组
　　注意：要了解更多关于实用程序ADDS目录安全的信息，请参阅由Ruest和Ruest合著的《Microsoft Windows Server 2008：The Complete Reference》一书的第5章（2008年由McGraw-Hill发行）。
　　当建立实用程序目录时，有以下几种原因，你可以考虑将此角色放置在运行着控制台服务的相同的服务器上。
　　▼第一，如果它们正在运行虚拟机上，控制台服务器应设置为自动启动，这样只要你的主机服务器启动完成，你就立即可以访问基础架构管理工具。实用程序目录服务也要设置为自动启动，以确保它启动时，你可以登录到环境中。
　　■第二，你想要在你的基础架构中运行的Windows服务器的数量——至少如果你不使用Windows hypervisor——以保持尽可能安全的环境。通过将管理和目录角色同时放在相同的服务器上，可以将你所需的Windows VM的数量降至最低。
　　▲第三，通过将这2个服务集成到一起，由于目录通信将变得直接，所以在身份验证方面你将获得更快的处理能力。
　　有一个缺点就是你必须在管理控制台中授予本地登录访问一些较受限制的角色。然而，在你的网络中你可能甚至不再需要受限的角色，所以这一问题很可能是毫无意义的。
　　13.2.3.6　最终的操作系统安全加强动作
　　要完成你的操作系统的安全加强，还需要额外的活动。首先包括更新和补丁程序。虽然很少更新hypervisor——是的，即使如果你在Server Core上运行Hyper-V——你必须为它们准备就绪提供适当的修补基础架构。这就是为什么你必须为你的主机服务器建立系统冗余的一大原因。如果你需要一台主机服务器执行维护但维修需要重新启动系统，那么在维护期间你必须能够将你的VM转移到另一台主机上。
　　如第7章所述，VMware依靠Update Manager（更新管理器）提供其可以同时更新hypervisor和它所运行的虚拟机的基础架构（见图13-11）。Update Manager支持Windows和Linux的客户操作系统以及它们所运行的应用程序。首先，你在Update Manager中创建基线修补级别。然后，一旦为主机服务器和虚拟机都创建好基线，Update Manager将确保机器为已被更新以满足基线。为了进一步保护虚拟机的状态，在进行更新之前，Update Manager将自动为工作中的虚拟机创建快照，如果出现差错，让你可以轻松地返回到更新前的状态。
　　此外，Update Manager可以修补没有暴露到网络的离线虚拟机。为此，离线虚拟机启动为一种孤立的模式，以确保一旦它们正在运行更新过程，它们不会影响生产机器。然而，自动更新离线机器的能力是虚拟化实施必不可少的组成部分，因为只有在这种情况下，你将会拥有特定机器的多个副本。
　　图13-11　VMware Update Manager将同时更新hypervisor以及它所运行的虚拟
　　为了保护hypervisor和它们所运行的工作负载，Update Manager将与VMware的分布式资源调度程序（Distributed Resource Scheduler，DRS）协同工作，在将补丁程序应用到当前主机之前，将虚拟机工作负载转移动到其他的主机上。一旦新近已修补的主机恢复并运行，它会将虚拟机转移回原处。Update Manager是VMware的虚拟基础架构每个版本必有的一部分，因为它为虚拟机和主机提供了关键的功能。
　　Citrix XenServer通过XenCenter管理界面包含了类似的能力。池范围补丁程序将自动通过Citrix网站进行检查，查看是否有可用的XenServer补丁程序，如果有补丁程序可供使用，在修补之前会以与VMware Update Manager类似的方法使用XenMotion将虚拟机从主机上移开。池范围补丁程序是通过一个向导引导你一步一步地完成。然而，此功能只适用于XenServer主机，不适用于它们所运行的虚拟机。对于虚拟机修补，你需要转向第三方解决方案。
　　Microsoft依靠免费的Windows服务器更新服务（Windows Server Update Services，WSUS）同时修补主机和虚拟机。如果你在XenServer上运行Windows虚拟机也将需要WSUS，因为XenServer不能对虚拟机进行修补。WSUS为不同的机器类型维护一个基线补丁程序级别的数据库。机器通过每个Windows版本内的Windows Update客户端按照你设置的日程安排进行补丁更新。Microsoft还提供了其他支持补丁程序的产品，如为中小型企业提供的System Center Essentials或为大型公司提供的System Center Configuration Manager（系统中心配置管理器）；但WSUS是免费并且具有良好的伸缩性，所以它可能正是你所需要的。
　　WSUS也可以与Microsoft离线虚拟机维护工具（Microsoft Offline Virtual Machine ServicingTool，OVMST）一起工作，其中汇集了一系列与System Center Virtual Machine Manager协同工作的PowerShell脚本来启动离线虚拟机，创建快照，通过WSUS对其进行更新，然后将其关闭（见图13-12）。OVMST依靠维护主机维修离线虚拟机。维护主机用于在离线修补过程中避免对运营主机工作负载产生任何的影响。
　　图13-12　离线VM的维护过程
　　注意：可以在http://technet.microsoft.com/en-us/wsus/default.aspx连接中找到更多的关于WSUS的信息。要了解更多有关离线虚拟机维护工具的资料，请访问http://technet.microsoft.com/en-us/virtualization/default.aspx。
　　注意：因为XenServer用Microsoft虚拟硬盘（VHD）格式运行虚拟机，所以Microsoft离线虚拟机维护工具也可以用于XenServer所运行的虚拟机。
　　最后，为了完成你的操作系统安全加强过程，你需要在所有的级别上实施冗余系统。系统冗余意味着将抗灾能力纳入到你的主机和管理服务器中，以及它们所提供的服务中。更多的讨论将涵盖在第15章中，通过高可用性群集为你建立额外的抗灾能力。
　　13.2.4　第4层：信息访问
　　第4层处理用户标识和允许它们在你的网络内操作的访问分配。对于内部网络其中最重要的是Kerberos安全协议。它具有许多优点，其中之一是它可以同时在Windows和Linux中运行。它最好的功能之一就是当用户通过身份验证后，用户就不需要返回到授权服务器。在Kerberos中，用户在Kerberos服务器授予的访问令牌权限内携带权利和许可。此访问令牌是在用户登录时以Kerberos票证的形式授予的。此外，服务器对客户端进行验证，确保它被授予在其权力范围内的用户访问权限。最后，Kerberos还支持双重身份验证。这种双重身份验证可以是智能卡或生物识别设备的形式，如指纹识别设备。
　　Kerberos领域的关键元素之一——Kerberos相当于Windows活动目录域——是时间戳。时间同步在Kerberos中是不可或缺的，因为身份验证服务器的内部时钟必须与客户端的请求时间吻合。如果时间差超过指定的时间——在你的账户策略中设置——Kerberos服务器将不会验证用户身份。
　　13.2.4.1　安全用户标识
　　用户标识发生在资源池网络中的多个层面上。最明显的身份验证是通过你创建的ADDS实用程序域。为此，你需要为实用程序森林和域设置全局账户策略。此外，在跨计算机的情况下会发生身份验证。本地主机机器的身份验证将有所不同，这取决于你所使用的hypervisor。使用VM-ware，主机机器身份验证是通过VirtualCenter集中处理并关联到实用程序目录中，这在先前已经讨论过。在XenServer中，主机机器身份验证是通过XenCenter将机器配置从主机复制到主机来集中处理。在Hyper-V中，主机机器身份验证使用成员服务器结构，并且可以通过该实用程序目录集中处理。
　　依靠hypervisor的基于角色的身份验证功能控制管理员和技术人员的访问权限。
　　13.2.4.2　通过组策略对象来保护第4层
　　管理身份验证、授权和审计的最佳方法是通过组策略，这是Active Directory（活动目录）的核心。例如，你可以通过组策略对象（Group Policy Object，GPO）来设置访问控制审计。你可以在实用程序域中修改默认的GPO，但作为一种最佳实践，最简单的方法是创建一个新的GPO，使用它加强实用程序域中所有对象的安全，跟踪管理员和技术人员在环境中的操作。
　　全面记录你所创建的每一个GPO，对任何的修改使用一种有组织的变更管理方法，对任何的访问控制结构你也应该做同样的事情。
　　默认的域策略是域账户策略。由于只能有一个策略可以包含账户信息，因此信息应定义在一个单独的区域中。使用此策略时一定要小心，因为它不能被停用。如果你编辑此策略时犯了错误，那么你将会影响整个域。这就是结构化组策略改变管理策略的原因之一。
　　账户策略中需要涵盖的元素已在表13-3中列出。此表中列出的元素来自Computer Configuration（计算机配置）Policy（策略）Windows Components（Windows组件）Security Setting Branch of GroupPolicy（组策略的安全设置分支）。再提醒一次，请谨记要记录所有你的GPO设置。
　　提示：Kerberos策略的所有设置都设置为默认的Windows Server设置，但了解默认设置的实际含义可以有助于你的组策略操作人员明确地设置它们。
　　所有这些设置都应用于域级别，以确保它们影响域中的每个对象。事实上，账户策略是一种计算机策略。这意味着可以禁用该GPO的用户配置部分。
　　提示：这对于确保你具有很强的通信程序让管理员和技术人员意识到在资源池网络中拥有一个全面的账户策略的重要性是非常重要的。此外向他们说明你在账户策略中的设置。最后，教育他们在密码保护方面的意识，当他们认为密码可能已经被盗用时，需要立即更新密码。这将确保使用资源池账户策略的那个人支持该策略。
　　13.2.5　第5层：外部访问
　　第5层通常关注的是外围网络和你的内部网络免受外部的影响。在今天的互联世界中，创建与外部世界完全断开的内部网络是不太可能的，即使是在处理主机网络时。例如，在紧急情况下管理员可能需要在家里进行工作。为此，你需要尽可能地确保内部资源池网络的安全，在任何人都可以进入之前，创建一个必须跨越的障碍。这一障碍可以采用多种不同的形式，但在资源池网络的情况下，这意味着是创立，还是继续的使用你的外围环境。这种环境，通常称为非军事区或者DMZ。
　　外围网络可以包含任意数量的组件，但在资源池的情况下，它们可以被限制为一系列保护你的内部网络的防火墙，而且它们不应该包括和控制因特网服务器或外部网络服务。
　　资源池并不涉及外围网络，因为它们不与用户进行交互操作，不提供任何与用户相关的服务。不过，它们与远程管理员进行交互操作。此级别的交互操作，你必须使用安全套接字层（Secure Sockets Layer）或者基于IP安全（IP Security，IPSec）的虚拟专用网络连接。你还将需要一个公钥基础架构以支持SSL，因为SSL通信是通过服务器证书来验证的。对于服务器到服务器的通信，你还应确保任何远程站点都将使用IPSec，特别是复制虚拟机镜像时。你还可以确定你需要实施网络访问保护（Network Access Protection）以确保任何连接到资源库的系统在安全补丁程序方面始终是最新的并且受到反恶意软件的保护。
　　虚拟服务或产品，因为它们是生产力的重点，将涉及外围网络，因此需要在多个级别进行保护。VSO的外围网络可能包括服务的主机，但它们通常包括：
　　▼在你的工作场所外活动的移动终端用户的远程连接
　　■针对合作伙伴组织的联盟服务
　　■针对任何想要连接到网络的系统的Network Access Protection（网络访问保护）
　　▲公共密钥基础架构，为你在外围的应用程序提供保护，以及对智能卡部署的支持
　　由于资源池只与管理员进行交互操作，因此VSO中的实施水平比起资源池中的更加全面。
　　警告：由于你的外围网络由虚拟机组成，所以你应该依靠你的hypervisor内部的设置来创建虚拟LAN，分隔属于你的VSO网络每一部分的虚拟机。你还可以考虑将外围机器放置在特定的主机服务器上，确保它们永远不会与来自内联网区域的机器混合。
　　13.2.5.1　使用Windows Server防火墙的高级安全设置来保护Windows服务器
　　在外围环境中你必须使用的第一个工具——与你网络的任何区域中的所有服务器一样——就是高级安全的Windows服务器防火墙（Windows Server Firewall with Advanced Security，WSFAS）。Windows防火墙已内置到每个Windows版本中，在默认情况下已经安装。事实上，当你安装WS08的时候，Windows防火墙已设置为拒绝所有的远程访问。然后，当为你的服务器配置角色的时候，你可以修改默认防火墙策略，打开并控制特定的网络端口。
　　基本的防火墙与WSFAS之间的区别是后者将防火墙与IPSec管理结合到一个工具中，提供集成的安全通信管理。这意味着你可以使用WSFAS来管理内部和外部的服务器通信，以及虚拟专用网络连接。WSFAS可以通过组策略进行控制，并可以通过设置将相同的规则应用到所有系统上（见图13-13）。
　　图13-13　通过组策略来控制WSFAS
　　关于防火墙上可以谈更多，但基本上，你应该尽可能依靠Security Configuration Wizard（安全配置向导）来帮助你正确地配置基于服务器角色的防火墙规则。这对于保护你的管理和其他服务器将会大有帮助，无论它们是否在你的网络中。
　　请注意，大多数的外围网络中，WSFAS是不够的。大多数组织还将包括基于硬件的保护技术或基于软件的状态检测工具。它也是很好的实践，对周边的环境实现某种形式的入侵检测。
　　注意：若要了解更多的关于Windows Firewall（Windows防火墙）的信息，请访问http://technet.microsoft.com/en-us/network/bb545423.aspx。
　　13.2.5.2　使用安全套接字层保护通信
　　管理工作站与主机服务器之间的通信应该总是加密的，无论它们源自你网络的内部或外部。事实上，为了进一步保护你的管理通信，你应该创建一个特定的VLAN并将所有的主机和管理机器放入其中。这将可以限制其他用户或服务与这些机器进行交互操作的能力。
　　但即使这样，你仍然必须加密所有的通信。当你以Security=High开关——默认设置来安装VMware ESX时，正如先前所述——它会自动为主机服务器生成证书，并依靠它们对所有进出服务器的通信进行加密。然而，若要正确使用安全套接字层进行通信，通信链路中的每台计算机必须信任该证书的创建者。由于每台主机服务器上的证书是自签名的，所以你可以有3种选择。
　　▼将每一个自签名证书导入到你的管理机器中，确保它们是受信任的证书。
　　■实施内部公共密钥基础架构——可以通过Windows Server AD Certificate Services（服务器活动目录证书服务）轻松地完成——并将其集成到实用程序目录中。作为此目录一部分的任何机器将可以自动地信任你通过它生成的任何证书。然后你必须以生成新证书替换掉自签名证书。
　　▲获得来自公共证书颁发机构如Verisign、Thawte、Entrust或其机构的受信任证书。使用这些证书来替换你的服务器上的自签名证书。由于公共授权可以自动获得大多数客户端系统和Web浏览器的信任，所以这些新的证书无须进一步的设置就可以受到信任。你还可以希望新的主题备用名称（Subject Alternate Name，SAN）证书。SAN证书可以在证书内包含多个名称，你可以将所有你的主机服务器名称添加到一个证书中，在所有服务器上使用相同的证书。但是，每次添加了新的主机，你必须更新SAN证书。
　　如果你正在使用Windows Hyper-V，你还可以使用新的安全套接字层隧道协议（Secure Sockets Tunneling Protocol，SSTP）。传统上，Windows网络中的虚拟专用网络连接依靠IPSec协议，它在网络层提供了端到端的连接。然而，不是所有的情况都可以使用IPSec VPN。例如，当你使用Network Address Translation（网络地址转换）设备或者Web代理服务器时，你的IPSec VPN连接将被阻止在门口。此外，IPSec VPN的实施更为复杂，要求你对从外部世界建立连接的终端或客户端系统具有某种程度的控制。如你所知，这往往并非如此。
　　这就是Microsoft实现安全套接字隧道协议的原因。SSTP依靠建立于安全套接字层之上的HTTP，或者HTTPS，在端口443上创建VPN连接。SSTP支持Network Access Protection（网络访问保护）以及IPv13。当你创建SSTP VPN时，客户端与内部服务器建立了一个独立的连接，所有的通信都通过此连接进行。但是，你不能使用它来创建站点到站点的连接。
　　SSTP依靠PKI证书创建连接。负责SSTP连接的服务器必须已安装包括服务器身份验证（Server Authentication）或通用增强型密钥用法（All-Purpose Enhanced Key Usase）属性的证书，以接受SSTP连接。SSTP VPN是Network Policy and Access Services（网络策略和访问服务）服务器角色的一部分，必须通过Routing and Remote Access Services（路由和远程访问服务）控制台节点来进行管理。
　　注意：若要了解SSL VPN的完整概述，请参阅www.reso-net.com/articles.asp？m=8#c连接下“the Advanced PKI（高级PKI）”部分下的“The Case for SSL Virtual Privata Networks（SSL虚拟私人网络案例）”。
　　13.2.5.3　依靠内部公钥基础架构
　　PKI的实施是相当的复杂，特别是如果你需要使用它们与客户或者内部网络之外的供应商进行交互操作。在此级别的主要问题是权威机构：你真的是你所说的你吗？你的证书可以被信任吗？在这种情况下，你应该依靠专门从事这一领域的第三方权威机构来为你提供担保，表明你的证书可以而且应该得到信任。在这些情况下WS08在减少PKI费用方面可以发挥重要的作用。由于它包含了通过活动目录证书服务（Active Directory Certificate Services，ADCS）来实施PKI服务所需的所有功能，你需要做的只是从一个外部源中获取根服务器证书。然后，该证书将嵌入到由你的基础架构发出的每一个证书中。它将证明你的客户、合作伙伴和供应商确实是其人，你将不必实施一个昂贵的第三方PKI解决方案。
　　但对于资源池网络而言，你并不需要这种类型的证书，因为你控制了网络内所有的系统，你不需要向它们证明你自己或你的组织。ADCS支持多种类型的安全情形。你可以使用它们完成以下功能：
　　▼保护Web服务、服务器和应用程序的安全
　　■保护和数字签名电子邮件
　　■支持加密文件系统
　　■符合代码
　　■支持智能卡登录
　　■支持虚拟专用网络
　　■支持远程访问身份验证
　　■支持基于简单邮件传输协议（Simple Mail Transfer Protocol，SMTP）之上的活动目录域服务复制链接的身份验证
　　▲支持无线网络身份验证
　　WS08提供了2种类型的证书颁发机构（Certificate Authority，CA）：独立和企业。后者提供了与ADDS的全面集成。企业CA的优点是由于它们的证书是与目录集成在一起的，所以它们可以提供自动注册和自动续订服务。这就是为什么在资源池网络中你应该实施基于企业CA的PKI服务。
　　对于根证书颁发机构，PKI的最佳实践需要高级别的物理保护。这是因为根CA是整个PKI层次结构的核心CA。如果由于某种原因而受到损坏，那么你的整个公共密钥基础架构将会被损坏。因此，一旦其证书已经发出，请务必从操作中移除根CA。由于你将从操作中移除此服务器，在虚拟机中将其创建为独立CA是明智的（从网络中移除企业CA将导致在ADDS中发生错误）。提示：为了保护它们，应该将根CA从操作中移除操作。这就是为什么根CA的理想配置应该是在虚拟机中。将虚拟机离线比物理机器容易得多。此外，可以将虚拟机设置为无定期的挂起状态，当需要用到它时，它可以更容易和更快速地恢复为联机状态。
　　PKI的最佳实践也需要分为多个层次的等级。事实上，在必须与公众进行交互操作的PKI环境中，为了保护前2个等级的基础架构并将两者从网络中移除是明智的。但在内部的PKI环境中，特别是一个将主要用于在资源池中保护通信安全的PKI环境中，2个级别就足够了。从属CA应为企业CA，这样它们可以与ADDS集成。若要对从属CA增加进一步的保护，不要将它安装在域控制器上。这将减少在服务器上运行服务的数量。
　　即使你的PKI环境将位于内部网络上，但你仍然应该集中研究一个适当的PKI设计。这意味着要执行一个7步过程。
　　1.查看WS08的PKI信息熟悉关键的概念。以下在线连接是入手的极好地点：Http://technet2.microsoft.com/windowsserver2008/en/library/532ac164-da33-4369-bef0-8f019d5a18b81033.mspx？mfr=true。
　　2.定义你的证书需求。确定资源池证书的所有用途，将它们列成清单，定义它们应如何被归因。
　　3.创建你的PKI结构。你将需要多少个等级的证书颁发机构？你将如何管理离线CA？需要多少个CA？
　　4.创建或修改你所需要的证书类型。确定是否需要使用模板。模板是首选的证书归因方法。
　　5.配置证书的持续时间。持续时间会影响整个基础架构。根CA拥有的证书比从属CA的持续时间更长。
　　6.确定你将如何管理和分发证书吊销列表，哪些ADCS角色将要包含在你的基础架构中。这可以包括Web注册和除了CA之外的在线响应程序。
　　7.为你组织中的证书基础架构确定你的运营计划。谁将管理证书？谁能为用户提供它们？如果使用了智能卡，它们如何归因？
　　以上问题的答案应该可以提供你打算使用的结构（见图13-14）。
　　图13-14　潜在的ADCS结构
　　在部署ADCS之前，请仔细考虑每一步。这不是你可以犯错误的地方。在你的资源池网络中继续进行实施之前，要全面测试ADCS结构的每个元素。最后，当你创建你的安全策略来定义如何保护你的环境时，你将需要创建一个证书策略，并将其传达给你的管理人员。
　　注意：要了解更多关于PKI以及它所支持的信任世界的详细信息，请访问www.reso-net.com/articles.asp？m=8#c。关于执行和使用ADCS的详细信息，请参阅由Holme，Ruest，和Ruest合著的《MCTS Self-Paced Training Kit（Exam 70-640）：Configuring Windows Server 2008 Active Directory》一书的第16章，（2008年由Microsoft出版发行）。
　　



　　13.3　完善资源池安全策略
　　城堡防御系统提供了一种结构化的方法来进行安全策略的设计。但它不能单独使用来保卫你的关键资源。它必须辅以一项防御计划，一项同时包含了被动和主动防御措施的计划。这意味着要在多个等级，特别是在系统恢复能力方面实施额外的防御。
　　还存在着一些正在进行的操作，所以必须每隔一段时间进行，以确保你的防御系统持续地受到监控，你的反应计划工作正常。模拟是很好的做法。你将看到你如何响应，你的响应计划是否充分。勿使你自己陷入唯一的响应就是拔下系统电源的处境，特别是在主机系统上运行着多个虚拟机的情况时。
　　一套可靠的响应计划的关键之一是要确保组织中的每个人都清楚和了解他们在该计划中的角色。资源池为你的网络带来了相当大的变化，特别是在它们所运行服务的类型方面。你的管理人员必须充分了解这些变化是十分重要的。在你的运作中确定每个新的角色，确定你必须为现有角色带来的更改，这也是非常重要的。最后，为了支持你的安全策略能达到最充分，你需要对分配给你网络中的管理员和操作员的委派权限进行限制。
　　



　　第14章　保护虚拟基础架构
　　即使你尽最大的努力来确保服务器和服务的安全，但灾难总是会发生的，而且服务器（包括主机和虚拟）总是会停机。这就是为什么为系统恢复做好准备是如此的重要。没有系统是完美的，但你可以将更多的保护级别应用到你的系统中，这样就可以减少丢失数据和体验停机时间的机会。因此，你需要实施数据保护策略来补充安全策略。
　　恢复系统永远不是一件容易的事情。避免需要恢复系统的最佳方法是使用多层的保护策略。但如果你遇到了必须要进行恢复操作的场面，你必须遵循一份详细的策略。像每一个在虚拟基础架构中的其他操作一样，恢复步骤必须早已规划好。恢复策略必须以了解hypervisor内置的用于虚拟机状态的保护功能开始。一旦你熟悉了hypervisor提供的用于帮助你保护系统的工具，你就可以草拟或调整你的保护策略。
　　



　　14.1　制定系统保护策略
　　在虚拟基础架构中系统保护必须集中于以下几个关键元素。
　　▼无须备份主机服务器，因为它们是冗余的，并且在大多数情况下，你可以通过现有可用的集成式hypervisor容易地重新创建主机服务器。
　　■你还必须为资源池保护管理数据库和管理虚拟机（VM）。如果你想要确保资源池可以持续正常运行，管理数据库尤其必须得到保护。至于管理虚拟机，你可以使用一般的VM保护措施。
　　■你可以通过各个hypervisor的快照功能轻松地保护虚拟机。你可以为每个虚拟机创建多达512个快照。快照就是一个虚拟机当前的状态，一种你可以随时返回到的状态。这种状态捕获了所有的操作系统设置和配置、应用程序状态以及所有当时在VM中包含的数据。对于大多数的hypervisor，快照通常存储在资源池的库存储区中。在某些情况下，例如VMware，快照存储在虚拟机文件夹中。
　　■你可以备份构成虚拟机的文件，捕获其所有的内容，因而保护包含在其内的所有数据。
　　▲你可以备份虚拟机里面的内容，就像你通常备份物理计算机。
　　关于最后2点市场上有很多的讨论。很多人倾向于使用最后一个策略，备份每个虚拟机的内容，并为他们的虚拟机使用传统的恢复策略。然而，机器现已虚拟并存储在共享的存储容器上的这个事实应该让你重新考虑这一策略。如果你可以备份整个虚拟机并脱机安装虚拟磁盘驱动器，那么你可以很轻易地从这些磁盘驱动器中还原所有的内容。这一过程是更容易和更简单的工作。
　　但是，在你研究你将如何保护系统之前，你需要确保系统的恢复和保护策略是可靠的。
　　14.1.1　使用标准系统恢复策略
　　每个组织，无论大小，都必须依靠一套标准的系统恢复策略来保护他们的机器。在一个虚拟基础架构中，这意味着要对资源池和它们所运行的虚拟机使用相同的策略。标准的恢复策略应该基于下列行为：
　　▼检测到服务中断。此中断可以发生在资源池或虚拟机中。如果是发生在虚拟机中，那么影响只限于此虚拟机；但如果发生在资源池中，那么其后果可能会影响生产力网络中许多虚拟机所提供的服务；因此，反应必须更加迅速。
　　■必须对中断事件进行调查和分类。完成此项工作最好的方法是依靠一套标准的故障排除策略。
　　■必须对风险级别进行评估。此风险的级别将决定所需的响应级别。例如，如果一台运行着20个虚拟机的主机发生故障，而且有没有替换的主机，那么必须立即响应。如果是非关键性的虚拟机遇到麻烦，那么响应可以不用那么紧急。
　　■要实施针对这一风险级别的恢复计划。标准恢复计划应该已经针对最常见的情况做好预案。这些标准恢复计划还应该包含“B计划”，以防主恢复策略不适用于某些原因的情况。
　　■执行恢复。核心恢复动作的重点是获取服务备份并尽快运行。一旦基本的恢复完成，你应该全面测试恢复行动的结果，确保一切都恢复到正常状态。
　　■一旦核心动作和测试完成，就可以执行后续的恢复行动；例如，修复处于离线状态的故障虚拟机，或者通知用户他们的文件已重新上线。
　　▲一旦完成恢复，如果有需要，应该记录事件和更新程序。
　　针对每种类型的情况详细列明实际的恢复计划是非常重要的。这就是为什么风险评估是如此重要的原因之一。你可能没有时间去记录每次独立灾难状况的恢复过程，但如果你已经花时间进行风险评估，那么你可以确保记录下最关键情况的恢复计划。最后，你将拥有多套恢复计划可以“联结到”你的恢复策略中。所有这些都应该基于标准作业程序（Standard operating procedures，SOP），确保你的员工以相同的方式响应类似的情况。
　　为了支持这一恢复计划，你还需要：
　　▼一份计划的异地副本，以保护计划本身
　　■资源池的现场备用硬件组件
　　■可靠的和经过测试的系统备份
　　■对于轮换的备份介质要远距离异地存放，如磁带
　　▲执行系统恢复的可用资源——系统、组件、人员
　　此外，你需要具有故障保护服务器或者热备站点——镜像复制生产站点并且在灾难发生时可以接管的单独站点——以便支持恢复计划。热备站点可以由你自己完全控制或者由外部服务提供商托管，这取决于拥有的可用资源。关于这方面的内容在15章中有更多的讨论。正如你将看到的，使用资源池，这个辅助站点是很易设置的。
　　14.1.1.1　使用标准故障排除技术
　　系统恢复过程的核心要素之一是一套可靠的故障排除策略。这是操作人员将来用于标识他们所面对的灾难类型的策略。一套明确的战略是至关重要的，它还应该成为组织内的标准，因为这套策略对于恢复过程是非常关键的。例如，如果错误地识别所面临的问题，应用于它的恢复策略可能会导致更严重的灾难。你应该将此策略同时应用于资源池和虚拟服务或产品。
　　一般情况下，帮助请求和问题报告应该通过一套有组织的/科学的方法来处理，将系统错误视为总是事出有因；即问题不会是无缘无故发生的——它们背离了具有明显的、可识别原因的标准。故障排除技术人员的工作是基于他或她的系统工作原理的知识来逻辑推断问题的原因。最好的方法就是使用一套标准的程序。
　　例如，技术人员可以依靠以下步骤来解决系统问题：
　　1.一旦发现问题，要记录相应的信息，例如时间、日期、受影响的计算机，以及任何相应的用户信息。
　　2.记录与问题相关的所有信息。如有必要，请参考你的基准系统操作信息。
　　3.创建分条列述的问题说明。回答这些问题：
　　■这个问题确实是可重现的还是随机出现的？
　　■它是否与当天的时间有关？
　　■问题是发生于特定用户身上吗？
　　■是发生在特定的平台上吗？
　　■是发生在特定的版本吗？
　　■是否与硬盘可用空间有关吗？
　　■是否与网络通信有关？
　　■究竟是不是问题？
　　4.在内部故障排除数据库中研究类似的事件。查阅受影响组件的帮助系统，如果它还可用。此外，查阅外部的故障排除数据库，如制造商的知识文库。借鉴同事们的专业知识也是一个很好的主意。
　　5.基于所有可用的信息建立一个合理的假设。
　　6.测试假设，并记录结果。
　　7.如果测试成功地解决了问题，记录并结案。如果不成功，修改假设，或者如果有必要，建立一个新的假设。重复假设和测试周期，直到问题得到解决。
　　请注意复杂的问题（一个以上的因果关系）可能需要多次重复步骤2到步骤7。无论资源池或虚拟机内的不良事件在何时发生，依靠这种方法将会极大地简化问题的解决。
　　14.1.1.2　资源池和VSO的分类问题
　　故障排除的一个重要方面是问题的分类。根据事件周围的情况通常有助于对错误进行分类。表14-1包括了问题分类的示例列表。
　　正如你所见，故障排除过程不只是在灾难中使用。它可以用于所有的故障排除情况。但对于灾难来说，故障排除和恢复策略的关键是可靠的备份——数据、操作系统和组件。这就是为什么备份策略是系统复原计划中最重要的元素之一。
　　14.1.2　hypervisor制造商的产品
　　备份策略将根据你所运行的hypervisor会有所不同。不同的hypervisor使用完全不同的方法。此外，基于你所运行的主机服务器的数量以及它们的配置方法也会有所不同。
　　14.1.2.1　VMware Consolidated Backup
　　VMware提供了一个Consolidated Backup（整合备份）工具，与更新管理器一样，这个工具在虚拟基础架构的所有版本中都有提供，因为它是基础架构的关键组件。整合备份依靠集中式的代理服务器来执行并运行资源池数据库（如果它是包含在VM中）和它所运行的虚拟机的所有备份操作（见图14-1）。其运作的关键是通过存储容器执行备份，而不是通过局域网（Local Area Network，LAN）——这是传统备份策略的做法。因为它提供了一个开放的应用程序编程接口，整合备份可结合你现有的备份工具，能够提供集中式的虚拟机备份。
　　图14-1　VMware整合备份依靠中央代理服务器和存储容器的功能
　　整合备份通过依靠你所运行的虚拟机的快照将数据备份到磁带或磁盘上，无论是在线还是离线。但是请注意，当你执行一个完整的镜像备份时它将首先把数据备份到磁盘上。当一个备份作业被触发后，整合备份捕获快照，并挂载它来执行备份，让虚拟机在其原来的主机上运行，对其操作产生极小的影响。一旦备份操作完成，此快照会被卸载并删除。
　　整合备份还支持文件级或增量备份，以及整个虚拟机的完整镜像备份。请注意，增量备份是通过你所使用的第三方备份工具与整合备份一起来提供。整合备份支持任何类型的存储——通过互联网小型计算机系统接口（Internet Small Computer Systems Interface，iSCSI）、网络附加存储（Network Attached Storage，NAS）、存储区域网络（Storage Area Networks，SAN）、或者直接连接存储（Direct Attached Storage，DAS）来访问的存储。
　　注意：要了解VMware的兼容备份软件的列表，请访问www.vmware.com/pdf/vi35＿backup＿guide.pdf。
　　14.1.2.2　Citrix XenServer
　　Citrix没有对主机或虚拟机的备份提供任何专门的工具。相反，Citrix建议主机必须尽可能保持其结构简单。如果主机出现故障，只需重新安装它，因为不会丢失任何数据。但是，由于每台主机服务器都存储了一份配置数据库的本地副本，所以时刻保护此数据库是非常重要的，因为如果你丢失了本地数据，那么你有可能失去全部的虚拟机。你对每一个数据库的保护策略都将取决于你所运行主机的数量。
　　对于XenServer，单一的主机可以通过命令行界面（Command-Line Interface，CLI）进行备份。使用xe pool-dump-database命令来保护单独服务器上的数据库。使用xe pool-restore-database恢复它。在某些情况下，你可能必须运行xe vm-reset-powerstate命令来确保被恢复主机上的虚拟机状态设置为适当的模式。
　　对于服务器池，你必须保护主数据库，因为为了配置数据库联合主机工作于主从关系。对于备份和还原配置数据库你可以使用相同的命令，但你只能在主服务器上运行它。不过，恢复过程会稍有不同。因为它是一个池，你还必须从丢失池中删除旧的从属服务器，并重新创建它们。运xe host-forget命令删除旧的从属服务器，然后在每台新的从属服务器上运行xe pool-join命令加入新池。
　　对于虚拟机，Citrix建议你把它们视为标准的物理机器，并在每个虚拟机中加载传统的备份代理。使用与你在迁移到虚拟基础架构之前相同的方式来运行虚拟机备份。
　　注意：关于XenServer备份策略的详细信息，可以在此地址中找到http://docs.xensource.com/XenServer/4.0.1/installation/apbs04.html。
　　14.1.2.3　Microsoft Hyper-V
　　由于Hyper-V是运行在Windows Server 2008上的一个标准角色，虚拟机——至少Windows虚拟机——和主机服务器两者的备份与你在任何Windows网络中所运行的标准备份实践相类似。自从Windows Server2003发布以来，卷影复制服务（Volume Shadow Copy Service，VSS）就成为了在Windows Server中备份的关键。VSS可以创建运行中机器的快照，然后依靠此快照执行备份。VSS可以与多种备份软件一起使用，包括Windows Server 2008中的新工具Windows服务器备份（Windows Server Backup，WSB）；Microsoft的系统中心数据保护管理器（System Center Data Protection Manager，DPM），数据流备份引擎；以及大多数Windows Server使用的第三方备份工具。
　　基本上，VSS就像是一位乐队指挥。它是控制卷影复制操作的主要行动者。为此，它必须与在此过程中的所有其他行动者进行都沟通。工作过程如下所示（见图14-2）：
　　图14-2　Windows Server中的卷影复制过程
　　1.一个已注册的请求者——一个与卷影复制服务一起工作的应用程序，例如，Hyper-V——发起一个VSS会话并请求创建卷影复制。
　　2.VSS将请求发送给所有已注册的写入者——目的在于让应用程序获悉VSS请求——要冻结被请求卷上的所有输入和输出（I/O）活动。
　　3.定向的已注册写入者向VSS指示何时会完成。
　　4.一旦收到冻结活动的确认，VSS就通知存储提供者执行其供应商特有的卷影副本。
　　5.当卷影复制完成时，存储提供者向VSS确认工作已完成。
　　6.VSS通知定向的已注册写入者，它可以解冻在冻结卷上的I/O活动，并继续正常的运作。
　　7.最后，VSS向原始请求者指示操作是成功还是失败。
　　这个过程的发生极为迅速。事实上，如果已注册写入者的设计得当，那么此过程对于用户是完全透明的。
　　在VSS过程中的另一个重要因素是与存储技术实际创建卷影复制的方式有关。如果它们创建了一个卷的整个副本，那么它们就需要大量的物理空间。这样成本会变得非常高昂。这就是为什么大多数的存储提供商更愿意使用一种单一实例存储方法。它们并不会实际创建一个磁盘的完整副本，而是集中于上一次的卷影复制以来对卷所做的更改。Microsoft的提供程序为此使用了一种抄写过程：每次当一个磁盘块将被覆盖时，在写入操作之前，它被移动到一个保留的区域。这是一项重大的技术挑战，可能会导致磁盘磁头负担过重。其他提供商使用了一种从不覆盖同一区域的方法：所有的信息都是追加到磁盘上。此方法可以有效降低磁盘空间的成本，并且磁盘磁头也轻松得多。这是大多数的hypervisor用于为它们所运行的虚拟机生成快照的方法。
　　正如你所见，当发出了一个备份操作请求时，Hyper-V就启动了一个VSS过程，而且这种备份减少了副本的大小。副本可以根据你的需要删除或保留。保留副本不失为一个好主意，因为它允许你可以依靠Previous Versions（以前的版本）客户端来恢复丢失的文件和文件夹（见图14-3）。你甚至可以依靠此工具恢复Hyper-V主机上丢失的虚拟机。Previous Versions（以前的版本）是Windows文件属性的一个功能。只需右键单击对象——文件或文件夹，查看其属性，然后移动到Previous Versions（以前的版本）选项卡来恢复你丢失的内容。这是此操作系统的一项强大的功能，Hyper-V只是继承了这个功能，因为它运行在这个操作系统上。
　　图14-3　使用Previous Versions（以前的版本）客户端来恢复丢失的数据
　　注意：更多关于Windows Server 2008（WS08）备份策略的详细信息，请参阅由Ruest和Ruest合著的《Microsoft Windows Server 2008：The Complete Reference》一书的第11章（2008年由McGraw-Hill发行）。
　　使用System Center Data Protection Manager（系统中心数据保护管理器），Microsoft提供了一个能捕获远程VSS镜像并将它们集中存储的数据流备份引擎，使得管理员能够集中地管理所有的快照。用户的Previous Versions（以前的版本）客户端自动重定向到中央VSS存储库，这使它更易于支持。DPM将所有备份流至中央磁盘系统，然后再将它们存储到脱机存储的磁带上。这对于大多数组织是必要的，因为Windows服务器备份，这个与WS08集成的工具已不再支持磁带作为备份的介质。
　　14.1.2.4　Hyper-V资源池的数据保护策略
　　备份Hyper-V主机服务器是指备份2个不同类型的对象。
　　▼操作系统　就是构成C：驱动器并运行Hyper-V角色的分区。
　　▲数据分区　就是包含Virtual Service Offerings（虚拟服务或产品）的数据驱动器。这应该是某种形式的共享或复制存储。
　　Hyper-V服务器是Windows网络中最简单的一类服务器，因为它们只运行一个主要的角色：虚拟化。如果你正确设置了基础架构，那么备份这些机器就会相对比较容易。理想情况下，构成此服务器的每个驱动器将被托管在共享的存储基础架构中。这提供了多个层次的对数据或系统丢失的防御。
　　▼每个分区可以依靠卷影复制服务或存储单元所提的内部快照工具来提供第一道防线。
　　■第二道防线是由虚拟机所在的数据驱动器上的卷影复制来提供。
　　■第三道防线是通过复制构成每个虚拟服务或产品（VSO）的文件来提供。
　　■第四道防线是通过故障转移群集来提供。
　　▲最后一道防线是通过备份构成每台主机系统的磁盘来提供。
　　警告：为了通过Windows服务器备份工具来执行备份，你需要为每台主机服务器添加额外的磁盘分区。WSB不支持备份到磁带。我们的建议：获取第三方备份工具，因为你将需要为主机服务器提供全面的备份支持。不错的产品，如Symantec BackupExec（www.symantec.com/backupexec/index.jsp）或者CommVault Galaxy（http://commvault.com/products/data＿protection.asp）。
　　设置你的日程，持续地保护系统。你应该每周执行一次完整备份，每天接着进行差异备份。差异备份比起增量备份占用更多的空间，但它们更容易恢复，因为它们包含了自完整备份以来的所有变更。在恢复情况下，你只需要最近的完整备份和最近的差异来还原系统。这比起使用增量备份快很多，因为你只需要添加每一个增量直到故障点为止来恢复系统。
　　如果你决定要从Windows服务器备份执行主机系统备份，可以使用下列命令行。它每天下午6：00执行一次对磁盘分区完整的系统备份。
　　wbadmin enable backup addtarget：DiskID schedule：18：00 user：Username password：Password
　　这里的DiskID是指备份目标磁盘的磁盘ID号；使用DISKPART，然后运行List Disk命令来确定磁盘ID。Username（用户名）和Password（密码）应属于在此主机服务器上具有本地管理权限的服务账户。
　　注意：当你使用WSB时，目标驱动器应专为备份的目的而保留，因为所有其他的数据将会被删除。
　　14.1.3　虚拟服务或产品的数据保护策略
　　备份你的Virtual Service Offerings（虚拟服务或产品）将意味着需要备份多种类型的信息：用户数据、公司数据、数据库、文档、你的服务器的系统状态和Active Directory（活动目录）数据。如先前所述，你可以使用内置的备份工具或第三方备份工具来执行这些备份。无论你使用哪一个工具，请确保你将会使用一套标准备份策略，创建特定数据类型的备份集——例如，在一个备份集中创建只有用户数据的备份，并在另一个备份集中创建只有系统数据的备份。这将可以简化恢复过程。
　　数据的备份是相当简单的；选择数据驱动器并将其备份。请记住在大多数情况下，无论你是使用Windows还是共享的存储提供者，备份工具在备份数据之前将自动创建一个快照，然后从快照数据中创建备份集。这样可以避免文件使用中的问题。快照工具拥有专门的应用程序编程接口（API），使它们能够与数据库如Active Directory、SQL Server和Exchange Server一起工作，使快照对数据库也是有效的。
　　基本上，你应该在日常基础上备份数据和操作系统。每周执行一次完整备份，然后依靠差异备份。你需要以远程存储解决方案和异地介质存储2个要素来支持你的备份策略。请记住，你将需要一个第三方备份工具，如果你想要在Windows Server 2008的机器上备份到磁带。对于介质，你将需要确保你拥有安全的脱机存储空间。你应定期轮换异地介质。例如，每隔一次的完整备份应异地存储在受控的环境中。
　　常见的日程安排基于一个4个星期的保留策略。这意味着你需要保留为期4周的备份介质。如果你间隔地把副本保存到异地，你总是只有一个星期可以远离完全的灾难。此外，你的归档日程安排将概述哪些副本应永久性地保持在异地。
　　14.1.4　依靠复制进行备份
　　如果你正在使用一个复制引擎将所有你运行中的VSO复制到一个远程站点，那么你可能不需要注重内部的机器备份，因为你已拥有所有你的虚拟机的异地副本。在出现数据丢失的情况下，你可以依靠你的hypervisor引擎在脱机模式下挂载虚拟磁盘驱动器，让你从已挂载的虚拟硬盘中恢复你需要的数据文件。
　　VMware以Virtual Disk Manager（虚拟磁盘管理器）和DiskMount实用程序来支持脱机磁盘的挂载。两者都可以在虚拟磁盘开发工具包中找到，地址为www.vmware.com/support/developer/vd-dk/VDDK-1.0-Relnotes.html。使用虚拟磁盘管理器来克隆、创建、重新定位、重命名、加大、缩小或对脱机虚拟机磁盘（Offline Virtual Machine Disk，VMDK）文件进行碎片整理。使用Disk-Mount实用程序在Windows或Linux中挂载脱机磁盘，查看其内容，就像它是连接到你系统中的另一个磁盘。然后你可以从脱机磁盘文件中恢复所需的文件。
　　Microsoft和Citrix都可以依靠Microsoft VHDMount工具，这是一个挂载脱机虚拟硬盘（Virtual Hard Disk，VHD）文件的Windows实用工具，允许你查看内容，就像是在你的系统中的一个单独的磁盘驱动器。在Virtual Server 2005 R2中可以找到这个实用程序：www.microsoft.com/windowsserversystem/virtualserver。此实用程序包含在这个下载包内，必须从下载包中提取它并单独使用它。
　　注意：按照来自Chris Wolf（我们的技术审阅者之一）的指示，无须安装Virtual Server就可以提取VHDMount：http://myitforum.com/cs2/blogs/rcrumbaker/archive/2007/06/13/vhd-mount.aspx。
　　使用此策略将极大地简化你的VSO备份和还原策略。但是，请确保你所使用的复制工具是虚拟机感知的，并且理解虚拟机的构成，以确保正确的数据复制。第15章将有更多关于这方面的讨论。
　　14.1.5　选择第三方备份工具
　　在许多情况下，组织会选择依靠第三方备份工具来保护他们的环境。VMware建议使用第三方工具；Citrix绝对需要第三方工具；而Microsoft的新Windows服务器备份不是一个企业级的备份工具。为此，你很可能会发现你自己处于需要第三方工具的情况，如果你还没有拥有一个。
　　第三方备份工具选择的最重要的方面之一是使hypervisor运转的组件的意识。许多备份工具不能与你所运行的hypervisor进行正确的交互操作，因此不会理解虚拟机文件的构成。当你选择备份工具时，确保它是hypervisor感知的。
　　市场上有许多第三方备份解决方案是专门为hypervisor设计的。它们都符合特定的条件，其中必须包括：
　　▼要能了解hypervisor的内部工作原理
　　■能够集中地保护管理数据库的数据
　　■能够与你的存储提供者的快照服务集成，能够在启动备份操作之前触发快照
　　■能够用于Windows或Linux虚拟机，具体取决于在你的VSO中你所运行的基础架构
　　■可以通过一个简单的过程完成主机系统的恢复
　　▲可以通过一个简单的过程完成虚拟机的恢复
　　符合这些基本准则是必不可少的。当然，还有其他的标准，如能够与由你的hypervisor引擎所支持的海量存储产品集成，包括用于SQL Server、Exchange、Active Directory、Oracle等特殊的驱动程序；但此处列出的是智能的第三方备份解决方案的核心要求。
　　注意：进行最佳备份工具选择的一个好方法是依靠你的hypervisor供应商的推荐。每个制造商都列出适用于其引擎的第三方工具。对于VMware，请访问wwwa.vmware.com/partnercatalog/catalog，并选择ISV系统基础架构，选择备份和可用软件的子类别。对于Citrix，请访问www.citrix.com/English/partners/partnertop.asp？ntref=hp＿nav＿US。对于Microsoft，请访问www.windowsservercatalog.com，寻找基础架构解决方案，然后查看Hyper-V子类别。
　　



　　14.2　完善恢复策略
　　虚拟基础架构中的数据保护意味着要改变传统的方法，以适应由资源池和虚拟服务或产品分别产生的新的要求。保护这些环境还需要调整你的方法。总体而言，你会发现因为你现在拥有2种基础架构，所以你也将不得不调整其他的管理方法。这与系统冗余策略一起，将是下一章的主题。
　　做好准备。虚拟基础架构的安全、保护和管理不同于单独的物理基础架构的使用。如果你的组织有一定的规模，你也许可以向每一个基础架构都投放资源；但如果没有，你就必须训练你自己和你的同事承担起不同的责任，并在问题出现时以不同的方式做出响应。
　　



　　第15章　为业务连续性做准备
　　虚拟化转变了组织运行其数据中心的方式。服务器虚拟化将生产力工作负载转变为可以在需要时运行和基于业务需求缩放的延展性引擎。桌面虚拟化允许你创建非永久性或无状态的桌面操作系统镜像，这极大地简化了管理并减少了分布式桌面管理的痛苦。应用程序虚拟化终于使你能够彻底地战胜DLL地狱，并为用户提供了一种按需应用程序的模式。配置文件虚拟化允许你的用户可以在组织内的任何位置使用任何的桌面。
　　所有这些级别的虚拟化最终让你能够建立动态数据中心——一种可以使其本身动态地适应业务周期波动的数据中心。但是，这种数据中心不会自己生成。到目前为止，你已经了解所有不同级别的虚拟化可能会影响你的数据中心；但为了运行虚拟化并充分利用它，你还有2个项目待实施：业务连续性和管理方法。
　　业务连续性的重点是确保你的服务在任何时候都可用，无论你在何处和无论你在什么情况下需要它们。为支持这种新的IT模式，管理方法必须要更新，必须由合适的工具集来支持。这些管理变化在第16章详细地介绍。
　　



　　15.1　业务连续性的要点
　　系统冗余依靠实施一些方法和措施来确保如果组件发生故障，其功能将立即被另一个组件接管，或者最低限度将组件重新上线的过程是有文档记录的，并且由系统操作员所熟知。令管理员头疼的常见问题是网络安全与灾难恢复。这并不令人吃惊。我们已经面临过灾难，如“9·11”和卡特里娜飓风，我们都知道这些事件对于任何规模的企业会造成了多么大的伤害。事实上，绝大多数的业务并不具备业务连续性的规划，在面对重大灾难时通常会破产，因为他们无法从这些灾难性的事件中得到恢复。这些问题是网络设计的核心。不管你做什么，你必须确保在任何时候你的系统都会受到保护。
　　再一次重申，城堡防御系统可以提供帮助。第1层帮助你鉴定风险级别，因为它可以帮助你确定信息资产的价值。风险是由鉴定价值（一个资产的重要性）乘以与之相关联的风险因素所决定的。公式如下所示：
　　风险=资产价值*风险因素
　　例如，一套价值为100万美元的资产其风险因素为0.2，那么其风险值就为20万美元。这意味着你可以投资多达20万美元来保护这一资产并减少其风险因素。
　　虽然这些计算本质上有些难懂，但其要点就是以最大的投资来保护你最宝贵的资产。这就是为什么了解你现有的资产价值是如此重要的原因之一。图15-1是这项原则很好的提示。
　　图15-1　信息资产类别
　　第3章介绍了虚拟基础架构/体系结构的概念（见图15-2）。这种结构的重点是虚拟化的7个层次和你该如何保护它们。此外，它涵盖了你所运行的2个网络中的每个该如何包含在不同的安全上下文中。现在，你需要完成这种结构，处理这些元素，确保这种结构的每个关键组件都会受到保护并且始终可用。
　　图15-2　虚拟结构的7个层次
　　要确保基础架构每一层的可用性，你必须解决每一层结构级别的需求。这包括以下内容：
　　▼资源池必须包括对服务器虚拟化基础架构每个元素的保护。这必须集中于主机服务器和支持它们的存储基础架构。
　　■虚拟服务或产品也必须通过你所运行的基础架构本身的能力来进行保护。
　　■虚拟桌面必须进行设置以保护它们的可用性，尤其是每当它们需要时用户可以重新连接到其桌面的能力。
　　■应用程序资源库必须设定高度可用，以确保应用程序总是运行。
　　■配置文件存储容器也必须为始终可用，并通过备份来进行保护，正如第14章所述。
　　■分配和管理层必须进行更新以包括新的IT作业方式。
　　■整个基础架构必须通过异地复制和其他的业务连续性实践来进行保护。
　　保护每一个资源并确保其可用性将允许你完成整个虚拟化结构，并运行它来响应你的组织的业务需求。
　　15.1.1　建立高度可用的资源库
　　通过集中对物理的保护或者对资源池的保护，城堡防御系统的第2层还可以帮助你规划系统冗余。但是主机服务器并不是资源池中唯一的组件。正如第14章所述，资源池包括了多个不同的元素，其中每个都必须包含一定级别的保护，以确保它持续运行并且始终保持可用，当你需要访问资源池的功能时，就算遇到系统故障或者维护窗口也不能将你拒之门外。
　　这意味着你必须为以下每个元素提供保护：
　　▼主机服务器　这些服务器必须建立冗余，无论它们是集中的还是位于远程位置。
　　■存储容器　这部分绝不能出现单点故障。
　　■管理数据库　此数据库包含了关键的业务信息并且在任何时候都必须为可用。
　　■管理虚拟机（VM）　这些机器提供访问管理数据库和控制资源池的主机。为此，必须要为它们建立冗余。
　　■管理桌面虚拟机（DVM）　操作员用于访问管理基础架构的虚拟桌面必须时刻受到保护。
　　■资源池活动目录　此目录必须具备内置的冗余以变得高度可用。
　　▲其他的服务器　包含在基础架构中的任何其他的服务器都必须建立高度可用。例如，如果需要它们，你可能必须运行许可授权服务器以支持你的实施。此外，如果它们正在使用中，你所运行的用于支持加密通信的证书服务器必须受到保护。同样的，你要为你所维护的资源池中的任何其他基础架构元素提供保护——Network Access Protection（网络访问保护）、Virtual Private Network（虚拟专用网络）、Update Services（更新服务）等。
　　保护资源池意味着要保护其中的每个元素（见图15-3）。
　　15.1.1.1　创建高度可用的主机服务器
　　正如你所知，为了你的资源池能够正常地工作，你的虚拟服务或产品在任何时候都保持可用，你必须将高可用性的概念和组件集成到每一台主机服务器中。以服务器本身的构建开始着手。例如，使用廉价磁盘随机阵列（Random Arrays of Inexpensive Disk，RAID）和将多张网卡组队，为主机系统提供直接的硬件级别的保护。然而，理想的主机系统还包括集成的hypervisor，不需要本地磁盘驱动器；如果你必须运行一个主机操作系统，建议从共享存储中运行它，不要在本地磁盘中运行。
　　具备不间断电源（Uninterrupted Power Supply，UPS）系统也是非常重要的；这些系统可以是单独的、通过USB连接的UPS设备（用于区域服务器），或者是保护整个机房（通常位于中心站点）的集中式电源管理基础架构。
　　资源池也需要冗余。每一台用于托管虚拟服务或产品（VSO）的物理服务器都必须具备某种形式的内置冗余。如果一台主机服务器运行着10个至15个VSO，那么在发生硬件级故障的事件时，它必须能够将这些VSO故障转移到另一台物理主机上。这意味着必须将所有的物理主机组成群集——共同负担VSO的工作负载，以便VSO在任何时候都可供用户使用。这就是为什么要将VSO托管在共享存储之上的原因之一。因为它们是托管在一个每台主机都可以访问到的存储结构上，可以在对用户影响极微的情况下将VSO从一台主机转移到另一台主机。这提供了站点级别的冗余。这也意味着你必须具有多台主机以支持虚拟工作负载的故障转移。请记住这条金科玉律：如果你要对20台服务器执行物理整合，你的整合率不能是20:1；相反，你的整合率应该是10:1，因为你必须具备2台主机以支持20个虚拟服务器的高可用性（见图15-4）。
　　图15-3　保护资源池
　　图15-4　要提供站点级别的冗余，你必须始终具有备用主机
　　VMware依靠虚拟机文件系统（Virtual Machine File System，VMFS）和高可用性功能来提供这一级别的可用性。Citrix XenServer依靠资源池概念和共享存储。Microsoft，由于Hyper-V运行在Windows上，因此可以依靠Windows的服务器故障转移群集功能，当然还需要共享存储。
　　如果你选择在远程位置托管虚拟工作负载以提供更好的服务可用性，那么有必要在区域一级实施站点级的冗余。这就是为什么理想的区域服务器将是一个包含有至少2台物理主机服务器、共享存储和广域网络连接的多功能一体机柜。通过包含2台主机服务器，你可以确保此基础架构托管的区域VSO将始终为可用（见图15-5）。
　　15.1.1.2　保护存储容器
　　当你在构建高可用性时，你必须确保没有一个组件会成为故障点。这意味着每一个组件必须具有一些内置的冗余。例如，你不能将你所有的虚拟工作负载放到一个单一的共享存储容器中，因为如果它发生了故障，比起单一主机服务器的故障你将会遇到更严重的麻烦，因为你所有的虚拟机将会失效。
　　存储容器还要包含RAID配置，以提供第一级的故障防御。它们还包含让你生成内容快照等多个功能，以便你可以通过备份来保护它们。此外，许多存储容器，尤其是存储区域网络（SAN），具有将内容从一个SAN结构复制到另一个SAN结构的能力。
　　当在同一站点中运行时，多台主机系统可以利用此复制引擎。VMware通过Storage VMotion提供了此功能，一个可以在无故障的情况下将VM的内容从一个存储容器自动地转移到另一个存储容器的工具（见图15-6）。当然，为了Storage VMotion能工作，你必须依据VMware指南构建SAN。此解决方案只是一个站点级的解决方案。
　　图15-5　使用多功能一体机柜提供　区域站点级的冗余
　　图15-6　VMware可以使用Storage VMotion将VM　从一个容器转移到另一个容器中
　　注意：VMwarez在《the VMware SAN System Design and Deployment Guide》（VMware SAN系统设计和部署指南）中发布了如何配置SAN及其技术的信息，地址为：www.vmware.com/pdf/vi3＿san＿design＿deploy.pdf。
　　Microsoft可以使用多站点故障转移群集和Hyper-V引擎做相同的事。Windows Server 2008支持不依靠共享存储就可以创建群集的能力，但实际上是依靠直接附加存储（DAS）。此群集将为运行在其上的虚拟机提供故障转移——当然不是通过实时迁移，而是通过Quick Migration（快速迁移）功能，它会暂停这台虚拟机，传输它，然后重新启动它。这种故障转移可以不依靠共享磁盘基础架构，但需要通过第三方引擎在群集中的每台主机之间进行数据复制。群集数据是存储在File Share Witness（文件共享见证）上，确保每台主机都可以感应其他主机的状态。这是Windows中的一种多数节点集的群集结构。此群集结构旨在提供多站点故障转移，在不同的站点运行群集节点，你没有理由不使用此结构来同时提供单站点故障转移和存储容器保护（见图15-7）。
　　图15-7　使用多站点群集为磁盘和主机提供站点级的保护
　　注意：关于Windows Server 2008多站点群集的详细信息，请访问www.microsoft.com/windowsserver2008/en/us/clustering-multisite.aspx。关于群集Hyper-V的分步指南，请访问http://technet.microsoft.com/en-us/library/cc732181.aspx。
　　Citrix XenServer依靠第三方产品来提供这种类型的保护。Citrix的合作伙伴Steel Eye（www.steeleye.com），LeftHand Networks（www.lefthandnetworks.com）以及其他如Marathon Technologies（www.marathon.com）都提供了可以在单个或多个站点中同时保护数据和主机的工具。
　　其他的存储供应商，例如，NetApp，为网络连接存储（NAS）和SAN提供了复制功能。对于系统管理，NetApp依靠与VMware相同的策略。VMware一直是依靠VirtualCenter管理其虚拟基础架构，随着你的需求增长而添加工具的功能。NetApp也是如此，随着你的需求增长，可以在NAS或SAN产品之间无差别地将功能添加到其存储管理引擎中。这极大地简化了它们的产品的使用。
　　15.1.1.3　保护管理虚拟机和桌面虚拟机
　　正如第14章所述，资源池不只是由物理机器组成。事实上，它通常包含了多个虚拟机。这些机器可以扮演任意数量的角色。
　　▼运行虚拟化管理软件。
　　■运行桌面操作系统（OS）以支持对资源池管理虚拟机的管理访问。
　　■运行Active Directory（活动目录），将安全组与资源库中你指定的角色进行同步。
　　■运行数据库引擎（本地的，SQL Server或Oracle），其中包含管理数据。
　　▲可能要运行额外的角色，如证书服务、网络访问保护、虚拟专用网络等。
　　虽然可以在同一个虚拟机中运行以上这些角色，但应至少使用2个虚拟机甚至可能更多才是比较明智的，这可以确保服务的高可用性，使得资源池能够保持正常运行。使用以下这些准则创建一个高度可用的资源池基础架构：
　　▼作为最佳方法，Active Directory（活动目录）至少需要运行2台机器。这些机器应保持与其他角色分隔开来。这些机器还应该运行域名服务（Domain Name Service，DNS）角色，因为Active Directory需要DNS才能运行。虽然有可能在域控制器上运行多个服务，但不建议这样做，因为这是一个需要高度安全的角色。在这些服务器上运行多个服务可能是允许的，因为它们不与最终用户进行交互操作，只与管理员、操作人员和技术人员进行交互操作。依据你的可用预算来确定你的需求。
　　■对于数据库引擎至少要运行2台机器。这些机器可以运行其他服务——例如，资源池管理工具——但它们必须要配置为群集以确保管理数据库具有高可用性。对于SQL Server，这意味着要在托管数据库的虚拟机中运行Windows故障转移群集服务（Windows Failover Cluster Service，WFCS）。对Oracle，这意味着要运行真正应用群集（Real Application Cluster，RAC）。因此，可能无法在同一服务器实例上运行虚拟化管理工具。
　　警告：Oracle不支持其应用程序运行于除了Oracle VM以外的任何hypervisor上。
　　注意：XenServer不需要这种服务器角色，因为它在每台主机服务器上使用了一种主/从配置存储库。
　　■如果你将主机管理工具与数据库分隔开来，那么至少要在2个不同的VM上运行此服务的2套实例。设置VM为跟随主机服务器启动时自动启动，确保你可以立即访问主机管理工具。
　　注意：作为最佳实践，你应将每个作为资源池管理基础架构一部分的虚拟机设置为自动启动。只有这样做，你才可以立即访问到所有支持资源池运作的工具。
　　■运行安装有管理客户端的桌面虚拟机来连接到资源池管理虚拟机。作为最佳实践，通过桌面而不是通过服务器来访问管理工具是最佳的方式。使这些桌面虚拟机成为资源池Active Directory（AD）的一部分。使用DVM将允许管理员、操作人员和技术人员从其生产桌面或者任何其他已连接的系统中连接到资源池。他们启动虚拟桌面，登录到资源池AD，通过完全独立的安全上下文访问管理工具，这样做可以保护他们生产网络的基础架构。
　　▲在其他的虚拟机上运行其他的服务。服务如证书服务将至少需要2个虚拟机：一个处于离线状态——根证书颁发机构（CA）——而另一个是在线状态——颁发CA。这些机器中，特别是离线的机器，不应该是域控制器。虚拟专用网络（VPN）、网络访问保护（NAP）和更新服务可以共同处于同一服务器上。你不希望它们共同处于管理虚拟机上，因为VPN服务器通常是从你的影响区域以外进入内部网络的进入点。如果有人冒用了VPN服务器，而且它共同处于管理服务器上，那么这可能会危害到你的资源池。
　　这些服务中的许多，除了明显的Windows服务，都可以在Linux和Windows上运行。但是，请记住Windows Server企业版许可授予你在虚拟机中运行最多4个免费Windows实例的权利。如果你利用了这项权利，你可以在少于8个虚拟机中运行整个基础架构，这控制了你的Windows许可费用。
　　只有当你了解了它的工作原理，在你的系统中构建冗余才是有价值的。这对于做好准备还不够；你还需要知道你的准备是非常重要的。为此，你将需要测试和重新测试你在你的资源池中实施的每个单独的冗余级别。太多的组织没有经过测试就实施了高可用性技术，只有在他们需要用到它们的时候才发现它们是无效的，这就导致了致命错误的发生。这不是无中生有的说辞，这种情况实际一直发生着。不要让这种情况发生在你身上。测试你所有的系统并记录你的程序。事实上，对于你编写标准作业程序这是另一个极佳的机会。
　　15.1.2　保护你的虚拟服务或产品
　　建立一个用于支持资源池的冗余网络是你需要实现高可用性架构的一部分。你还必须确保你在你的生产力网络中所提供的服务是高度可用的。虽然有些人认为如果你已正确地实施了虚拟基础架构，你就不必再为此而烦恼。但这样做仍然是很好的方法。
　　例如，在虚拟机中运行Exchange服务器。此服务器是作为独立的服务来运行。由于它是在虚拟机中运行，它将是高度可用的，因为资源池是高度可用的。如果运行虚拟机的主机服务器出现故障，那么虚拟机将通过高可用性（High Availability，HA）功能自动转移到另一台主机。但服务将会有短时间的中断，因为HA并不像实时迁移；由于发生硬件级的故障，所以在hypervisor的HA功能检测到主机故障之前，运行在此主机上的所有虚拟机也将失效。一旦检测到主机出现故障，机器会被转移并重新启动。
　　但是，如果故障是发生在虚拟机中，而不是在物理主机上呢？在这种情况下，hypervisor技术提供了大量的物理机上所没有提供的功能。例如，你可以从快照或从较旧的脱机副本中重新启动Exchange虚拟机，但这将意味着会丢失一些数据。你的电子邮件用户对此将不会太高兴。
　　答案是在虚拟化层内进行群集。如果你正在运行Windows，你可以在虚拟机上运行故障转移群集或网络负载平衡（NLB）。如果你正在运行Linux，那么你要实施企业群集以令工作负载具有高可用性。然后，如果出于任何原因服务发生了故障——主机服务器故障、虚拟机故障等——它将自动转移到你网络中的另一个虚拟机上，不会导致对你的最终用户服务的中断。
　　15.1.2.1　考虑不同服务的高可用性
　　群集不是唯一的你可以运行的高可用性方式。许多服务包含了内置的可靠性功能。请考虑下列因素：
　　▼目录服务　分布在整个网络中的目录服务器创建了可恢复能力。它也基于多主机复制系统，建立适当的复制拓扑。
　　■DNS DNS通常与目录服务密切结合。通过DNS与目录服务相结合，可以确保你的网络名称解析服务总是起作用，因为它具有与目录服务相同的可恢复能力。此功能是通过DNS复制来提供的。
　　■DHCP　你的地址分配基础架构也具有内置的可恢复特性，因为你使用了冗余范围的方式构建它。此外，如果你将你的动态主机配置协议（Dynamic Host Configuration Protocol，DHCP）服务器放置于不同的站点，那么你就具有了一个在灾难发生时可以继续运作的解决方案。
　　■文件共享　你的文件共享资源可以通过它们所运行的操作系统的各种功能来建立可恢复能力。例如，Windows包含的分布式文件系统（Distributed File System，DFS），可以将文件共享内容从一个站点复制到另一个站点，使它们具有可恢复能力。DFS还支持自动故障转移，即如果在一个站点中的服务发生了故障，它会自动故障转移用户连接到另一个站点。还可以通过故障转移群集来保护DFS。
　　■卷快照　共享的文件、共享的数据库、Exchange存储和其他的共享信息存储库也可以通过你的操作系统或你的存储容器所具备的快照功能来进行保护。例如，在Windows中，卷影复制服务可以定期创建系统快照，甚至允许最终用户恢复他们自己的文件。
　　这些只是几个内置可恢复性功能的例子。尽管你的一些系统是可恢复的，但如果它们发生了故障，仍有可能会对你的运作产生重大的影响。
　　请记住，黑客攻击的主要手段之一是分布式拒绝服务（Distributed Denial of Service，DDoS）。这种类型的攻击可以取得成功的原因有2个。第一，服务器托管的服务没有受到保护；第二，服务由单一服务器托管，即没有故障转移服务。第14章向你说明了如何通过城堡防御系统保护你的系统。现在你需要为VSO网络添加额外的恢复能力。
　　15.1.2.2　虚拟服务或产品的群集服务
　　虽然许多服务本身包含了内置的可恢复性，但其他的服务必须依靠它们所运行的操作系统的可恢复特性。如先前所述，对于Windows，就是故障转移群集和NLB。要确定何时使用哪一种，请谨记以下内容：
　　▼当要保护无状态系统或提供只读服务的系统，依靠网络负载平衡。
　　▲当要保护有状态系统或提供读写服务的系统，依靠故障转移群集。
　　它是一个简单的公式：不需要保存数据的系统应依靠NLB。这些系统通常是前端系统。需要保存数据的系统应依靠故障转移群集。这些系统通常是后端系统。
　　NLB群集不需要任何特殊的硬件，因为它们依靠网卡来工作。而故障转移群集则依靠小型计算机系统接口（SCSI）模拟器或互联网小型计算机系统接口（iSCSI）连接器。故障转移群集也可以使用光纤通道，但在虚拟化层还没有光纤通道模拟器，至少目前还没有。在Windows Server 2008中，你可以创建2个节点或最多达16个节点的故障转移群集。NLB群集支持最多达32个节点。
　　你会发现在VSO中组建群集比在资源池中更加全面，因为有了更多的保护。表15-1概述了这些功能以及在Windows Server 2008（WS08）中针对VSO的每一种组建群集模式所支持的服务。
　　正如你所看到的，NLB和故障转移群集是相辅相成的。事实上，不建议在同一服务器上同时启用这2种服务；也就是说，故障转移群集不应该同时也是NLB群集的成员。此外，NLB群集用于支持更多的静态连接。这意味着它们不是用于提供与服务器群集相同类型的故障转移。对于后者，如果用户正在编辑文件时服务器停止了响应，那么故障转移组件将自动被激活，而用户将可以继续执行他或她的工作，并不会意识到发生了故障（响应时间可能会有轻微的延迟）。这是因为服务器群集是用于向用户提供一个镜像的系统。但NLB群集将不能提供相同类型的用户体验。其主要目的是按需重定向到可用资源。因此，这些资源本质上必须是静态的，因为NLB并不包括任何镜像信息寄存的能力。
　　这2种群集服务提供了支持4种服务提供必要条件的能力。
　　▼可用性　由群集来提供服务或产品，确保在组织制定的故障恢复周期内它们是可用的。
　　■可靠性　使用群集，确保用户可以依靠服务或产品，这是因为如果一个组件发生了故障，它会自动使用另一个正常的组件来代替。
　　■可扩展性　使用群集，可以在不影响向用户交付服务的情况下，增加提供服务或产品的服务器的数量。
　　▲维护　群集允许IT人员升级、修改、应用服务包，以及在不影响群集所提供的服务或产品的服务级别的情况下，分别单独地维护群集组件。
　　故障转移群集与NLB群集相比的一个优势是能够共享数据。故障转移群集资源必须绑定到相同的数据存储资源，确保故障转移过程的透明度。
　　群集也有缺点。它们的建立和管理比独立的服务器更为复杂，并且为了能够利用群集的功能，指派到群集的服务必须为支持群集感知的服务。
　　警告：请记住如果你要为虚拟服务或产品创建高可用性的配置，你必须确保反关联规则已应用于资源池中的虚拟机。反关联规则将确保组成高度可用服务的虚拟机不会驻留在同一主机上，将被分散到多个可用主机上。毕竟，如果2个节点的Exchange群集都运行在同一主机上，当这一主机出现故障时，2个节点都将失效，那么你为创建高度可用的Exchange服务所做的一切努力都将化为泡影。
　　15.1.2.3　Windows VSO群集兼容性列表
　　如果你正在你的VSO内运行Windows服务，与大多数组织一样，你会想了解该如何保护你在生产力网络中所运行的每一项服务。即使在Microsoft自己提供的产品中，在群集兼容性方面也具有一些特殊性。群集兼容性可以分为以下4个类别：
　　▼WSFC-感知　就是可以充分利用群集服务的产品或内部WS08服务。它可以与群集应用程序编程接口（API）进行沟通，接收来自服务器群集的状态和通知。它可以对群集事件做出反应。
　　■WSFC-独立（或不感应）就是不能感应群集的存在，但可以在群集上安装，其行为举止如同在单一服务器上的产品或内部WS08服务。它只会响应最基本的群集事件。
　　■WFSC-不兼容　就是不能很好地遵守群集的规范，不应在群集服务器上安装的产品或内部WS08服务。
　　▲NLB兼容　下表列出的产品可以很好地适应于NLB群集。NLB和WSFC往往是互不兼容的。
　　表15-2对Microsoft的Windows Server System（Windows服务系统）和WS08群集兼容性方面的功能进行了分类。
　　表15-2中的信息会随着每个产品的发展随时发生变化，但在决定你该如何为你的服务配置高可用性时，它可以作为一个良好的起点。
　　注意：随着服务器虚拟化的发展，Microsoft服务器产品团队正在改进其特定产品所支持的高可用性策略。例如，Exchange 2007现在仅支持应用于客户操作系统级别而不支持主机级别的高可用性。要了解此策略的详细信息，请访问：http://technet.microsoft.com/en-us/library/cc794548.aspx。
　　15.1.3　建立高度可用的虚拟桌面
　　第10章概述了集中式桌面虚拟化如何工作，以及它如何与你的服务器虚拟化基础架构融为一体。服务器虚拟化资源池与桌面虚拟化资源池之间的主要区别是第一次越过安全边界。这归结于桌面虚拟化的实际工作方式。工作过程如下（见图15-8）：
　　图15-8　桌面虚拟化分配过程
　　1.用户开启他或她的接入点设备。可以是工作站、家中的个人计算机、瘦客户端设备或者公共浏览器。然后，用户进入虚拟桌面基础架构（VDI）接口并登录。
　　2.生产活动目录验证用户的身份，如果他们是有效的，处理他们的登录。
　　3.活动目录与桌面代理程序协同分配将要使用的桌面虚拟机。
　　4.资源调配引擎在服务器虚拟化基础架构中将桌面虚拟机（DVM）分配到主机上。
　　5.登录过程开始，在用户的桌面上会出现虚拟化应用程序图标。同时也会加载用户的远程配置文件。
　　6.一旦用户已完成工作并登出了会话，DVM会被丢弃，因为核心DVM镜像是只读的。
　　7.DVM然后返回到资源池中，用户配置文件中所有的更改信息会被保存到用户配置文件存储中。
　　这个过程是比较简单的，但它需要思考和准备才可以正确地设置和工作。
　　然而，DVM分配过程概述了几个有别于服务器虚拟化基础架构的关键项目。
　　▼第一，在DVM分配过程中的第4步，产生了跨越安全边界的操作。这是因为桌面代理程序发送一个信号给资源调配引擎，将DVM分配给主机服务器。在此特定操作中，包含在生产Active Directory（活动目录）中的资源调配引擎必须与资源池进行交互操作，因为它需要获取将DVM分配给主机服务器的权限。此交互操作通常是由在发送命令内的操作嵌入所需的凭据来执行的。为此，资源调配服务器与资源池之间的连接必须进行加密。
　　■第二，此操作需要多个支持组件，包括AppV应用程序存储库、用户配置文件存储库，用于AppV应用程序的流引擎、向DVM分配非永久性的IP地址的DHCP、Active Directory、DNS等。这些组件中的每一个都必须提供高可用性以支持DVM分配。
　　▲执行DVM分配过程操作所需的许多项目在大多数的Windows网络中应该都已准备就绪。这意味着DVM结构必须是资源池与虚拟服务或产品的组件（见图15-9）的混合。你必须谨记任何VSO与资源池基础架构之间的交互操作必须始终保持高度安全和受到保护。
　　保护DVM分配基础架构的组件
　　虽然你的服务器虚拟化基础架构已经得到了很好的保护，但桌面虚拟化基础架构的几个组件还没有得到解决。其中包括下列项目：
　　▼生产活动目录
　　■生产DNS
　　■DHCP服务
　　■包含应用程序虚拟化（AppV）的应用程序和配置文件的文件共享存储
　　■AppV流引擎
　　■虚拟桌面基础架构组件，如桌面代理程序和资源调配服务器
　　■虚拟桌面本身
　　▲（可选），文件共享复制和抽取引擎
　　每个组件都需要讨论。AppV和配置文件保护机制两者稍后讨论，但其他组件必须在这里得到解决。
　　生产活动目录用于多个项目。它连接着用户账户和分配的桌面，以安全标识符来提供桌面，将Group Policy（组策略）应用到桌面和用户中，向用户分派AppV应用程序。特别是组策略，它是控制漫游用户配置文件和文件夹重定向设置的核心引擎，使配置文件虚拟化能与桌面虚拟化一起工作。基本上，生产活动目录（AD）在其包含的每个域中必须至少具有2个域控制器。通常情况下，生产AD运行在多域的森林，保护森林的根免受最终用户交互操作的损害。这意味着最少需要4个域控制器或者更多。AD结构的重点放在逻辑（每个域内组织单元的结构）和物理（森林中用于控制复制的站点结构）两者之上。请确保你的AD结构是合理的并且已准备就绪。
　　图15-9　DVM分配基础架构的组件
　　注意：关于生产活动目录结构的探讨，可以在www.reso-net.com/livre.asp？p=main & b=winsvr & m=12连接中免费下载《Windows Server 2003，Best Practices for Enterprise Deployments（Windows Server 2003企业部署的最佳实践）》一书的第3章。本章介绍了生产活动目录结构的每个方面。
　　出于多种原因，DNS也是DVM基础架构的一个关键组成部分。DNS是生产活动目录运作的核心。为此，它通常应该直接与目录集成。要做到这一点最好的方法是将你的DNS角色与你网络中的每个域控制器相结合。DNS对于DVM的运行也是至关重要的。因为每个DVM是非永久性的，它将被分配到一个非永久性的IP地址。为了DVM能够正常地工作，必须将此地址注册到DNS中。使用与AD集成的Windows DNS服务器和Windows DHCP服务将可以确保DVM的正确操作。
　　DHCP也是其中的一项要求。DHCP服务器用于当生产环境中的机器启动时，向机器分配非永久性的或者动态的IP地址。此外，Windows DHCP服务器将自动与Windows DNS服务进行交互操作，以确保每台机器已被正确注册。一旦它们收到来自DHCP服务器的IP地址，现代的Win-dows操作系统将在DNS中管理它们自己的注册。若要使DHCP基础架构具有可恢复的能力，在生产网络中你必须至少拥有2个DHCP服务器，并且每个DHCP服务器必须进行配置以支持该网络内地址的50%。
　　VDI组件也必须为高度可用。高可用性解决方案基于你所使用的VDI引擎会有所不同。在某些情况下，通过安装服务的多个副本，依靠负载平衡程序来运行它们，桌面代理程序和资源调配服务器均可实现高度可用性。你所使用的负载平衡程序很大程度上将取决于你所使用的VDI产品；但基本上，该过程使用了一种IP地址转换架构，它将传输控制协议/网际协议（TCP/IP）请求重定向到可用的服务器。这是类似于先前讨论的网络负载平衡服务，虽然某些产品可以使用NLB来运行，但其他产品需要第三方负载平衡装置来运行。
　　在其他情况下，VDI组件将包括它们自己的高可用性能力。例如，Citrix XenDesktop为其每个组件提供了内置的高可用性。XenDesktop农场由多个桌面交付控制器（Desktop Delivery Controller，DDC）组成，其中包括DDC主控和多个DDC成员服务器。如果DDC主控变得不可用，那么DDC成员将被自动提升为新的主控。此外，一个共用的虚拟桌面环境将通过网卡的预启动执行环境（Pre-boot Execution Environment，PXE）功能使用资源调配服务器来启动DVM。为了实现高可用性，资源调配服务器将确保由横跨多个服务器的负载平衡请求以透明的方式处理来自DVM的PXE启动请求。
　　此外DVM必须受到保护，以确保它们始终可用。为了DVM能正常地工作，它必须与桌面代理程序进行通信。DVM通过连接到活动目录来发现桌面代理程序。如果有多个桌面代理服务器可用，DVM将会随机挑选一个，使其具有高可用性。
　　最后一个组件是对托管虚拟应用程序和用户配置文件内容的文件共享的保护。虚拟应用程序共享可以为只读，因为系统用户只需要读取内容来运行应用程序。另一方面，配置文件共享必须能够读取和写入。Windows Server包含了一个功能强大的工具，称为分布式文件系统（Distributed File System，DFS）。DFS是由2个组件组成。第一个是DFS命名空间（DF-SN）。DFS命名空间用于为具有多个目标的文件共享创建一个单一的命名空间。DFS命名空间使用通用命名约定（Universal Naming Convention，UNC）文件共享格式，但它们使用的是＼＼domainname＼sharename格式，而不是使用＼＼servername＼sharename格式。命名空间使用一个单一的名称，但对应多个目标。这使得它可以在多个站点中可用。使用多个文件共享目标可以使你的文件共享具备冗余。将DFS命名空间与活动目录结合，确保用户无论在哪里总是可以找到适当的目标。
　　为了使DFS命名空间能正常地工作，它们必须包含相同的项目。这就是为什么第二个DFS组件，DFS复制（DFSR）必须与命名空间一起使用。DFSR是一个增量压缩复制引擎，在字节级别对文件更改进行复制，在通过WAN链路发送它们之前先对它们进行压缩。此外，DFSR可以控制复制所用带宽的用量，让你可以精确地控制复制在你的网络中将如何运行。DFSN与DFSR一起使用将可以确保位于远程站点的应用程序在本地也是始终可用，你的用户总能找到他们的配置文件，无论它们在你的网络中的哪个位置。
　　注意：更多有关建立和配置每个Windows Server组件以支持VDI高可用性的完整说明，请参阅由Ruest和Ruest编著的《Windows Server 2008：The Complete Reference》一书（2008年由McGraw-Hill发行）。
　　确定其中每个项目都具备了高可用性，将确保你的用户始终能够找到他们的集中式桌面，无论你的用户何时需要它们。
　　15.1.4　建立高度可用的虚拟应用程序
　　正如第11章所述，应用程序虚拟化将对你使用应用程序的方式带来重大的改变。要使AppV工作，需要多个组件，其中一些通过你准备的VDI已经具备了高可用性。
　　▼活动目录用于向最终用户分派AppV应用程序。
　　■文件共享被用做AppV存储库。如果你在多个站点需要存储库，那么它们应该通过DFS来运行。
　　流服务器用于在你运行的虚拟桌面内提供应用程序。
　　■管理服务器允许你分派用程序并将它们连接到AD的安全组。
　　■数据库服务器用于存储AppV分配信息。
　　▲AppV封装和管理站用于创建AppV软件包并管理AppV的基础架构。这些机器可以只是具有AppV组件的非永久性DVM。
　　AppV基础架构与VDI基础架构之间的主要区别是AppV基础架构不需要与资源池进行任何级别交互操作，因为虚拟化应用程序是最终用户使用的应用程序——至少现在是——不会在服务器上运行。即使它们这样做，你很可能只是将AppV服务器工具分派到生产网络中，而不是到资源池网络中。
　　使AppV工作所需的所有组件中（见图15-10），活动目录、文件共享和NLB组件使流服务器的高可用性已经得到了解决。数据库服务器应该运行与资源池数据库引擎相同的故障转移群集服务。然而，这些数据库服务器位于生产网络中，而不是在资源池中，可以支持其他的基础架构管理数据库，如更新服务所需的更新汇总清单，或者你用于管理不能被虚拟化的实用程序和组件的传统电子软件分发（Electronic Software Distribution，ESD）引擎。
　　图15-10　一种高度可用的AppV基础架构
　　封装工作站如果准备妥当，可以只是非永久性的桌面虚拟机，因此可以通过你的VDI组件来提供高可用性。
　　15.1.5　建立高度可用的配置文件
　　正如第11章中所述，配置文件虚拟化是通过漫游配置文件和文件夹重定向的混合来提供支持。漫游配置文件是在活动目录中分配，因为它们是用户账户的其中一个属性。然而，漫游配置文件本身十分庞大，可能需要花费很长的时间才能加载。通过从漫游配置文件中删除内容，将它们分配到重定向文件夹中——这2项设置都可以通过组策略来完成——你可以确保漫游配置文件保持很少，并且可以快速地加载。
　　通过文件夹重定向提供的像用户文档这样的内容，随时可用。重定向的文件夹是网络文件共享，因此在用户登录时不需要将内容下载到非永久性桌面中。当用户打开一个重定向的文档时，该文档才从文件共享中打开，在桌面机器中自动缓存。一旦它缓存到本地，可以加快访问速度。如果由于某种原因进行了脱机更改，那么Windows中的同步管理器将自动把内容从本地缓存中同步到网络中。
　　支持配置文件虚拟化组件的高可用性已经通过VDI和AppV的基础架构得到了解决。活动目录已经具备高可用性，文件共享应该运行DFSN和DFSR，尤其是如果支持远程站点。配置文件共享和AppV文件共享之间的主要区别是AppV文件共享对于用户是只读的，而配置文件共享对于最终用户设置为读写。
　　建立VDI、AppV和配置文件虚拟化基础架构的高可用性将可以确保无论在站点级发生什么事，你的最终用户将始终能够访问到他们的集中式桌面。
　　



　　15.2　建立你的业务连续性策略
　　到目前为止所有的准备工作只是为了一个单一的目标：为你的服务和基础架构建立单个站点级别的高可用性。然而，这对于当出现错误和整个站点不再可用时起不到任何的作用。这可能是由任意数量的潜在灾难导致的。
　　有2种类型的灾难：自然和人为。自然灾害包括地震、龙卷风、火灾、水灾、飓风、泥石流等。它们都是难以预测的，虽然很困难但预防并非是不可能的。防止这些灾难的最佳方法是拥有冗余站点：你的核心服务器和服务在多个站点中可用。如果出于任何原因你的主数据中心受到了损害，那么你还有其他的站点可以接管。这也是故障安全服务器（failsafe server）应运而生的概念。此服务器是处于休眠状态的备用服务器，但如果有需要可以很快被激活。在动态数据中心内，这意味着需要提供冗余资源池服务器和保存在生产中你所运行的每个VSO的副本。
　　还有一些人为的灾难：恐怖袭击、停电、应用程序故障、硬件故障、安全攻击和内联网的破坏。这些攻击也是难以预测的。某些情况需要和用于自然灾害相同类型的保护。其他的，如应用程序和硬件故障以及安全攻击，可以通过城堡防御系统来避免。
　　为了确定你需要应用的服务保护级别，你可以使用类似于第1层数据分类的服务分类。
　　▼关键任务系统　这些是最需要保护的系统，因为服务的中断是不可接受的。
　　■支持任务系统　这些比起关键任务系统需要少一些的保护，但中断应尽可能地减少。
　　■关键业务系统　这些系统的服务出现短时间的中断是可以接受的。
　　▼无关重要的系统　这些被视为是非关键的系统，可以有较长时间的中断。
　　大多数人很少会知道，在许多情况下，你的网络的基本网络基础架构其实是关键任务级别的一部分，因为如果它无法正常工作，没有系统可以工作。
　　由于虚拟机只是处于某处服务器上的一组文件，所以你能够确保更好的业务连续性管理（Business Continuity Management，BCM）方法。如先前所述，本地的BCM是通过高可用性措施来保证。例如，将所有的主机服务器都连接到共享的存储。如果一台主机服务器发生停机，那么高可用性自动将负载转移到群集中的另一个节点上，但在每个群集中你必须具有备用的节点。针对站点级灾难的保护，你必须实现多站点的BCM。由于虚拟机只是服务器上的一组文件，所以你将会发现多站点的BCM比以往任何时候都更容易实现。
　　15.2.1　提供多站点冗余
　　组织不再满足于站点级的冗余。当灾难来袭时太多的组织的确失去了一切。你不希望将所有的鸡蛋放在同一个篮子里。幸运的是，虚拟化的到来使得提供多站点的冗余更为容易。首先，你需要建立第2个数据中心，如果它已经不可用。这个辅助数据中心不需要承载与你的生产环境相同的资源（见图15-11）。它只需少量的资源——事实上能帮助你在紧急的情况下提供支持就足够了。这意味着需要几台已连接到共享存储的主机服务器。此外，它还需要中央电源保护设备和WAN连接。
　　图15-11　提供多站点冗余
　　这个辅助站点甚至可以由互联网服务提供商（Internet Service Provider，ISP）来托管。在市场上有多家ISP可供使用。对于中小型企业来说，使用ISP可能是最佳的选择，因为自己动手为业务连续性管理目的而建立辅助数据中心是十分复杂的，有时候还要冒着昂贵的投资风险。
　　注意：多家ISP提供了此项服务，例如SunGard（www.availability.sungard.com）、Sunrad（www.sanrad.com/products/overview.aspx）和INetU（www.inetu.net/innovative-support/virtualization.php）。当需要在你的组织以外进行托管时，仔细地选择你的供应商，彻底审查他们的私隐协议，以确保你的数据是安全的。
　　15.2.2　调整你的服务级别协议
　　用于灾难恢复的服务级别协议（Service Level Agreement，SLA）与用于正常生产的那些协议并不相同。当灾难发生时，你仅需要从必要的服务开始。此外，当你处于灾难恢复的情况时，这种情况不应该永远持续下去，这段时间你所需要的是退回到初始状态。为此，在灾难恢复站点中你所需的主机服务器资源不必与你的生产数据中心的资源相同。
　　你可以依靠公式来帮助你确定你的灾难恢复中心究竟将需要多少物理资源。公式如下所示：
　　生产资源/恢复时间=灾难恢复资源
　　例如，如果你正在15台物理主机上运行你的基础架构，预期你的恢复时间为3个小时，那么你可以使用5台物理主机运行灾难恢复中心。降低恢复时间，你将需要为你的恢复中心增添更多的资源。
　　平衡你需要进行重新加载关键服务的恢复中心中的物理资源的数量。在灾难事件发生时，你的恢复首先将需要必要的服务——例如，活动目录域服务和DNS——然后加载辅助服务、DH-CP、文件和打印服务器等。使用分级方式重新加载用户的服务将允许你分阶段将一切恢复到联机状态，可以减少辅助数据中心的开销。
　　15.2.3　通过复制实现业务连续性管理
　　资源池的远程业务连续性是通过将你的存储容器内容从一个位置复制到另一个位置的数据复制技术来提供的。你可以依靠存储容器本身的复制引擎，或者你可以使用第三方引擎。使用第三方复制引擎的优点是它通常包含了在灾难事件发生时将你的最终用户正在访问的服务重定向到远程站点所需的组件。这可以简化灾难恢复的过程。
　　对于多站点的可恢复性，每个资源池供应商依靠于不同的解决方案。例如，Microsoft可以依靠先前提到的多站点故障转移群集来为Hyper-V提供可恢复的多站点（见图15-12）。此解决方案是依靠Windows Server 2008的内置功能，但也需要第三方复制引擎来保持站点之间的存储内容完全相同。请注意，要使此解决方案起作用，在生产和远程2个站点中你必须具有完全相同的可用资源。此解决方案与任何的成本-效益背道而驰。
　　图15-12　Hyper-V使用多站点故障转移群集
　　注意：要了解Hyper-V故障转移群集的复制合作伙伴的列表，请访问www.microsoft.com/windowsserver2008/en/us/clustering-multisite.aspx。
　　Citrix依靠第三方产品来提供业务连续性。基本上，你必须获取XenServer资源池复制引擎。此引擎将包含通过复制来执行连续数据保护（Continuous Data Protection，CDP）的能力，以及在故障发生时将所有用户重定向到远程站点的能力。重定向主要是通过更改每个用户所依靠服务的DNS条目来执行的。
　　VMware依靠站点恢复管理器（Site Recovery Manager，SRM）以及集成的SAN功能或者复制引擎来提供多站点的冗余。站点恢复管理器是VMware虚拟基础架构的一个组件，可以帮助你建立、管理和执行灾难恢复计划。SRM通过启用无中断测试来确保恢复是可靠的。它还通过自动化消除了手动恢复的步骤，并且提供集中管理的恢复计划（见图15-13）。
　　图15-13　运行VMware Site Recovery Manager（站点恢复管理器）
　　SRM提供了一个简单的集成接口，再一次重申，这是VMware Virtual Center的功能扩展（见图15-14）。这极大地简化了工具的管理，因为你总是使用相同的接口。
　　图15-14　VMware Site Recovery Manager的管理界面
　　SRM完全支持先前讨论过的数据中心复制模式。恢复或辅助站点不需要具有与生产或主站点相同或完全相同的资源。例如，如果你的生产站点是依靠光纤通道和最好的高速驱动器的SAN，你的恢复数据中心便可以轻松地在串行ATA（SATA）驱动器上运行iSCSI。这意味着恢复站点的实现比生产站点要便宜得多。依靠先前列出的公式来确定你究竟想要在恢复站点中实现哪一种技术。
　　注意：要了解VMware站点恢复管理器的详细信息，请访问www.vmware.com/products/srm。
　　15.2.4　选择合适的复制工具
　　你选择的复制工具必须能够充分理解你的虚拟机和虚拟化引擎的构成。几种基于SAN的复制工具仅能够复制而不能做别的。由于复制发生在字节级别，所以数据的内容变得无关紧要。但是，当你选择你的复制引擎时，请考虑以下内容：
　　▼引擎必须受到虚拟化供应商的官方支持。
　　■引擎必须能够使用你部署的任何存储基础架构：DAS、NAS或SAN。
　　■引擎必须支持资源的自动故障转移，正确地将最终用户重定向到远程位置。
　　▲引擎必须支持隔离的恢复测试（见图15-15）。
　　图15-15　执行隔离的恢复测试
　　最后的项目可能是最重要的一个，因为复制本身并不能作为恢复解决方案。使用VMware，正如先前所述的，站点恢复管理器将从一个基于站点的灾难中执行许多恢复所需的关键动作。但是，如果你没有在运行VMware，那么你将需要类似的功能。这些将来自你的复制工具或者你的复制工具组合以及你的hypervisor的内置功能。
　　如果你无法在不中断你的生产网络的情况下测试故障转移情况，那么你将需要破坏生产网络来执行该测试。没有经过测试的方案就不能算是解决方案。如果你不对你的故障转移策略做测试，那么你将永远不会知道你的解决方案是否有效。不要等到发生重大故障才来找出无法正常工作的原因！
　　此外，虽然以前的物理网络依靠复制技术来提供服务的可用性，但在资源池中你不再需要关心这方面的问题。例如，多个复制供应商已经通过复制引擎来保护Microsoft Exchange。在过去，你要实施一个复制引擎来确保如果某个位置的Exchange服务器出现停机，那么另一个Ex-change服务器副本会在别处恢复运行。使用资源池，你就不必担心这方面的问题，因为如果你复制了正在运行Exchange虚拟机，那么虚拟机就可以在其他地方恢复运行，这就是你所需要的全部。不用在虚拟机内进行复制——仅需集中复制资源池的内容，那么你的解决方案就已满足需求。
　　最后，请记住复制不是一种备份解决方案；它是一种BCM（业务连续性管理）解决方案。但是，如果你部署了适当的BCM解决方案，它也可以作为虚拟机内容的额外保护级别。
　　15.2.5　为基于站点的灾难做准备
　　当规划你的远程业务连续性管理站点时，请谨记以下各项。在BCM的情况中，你必须：
　　▼首先以关键的服务作为开始：域控制器、DNS、DHCP
　　■然后启动关键的应用程序：业务应用程序、电子邮件服务等
　　▲以降低了的服务级别协议模式来运行——并不是所有的服务都需要符合BCM的情况
　　为此，你能够以刚好满足的硬件作为开始来运行核心VM，并保持你的业务的运行。如果BCM的情况持续下去，就提供更多的主机服务器，启动额外的虚拟工作负载。如果你使用集成的hypervisor，那么可以轻易地将它们添加到BCM资源池。
　　使用以下经验法则：以你的生产环境硬件能力的25%作为开始。确定你所有的关键应用程序。为每个应用程序分配优先级。然后运行连续的测试，以确保所有的关键应用程序将以此BCM配置来加载。然后再根据需要调整你的配置。最后，确保你完整地记录你的BCM策略，并且所有的管理员和技术人员都要清楚这一点。灾害不仅会在机器上发生；它们还会在人身上发生。确保你的整个团队清楚了解遇到灾难情况时该如何应对，当最坏的情况发生时，将极大地有助于保护你的基础架构。
　　



　　第16章　更新你的管理架构
　　最后但并非最不重要的一点是，你必须要检查你的管理实践。这意味着要研究你的员工将在资源池基础架构中所扮演的新的管理和技术的角色。这也意味着当到了必要的时候，要使用新的基于策略的工作负载或者动态启动的工作负载，以支持业务流程。资源池管理也将迫使你不得不寻求新的方法来处理分支机构的事务。此外，它们将促使你在资源池与生产网络之间创建一个新的职责划分。
　　若要确保你具有你所运行的两个基础架构的完全控制权，需要确保你拥有适当的权限管理工具。对于每个基础架构，你将使用同样的工具呢还是将它们两个分开呢？这些问题将帮助你完成你必须着手迁移到一个完全的虚拟基础架构的反思。
　　



　　16.1　依靠新的管理角色
　　管理两个基础架构（物理的和虚拟的）改变了IT在数据中心内需要工作的方式。很显然你需要使用工具来管理你的资源池。例如，在VMware VirtualCenter中，Administration（管理）标签页包含了默认的资源池角色（见图16-1）。虽然你不需要依靠每个角色，但某些额外的角色是必需的。表16-1概述了一些新的或更改过的你将会在对服务器、台式机和应用程序进行了虚拟化的数据中心内发现的角色，并将它们映射到相应的基础架构。
　　图16-1　VMware VirtualCenter中默认的管理角色
　　表16-1中所概述的角色涵盖了两个网络。例如，服务器虚拟化角色全部只驻留在资源库中，而桌面和应用程序虚拟化角色全部驻留在生产力或虚拟网络中。
　　请记住这些角色不需要有一个特定的人员专门负表。较大型的组织可能会有人员去填补每个角色，但较小型和中型的组织可能依靠几个人去填充所有的角色。在后一种情况，职员将不得不负责多项工作以确保所有事情都得到完成。
　　



　　16.2　迁移到基于策略的工作负载
　　虚拟化对IT操作产生的最大影响之一是创建基于策略的工作负载的能力。在虚拟基础架构中，物理服务器只不过是汇集在一起创建为一个整体的资源，与网络基础架构非常类似。生产力服务提供——与用户进行交互操作的提供——仅在虚拟机中运行。因为这些服务都是在虚拟层提供的，它们比以往变得更具延展性。
　　然而没有组织想负担多台只是经常空闲在那里等待业务需求的物理服务器，所有组织可以使用虚拟机来承担这项工作。比方说，你为了支持季节性业务波动而有急切需要的临时服务。在过去的IT世界，你必须要为此工作负载波动提前做好计划，确保可以运行额外的服务。但今天，你可以简单地创建动态的工作负载，根据需要将它们添加到你的基础架构中——当然，以你必须具有运行它们所需的主机服务器为前提。
　　这种在需要时创建机器，运行它们，然后删除它们的能力是虚拟数据中心所需要的自动化的一部分。每个虚拟机都有生命周期，正如第9章所述，此生命周期包括了可能还没有得到解决或在过去从不需要的步骤。机器根据需要而被创建，并运行在一台主机上或者基于你为这台机器设置的策略和优先事项的另一台机器上。不但可以更容易动态地创建虚拟机，而且也很容易让它们在不使用时可以保留下来。个别虚拟机通常是处于“静止”状态等待别人使用它们，但仍占用着空间和资源。当它们的目的已经完成，可以自动地将资源返还给虚拟机池，这就是为什么通常更佳的做法是创建基于时间的机器。
　　正如你所看到的，策略是虚拟基础架构中过程自动化的核心。但是你可以采取进一步的步骤，创建像影响虚拟机那样影响主机服务器的策略。在这种情况下，虚拟服务产品（Virtual Service Offering，VSO）是基于需求来开机和关机，资源池是基于VSO的工作负载来开启的（见图16-2）。例如，一个薪金计算应用程序只有在运行薪金支付计算的时候才需要大量的资源。这取决于你的薪金发放的时间安排，可以是每2周1次或每月2次。其他的时间，薪金计算机器是处于“静止”的状态，并且与其他虚拟机一起停泊在主机服务器上。在停泊模式下，这台机器仍然运行，但不会占用大量的资源。
　　图16-2　工作中的基于策略的工作负载
　　你甚至可以将此功能扩展到你所有的工作负载。例如，一个大型的数据中心可以根据需要增减服务。没有理由在晚上没有人使用它们的时候运行10台Exchange Server（服务器）。不过，你可以在晚上运行这些机器中的2台，然后设置策略在有需要的时候唤醒其他机器以及他们相应的主机——例如，在高峰时间，如在清晨和午饭后。
　　运行基于策略的工作负载改变了数据中心的规范，为绿化数据中心提供了更大的支持。如果可以将主机服务器静止，仅在需要时才运行，这对于数据中心的电力和冷却的最低需求将有积极的影响。但是，若要控制这种新的动态数据中心，你必须具有合适的工具集。
　　注意：供应商Cassatt已经提供了自动化的电源效率软件；要了解他们的电力节省计算器请访问www.cassatt.com/tools/powersavecalc.php。
　　注意：Microsoft已更新了它的Windows Server产品授权许可。之前，每个授权许可被捆绑到物理服务器，即运行虚拟机的主机。现在，授权许可被捆绑到一个数据中心或主机服务器池。这意味着你可以使用基于策略的工作负载管理，而不必担心每次将VM从一台主机转移到另一台主机时需要重新分配授权许可。
　　



　　16.3　基于策略的资源管理
　　基于策略的资源管理需要的不仅是新的数据中心视图，而且还需要进行这项工作的合适的工具。虚拟化供应商在完成运行虚拟数据中心所需的不同工具集方面已经取得了进展，但在某些情况下，这些工具还是不够的。表16-2描述了在虚拟数据中心中所需要的不同的功能，以及为满足这些功能要求，由VMware、Microsoft和Citrix所提供的管理工具。请记住，虚拟基础架构管理必须集中于4个关键功能，你可以通过表16-2的内容看到：
　　▼管理用于虚拟机的驱动程序（集成组件、VMware附件等）。
　　■为客户操作系统分配或创建虚拟机空间。
　　■监控VM的特征（内存、处理器内核、磁盘空间、I/O），并在需要时提供警报。
　　▲装载、卸载和备份每个虚拟机。
　　这些是所有虚拟机管理工具所需的4种基本功能。任何额外的功能都是奖励。
　　正如你所看到的，VMware和Microsoft都提供了广泛的工具选择来支持动态数据中心。然而，即使VMware和Microsoft在表16-2的特定部分都有工具列出，但这些工具不一定具有相同的功能集。例如，VMware Lifecycle Manager（生命周期管理器）在虚拟资源调配自动化方面比Virtual Machine Manager（虚拟机管理器）提供了更全面的功能集。另一个例子是在主机电源管理方面VMware的Distributed Power Management（分布式电源管理）与Microsoft的Operation Manager（操作管理）的比较。
　　另一个主要的区别是VMware在VirtualCenter中提供了全部的工具集，随着你对额外功能的进一步需求而添加功能。VirtualCenter支持7种不同的关键功能——基本的虚拟机和主机管理、资源调配、迁移、资源管理、系统监控、安全和访问控制——同时还为第三方工具的集成提供了一个应用程序编程接口（Application Programming Interface，API）（见图16-3）。
　　图16-3　VMware VirtualCenter提供了多种功能
　　为了方便获取你需要用于维护动态VMware数据中心的所有工具，VMware与Virtual Infrastructure（虚拟基础架构）版本一起提供了2种软件捆绑。VMware IT服务交付捆绑包括了VMware Lifecycle Manager（生命周期管理器）、Lab Manager（实验室管理器）和Stage Manager（场景管理器），让你通过自动化的策略来控制VM的生命周期。VMware管理和自动化捆绑包括了前面捆绑的所有东西和Site Recovery Manager（站点恢复管理器）。
　　Citrix的XenCenter与VirtualCenter类似，因为它为主机和虚拟机资源的操作和管理提供了一个单一的界面（见图16-4）。主机服务器可以使用速成版和标准版进行独立的管理，或通过更高级版本的资源池进行管理。该界面在一个工具中提供了所有的基本管理功能。
　　图16-4　Citrix XenCenter为XenServer管理提供了一个界面
　　Microsoft的工具集大多数是依靠System Center（系统中心）工具，它们都具有相同的外观和感觉，但都是独立的工具。可是，对于单机和池的管理，Microsoft依靠的是Hyper-V Manager，它既可作为一个独立的工具（见图16-5），也可以作为Windows Server 2008 Server Manager的一个附加功能（见图16-6）。如果你没有访问System Center工具的权限，后者通常是更合适的，因为它在一个单一的界面中汇集了所有的服务器管理功能。
　　图16-5　使用Hyper-V管理器
　　但是，请注意，Server Manager不能在工作站上安装，因为它是Windows Server不可或缺的一部分。为此，许多组织倾向于在他们的服务器上以应用程序模式安装终端服务，并通过终端服务的RemoteApp功能使用它来发布Server Manager作为远程应用程序。这为管理员提供了就像本地安装的工具一样的经验。
　　图16-6　使用WS08　Server Manager管理Hyper-V
　　Server Manager不能管理远程的计算机，因此只能在完整安装的Windows Server 2008（WS08）上使用。如果你在Server Core上安装Hyper-V角色——因为你应该减少主机操作的开销——你将不能依靠Server Manager，并不得不依靠用于故障转移群集和Hyper-V管理的独立界面。这两者都可以通过远程服务器管理工具（Remote Server Administration Tool，RSAT）提供，它可用于x86和x64版本的Windows上。RSAT只可以安装在Windows Server 2008或Windows Vista Service Pack 1上。
　　注意：用于x86的RSAT可以在下列地址中找到：www.microsoft.com/downloads/details.aspx？FamilyID=9ff6e897-23ce-4a36-b7fc-d52065de9960 & displaylang=en，而用于x64的RSAT可以在下列地址中找到：www.microsoft.com/downloads/details.aspx？FamilyId=D647A60B-63FD-4AC5-9243-BD3C497D2BC5 & displaylang=en。两者都记录在编号为941314的Microsoft知识库文章中。需要正版Windows验证才能获得下载。
　　但是，当你运行虚拟基础架构时，最简单的基础架构所需的一切基本功能都可以在VMware的VirtualCenter中找到。为了实现这一级别的功能，你需要Microsoft的System Center工具。较小的公司可以依靠System Center Essential与系统中心虚拟机管理器（System Center Virtual Machine Manager，SCVMM）工作组版（Workgroup Edition）结合使用。Workgroup Edition支持最多5台主机服务器。较大的公司需要完整的System Center工具包，这可以通过特殊的捆绑提供——服务器管理套件企业（Server Management Suite Enterprise，SMS）其中包括4个工具：
　　▼系统中心配置管理器（System Center Configuration Manager，前身是Systems ManagementServer），它可以提供机器、主机或虚拟机，并管理它们的配置和维护配置的一致性。
　　■系统中心操作管理器（System Center Operations Manager，SCOM）可能是Microsoft的最佳工具，它可用于监控主机服务器、虚拟机以及虚拟机内应用程序的健康和性能。SCOM依靠管理包来支持服务器工作负载或者应用程序。第三方供应商如nWorks（www.nworks.com）甚至提供用于VMware ESX Server的管理包，让你通过一个单一的工具来管理混合的环境。
　　■系统中心数据保护管理器（System Center Data Protection Manager），它是一种连续的保护工具，可用于集中所有的备份和恢复操作。
　　▲系统中心虚拟机管理器（System Center Virtual Machine Manager），负责管理主机和VM操作。此捆绑简化了管理，虽然每个工具都提供了相同的界面（见图16-7），但它们是相互独立的工具。
　　图16-7　像Virtual Machine Manager这样的System Center工具都基于相同的界面
　　



　　16.4　依靠第三方管理工具
　　尽管每个供应商都为他们的hypervisor提供了功能强大的管理工具，并且有一些工具甚至可以管理其竞争对手的hypervisor，但你可能会发现一些特性和功能根本没有包括在此工具集中，因此需要第三方工具。表16-3提供了一份到目前为止一些最具创新性的第三方工具的示例清单。随着虚拟化成为主流，其他供应商一定会跟随他们的脚步前进。
　　正如你所看到的，第三方工具尝试解决三大仍然还没有解决的需求、VM优化、多供应商的生命周期管理、主机服务器资源调配，以及（特别是）控制虚拟机的泛滥，所有这些功能将是你的环境最终需要的。基于这些原因，获取第三方工具可能是许多人的最佳策略。
　　



　　16.5　更新你的管理实践
　　虚拟机管理和资源池管理为现代数据中心带来很多的变化。为此，你需要更新你的管理实践。在小型公司中，IT人员将不得不学会承担新的工作，并且要特别小心，当他们执行他们的行动时，切勿跨越安全边界。在较大的公司中，你将要为资源池与虚拟服务产品的管理创建专门的职位，并保持他们是独立的。
　　理想的动态数据中心是一个将所有的资源捆绑到一起只用于托管服务的资源池。虚拟机尽可能提供所有其他的服务。这种双重性现在已是一种实在的技术，并且数据中心将会按照这种方式运行和操作。请确保仔细地检查了你当前的实践，并当你将数据中心转变成动态环境时准备好更新它们。
　　



　　后记
　　此刻，你对于虚拟化将会如何改变你的数据中心已经有了深入的了解。现在，你需要关注你的实现途径。据IDC报道，已经实行了迁移的组织最常使用一种三段式的方法（见图1）。首先，他们关注于资本的支出和物理整合的目的。其次，他们转向操作上的变化并侧重于具有高可用性和灾难恢复的实施。最后，他们开始思考虚拟化所提供的策略优势，真正地开始将他们的数据中心转换为它们应该成为的动态系统。
　　图1　潜在的实施途径
　　（来源：IDC，Virtualization 2.0：The Next Phase in Customer Adoption，2006年11月）
　　从你的短期需求入手。大多数情况下，存在问题应用程序的组织可以立即从实施虚拟化中受益。随后，一旦你的基础架构达到稳定，再着眼于长远。你的目标应是100%的虚拟化，但请记住以下注意事项：
　　▼虚拟化一切应用程序，除非应用程序所有者或供应商能够提供不要这样做的成本论证。
　　■目标是使你的主机服务器的利用率达到60%~70%。
　　■将主机服务器农场或资源池限制在最多8台服务器或更少，以保持可管理性。VMware支持一个农场包含32台服务器，而Microsoft Hyper-V和Citrix XenServer可以支持16台。但是，创建的最大节点数量的农场往往使它们难以管理。
　　■要为虚拟服务或产品设计高可用性。你要确保你的服务器，至少是提供生产服务的服务器，在任何时候均为可用。
　　■在每个服务器农场中保持匹配的处理器类型，以支持实时迁移功能，并且每次处理器类型发生变更时应新建一个新的服务器农场。虽然这种情况正在发生改变，但现在这仍然是一种很好的做法。
　　■确保你为运行在主机上的每个虚拟机（VM）执行成本核算——很容易失去对VM成本的跟踪，因为它们很容易创建和部署。
　　▲使用特定的VM分配程序，包括管理和技术，确保只有必需的VM才能进入你的网络。这些做法都是有益的策略。当你推行你的项目的时候请谨记它们。
　　计算你的投资回报
　　最后，你需要执行事后分析，其中你将计算你的投资回报（ROI）。你会发现硬钱（直接的利益）很容易收回，但软钱（非直接的利益）是难以计算清楚的。当你在计算你的投资回报时，请谨记下列问题：
　　▼是否有评估准备一台虚拟服务器比准备一台物理服务器为你节省时间的价值？
　　■是否有评估你所准备的标准测试和开发环境的价值？
　　■是否有评估一个灵活的虚拟基础架构可以满足你不断变化的业务需求的价值？
　　▲是否有评估缩短了所有你的核心应用程序的交付时间的价值？
　　时间就是金钱，但很难量化。表1概述了一些潜在的成本节约，当你迁移到虚拟化时你将会受益。
　　虚拟化也将改变你的IT部门中的指标（见图2）。你可以减少高达50%的资本支出。响应时间将会减少，有时高达90%。营运开支，尤其是电力和冷却成本，将会极大地减少。并且恢复时间也将受益于这一举措。
　　图2　虚拟化的潜在回报
　　这仅仅是开始。当你迁移到一个虚拟基础架构时，几十家新的公司将会出现，数以百计的新产品将会可用。未来就是现在，在IT方面，这意味着数据中心内的一切都在朝着虚拟化发展。
　　



　　版权信息
　　书名：我在高盛的经济预测法
　　作者：[美]埃利斯
　　ISBN：9787111347682
　　出版社：机械工业出版社
　　本书由北京华章图文信息有限公司授权苏宁易购电子版制作与发行
　　版权所有·侵权必究
　　
";